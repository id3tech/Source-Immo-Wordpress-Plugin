function BaseDialogController($dialogId,$scope,$rootScope,$mdDialog){return $scope.dialogId=$dialogId,$scope.callback=null,$scope.title=$dialogId.replace("-"," "),$scope.actions=[{label:"OK",action:function(){$scope.cancel()}}],$scope._dialogInit_=function(){$scope.$on("on-"+$scope.dialogId,function($event,$params,$callback){if(console.log("instance of dialog",$scope.dialogId,"called with",$params),"function"==typeof $scope.init)$scope.init($params);$scope.open($scope.dialogId),$scope.callback=$callback})},$scope.setTitle=function($new_title){$scope.title=$new_title},$scope.open=function($dialogId){return $mdDialog.show({contentElement:"#"+$dialogId,parent:angular.element(document.body),targetEvent:null,clickOutsideToClose:true,fullscreen:true})},$scope.cancel=function(){$mdDialog.cancel()},$scope.return=function($result){$scope.callback($result),$mdDialog.cancel()},$scope}function BasePageController($pageId,$scope,$rootScope){return $scope.pageId=$pageId,$scope.callback=null,$scope.actions=[{label:"OK",action:function(){$scope.cancel()}}],$scope._pageInit_=function(){console.log("pageInit for",$scope.pageId,"called"),$scope.$on("on-"+$scope.pageId,function($event,$params,$callback){if(console.log("instance of page",$scope.pageId,"called with",$params),"function"==typeof $scope.init)$scope.init($params);$scope.open_page($scope.pageId),$scope.callback=$callback})},$scope.cancel=function(){$scope.close_page()},$scope.return=function($result){$scope.callback($result),$scope.close_page()},$scope.open_page=function($page_id){$rootScope.current_page=$page_id},$scope.close_page=function(){$rootScope.current_page="home"},$scope}var siApp=angular.module("siApplication",["ngRoute","ngMaterial","ngMessages"]);siApp.config(function($routeProvider,$mdThemingProvider,$httpProvider,$mdAriaProvider){$mdAriaProvider.disableWarnings(),$mdThemingProvider.theme("default").primaryPalette("blue").accentPalette("deep-orange"),$mdThemingProvider.theme("docs-dark","default").primaryPalette("blue").dark()}),siApp.controller("homeCtrl",function($scope,$rootScope){console.log("configs controller loaded"),$scope.route_listing_elements={"{{item.ref_number}}":"ID","{{item.transaction}}":"Transaction type","{{item.location.region}}":"Region","{{item.location.city}}":"City","{{item.location.street}}":"Street","{{item.location.civic_address}}":"Civic address"},$scope.route_broker_elements={"{{item.ref_number}}":"ID","{{item.first_name}}":"First name","{{item.last_name}}":"Last name"},$scope.route_city_elements={"{{item.code}}":"ID","{{item.location.region}}":"Region","{{item.name}}":"Name"},$scope._pageInit_=function(){},$scope.addRouteElement=function($item,$elm){$item.route+=$elm},$scope.addRoute=function($list){let lLocale="";for(let $key in $scope.lang_codes)if($list.map(function(e){return e.lang}).indexOf($key)<0)lLocale=$key;$list.push({lang:lLocale,route:""})},$scope.removeRoute=function($route,$list_name){let lNewRoutes=[],lList=$scope.configs[$list_name];lList.forEach(function($e){if($e!=$route)lNewRoutes.push($e)}),$scope.configs[$list_name]=lNewRoutes},$scope.hasMinRouteCount=function($list){return 1==$list.length},$scope.hasMaxRouteCount=function($list){let lResult=true;if($list)for(let $key in $scope.lang_codes)if($list.map(function(e){return e.lang}).indexOf($key)<0)lResult=false;return lResult},$scope.clearAccessToken=function(){$scope.api("access_token",null,{method:"PATCH"}).then(function($response){$scope.show_toast("Access token cleared")})}}),siApp.controller("listCollectionCtrl",function($scope,$rootScope){$scope.init=function(){},$scope.add=function(){$scope.show_page("listEdit",null).then(function($result){lNew=$result,$scope.configs.lists.push(lNew)})},$scope.edit=function($list){$scope.show_page("listEdit",$list).then(function($result){console.log("new list data",$result);for(const key in $result)if($result.hasOwnProperty(key)){const element=$result[key];$list[key]=element}$scope.$emit("save-request")})},$scope.remove=function($list){$scope.confirm("Are you sure you want to remove this list?","This action could renders some sections of your site blank",{ok:"Continue"}).then(function(){let lNewlists=[];$scope.configs.lists.forEach(function($e){if($e!=$list)lNewlists.push($e)}),$scope.configs.lists=lNewlists,$scope.show_toast("List removed")})},$scope.getListShortcode=function($list){return'[si alias="'+$list.alias+'"]'},$scope.countFilters=function($list){let lResult=0;if(null!=$list.filter_groups)$list.filter_groups.forEach(function($e){lResult+=$e.filters.length});return lResult}}),siApp.controller("listEditCtrl",function($scope,$rootScope,$q,$siUtils){BasePageController("listEdit",$scope,$rootScope),$scope.model={},$scope._original=null,$scope.actions=[{label:"Apply".translate(),action:function(){$scope.return($scope.model)}},{label:"Cancel".translate(),action:$scope.cancel}],$scope.init=function($params){if(console.log("listEdit init"),null==$params)$scope.model={alias:"New list".translate(),source:$scope.data_views[0],type:"listings"},$scope.reset_default_value();else{if($scope.model=angular.copy($params),null!=$scope.model.source)$scope.model.$$source_id=$scope.model.source.id;$scope.validate()}$scope._original=$params},$scope.reset_default_value=function(){switch($scope.model=angular.merge($scope.model,{sort:"auto",sort_reverse:false,limit:0,searchable:true,sortable:true,mappable:true,filter_group:{filters:[],filter_groups:[],operator:"and"}}),$scope.model.type){case"listings":case"brokers":$scope.model=angular.merge($scope.model,{list_layout:{preset:"standard",scope_class:"",custom:null},list_item_layout:{preset:"standard",scope_class:"",custom:null}});break;case"cities":$scope.model=angular.merge($scope.model,{list_layout:{preset:"direct",scope_class:"",custom:null},list_item_layout:{preset:"standard",scope_class:"",custom:null}})}},$scope.updateSource=function(){$scope.model.source=$scope.data_views.find(function($e){return $e.id==$scope.model.$$source_id})},$scope.saveOrClose=function(){if($scope.hasChanged())delete $scope.model.$$source_id,$scope.renewSearchToken().then(function($searchToken){$scope.model.search_token=$searchToken,$scope.return($scope.model)});else $scope.cancel()},$scope.renewSearchToken=function(){let lFilters=$scope.buildFilters(),lPromise=$q(function($resolve,$reject){if(null!=lFilters)$scope.api("",lFilters,{url:wpApiSettings.api_root+"/api/utils/search_encode"}).then(function($response){$resolve($response)});else $resolve("")});return lPromise},$scope.buildFilters=function(){let lResult=null;if($scope.model.limit>0)lResult={max_item_count:$scope.model.limit};if(""!=$scope.model.sort&&"auto"!=$scope.model.sort){if(null==lResult)lResult={};lResult.sort_fields=[{field:$scope.model.sort,desc:$scope.model.sort_reverse}]}if($scope.model.shuffle){if(null==lResult)lResult={};lResult.shuffle=$scope.model.shuffle}if(null!=$scope.model.filter_group){if(null==lResult)lResult={};lResult.filter_group=$scope.normalizeFilterGroup(angular.copy($scope.model.filter_group))}return lResult},$scope.normalizeFilterGroup=function($filter_group){if($filter_group.filters)$filter_group.filters.forEach(function($filter){if(["in","not_in"].indexOf($filter.operator)>=0){if("undefined"==typeof $filter.value.push)$filter.value=$filter.value.split(","),$filter.value.forEach(function($val){if(!isNaN($val))$val=Number($val)})}else if(!isNaN($filter.value))$filter.value=Number($filter.value)});if($filter_group.filter_groups)$filter_group.filter_groups.forEach(function($group){$scope.normalizeFilterGroup($group)});return $filter_group},$scope.switchSortReverse=function(){$scope.model.sort_reverse=!$scope.model.sort_reverse},$scope.hasChanged=function(){return!$scope.isSame($scope.model,$scope._original)},$scope.validate=function(){}}),siApp.controller("mainCtrl",function($scope,$rootScope,$mdDialog,$q,$http,$mdToast,$timeout,$siApi,$siList,$siUI,$siUtils){$scope._status="initializing",$scope.loaded_components=[],$scope.configs={},$scope.lang_codes={fr:"Français",en:"English",es:"Español"},$scope.global_list={sources:[],list_types:[{key:"listings",label:"Listings"},{key:"brokers",label:"Brokers"},{key:"cities",label:"Cities"}],list_layouts:{listings:[{name:"standard",label:"Standard"},{name:"map",label:"Map"},{name:"direct",label:"Server side rendering"}],brokers:[{name:"standard",label:"Standard"},{name:"direct",label:"Server side rendering"}],cities:[{name:"direct",label:"Server side rendering"}]},list_item_layouts:{listings:[{name:"standard",label:"Standard"},{name:"small",label:"Reduced"},{name:"minimal",label:"Minimal"}],brokers:[{name:"standard",label:"Standard"},{name:"reduced",label:"Reduced"},{name:"minimal",label:"Minimal"}],cities:[{name:"standard",label:"Standard"}]},detail_layouts:[{name:"standard",label:"Standard"},{name:"custom_page",label:"Custom layout from page"}],list_ordering_field:{listings:[{name:"contract_start_date",label:"Inscription date"},{name:"price",label:"Price"}],brokers:[{name:"name",label:"Name"},{name:"listing_count",label:"Number of listings"}],cities:[{name:"name",label:"Name"},{name:"region",label:"Region"}]}},$scope.registration_steps=[{name:"Linked account"},{name:"API key"},{name:"Data view"},{name:"Integration"}],$rootScope.current_page="home",$scope.pages={home:{label:"Home".translate(),style:""},listEdit:{label:"List editing".translate(),style:"transform:translateX(calc(-100vw + 180px));"}},$scope.configuration_step=0,$scope.credentials=null,$scope.data_views=[],$scope.wp_pages=[],$scope.login_infos={email:"",password:""},$scope.api_keys=null,$scope.default_page={listing:"NEW",broker:"NEW"},$scope.init=function(){$scope.load_configs().then(_=>{$q.all([$scope.load_wp_pages(),$scope.load_data_views()]).then(_=>{$siList.init(),$scope._status="ready"},_=>{$scope._status="ready"}).catch($err=>{$scope._status="ready"})}),$scope.$on("save-request",function(){$scope.save_configs()})},$scope.load_configs=function(){return $q(function($resolve,$reject){$scope.api("configs").then(function($response){if($scope.configs=$response,null==$scope.configs.default_view)return $scope.reset_configs(),void $resolve();if("undefined"!=typeof $scope.configs.default_view.id)$scope.configs.default_view=$scope.configs.default_view.id;if($scope.configs.default_view.indexOf('{"id":')>=0)$scope.configs.default_view=JSON.parse($scope.configs.default_view).id;$resolve()})})},$scope.reset_configs=function(){$scope.api("configs/reset",null,{method:"POST"}).then(function($response){$scope.configs=$response,$scope.show_toast("Configuration reset to demo mode")})},$scope.save_configs=function($silent){return $silent="undefined"==typeof $silent?false:$silent,$q(function($resolve,$reject){$scope.validateListConfigs().then(_=>{$scope.api("configs",{settings:$scope.configs}).then(function($response){if(!$silent)$scope.show_toast("Save completed");$resolve()})})})},$scope.validateListConfigs=function(){const lDefaultSearchTokenRenew=$scope.configs.lists.filter($l=>""==$l.search_token).map($l=>$q(($resolve,$reject)=>{$siUtils.renewListSearchToken($l).then($token=>{$l.search_token=$token,console.log("After token renew",$l),$resolve()})}));return $q.all(lDefaultSearchTokenRenew)},$scope.isInitializing=function(){return"initializing"==$scope._status},$scope.load_wp_pages=function(){return $q(function($resolve,$reject){$q.all([$scope.api("page/list",{locale:"fr",type:""},{method:"GET"}),$scope.api("page/list",{locale:"en",type:""},{method:"GET"})]).then($results=>{$scope.wp_pages.fr=$results[0],$scope.wp_pages.en=$results[1],$scope.loaded_components.push("file"),$resolve($scope.wp_pages)}).catch($err=>{console.error($err)})})},$scope.load_data_views=function(){return $q(function($resolve,$reject){$scope.api("account").then(function($response){if(null!=$response)$scope.data_views=$response.data_views,$scope.loaded_components.push("list"),$resolve($response.data_views);else $resolve()})})},$scope.signin=function(){$scope.portalApi("auth/login",$scope.login_infos).then($response=>{if([10,20].includes($response.statusCode))return void $scope.show_toast($response.message);$scope.credentials=$response,$scope.configs.account_id=null,$scope.configs.api_key=null;const lRegistrationSequence=[$scope.selectAccount,$scope.selectApiKey,$scope.selectDefaultView,$scope.setDisplayPages];lRegistrationSequence.reduce(($previous,$current)=>$previous.then(_=>$current()),Promise.resolve()).then($result=>{$scope.configs.registered=true,$scope.show_toast("Configuration completed"),$scope.save_configs().then(_=>{$scope.configuration_step=0,$scope.api_keys=null})})})},$scope.signout=function(){$scope.reset_configs()},$scope.selectAccount=function(){return $q(function($resolve,$reject){console.log("Account selection"),$scope.configuration_step+=1,$scope.portalApi("linked_account/list").then($response=>{$response.items.forEach($e=>{$e.clickHandler=function(){console.log("selected account",$e),$scope.portal_account_id=$e.id,$resolve()}}),$scope.accounts=$response})})},$scope.selectApiKey=function(){return $q(function($resolve,$reject){console.log("Api Key selection"),$scope.configuration_step+=1,$scope.portalApi("api_key/list").then($response=>{if(1==$response.items.length)$scope.configs.account_id=$response.items[0].accountId,$scope.configs.api_key=$response.items[0].id,$scope.save_configs(true).then(_=>{$resolve()});else $response.items.forEach($e=>{$e.clickHandler=function(){$scope.configs.account_id=$e.accountId,$scope.configs.api_key=$e.id,$scope.save_configs(true).then(_=>{$resolve()})}}),$scope.api_keys=$response})})},$scope.selectDefaultView=function(){return $q(function($resolve,$reject){console.log("Default view selection"),$scope.configuration_step+=1,$scope.load_data_views().then($views=>{if(console.log("views",$views),1==$views.length)$scope.configs.default_view=$views[0].id,$scope.updateListsView(),$resolve();else $views.forEach($e=>{$e.clickHandler=function(){$scope.configs.default_view=$e.id,$scope.updateListsView(),$resolve()}})})})},$scope.setDisplayPages=function(){return $scope.configuration_step+=1,$q(function($resolve,$reject){$scope.load_wp_pages().then($pages=>{$pages.fr.forEach($p=>{if(console.log($p.post_title),"propriétés"==$p.post_title.toLowerCase())$scope.default_page.listing=$p.ID;if("courtiers"==$p.post_title.toLowerCase())$scope.default_page.broker=$p.ID}),$scope.applyShortCodeHandler=function(){$q.all($scope.applyListingShortCode(),$scope.applyBrokerShortCode()).then($result=>{$resolve()})}})})},$scope.applyListingShortCode=function(){return $q(function($resolve,$reject){const params={page_id:$scope.default_page.listing,title:"Our Listings".translate(),content:'[si alias="listings"]'};$scope.api("page",params).then($result=>{$resolve()})})},$scope.applyBrokerShortCode=function(){return $q(function($resolve,$reject){const params={page_id:$scope.default_page.broker,title:"Our Teams".translate(),content:'[si alias="brokers"]'};$scope.api("page",params).then($result=>{$resolve()})})},$scope.updateListsView=function(){$scope.configs.lists.forEach($e=>{if(""==$e.source)$e.source=$scope.data_views.find($e=>$e.id==$scope.configs.default_view),$e.search_token=""}),console.log("config lists",$scope.configs.lists)},$scope.initListSearchToken=function(){let lFilters=null,lPromise=$q(function($resolve,$reject){if(null!=lFilters)$scope.api("",lFilters,{url:wpApiSettings.api_root+"/api/utils/search_encode"}).then(function($response){$resolve($response)});else $resolve("")});return lPromise},$scope.changeApiKey=function(){$siUI.getPortalCredentials().then($credentials=>{console.log($credentials),$scope.credentials=$credentials,$scope.portalApi("linked_account/list").then($response=>{const lPortalAccount=$response.items.find($e=>$e.account.id==$scope.configs.account_id);if(null!=lPortalAccount)$scope.portal_account_id=lPortalAccount.id,$scope.portalApi("api_key/list").then($response=>{if(1!=$response.items.length)$scope.api_keys=$response.items;else $siUI.show_toast("There's only one API key for this account")})})})},$scope.show_page=function($page_id,$params){console.log("page is called",$page_id);let lPromise=$q(function($resolve,$reject){$rootScope.$broadcast("on-"+$page_id,$params,function($result){$resolve($result)})});return lPromise},$scope.confirm=function($title,$message,$options){return $siUI.confirm($title,$message,$options)},$scope.show_toast=function($message){$siUI.show_toast($message)},$scope.dialog=function($dialog_id,$params){return $siUI.dialog($dialog_id,$params)},$scope.api=function($path,$data,$options){return $siApi.rest($path,$data,$options)},$scope.portalApi=function($path,$data,$options){const lOptions=Object.assign({method:"POST"},$options);if(lOptions.url="https://portal-api.source.immo/api/"+$path,null!=$data)if("POST"==lOptions.method)lOptions.data=$data;else lOptions.params=$path;if(null!=$scope.credentials){if(!lOptions.params)lOptions.params={};if(lOptions.params.at=$scope.credentials.authTokenKey,null!=$scope.portal_account_id)lOptions.params.la=$scope.portal_account_id}return $q(($resolve,$reject)=>{$http(lOptions).then($response=>{if(200==$response.status)$resolve($response.data)}).catch($err=>{console.log($path,"call failed",$err)})})},$scope.copy=function($data){let lContent="";if(null!==$data&&"object"===typeof $data)lContent=JSON.stringify($data);else lContent=$data;let lTextarea=document.createElement("textarea");lTextarea.textContent=lContent,lTextarea.style.position="fixed",document.body.appendChild(lTextarea),lTextarea.select();try{$scope.show_toast("Copied to clipboard"),document.execCommand("copy")}catch(ex){return console.warn("Copy to clipboard failed.",ex),false}finally{document.body.removeChild(lTextarea)}},$scope.isSame=function($objA,$objB){if(null!=$objA&&null!=$objB){for(const key in $objA)if("$$hashKey"!=key)if(0!=key.indexOf("$$"))if(null!=$objA[key]&&null!=$objB[key])if("undefined"!=typeof $objA[key]&&"undefined"!=typeof $objB[key]){if("function"==typeof $objA[key].push){if($objA[key].length!=$objB[key].length)return false;else for(let i=0;i<$objA[key].length;i++)if(!$scope.isSame($objA[key][i],$objB[key][i]))return false}else if("object"==typeof $objA[key]){if(!$scope.isSame($objA[key],$objB[key]))return false}else if($objA[key]!=$objB[key])return false}else return false;else if(null!=$objA[key]||null!=$objB[key])return false}else if(null==$objA||null==$objB)return false;return true}}),siApp.controller("signinCtrl",function signinCtrl($scope,$rootScope,$mdDialog,$siUI){BaseDialogController("signin",$scope,$rootScope,$mdDialog),$scope.login_infos={email:"",password:""},$scope.title="Please signin",$scope.actions=[{label:"Submit",action:_=>{$scope.login()}}],$scope.login=function(){$scope.portalApi("auth/login",$scope.login_infos).then($response=>{if(200==$response.statusCode)$scope.return($response);else $siUI.show_toast($response.message.translate())})}}),siApp.directive("siRouteBox",function siRouteBox($siUtils,$siList,$siUI){return{restrict:"E",scope:{route:"=",removeHandler:"&onRemove",list:"=",type:"@",changeHandler:"&siChange"},templateUrl:wpApiSettings.base_path+"/views/ang-templates/si-route-box.html",replace:true,link:function($scope,$elm,$attr){$scope.init()},controller:function($scope){$scope.lang_codes={fr:"Français",en:"English",es:"Español"},$scope.route_listing_elements={"{{item.ref_number}}":"ID","{{item.transaction}}":"Transaction type","{{item.location.region}}":"Region","{{item.location.city}}":"City","{{item.location.street}}":"Street","{{item.location.civic_address}}":"Address"},$scope.route_broker_elements={"{{item.ref_number}}":"ID","{{item.first_name}}":"First name","{{item.last_name}}":"Last name"},$scope.route_city_elements={"{{item.ref_number}}":"ID","{{item.location.region}}":"Region","{{item.name}}":"Name"},$scope.route_default={listing:{fr:"proprietes/{{item.location.region}}/{{item.location.city}}/{{item.transaction}}/{{item.ref_number}}",en:"listings/{{item.location.region}}/{{item.location.city}}/{{item.transaction}}/{{item.ref_number}}",es:"casas/{{item.location.region}}/{{item.location.city}}/{{item.transaction}}/{{item.ref_number}}"},broker:{fr:"courtiers/{{item.first_name}}-{{item.last_name}}/{{item.ref_number}}",en:"brokers/{{item.first_name}}-{{item.last_name}}/{{item.ref_number}}",es:"agentes/{{item.first_name}}-{{item.last_name}}/{{item.ref_number}}"},city:{fr:"villes/{{item.location.region}}/{{item.name}}/{{item.ref_number}}",en:"cities/{{item.location.region}}/{{item.name}}/{{item.ref_number}}",es:"ciudades/{{item.location.region}}/{{item.name}}/{{item.ref_number}}"}},$scope.route_elements={},$scope.init=function(){$scope.route_elements=$scope["route_"+$scope.type+"_elements"]},$scope.hasMinRouteCount=function(){if(null==$scope.list||void 0==$scope.list)return true;if($scope.list.length<=1)return true;else return false},$scope.langIsUsed=function($lang){if(null==$scope.list||void 0==$scope.list)return true;else return $scope.list.some($e=>$e.lang==$lang)},$scope.elementIsUsed=function($elm){if(""==$scope.route.route)return false;else return $scope.route.route.indexOf($elm)>=0},$scope.elementUseCount=function(){let lResult=0;if(null==$scope.route_elements||void 0==$scope.route_elements)return 0;let lRouteElms=$siUtils.toKeyArray($scope.route_elements);return lRouteElms.forEach(function($e){if($scope.route.route.indexOf($e)>=0)lResult++}),lResult},$scope.reset=function(){$scope.route.route=$scope.route_default[$scope.type][$scope.route.lang]},$scope.elementAvailable=function(){if(null==$scope.route_elements||void 0==$scope.route_elements)return 0;let lRouteElms=$siUtils.toKeyArray($scope.route_elements),lResult=lRouteElms.length-$scope.elementUseCount();return lResult},$scope.remove=function(){let fnRemove=function(){$scope.list.forEach(function($e,$i){if($e!=$scope.route);else $scope.list.splice($i,1)})};if(""==$scope.route.route)fnRemove();else $siUI.confirm("Are you sure you want to remove this route?").then(function(){fnRemove()})},$scope.update=function(){if("function"==typeof $scope.changeHandler)$scope.changeHandler({route:$scope.route})},$scope.addRouteElement=function($key){$scope.route.route+=$key}}}}),siApp.directive("siFilterGroup",function siFilterGroup(){let dir_controller=function($scope,$rootScope){$scope.filter_group_operators={and:"And",or:"Or"},$scope.$watch("model",function(){$scope.init()}),$scope.init=function(){console.log("filter_group model",$scope.model,$scope.parent)},$scope.addFilterGroup=function(){if(null==$scope.model.filter_groups)$scope.model.filter_groups=[];$scope.model.filter_groups.push({filters:null,operator:"and"})},$scope.removeGroup=function(){$scope.removeFromList($scope.model,$scope.parent,"filter_groups")},$scope.removeFromList=function($item,$parent,$name){let lNewList=[];if($list=$parent[$name],$list.forEach(function($elm){if(JSON.stringify($elm)!=JSON.stringify($item))lNewList.push($elm)}),0==lNewList.length)lNewList=null;$parent[$name]=lNewList},$scope.addFilter=function($group){if(null==$scope.model.filters)$scope.model.filters=[];$scope.model.filters.push({field:"",operator:"Equal",value:""})},$scope.switchOperator=function($newOperator){$scope.model.operator=$newOperator}};return{restrict:"E",scope:{model:"=ngModel",parent:"=ngParent"},controllerAs:"ctrl",template:'<div ng-include="\'filter-group\'" class="si-filter-group group-operator-{{model.operator}}"></div>',controller:dir_controller}}),siApp.directive("siFilterItem",function siFilterItem($siUtils,$siList){return{restrict:"E",scope:{filter:"=ngModel",removeHandler:"&onRemove"},templateUrl:wpApiSettings.base_path+"/views/ang-templates/si-filter-item.html",replace:true,link:function($scope,$elm,$attr){$scope.init()},controller:function($scope){$scope.value_choices=[],$scope.selected_key="price.sell.amount",$scope.selected_filter_key=null,$scope.filter_key_list=[{value:"price.sell.amount",label:"Selling price",value_type:"number",op_out:["like","not_like"]},{value:"price.lease.amount",label:"Leasing price",value_type:"number",op_out:["like","not_like"]},{value:"location.country_code",label:"Country",value_type:"list",choices:"getCountryList",op_in:["in","not_in"]},{value:"location.state_code",label:"State/Province",value_type:"list",choices:"getStateList",op_in:["in","not_in"]},{value:"location.region_code",label:"Region",value_type:"list",choices:"getRegionList",op_in:["in","not_in"]},{value:"location.city_code",label:"City",value_type:"list",choices:"getCityList",op_in:["in","not_in"]},{value:"category_code",label:"Category",value_type:"list",choices:"getCategoryList",op_in:["in","not_in"]},{value:"subcategory_code",label:"Subcategory",value_type:"list",choices:"getSubcategoryList",op_in:["in","not_in"]},{value:"open_houses[0].end_date",label:"Open house date",value_type:"text",choices:"udf.now():Now"},{value:"main_unit.bedroom_count",label:"Bedroom count",value_type:"number",op_out:["like","not_like"]},{value:"main_unit.bathroom_count",label:"Bathroom count",value_type:"number",op_out:["like","not_like"]},{value:"attributes.PARKING",label:"Parking count",value_type:"number",op_out:["like","not_like"]},{value:"attributes.GARAGE",label:"Garage",value_type:"bool",op_in:["equal","not_equal"]},{value:"attributes.POOL",label:"Pool",value_type:"bool",op_in:["equal","not_equal"]},{value:"status_code",label:"Status",value_type:"list",choices:"SOLD:Sold|AVAILABLE:Available",op_in:["in","not_in"]}],$scope.filter_operators=[{key:"equal",value:"Equal to"},{key:"not_equal",value:"Different of"},{key:"less_than",value:"Less than"},{key:"less_or_equal_to",value:"Less or equals to"},{key:"greater_than",value:"Greater than"},{key:"greater_or_equal_to",value:"Greater or equals to"},{key:"in",value:"One of"},{key:"not_in",value:"Not one of"},{key:"like",value:"Contains"},{key:"not_like",value:"Does not contains"}],$scope.init=function(){$scope.selected_key=$scope.filter.field,$scope.selected_filter_key=$scope.filter_key_list.find($e=>$e.value==$scope.selected_key),$scope.updateFilterChoices()},$scope.remove=function(){if(void 0!=$scope.removeHandler)$scope.removeHandler()},$scope.filterFieldChanged=function(){$scope.filter.field=$scope.selected_key,$scope.value_choices=[],$scope.filter.value="",$scope.selected_filter_key=$scope.filter_key_list.find($e=>$e.value==$scope.selected_key),$scope.updateFilterChoices()},$scope.updateFilterChoices=function(){if("list"==$scope.selected_filter_key.value_type)if(console.log("list from ",$scope.selected_filter_key.choices),"function"==typeof $siList[$scope.selected_filter_key.choices])console.log($scope.selected_filter_key.choices,"found"),$scope.value_choices=$siList[$scope.selected_filter_key.choices](),console.log($scope.selected_filter_key.choices,$scope.value_choices);else $scope.value_choices=$siUtils.stringToOptionList($scope.selected_filter_key.choices)},$scope.formatFilterValueList=function(){if(null!=$scope.filter.value)if("function"==typeof $scope.filter.value.push)if(1==$scope.filter.value.length)return"1 item selected".translate();else return"{0} items selected".translate().format($scope.filter.value.length);return $scope.filter.value},$scope.operatorFilterByField=function($item){if(null==$item)return false;if(void 0!=$scope.selected_key.op_in)return $scope.selected_key.op_in.indexOf($item.key)>=0;else if(void 0!=$scope.selected_key.op_out)return!($scope.selected_key.op_out.indexOf($item.key)>=0);return true}}}}),siApp.directive("siSvg",["$parse","$compile",function siSvg($parse,$compile){return{restrict:"E",scope:{src:"@"},link:function($scope,$element,$attrs){if(""!=$element.html())$scope.src=$element.html(),$element.html("");$scope.init($element)},controller:function($scope){$scope.elm=null,$scope.init=function($element){$scope.elm=$element},$scope.$watch("src",function($new,$old){if(null!=$new)if(null!=$old)$scope.render()}),$scope.render=function(){const lTemplate='<ng-include src="getSvgPath()"></ng-include>';let elementContent=$compile(lTemplate)($scope);$scope.elm.append(elementContent)},$scope.getSvgPath=function(){let lPath=$scope.src;if(0==lPath.indexOf("~"))lPath=lPath.replace("~",wpApiSettings.base_path);return lPath}}}}]),siApp.directive("faIcon",["$parse","$compile",function faIcon($parse,$compile){return{restrict:"E",replace:true,scope:{icon:"@",iconStyle:"@?",size:"@",useSvg:"@"},link:function($scope,$element,$attrs){if(!$attrs.iconStyle)$scope.iconStyle="fal";if(!$attrs.size)$scope.size="1x";if("string"==typeof $attrs.icon&&$attrs.icon.indexOf("[")>=0){let lIconParse=$parse($attrs.icon);$scope.icon=lIconParse($scope)}else if(""!=$element.html())$scope.icon=$element.html(),$element.html("");$scope.init($element)},controller:function($scope){$scope.elm=null,$scope.init=function($element){$scope.elm=$element},$scope.$watch("icon",function($new,$old){if(null!=$new)if(null!=$old){if("string"==typeof $new&&$new.indexOf("[")>=0){let lIconParse=$parse($new);$scope.icon=lIconParse($scope)}$scope.render()}}),$scope.resetElement=function(){let lElm=$scope.elm[0],lClassToRemove=[];for(let i=0;i<lElm.classList.length;i++)if(lElm.classList.item(i).indexOf("fa-")>=0)lClassToRemove.push(lElm.classList.item(i));lElm.classList.remove.apply(lElm.classList,lClassToRemove),$scope.elm.html("")},$scope.render=function(){let lTemplate="";if($scope.resetElement(),$scope.useSvg){lTemplate='<ng-include src="getIconPath()"></ng-include>';let elementContent=$compile(lTemplate)($scope);$scope.elm.append(elementContent)}else if(Array.isArray($scope.icon))$scope.elm.addClass("fa-stack"),$scope.icon.forEach(function($e,$i){lTemplate='<i class="fal fa-'+$e+' fa-stack-1x"></i>',$scope.elm.append(lTemplate)});else $scope.elm.clearClass,$scope.elm.addClass($scope.iconStyle),$scope.elm.addClass("fa-"+$scope.icon),$scope.elm.addClass("fa-"+$scope.size)}}}}]),siApp.directive("siOnEnter",["$parse",function siOnEnter($parse){return{restrict:"A",link:function($scope,$element,$attr){$element.on("keyup",function($event){if(13==$event.keyCode){const lHandler=$parse($attr.siOnEnter);lHandler($scope,{$event:$event})}})}}}]),siApp.factory("$siUtils",["$siApi","$q",function $siUtils($siApi,$q){let $scope={stringToOptionList:function($source){if(null==$source||void 0==$source)return null;if($source.indexOf("|")<0)return[$source];let lKeyValues=$source.split("|"),lResult=[];return lKeyValues.forEach(function($e){let lItemArr=$e.split(":"),lItem={key:lItemArr[0],label:lItemArr.length>1?lItemArr[1]:lItemArr[0]};lResult.push(lItem)}),lResult},toArray:function($source){let lResult=[];for($key in $source)if("function"!=typeof $source[$key])lResult.push($source[$key]);return lResult},toKeyArray:function($source){let lResult=[];for($key in $source)if("function"!=typeof $source[$key])lResult.push($key);return lResult},toKeyValueArray:function($source){let lResult=[];for($key in $source)if("function"!=typeof $source[$key])lResult.push({key:$key,value:$source[$key]});return lResult},renewListSearchToken:function($list){let lFilters=$scope.buildListFilter($list);return $q(function($resolve,$reject){if(null!=lFilters)$siApi.call("",lFilters,{url:wpApiSettings.api_root+"/api/utils/search_encode"}).then(function($response){$resolve($response)});else $resolve("")})},buildListFilter:function($list){let lResult=null;if($list.limit>0)lResult={max_item_count:$list.limit};if(""!=$list.sort&&"auto"!=$list.sort){if(null==lResult)lResult={};lResult.sort_fields=[{field:$list.sort,desc:$list.sort_reverse}]}if($list.shuffle){if(null==lResult)lResult={};lResult.shuffle=$list.shuffle}if(null!=$list.filter_group){if(null==lResult)lResult={};lResult.filter_group=$scope.normalizeFilterGroup(angular.copy($list.filter_group))}return lResult},normalizeFilterGroup:function($filter_group){if($filter_group.filters)$filter_group.filters.forEach(function($filter){if(["in","not_in"].indexOf($filter.operator)>=0){if("undefined"==typeof $filter.value.push)$filter.value=$filter.value.split(","),$filter.value.forEach(function($val){if(!isNaN($val))$val=Number($val)})}else if(!isNaN($filter.value))$filter.value=Number($filter.value)})
;if($filter_group.filter_groups)$filter_group.filter_groups.forEach(function($group){$scope.normalizeFilterGroup($group)});return $filter_group}};return $scope}]),siApp.factory("$siList",["$siApi",function $siList($siApi){let $scope={dictionary:null,init:function($view_id){$scope.fetchDictionary($view_id)},fetchDictionary:function($view_id){if(null!=$view_id)$siApi.rest("dictionary").then(function($response){$scope.dictionary=$response})},getCountryList:function(){if(console.log($scope.dictionary),null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.country)},getStateList:function(){if(console.log($scope.dictionary),null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.state)},getRegionList:function(){if(console.log($scope.dictionary),null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.region)},getCityList:function(){if(console.log($scope.dictionary),null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.city)},getCategoryList:function(){if(console.log($scope.dictionary),null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.listing_category)},getSubcategoryList:function(){if(console.log($scope.dictionary),null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.listing_subcategory)},getBuildingCategoryList:function(){if(console.log($scope.dictionary),null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.building_category)},toArray:function($source){let lResult=[];for($key in $source)lResult.push({key:$key,label:$source[$key].caption});return console.log("toArray:",lResult),lResult}};return $scope}]),siApp.factory("$siApi",["$http","$q",function $siApi($http,$q){return $scope={},$scope.rest=function($path,$data,$options){if($options=angular.merge({url:wpApiSettings.root+"si-rest/"+$path,method:"undefined"==typeof $data?"GET":"POST",headers:{"X-WP-Nonce":wpApiSettings.nonce}},$options),"GET"==$options.method)$options.params=$data;else $options.data=$data;let lPromise=$q(function($resolve,$reject){$http($options).then(function success($result){if("200"==$result.status)$resolve($result.data);else $reject(null)},function fail($error){console.log("Fail on path",$path,"with data",$data,$error),$scope.show_toast($error)})});return lPromise},$scope.call=function($path,$data,$options){if($path="function"==typeof $path.push?$path.join("/"):$path,$options=angular.merge({url:wpApiSettings.api_root+"/api/"+$path,method:"undefined"==typeof $data?"GET":"POST"},$options),"GET"==$options.method)$options.params=$data;else $options.data=$data;let lPromise=$q(function($resolve,$reject){$http($options).then(function onSuccess($response){if("200"==$response.status)$resolve($response.data);else $reject(null)},function onFail($error){console.log("Fail on path",$path,"with data",$data,$error),$reject($error)})});return lPromise},$scope}]),siApp.factory("$siUI",["$mdDialog","$mdToast","$q","$rootScope",function $siUI($mdDialog,$mdToast,$q,$rootScope){return $scope={},$scope.confirm=function($title,$message,$options){$message="undefined"==typeof $message?"":$message,$options=angular.merge({ev:null,ok:"OK",cancel:"Cancel"},$options);var confirm=$mdDialog.confirm().title($title.translate()).textContent($message.translate()).targetEvent($options.ev).ok($options.ok.translate()).cancel($options.cancel.translate());return confirm._options.parent=angular.element(document.body),$mdDialog.show(confirm)},$scope.show_toast=function($message){try{$mdToast.show($mdToast.simple().textContent($message.translate()).position("top right").hideDelay(3e3))}catch($ex){console.log($ex),console.log($message)}},$scope.dialog=function($dialog_id,$params){let lPromise=$q(function($resolve,$reject){$rootScope.$broadcast("on-"+$dialog_id,$params,function($result){$resolve($result)})});return lPromise},$scope.getPortalCredentials=function(){return $q(($resolve,$reject)=>{$scope.dialog("signin").then($credentials=>{$resolve($credentials)},_=>{$reject()})})},$scope}]),siApp.filter("isIn",function(){return function($needle,$stack){if(null==$needle||void 0==$needle)return false;else return $stack.indexOf($needle)>=0}}),siApp.filter("truncate",function(){return function($source,$limit){let lResult=$source;if(lResult)if(lResult.length>$limit)lResult=lResult.substr(0,$limit/2)+"..."+lResult.substr(lResult.length-$limit/2);return lResult}});