function BaseDialogController($scope,$mdDialog,$rootScope){return $scope.actions=[{label:"OK",action:function(){$scope.cancel()}}],$scope.cancel=function(){$mdDialog.cancel()},$scope.closeAndReturn=function($result){$mdDialog.hide($result)},$scope}function BaseListItemEditController($scope,$rootScope){$scope.layoutList=[],$scope.availVars=[],$scope.base={init:function($params){if($scope.model=Object.assign($scope.model,$params),$scope.layoutList=$rootScope.global_list.list_item_layouts[$scope.model.type],$scope.availVars=$rootScope.global_list.list_item_vars[$scope.model.type],$scope.imageHoverEffects=$rootScope.global_list.list_item_image_hover_effects[$scope.model.type],$scope.layerHoverEffects=$rootScope.global_list.list_item_show_layer_effects[$scope.model.type],Array.isArray($scope.model.list_item_layout.displayed_vars))delete $scope.model.list_item_layout.displayed_vars;if(void 0==$scope.model.list_item_layout.image_hover_effect)$scope.model.list_item_layout.image_hover_effect="none";if(void 0==$scope.model.list_item_layout.secondary_layer_effect)$scope.model.list_item_layout.secondary_layer_effect="none";if(void 0==$scope.model.list_item_layout.displayed_vars)$scope.model.list_item_layout.displayed_vars={main:$scope.availVars,secondary:[]}}},$scope.actions=[{label:"OK",action:function(){$scope.closeAndReturn($scope.model)}}],$scope.varIsChecked=function($item,$layer="main"){if(void 0==$scope.model.list_item_layout.displayed_vars[$layer])return false;else return $scope.model.list_item_layout.displayed_vars[$layer].includes($item)},$scope.varToggle=function($item,$layer="main"){if(void 0==$scope.model.list_item_layout.displayed_vars[$layer])$scope.model.list_item_layout.displayed_vars[$layer]=[];if($scope.model.list_item_layout.displayed_vars[$layer].includes($item))$scope.model.list_item_layout.displayed_vars[$layer]=$scope.model.list_item_layout.displayed_vars[$layer].filter($v=>$v!=$item);else $scope.model.list_item_layout.displayed_vars[$layer].push($item)},$scope.updateStyles=function($styles){$scope.model.list_item_layout.styles=$styles}}function BasePageController($pageId,$scope,$rootScope){return $scope.pageId=$pageId,$scope.callback=null,$scope.actions=[{label:"OK",action:function(){$scope.cancel()}}],$scope._pageInit_=function(){console.log("pageInit for",$scope.pageId,"called"),$scope.$on("on-"+$scope.pageId,function($event,$params,$callback){if(console.log("instance of page",$scope.pageId,"called with",$params),"function"==typeof $scope.init)$scope.init($params);$scope.open_page($scope.pageId),$scope.callback=$callback})},$scope.cancel=function(){$scope.close_page()},$scope.return=function($result){$scope.callback($result),$scope.close_page()},$scope.open_page=function($page_id){$rootScope.current_page=$page_id},$scope.close_page=function(){$rootScope.current_page="home"},$scope}var siApp=angular.module("siApplication",["ngRoute","ngMaterial","ngMessages","mdColorPicker","ngSanitize","ng-sortable"]);siApp.config(function($routeProvider,$mdThemingProvider,$httpProvider,$mdAriaProvider){$mdAriaProvider.disableWarnings(),$mdThemingProvider.theme("default").primaryPalette("blue").accentPalette("deep-orange"),$mdThemingProvider.theme("docs-dark","default").primaryPalette("blue").dark()}),siApp.controller("homeCtrl",function($scope,$rootScope,$timeout,$siConfigs){console.log("configs controller loaded"),$scope.route_listing_elements={"{{item.ref_number}}":"ID","{{item.transaction}}":"Transaction type","{{item.location.region}}":"Region","{{item.location.city}}":"City","{{item.location.street}}":"Street","{{item.location.civic_address}}":"Civic address"},$scope.route_broker_elements={"{{item.ref_number}}":"ID","{{item.first_name}}":"First name","{{item.last_name}}":"Last name"},$scope.route_office_elements={"{{item.ref_number}}":"ID","{{item.name}}":"Name","{{item.agency.name}}":"Agency name"},$scope.route_agency_elements={"{{item.ref_number}}":"ID","{{item.name}}":"Name"},$scope.route_city_elements={"{{item.code}}":"ID","{{item.location.region}}":"Region","{{item.name}}":"Name"},$scope._pageInit_=function(){$scope.show("general")},$scope.addRouteElement=function($item,$elm){$item.route+=$elm},$scope.addRoute=function($list,$lang){let lLocale=$lang;if(!$list.some(function($e){return $e.lang==$lang}))$list.push({lang:lLocale,route:""})},$scope.removeRoute=function($index,$list_name){$scope.configs[$list_name].splice($index,1)},$scope.addLayout=function($list,$lang){if(!$list.some(function($e){return $e.lang==$lang}))$list.push({lang:$lang,page:null,communication_mode:"basic"}),$scope.save_configs()},$scope.removeLayout=function($index,$list){$timeout(_=>{$list.splice($index,1),$scope.save_configs()})},$scope.hasMinRouteCount=function($list){return 1==$list.length},$scope.hasMaxRouteCount=function($list){let lResult=true;if($list)for(let $key in $scope.wp_languages)if($list.map(function(e){return e.lang}).indexOf($key)<0)lResult=false;return lResult},$scope.clearAccessToken=function(){$scope.api("access_token",null,{method:"PATCH"}).then(function($response){$scope.show_toast("Access token cleared")})},$scope.show=function($panel_id){const lAdminPanel=document.querySelector("#si-admin-configs"),lNavButtons=Array.from(lAdminPanel.querySelectorAll(".nav-button")),lSections=Array.from(lAdminPanel.querySelectorAll(".sections section")),lButton=lAdminPanel.querySelector(".nav-button."+$panel_id),lTarget=lAdminPanel.querySelector("#"+$panel_id);$scope.panelChanged($panel_id),lNavButtons.forEach($e=>$e.classList.remove("selected")),lSections.forEach($e=>$e.classList.remove("selected")),lTarget.classList.add("selected"),lButton.classList.add("selected")},$scope.panelChanged=function($panel_id){if(panelChangeAction={advanced:_=>{$scope.load_wp_menus()}},void 0!=panelChangeAction[$panel_id])panelChangeAction[$panel_id]()}}),siApp.controller("listCollectionCtrl",function($scope,$rootScope,$siConfigs){$scope.init=function(){}}),siApp.controller("mainCtrl",function($scope,$rootScope,$mdDialog,$q,$http,$mdToast,$timeout,$siApi,$siList,$siUI,$siUtils,$siUser,$siConfigs,$siWP){$scope._status="initializing",$scope.loaded_components=[],$scope.wpSiApiSettings=wpSiApiSettings,$scope.notices=[],$scope.user=$siUser,$scope.configs={},$scope.lang_codes={fr:"Français",en:"English",es:"Español"},$scope.wp_languages=null,$rootScope.global_list={sources:[],list_types:[{key:"listings",label:"Listings"},{key:"brokers",label:"Brokers"},{key:"cities",label:"Cities"},{key:"offices",label:"Offices"},{key:"agencies",label:"Agencies"}],list_layouts:{listings:[{name:"standard",label:"Client side (default)"},{name:"direct",label:"Server side (no search tool)"}],brokers:[{name:"standard",label:"Client side (default)"},{name:"direct",label:"Server side (no search tool)"}],cities:[{name:"direct",label:"Server side (no search tool)"}],offices:[{name:"standard",label:"Client side (default)"},{name:"direct",label:"Server side (no search tool)"}],agencies:[{name:"standard",label:"Client side (default)"},{name:"direct",label:"Server side (no search tool)"}]},list_item_layouts:{listings:[{name:"standard",label:"Standard",vars:["address","city","photo","price","category","subcategory","rooms","flags","open_houses"]},{name:"double-layer",label:"Double Layers (advanced)"}],brokers:[{name:"standard",label:"Standard",vars:["photo","fullname","title","phone"]},{name:"double-layer",label:"Double Layers (advanced)"}],cities:[{name:"standard",label:"Standard",vars:["name","listing_count"]}],offices:[{name:"standard",label:"Standard",vars:["name","agency_name","phone","listing_count"]}],agencies:[{name:"standard",label:"Standard",vars:["name","license","phone"]}]},list_item_vars:{listings:[{name:"photo",label:"Photo"},{name:"ref_number",label:"Ref. number"},{name:"price",label:"Price"},{name:"address",label:"Address"},{name:"city",label:"City"},{name:"description",label:"Description"},{name:"category",label:"Category"},{name:"subcategory",label:"Subcategory"},{name:"rooms",label:"Rooms"},{name:"region",label:"Region"},{name:"available_area",label:"Available area"},{name:"flags",label:"Flags"},{name:"tags",label:"Tags"},{name:"open_houses",label:"Open houses"}],brokers:[{name:"photo",label:"Photo"},{name:"ref_number",label:"Ref. number"},{name:"fullname",label:"Fullname"},{name:"company_name",label:"Company name"},{name:"agency_name",label:"Agency name"},{name:"agency_license",label:"Agency license"},{name:"first_name",label:"First name"},{name:"last_name",label:"Last name"},{name:"title",label:"Title"},{name:"phone",label:"Phone"},{name:"description",label:"Description"},{name:"phones",label:"Phone list"},{name:"email",label:"Email"},{name:"address",label:"Office address"},{name:"contacts",label:"Contacts"},{name:"counters",label:"Listings"}],cities:[{name:"name",label:"Name"},{name:"namex",label:"Name (extracted)"},{name:"region",label:"Region"},{name:"counters",label:"Listings"},{name:"code",label:"Code"}],offices:[{name:"name",label:"Name"},{name:"agency-name",label:"Agency name"},{name:"counters",label:"Counters"},{name:"address",label:"Address"},{name:"phone",label:"Phone"},{name:"email",label:"Email"},{name:"contacts",label:"Contacts"},{name:"code",label:"Code"}],agencies:[{name:"name",label:"Name"},{name:"counters",label:"Counters"},{name:"address",label:"Address"},{name:"phone",label:"Phone"},{name:"email",label:"Email"},{name:"contacts",label:"Contacts"},{name:"license",label:"License"}]},list_item_image_hover_effects:{listings:[{name:"none",label:"None"},{name:"zoom",label:"Zoom"},{name:"gallery",label:"Gallery"}],brokers:[{name:"none",label:"None"},{name:"zoom",label:"Zoom"}],cities:[],offices:[],agencies:[]},list_item_show_layer_effects:{listings:[{name:"none",label:"None"},{name:"slide",label:"Slide"},{name:"flip",label:"Flip"},{name:"fade",label:"Fade"},{name:"tilt",label:"Tilt"}],brokers:[{name:"none",label:"None"},{name:"slide",label:"Slide"},{name:"flip",label:"Flip"},{name:"fade",label:"Fade"},{name:"tilt",label:"Tilt"}],cities:[{name:"none",label:"None"},{name:"slide",label:"Slide"},{name:"flip",label:"Flip"},{name:"fade",label:"Fade"},{name:"tilt",label:"Tilt"}],offices:[{name:"none",label:"None"},{name:"slide",label:"Slide"},{name:"flip",label:"Flip"},{name:"fade",label:"Fade"},{name:"tilt",label:"Tilt"}],agencies:[{name:"none",label:"None"},{name:"slide",label:"Slide"},{name:"flip",label:"Flip"},{name:"fade",label:"Fade"},{name:"tilt",label:"Tilt"}]},list_item_layer_positions:{listings:[{name:"fix",label:"Fix"},{name:"overlay",label:"Overlay"}],brokers:[{name:"fix",label:"Fix"},{name:"overlay",label:"Overlay"}],cities:[{name:"fix",label:"Fix"},{name:"overlay",label:"Overlay"}],offices:[{name:"fix",label:"Fix"},{name:"overlay",label:"Overlay"}],agencies:[{name:"fix",label:"Fix"},{name:"overlay",label:"Overlay"}]},detail_layouts:[{name:"standard",label:"Standard"},{name:"custom_page",label:"Custom layout from page"}],list_ordering_field:{listings:[{name:"contract_start_date",label:"Inscription date"},{name:"price",label:"Price"}],brokers:[{name:"name",label:"Name"},{name:"listing_count",label:"Number of listings"}],cities:[{name:"name",label:"Name"},{name:"region",label:"Region"}],offices:[{name:"name",label:"Name"},{name:"agency.name",label:"Agency name"},{name:"region",label:"Region"}],agencies:[{name:"name",label:"Name"}]},styles:{container_width:"1170px",font_name:"inherit",highlight:"#ff9900",highlight_text_color:"#333",text_color:"#333",background_color:"#fff",input_placeholder_color:"rgba(#333,0.5)",layout_gutter:"20px",padding:"20px",border_width:"1px",border_style:"solid",border_color:"#aaa",border_radius:"0px",list_item_separator_color:"#aaa",list_item_separator:"solid 1px [list_item_separator_color]",list_item_padding:"10px",high_contrast_color:"#333",high_contrast_text_color:"#fff",medium_contrast_color:"#b9b9b9",medium_contrast_text_color:"[text_color]",small_contrast_color:"#e2e2e2",small_contrast_text_color:"[text_color]",error_color:"#850000",button_border_color:"#aaa",button_border_style:"none",button_border_width:"1px",button_border_radius:"0",button_bg_color:"#333",button_text_color:"#fff",button_font_name:"[font_name]",button_hover_bg_color:"#ff9900",button_hover_text_color:"#333",button_alt_bg_color:"#777",button_alt_text_color:"#fff",button_alt_hover_bg_color:"#9d9d9d",button_alt_hover_text_color:"#fff",uls_label:"ULS: ",listing_item_sold_bg_color:"#ff8800",listing_item_sold_text_color:"#fff",listing_item_picture_ratio:"3 / 2",thumbnail_picture_size:"100px",broker_item_picture_ratio:"3.2 / 4"}},$scope.registration_steps=[{name:"Linked account"},{name:"API key"},{name:"Data feed(s)"},{name:"Integration"}],$rootScope.current_page="home",$scope.pages={home:{label:"Home".translate(),style:""},listEdit:{label:"List editing".translate(),style:"transform:translateX(-100%);"}},$scope.configuration_step=0,$scope.credentials=null,$scope.data_views=[],$scope.wp_pages=[],$scope.login_infos={email:"",password:""},$scope.api_keys=null,$scope.page_languages=[],$scope.languages={fr:"Français",en:"English",es:"Español"},$scope.message=null,$scope.default_page={fr:{listing:"NEW",listing_details:"NEW",broker:"NEW",broker_details:"NEW",city:"NONE",city_details:"NONE",office:"NONE",office_details:"NONE",agency:"NONE",agency_details:"NONE"},en:{listing:"NEW",listing_details:"NEW",broker:"NEW",broker_details:"NEW",city:"NONE",city_details:"NONE",office:"NONE",office_details:"NONE",agency:"NONE",agency_details:"NONE"}},$scope.init=function(){$scope.load_configs().then(_=>{$q.all([$scope.load_data_views(),$scope.load_dictionary(),$scope.load_addons()]).then(_=>{if($scope._status="ready",false!=$scope.configs.registered)$rootScope.$broadcast("si/ready"),$scope.checkIntegrity();else $scope.startRegistration()},_=>{$scope._status="ready",$rootScope.$broadcast("si/ready")}).then(_=>{$scope.$on("save-request",function(){console.log("save-request/received"),$scope.save_configs()}),$scope.$on("reload-pages",function(){}),$scope.getWhatNew()}).catch($err=>{console.log("An error occured on loading data",$err),$scope._status="ready",$rootScope.$broadcast("si/ready")})})},$scope.load_configs=function(){return $q(function($resolve,$reject){$siConfigs.load().then(function($response){if($scope.configs=$response,null==$scope.configs.default_view)return $scope.reset_configs(),void $resolve();if("undefined"!=typeof $scope.configs.default_view.id)$scope.configs.default_view=$scope.configs.default_view.id;if($scope.configs.default_view.indexOf('{"id":')>=0)$scope.configs.default_view=JSON.parse($scope.configs.default_view).id;$resolve()})})},$scope.load_addons=function(){$scope.api("addons/list",null,{method:"GET"}).then(function($response){$scope.loaded_components.push("cogs"),$scope.addons=$response})},$scope.load_wp_forms=function(){$scope.api("form/list",null,{method:"GET"}).then(function($response){$scope.loaded_components.push("clipboard-check"),$scope.formList=$response})},$scope.load_dictionary=function(){$scope.api("dictionary",{lang:$locales._current_lang_},{method:"GET"}).then(function($response){$scope.loaded_components.push("book"),$siList.dictionary=$response})},$scope.getWhatNew=function(){$siApi.rest("readme").then($content=>{const fileContent=$content,expression=/## Change log\r\nversion[^\r\n]+\r\n(([^\r\n]+\r\n)+)/gm,extractRE=new RegExp(/## Change log\r\nversion[^\r\n]+\r\n(([^\r\n]+\r\n)+)/gm,"gm"),testResult=extractRE.test(fileContent);if(testResult){extractRE.lastIndex=0;const extractResult=extractRE.exec(fileContent),converter=new showdown.Converter;$scope.whatNewText=converter.makeHtml(extractResult[1])}})},$scope.reset_all_configs=function(){$siUI.confirm("All your configurations will be lost.\nAre you sure you want to reset all settings?").then(function(){return $siUI.confirm("Before we proceed","Would you like to backup the current configuration?",{ok:"Yes",cancel:"No"}).then(_=>($scope.exportConfigs(),$scope.reset_configs()),_=>$scope.reset_configs())}).then(function(){$siUI.show_toast("Configurations cleared")}).then(function(){$scope.startRegistration()})},$scope.reset_configs=function(){return $scope.api("configs/reset",null,{method:"POST"}).then(function($response){$scope.configs=$response})},$scope.hasBackup=function(){return null!=$siConfigs.configsBackup},$scope.backupConfigs=function($silent){return $silent=void 0==typeof $silent?false:$silent,$siConfigs.backup().then(function(){if(!$silent)$siUI.show_toast("Settings backup done");$scope.checkIntegrity()})},$scope.exportConfigs=function(){var dataStr="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify($siConfigs.configs)),downloadAnchorNode=document.createElement("a");const exportName="si-configs."+location.hostname+"."+moment().format("YYYY-MM-DD");downloadAnchorNode.setAttribute("href",dataStr),downloadAnchorNode.setAttribute("download",exportName+".json"),document.body.appendChild(downloadAnchorNode),downloadAnchorNode.click(),downloadAnchorNode.remove()},$scope.importConfigs=function(){$siUI.getLocalFile(".json").then($fileContent=>{const newConfigs=JSON.parse($fileContent);if(null==newConfigs)return $siUI.alert("Error","File content is not valid");if(["app_id","api_key","account_id"].some($k=>void 0==newConfigs[$k]))return $siUI.alert("Error","File content is not valid");const fnSaveNewConfigs=function($data){$timeout(_=>{$scope.configs=$data,$scope.save_configs()},500)};$siUI.confirm("Warning","Are you sure you want to apply these configurations?",{ok:"Yes",cancel:"No"}).then(_=>{$siUI.confirm("Before we proceed","Would you like to backup the current configuration?",{ok:"Yes",cancel:"No"}).then(_=>{$scope.exportConfigs(),fnSaveNewConfigs(newConfigs)},_=>{fnSaveNewConfigs(newConfigs)})})})},$scope.showReadme=function(){$siUI.dialog("log-info")},$scope.showDocumentation=function(){$siUI.dialog("documentation")},$scope.openStyleEditor=function(){console.log("openStyleEditor",$siConfigs.configs.styles),$siUI.dialog("style-editor",$siConfigs.configs.styles).then($styles=>{$siConfigs.configs.styles=JSON.stringify($styles),$scope.save_configs()})},$scope.changeDefaultView=function($view){$scope.configs.lists.filter($l=>$l.source.id==$scope.configs.default_view).forEach($l=>{$l.source=$view}),$scope.configs.default_view=$view.id,$scope.save_configs()},$scope.logoChanged=function($logo){$scope.configs.site_logo=$logo,$scope.save_configs()},$scope.debounce_save_configs=function($delay=1e3){if(void 0!=$scope.$$save_timout)$timeout.cancel($scope.$$save_timout);$scope.$$save_timout=$timeout(()=>{$scope.save_configs()},$delay)},$scope.save_configs=function($silent){return $silent="undefined"==typeof $silent?false:$silent,$q(function($resolve,$reject){if(!$silent)$rootScope.$broadcast("si/working-state/changed",{icon:"fa-spin fa-spinner-third",text:"Saving configurations",class:"working"});$scope.validateListConfigs().then(_=>{console.log("saving configs",$scope.configs),$siConfigs.save($scope.configs).then(function($response){if(!$silent)$rootScope.$broadcast("si/working-state/changed",{icon:"fa-check-circle",text:"Save completed",class:"done",hide_timeout:2e3});$scope.checkIntegrity(),$resolve()},function($reason){if(403==$reason)$siUI.alert("Failed to save, nonce expired. The page will reload").then(_=>{window.location.reload(true)})})})})},$scope.validateListConfigs=function(){const lDefaultSearchTokenRenew=$scope.configs.lists.filter($l=>""==$l.search_token).map($l=>$q(($resolve,$reject)=>{$siUtils.renewListSearchToken($l).then($token=>{$l.search_token=$token,console.log("After token renew",$l),$resolve()})}));if(0==lDefaultSearchTokenRenew.length)return $q.resolve();else return $q.all(lDefaultSearchTokenRenew)},$scope.isInitializing=function(){return"initializing"==$scope._status},$scope.load_wp_languages=function(){return $q(function($resolve,$reject){if(null==$scope.wp_languages)$scope.api("language/list",null,{method:"GET"}).then($result=>{$scope.wp_languages=$result,$resolve($scope.wp_languages)}).catch($err=>{console.error($err)});else $resolve($scope.wp_languages)})},$scope.load_wp_pages=function(){},$scope.load_wp_menus=function(){return $scope.api("menu/list",null,{method:"GET"}).then($result=>{$scope.wp_menus=Object.keys($result).map($k=>({key:$k,name:$result[$k]}))})},$scope.load_data_views=function(){return $q(function($resolve,$reject){$scope.api("account").then(function($response){if(null!=$response)$rootScope.data_views=$scope.data_views=$response.data_views,$scope.loaded_components.push("list"),$resolve($response.data_views);else $resolve()})})},$scope.signin=function(){$scope.signin_in=true,$scope.portalApi("auth/login",$scope.login_infos).then($response=>{if($scope.signin_in=false,[10,20].includes($response.statusCode))return void $siUI.alert($response.message);console.log("signin configs",$scope.configs),$scope.credentials=$response,$scope.configs.account_id=null,$scope.configs.api_key=null;const lRegistrationSequence=[$scope.selectAccount,$scope.selectApiKey,$scope.selectDefaultView,$scope.setDisplayPages];lRegistrationSequence.reduce(($previous,$current)=>$previous.then(_=>$current()),Promise.resolve()).then($result=>{$scope.message={show_icon:true,title:"Configuration completed",text:"Thank you! Please wait while the interface reloads"},$scope.configs.registered=true,$scope.save_configs().then(_=>{window.setTimeout(_=>{$scope.configuration_step=0,$scope.api_keys=null,window.location.reload(true)},2e3)})})})},$scope.signout=function(){$siUI.confirm("Attention","Once disconnected from your account, all your real estate data will disapear from your site.\nAre you sure you want to continue?").then(function(){$scope.backupConfigs(true).then(function(){$scope.reset_configs().then(function(){$scope.show_toast("Configuration reset")}).then(function(){$scope.startRegistration()})})})},$scope.switchAccount=function(){$siUser.getCredentials().then($credentials=>{$siUI.dialog("change-datasources",$credentials,{clickOutsideToClose:false}).then($result=>{$siConfigs.replaceAccount($result).then(_=>{$scope.load_data_views(),$scope.load_dictionary(),$siUI.show_toast("Account switched successfully")})})})},$scope.startRegistration=function(){console.log("startRegistration"),$siUI.dialog("register",null,{multiple:true,clickOutsideToClose:false,hasBackdrop:false}).then(function(){window.location.reload(true)})},$scope.selectAccount=function(){return $q(function($resolve,$reject){console.log("Account selection"),$scope.configuration_step+=1,$scope.portalApi("linked_account/list").then($response=>{$response.items.forEach($e=>{$e.clickHandler=function(){console.log("selected account",$e),$scope.portal_account_id=$e.id,$resolve()}}),$scope.accounts=$response})})},$scope.selectApiKey=function(){return $q(function($resolve,$reject){console.log("Api Key selection"),$scope.configuration_step+=1,$scope.portalApi("api_key/list").then($response=>{if(1==$response.items.length)$scope.configs.account_id=$response.items[0].accountId,$scope.configs.api_key=$response.items[0].id,$scope.save_configs(true).then(_=>{$resolve()});else $response.items.forEach($e=>{$e.clickHandler=function(){$scope.configs.account_id=$e.accountId,$scope.configs.api_key=$e.id,$scope.save_configs(true).then(_=>{$resolve()})}}),$scope.api_keys=$response})})},$scope.selectDefaultView=function(){return $q(function($resolve,$reject){console.log("Default view selection"),$scope.configuration_step+=1,$scope.load_data_views().then($views=>{if(console.log("views",$views),1==$views.length)$scope.configs.default_view=$views[0].id,$scope.updateListsView(),$resolve();else $views.forEach($e=>{$e.clickHandler=function(){$scope.configs.default_view=$e.id,$scope.updateListsView(),$resolve()}})})})},$scope.setDisplayPages=function(){$scope.configuration_step+=1,console.log("setDisplayPages",$scope.wp_languages),$scope.wp_languages.forEach($l=>{$scope.addPageLanguage($l)});const lShortcodeMap={listing:{title:"Our listings",content:'[si alias="listings"]',list:_=>{$scope.addList("listings","listings","contract_start_date",true,30)}},listing_details:{title:"Listing details",content:"[si_listing]",layout:"listing_layouts"},broker:{title:"Our team",content:'[si alias="brokers"]',list:_=>{$scope.addList("brokers","brokers","last_name")}},broker_details:{title:"Broker details",content:"[si_broker]",layout:"broker_layouts"},office:{title:"Our offices",content:'[si alias="offices"]',list:_=>{$scope.addList("offices","offices","name")}},office_details:{title:"Office details",content:"[si_office]",layout:"office_layouts"},city:{title:"Cities",content:'[si alias="cities"]',list:_=>{$scope.addList("cities","cities","name")}},city_details:{title:"City details",content:"[si_city]",layout:"city_layouts"}};return["listing","listing_details","broker","broker_details"].forEach($k=>{const lPageEn=$scope.wp_pages.en.find($page=>$page.post_title==lShortcodeMap[$k].title),lPageFr=$scope.wp_pages.fr.find($page=>$page.post_title==lShortcodeMap[$k].title.translate());if(null!=lPageEn)$scope.default_page.en[$k]=lPageEn.ID;if(null!=lPageFr)$scope.default_page.fr[$k]=lPageFr.ID}),$q(function($resolve,$reject){$scope.applyShortCodeHandler=function(){$scope.configs.lists=[];const lSourcePages=[],lChildPages=[];return $scope.wp_languages.forEach(($language,$language_index)=>{Object.keys($scope.default_page[$language.code]).forEach($pKey=>{if("NONE"==$scope.default_page[$language.code][$pKey])return;const lMap=lShortcodeMap[$pKey];if(void 0==lMap)return void console.log("Map undefined",$pKey,$language.code,lShortcodeMap);if("function"==typeof lMap.list)lMap.list();const params={page_id:$scope.default_page[$language.code][$pKey],title:lMap.title.translate(void 0,$language.code),content:lMap.content,lang:$language.code},lCall=_=>{const lLayout=void 0==lMap.layout?null:$scope.configs[lMap.layout].find($layout=>$layout.lang==$language.code);if($language_index>0)if(void 0!=lMap.pages&&void 0!=lMap.pages[$scope.wp_languages[0].code])params.original_page_id=lMap.pages[$scope.wp_languages[0].code];return $scope.api("page",params).then($response=>{if("NEW"==$scope.default_page[$language.code][$pKey]&&!isNaN($response+1)){if(void 0==lMap.pages)lMap.pages={};if(lMap.pages[$language.code]=$response,null!=lLayout)lLayout.page=$response,lLayout.type="custom"}else if("NEW"!=$scope.default_page[$language.code][$pKey])if(null!=lLayout)lLayout.page=$scope.default_page[$language.code][$pKey],lLayout.type="custom"})};if(0==$language_index)lSourcePages.push(lCall);else lChildPages.push(lCall)})}),$timeout(_=>{$scope.message={show_icon:false,title:"Work in progress",text:"Please wait while we apply your configuration"}}),lSourcePages.reduce((promiseChain,currentTask)=>promiseChain.then(chainResults=>currentTask().then(currentResult=>[...chainResults,currentResult])),Promise.resolve([])).then(arrayOfResults=>(console.log("All main page created"),lChildPages.reduce((promiseChain,currentTask)=>promiseChain.then(chainResults=>currentTask().then(currentResult=>[...chainResults,currentResult])),Promise.resolve([])).then(arrayOfResults=>{console.log("All child page created"),$resolve()}))).catch($error=>{console.log("An error occured while creating page")})},$scope.skipPageBuilding=function(){$resolve()}})},$scope.addList=function($type,$alias,$sort="",$sortReverse=false,$limit=0){const lExistingList=$scope.configs.lists.find($l=>$l.alias==$alias),lView=$scope.data_views.find($e=>$e.id==$scope.configs.default_view),lList=$siUtils.createList(lView,$type,$alias,$sort,$sortReverse,$limit,lExistingList);if(null==lExistingList)$scope.configs.lists.push(lList)},$scope.addPageLanguage=function($lang){const lPageTitleByLangMap={fr:{"propriétés":"listing",courtiers:"broker",bureaux:"office",villes:"city"},en:{properties:"listing",brokers:"broker",offices:"office",cities:"city"}},lLocaleCode=$lang.code;if(void 0==$scope.default_page[lLocaleCode])$scope.default_page[lLocaleCode]={};$scope.wp_pages[lLocaleCode].forEach($p=>{const lMapKey=Object.keys(lPageTitleByLangMap[lLocaleCode]).find($k=>$k==$p.post_title.toLowerCase());if(null!=lMapKey)$scope.default_page[lLocaleCode][lMapKey]=$p.ID}),$scope.page_languages.push(lLocaleCode),console.log("page_languages",$scope.page_languages)},$scope.removePageLanguage=function($lang){$scope.page_languages=$scope.page_languages.filter($l=>$l!=$lang)},$scope.showPage=function($layout){if(void 0!=$layout.page)$scope.api("page/permalink",{page_id:$layout.page}).then($response=>{window.open($response)})},$scope.languageIsAvailable=function($lang){return!$scope.page_languages.includes($lang.code)},$scope.applyListingShortCode=function(){return $q(function($resolve,$reject){const params={page_id:$scope.default_page.listing,title:"Our Listings".translate(),content:'[si alias="listings"]'};$scope.api("page",params).then($result=>{$resolve()})})},$scope.applyBrokerShortCode=function(){return $q(function($resolve,$reject){const params={page_id:$scope.default_page.broker,title:"Our Teams".translate(),content:'[si alias="brokers"]'};$scope.api("page",params).then($result=>{$resolve()})})},$scope.updateListsView=function(){$scope.configs.lists.forEach($e=>{if(""==$e.source)$e.source=$scope.data_views.find($e=>$e.id==$scope.configs.default_view),$e.search_token=""}),console.log("config lists",$scope.configs.lists)},$scope.updateStyles=function($styles){$scope.configs.styles=$styles,$scope.save_configs()},$scope.initListSearchToken=function(){let lFilters=null,lPromise=$q(function($resolve,$reject){if(null!=lFilters)$scope.api("",lFilters,{url:wpSiApiSettings.api_root+"/api/utils/search_encode"}).then(function($response){$resolve($response)});else $resolve("")});return lPromise},$scope.changeApiKey=function(){$siUI.getPortalCredentials().then($credentials=>{console.log($credentials),$scope.credentials=$credentials,$scope.portalApi("linked_account/list").then($response=>{const lPortalAccount=$response.items.find($e=>$e.account.id==$scope.configs.account_id);if(null!=lPortalAccount)$scope.portal_account_id=lPortalAccount.id,$scope.portalApi("api_key/list").then($response=>{if(1!=$response.items.length)$scope.api_keys=$response.items;else $siUI.show_toast("There's only one API key for this account")})})})},$scope.checkIntegrity=function(){if($scope.notices=[],$scope.hasEmptyLayouts()){const lMissingLayout=$scope.getEmptyLayouts().map(function($l){return $l.translate()});console.log("missing layout",lMissingLayout),$scope.addNotice("Missing layouts","Some list are missing a detail page layout. Please check the following section{1}: {0}".translate().siFormat(lMissingLayout.join(", "),lMissingLayout.length>1?"s":""),{actions:{"Create missing pages":function(){$siUI.confirm("Attention","Creating missing layout may duplicate some page under certain circonstance.\nContinue anyway?",{ok:"Yes",cancel:"No"}).then(function(){$scope.fillEmptyLayouts()})}}})}if(isNullOrEmpty($scope.configs.map_api_key))$scope.addNotice("Map API key","The map API key is not configured. Maps will not be available in list or details.");if(0==$scope.notices.length)$scope.addNotice("All good","The plugin is properly configured",{type:"success",color:"#4AB448",icon:"fa-check-circle"});if($scope.hasBackup())$scope.addNotice("Backup detected","A settings backup has been detected. Select one of the following options:",{type:"success",color:"#41A5EE",icon:"fa-database",actions:{Restore:function(){$siConfigs.data_views=$scope.data_views,$siConfigs.restoreBackup()},Clear:function(){$siUI.confirm("Attention","Are you sure you want to delete this backup?",{ok:"Yes",cancel:"No"}).then(function(){$siConfigs.clearBackup().then(_=>{$scope.checkIntegrity()})})}}})},$scope.hasErrorNotices=function(){return $scope.notices.some(function($n){return"warning"==$n.type})},$scope.addNotice=function($title,$message,$options){const lNotice=Object.assign({title:$title,message:$message,color:"#ff9900",actions:[],icon:"fa-exclamation-triangle",type:"warning"},$options);$scope.notices.push(lNotice)},$scope.generateLayoutPage=function($layout,$groupType){const lTypeMaps={listings:{title:{
en:"Listing - details",fr:"Propriété - détails"},content:"[si_listing]",layouts:$scope.configs.listing_layouts},brokers:{title:{en:"Broker - details",fr:"Courtier - détails"},content:"[si_broker]",layouts:$scope.configs.broker_layouts},offices:{title:{en:"Office - details",fr:"Bureau - détails"},content:"[si_office]",layouts:$scope.configs.office_layouts},cities:{title:{en:"City - details",fr:"Ville - détails"},content:"[si_city]",layouts:$scope.configs.city_layouts},agencies:{title:{en:"Agency - details",fr:"Agence - détails"},content:"[si_agency]",layouts:$scope.configs.agency_layouts}},lLayoutInfos=lTypeMaps[$groupType],lPageTitle=lLayoutInfos.title[$layout.lang],lPageContent=lLayoutInfos.content,lOriginalPageId=lLayoutInfos.layouts.filter($l=>null!=$l.page&&$l.lang!=$layout.lang).reduce(($result,$cur)=>$cur.page,null);$siWP.addPage(lPageTitle,lPageContent,$layout.lang,lOriginalPageId).then($pageId=>{$layout.page=$pageId,$scope.save_configs()})},$scope.clearAllLayoutPage=function(){const lLayoutMap=["listing_layouts","broker_layouts","office_layouts","city_layouts"];lLayoutMap.forEach($layoutGroup=>{$scope.configs[$layoutGroup].forEach($layout=>{$layout.page=null})}),$scope.save_configs()},$scope.clearLayoutPage=function($layout){$layout.page=null,$scope.save_configs()},$scope.getEmptyLayouts=function(){const lLayoutMap={listings:"listing_layouts",brokers:"broker_layouts",offices:"office_layouts",cities:"city_layouts"},lFiltered=Object.keys(lLayoutMap).filter(function($type){return $scope.configs.lists.some(function($l){return $l.type==$type})});return lFiltered.filter(function($type){return $scope.configs[lLayoutMap[$type]].some(function($layout){return null==$layout||null==$layout.page})})},$scope.hasEmptyLayouts=function(){return $scope.getEmptyLayouts().length>0},$scope.fillEmptyLayouts=function(){const lLayoutMap={listings:"listing_layouts",brokers:"broker_layouts",offices:"office_layouts",cities:"city_layouts"},lPages={listings:{title:"Listing details",content:"[si_listing]"},brokers:{title:"Broker details",content:"[si_broker]"},offices:{title:"Office details",content:"[si_office]"},cities:{title:"City details",content:"[si_city]"}},lLayoutCreationPromises=[];return Object.keys(lLayoutMap).filter(function($type){return $scope.configs.lists.some(function($l){return $l.type==$type})}).forEach(function($type){let lOrignalPageId=null;$scope.configs[lLayoutMap[$type]].forEach(function($layout){if(null==$layout.page)lLayoutCreationPromises.push(_=>{const lPageTitle="en"==$layout.lang?lPages[$type].title:lPages[$type].title.translate(),lPageContent=lPages[$type].content;return $q(($resolve,$reject)=>{$scope.api("page",{lang:$layout.lang,page_id:"NEW",title:lPageTitle,content:lPageContent,original_page_id:lOrignalPageId}).then($response=>{$layout.page=$response,lOrignalPageId=$layout.page,console.log("apply page layout",$response,$layout.page),$resolve()})})})})}),$siUI.show_toast("Generating empty layout pages"),lLayoutCreationPromises.reduce((promiseChain,currentTask)=>promiseChain.then(chainResults=>currentTask().then(currentResult=>[...chainResults,currentResult])),Promise.resolve([])).then(arrayOfResults=>{console.log("saving these",$scope.configs),$scope.save_configs(),$rootScope.$broadcast("reload-pages")})},$scope.show_page=function($page_id,$params){console.log("page is called",$page_id,$params);let lPromise=$q(function($resolve,$reject){$rootScope.$broadcast("on-"+$page_id,$params,function($result){$resolve($result)})});return lPromise},$scope.confirm=function($title,$message,$options){return $siUI.confirm($title,$message,$options)},$scope.show_toast=function($message){$siUI.show_toast($message)},$scope.api=function($path,$data,$options){return $siApi.rest($path,$data,$options)},$scope.portalApi=function($path,$data,$options){const lOptions=Object.assign({method:"POST"},$options);if(lOptions.url="https://portal-api.source.immo/api/"+$path,null!=$data)if("POST"==lOptions.method)lOptions.data=$data;else lOptions.params=$path;if(null!=$scope.credentials){if(!lOptions.params)lOptions.params={};if(lOptions.params.at=$scope.credentials.authTokenKey,null!=$scope.portal_account_id)lOptions.params.la=$scope.portal_account_id}return $q(($resolve,$reject)=>{$http(lOptions).then($response=>{if(200==$response.status)$resolve($response.data)}).catch($err=>{console.log($path,"call failed",$err)})})},$scope.copy=function($data){$siUtils.copyToClipboard($data)},$scope.isSame=function($objA,$objB){if(null!=$objA&&null!=$objB){for(const key in $objA)if("$$hashKey"!=key)if(0!=key.indexOf("$$"))if(null!=$objA[key]&&null!=$objB[key])if("undefined"!=typeof $objA[key]&&"undefined"!=typeof $objB[key]){if("function"==typeof $objA[key].push){if($objA[key].length!=$objB[key].length)return false;else for(let i=0;i<$objA[key].length;i++)if(!$scope.isSame($objA[key][i],$objB[key][i]))return false}else if("object"==typeof $objA[key]){if(!$scope.isSame($objA[key],$objB[key]))return false}else if($objA[key]!=$objB[key])return false}else return false;else if(null!=$objA[key]||null!=$objB[key])return false}else if(null==$objA||null==$objB)return false;return true}}),siApp.controller("mainNetworkCtrl",function($scope,$rootScope,$q,$timeout,$siConfigs,$siList,$siUI,$siUtils){$scope._status="initializing",$scope.loaded_components=[],$scope.pages={home:{label:"Home".translate(),style:""},listEdit:{label:"List editing".translate(),style:"transform:translateX(-100%);"}},$scope.init=function(){$scope.load_configs().then(_=>{$scope._status="ready"}),$scope.$on("save-request",function(){console.log("save-request/received"),$scope.save_configs()})},$scope.load_configs=function(){return $q(function($resolve,$reject){$siConfigs.loadNetwork().then(function($response){$scope.networkConfigs=$response,$resolve()})})},$scope.updateSettings=function(){$scope.save_configs()},$scope.save_configs=function(){$siConfigs.saveNetwork($scope.networkConfigs)}}),siApp.controller("listEditCtrl",function($scope,$rootScope,$q,$siUtils,$siUI){BasePageController("listEdit",$scope,$rootScope),$scope.model={},$scope._original=null,$scope.previewElements=[],$scope.computedStyles=null,$scope.actions=[{label:"Apply".translate(),action:function(){$scope.return($scope.model)}},{label:"Cancel".translate(),action:$scope.cancel}],$scope.init=function($params){if(console.log("listEdit init",$scope.configs),"string"==typeof $params)$scope.model={alias:"New {0} list".translate().siFormat($params.translate()),$$source_id:$scope.configs.default_view,type:$params},$scope.reset_default_value();else{if($scope.model=angular.copy($params),null!=$scope.model.source)$scope.model.$$source_id=$scope.model.source.id;$scope.validate()}$scope._original=$params,$scope.buildPreviewElement(),$scope.computeStyles(),$scope.$watch("model.list_item_layout.preset",function($new,$old){if($new!=$old)$scope.buildPreviewElement()})},$scope.reset_default_value=function(){switch($scope.model=angular.merge($scope.model,{sort:null,sort_reverse:false,limit:0,searchable:true,priority_group_sort:null,search_engine_options:{type:"full",focus_category:null,orientation:"h",filter_tags:"none"},sortable:true,mappable:true,filter_group:{filters:[],filter_groups:[],operator:"and"}}),$scope.model.type){case"listings":$scope.model=angular.merge($scope.model,{list_layout:{preset:"standard",scope_class:"",custom:null,item_row_space:{desktop:33,laptop:33,tablet:50,mobile:100}},list_item_layout:{preset:"standard",scope_class:"",custom:null,primary_layer_position:"fix",secondary_layer_bg_opacity:80,layout:"standard",displayed_vars:{main:["address","city","price","category","rooms","subcategory"]}}});break;case"brokers":$scope.model=angular.merge($scope.model,{list_layout:{preset:"standard",scope_class:"",custom:null,item_row_space:{desktop:25,laptop:25,tablet:50,mobile:100}},list_item_layout:{preset:"standard",scope_class:"",custom:null,layout:"standard",displayed_vars:{main:["first_name","last_name","licence","phone"]}}});break;case"cities":$scope.model=angular.merge($scope.model,{list_layout:{preset:"direct",scope_class:"",custom:null,item_row_space:{desktop:25,laptop:25,tablet:50,mobile:100}},list_item_layout:{preset:"standard",scope_class:"",custom:null,layout:"standard",displayed_vars:{main:["name","region","listing_count"]}}});case"offices":$scope.model=angular.merge($scope.model,{list_layout:{preset:"standard",scope_class:"",custom:null,item_row_space:{desktop:25,laptop:25,tablet:50,mobile:100}},list_item_layout:{preset:"standard",scope_class:"",custom:null,layout:"standard",displayed_vars:{main:["name","agency-name","listing_count","address"]}}});case"agencies":$scope.model=angular.merge($scope.model,{list_layout:{preset:"standard",scope_class:"",custom:null,item_row_space:{desktop:33,laptop:33,tablet:50,mobile:100}},list_item_layout:{preset:"standard",scope_class:"",custom:null,layout:"standard",displayed_vars:{main:["name","license","address","listing_count"]}}})}},$scope.computeStyles=function(){console.log("computeStyles",$scope.configs.styles,$scope.model.style);const lGlobalStyles=isNullOrEmpty($scope.configs.styles)?{}:JSON.parse($scope.configs.styles),lLocalStyles=isNullOrEmpty($scope.model.list_item_layout.styles)?{}:JSON.parse($scope.model.list_item_layout.styles);console.log(lGlobalStyles,lLocalStyles),$scope.computedStyles=JSON.stringify(Object.assign({},lGlobalStyles,lLocalStyles))},$scope.updateSource=function(){$scope.model.source=$scope.data_views.find(function($e){return $e.id==$scope.model.$$source_id})},$scope.buildPreviewElement=function(){$scope.previewElements=[];const lModelCount={listings:3,brokers:4,cities:3,offices:3,agencies:3};$scope.previewElements=Array.from(new Array(lModelCount[$scope.model.type])).map($e=>{const lElement={layout:wpSiApiSettings.base_path+"/views/admin/statics/previews/"+$scope.model.type+"-element-"+$scope.model.list_item_layout.layout+".html"};switch($scope.model.type){case"listings":lElement.price=$scope.getPrice(),lElement.address=$scope.getAddress(),lElement.city=$scope.getCity(),lElement.category=$scope.getCategory(),lElement.subcategory=$scope.getSubcategory(),lElement.ref_number=$scope.getNumber(12345,19999),lElement.bedrooms=$scope.getNumber(2,5),lElement.bathrooms=$scope.getNumber(1,lElement.bedrooms),lElement.region=$scope.getRegion(),lElement.avail_area=100*$scope.getNumber(10,20);break;case"brokers":lElement.first_name=$scope.getFirstname(),lElement.last_name=$scope.getLastname(),lElement.licence=$scope.getLicence(),lElement.phone=$scope.getPhone(),lElement.office=$scope.getOffice(),lElement.listing_count=$scope.getListingCount(),lElement.email=lElement.first_name.toLowerCase()+"."+lElement.last_name.toLowerCase()+"@example.com";break;case"cities":lElement.name=$scope.getCity(),lElement.region=$scope.getRegion(),lElement.listings_count=$scope.getListingCount(),lElement.code=$scope.getNumber(1234,6543);break;case"offices":lElement.name=$scope.getCity(),lElement.region=$scope.getRegion(),lElement.listings_count=$scope.getListingCount(),lElement.brokers_count=$scope.getBrokerCount(),lElement.agency={name:"Agency"},lElement.location={street_address:$scope.getAddress(),city:lElement.name,state:$scope.getSate(),postal_code:$scope.getPostalCode()};case"agencies":lElement.name="Immo "+$scope.getFunkyName(),lElement.listings_count=$scope.getListingCount(),lElement.brokers_count=$scope.getBrokerCount(),lElement.offices_count=$scope.getOfficeCount(),lElement.main_office={location:{street_address:$scope.getAddress(),city:$scope.getCity(),state:$scope.getSate(),postal_code:$scope.getPostalCode()}};default:break}return lElement}),console.log("previewElements",$scope.previewElements)},$scope.getCustomCss=function(){if(void 0==$scope.model.list_item_layout)return"";if("custom"!=$scope.model.list_item_layout.preset)return"";const lStyles=$scope.model.list_item_layout.custom_css.split("\n"),lScopedStyles=lStyles.map($s=>".component-elements .si-element "+$s);return lScopedStyles.join("\n")},$scope.buildSearchElement=function(){$scope.model.search_engine_options.layout=wpSiApiSettings.base_path+"/views/admin/statics/previews/"+$scope.model.type+"-search-"+$scope.model.search_engine_options.type+".html"},$scope.saveOrClose=function(){if($scope.hasChanged())$scope.renewSearchToken().then(function($searchToken){$scope.model.search_token=$searchToken;const lResult=angular.copy($scope.model);if(lResult.show_list_meta=void 0==lResult.show_list_meta?false:lResult.show_list_meta,void 0==lResult.source)lResult.source=$scope.data_views.find(function($e){return $e.id==lResult.$$source_id});delete lResult.$$source_id,console.log("SaveOrClose",lResult,$scope.model),$scope.return(lResult)});else console.log("SaveOrClose",$scope.model),$scope.cancel()},$scope.renewSearchToken=function(){let lFilters=$scope.buildFilters(),lPromise=$q(function($resolve,$reject){if(null!=lFilters)$scope.api("",lFilters,{url:wpSiApiSettings.api_root+"/api/utils/search_encode"}).then(function($response){$resolve($response)});else $resolve("")});return lPromise},$scope.buildFilters=function(){let lResult=null;if($scope.model.limit>0)lResult={max_item_count:$scope.model.limit};if(null!=$scope.model.sort&&""!=$scope.model.sort&&"auto"!=$scope.model.sort){if(null==lResult)lResult={};if(lResult.sort_fields=[{field:$scope.model.sort,desc:$scope.model.sort_reverse}],!isNullOrEmpty($scope.model.priority_group_sort)){const lPriorityDesc=$scope.model.priority_group_sort.indexOf("-desc")>0?true:false;lResult.sort_fields.unshift({field:"priority",desc:lPriorityDesc})}}if($scope.model.shuffle){if(null==lResult)lResult={};lResult.shuffle=$scope.model.shuffle}if(null!=$scope.model.filter_group){if(null==lResult)lResult={};lResult.filter_group=$scope.normalizeFilterGroup(angular.copy($scope.model.filter_group))}return lResult},$scope.normalizeFilterGroup=function($filter_group){if($filter_group.filters)$filter_group.filters.forEach(function($filter){if(["in","not_in"].indexOf($filter.operator)>=0){if("undefined"==typeof $filter.value.push)$filter.value=$filter.value.split(","),$filter.value.forEach(function($val){if(!isNaN($val))$val=Number($val)})}else if(!isNaN($filter.value))$filter.value=Number($filter.value)});if($filter_group.filter_groups)$filter_group.filter_groups.forEach(function($group){$scope.normalizeFilterGroup($group)});return $filter_group},$scope.switchSortReverse=function(){$scope.model.sort_reverse=!$scope.model.sort_reverse},$scope.hasChanged=function(){return!$scope.isSame($scope.model,$scope._original)},$scope.validate=function(){if(void 0==$scope.model.priority_group_sort)$scope.model.priority_group_sort=null;if(void 0==$scope.model.search_engine_options)$scope.model.search_engine_options={type:"full",search_box_placeholder:{fr:"",en:""},tabs:[],fields:[]};$scope.$on("siListPreview/editListItem",function(){$scope.editListItem($scope.model.type)})},$scope.editSearchEngine=function($type){$siUI.dialog($type+"-search-engine-edit",$scope.model.search_engine_options).then($result=>{$scope.model.search_engine_options=$result})},$scope.editListItem=function($type){$siUI.dialog($type+"-list-item-edit",$scope.model).then($result=>{$scope.model=$result,$scope.computeStyles(),console.log("editListItem return with",$result)})},$scope.previewLayerHasVar=function($item,$layer="main"){if(void 0==$scope.model.list_item_layout.displayed_vars)return false;if(void 0==$scope.model.list_item_layout.displayed_vars[$layer])return false;else return $scope.model.list_item_layout.displayed_vars[$layer].includes($item)},$scope.getNumber=function($min,$max){return $min+Math.round(Math.random()*($max-$min))},$scope.getAddress=function(){const lNumber=$scope.getNumber(1e3,2e3),lStreetName=$scope.getLastname();return lNumber+" "+lStreetName},$scope.getFunkyName=function(){return["Capitale","2000","Carrefour","Action","Excellence","Platine","Selection","Elite","Bonjour","Accès","Concept","Horizon","Alto","Distinction","Diamant","Expertise","Prestige"].any()},$scope.getCity=function(){return["San Francisco","Montréal","Washington","Paris","Springfield","Franklin","Greenville","London","Los Angeles","New York","Vanconver","Calgary","St-John","Halifax","Ottawa","Toronto","Québec","Victoria","Edmonton","Regina","Winnipeg","Fredericton","Charlottetown"].any()},$scope.getRegion=function(){return"Region".translate()},$scope.getPrice=function(){const lPrice=1e3*$scope.getNumber(200,500);return lPrice.formatPrice()},$scope.getCategory=function(){return"Residential"},$scope.getSubcategory=function(){return["Two-storey house","Bungalow","Split-level"].any().translate()},$scope.getLastname=function(){return["Riordan","Tolkien","Montpellier","Vernes","Dumas","Poe","Doyle","Martin","Proust","Hugo","Balzac","Rimbaud","Camus","Austen"].any()},$scope.getFirstname=function(){return["Rick","Honoré","Alexandre","George","Edgar","Jules","Arthur","Victor","Marcel","Pierre","Albert","Jane"].any()},$scope.getLicence=function(){return["Real estate broker","Residential real estate broker","Certified real estate broker"].any().translate()},$scope.getListingCount=function(){return $scope.getNumber(2,30)},$scope.getBrokerCount=function(){return $scope.getNumber(2,20)},$scope.getOfficeCount=function(){return $scope.getNumber(2,8)},$scope.getOffice=function(){return $scope.getCity()},$scope.getPhone=function(){return[["819","514","450"].any(),"555",$scope.getNumber(1234,9876)].join("-")},$scope.getPostalCode=function(){return[["J7H","J0T","H7K","J4B"].any(),["1B4","3E4","5W2","7N8"].any()].join(" ")},$scope.getSate=function(){return["Québec","Ontario","Alberta","Manitoba","Saskatchewan","New-York","Washington","California","Florida","Nova Scotia"].any()}}),siApp.controller("brokersSearchEngineEditDialogCtrl",function brokersSearchEngineEditCtrl($scope,$rootScope,$siUI){$scope.model={type:"full",focus_category:null,orientation:"h",sticky:false},$scope.fieldList=[{key:"searchbox",caption:"Search box".translate()},{key:"letters",caption:"Alphabetical".translate()},{key:"licenses",caption:"Licenses".translate()},{key:"offices",caption:"Offices".translate()}],$scope.actions=[{label:"OK",action:function(){$scope.closeAndReturn($scope.model)}},{label:"Cancel",action:function(){$scope.cancel()}}],$scope.init=function($params){if($scope.model=Object.assign($scope.model,$params),void 0!=$scope.model.search_engine_options)delete $scope.model.search_engine_options;console.log("init brokerSearchEngine",$params,$scope.model)},$scope.toggleField=function($key){if(void 0==$scope.model.fields)$scope.model.fields=[];if(!$scope.model.fields.includes($key))$scope.model.fields.push($key);else $scope.model.fields=$scope.model.fields.filter($f=>$f!=$key)}}),siApp.controller("brokersListItemEditDialogCtrl",function brokersListItemEditCtrl($scope,$rootScope,$mdDialog,$siUI){BaseListItemEditController($scope,$rootScope),$scope.layoutList=[],$scope.availVars=[],$scope.model={},$scope.actions=[{label:"OK",action:function(){$scope.closeAndReturn($scope.model)}}],$scope.init=function($params){if(console.log("init brokerListItemEdit",$params,$rootScope.global_list.list_item_vars[$scope.model.type]),$scope.model=Object.assign($scope.model,$params),$scope.layoutList=$rootScope.global_list.list_item_layouts[$scope.model.type],$scope.availVars=$rootScope.global_list.list_item_vars[$scope.model.type],$scope.imageHoverEffects=$rootScope.global_list.list_item_image_hover_effects[$scope.model.type],$scope.layerHoverEffects=$rootScope.global_list.list_item_show_layer_effects[$scope.model.type],$scope.layerPositions=$rootScope.global_list.list_item_layer_positions[$scope.model.type],Array.isArray($scope.model.list_item_layout.displayed_vars))delete $scope.model.list_item_layout.displayed_vars;if(void 0==$scope.model.list_item_layout.image_hover_effect)$scope.model.list_item_layout.image_hover_effect="none";if(void 0==$scope.model.list_item_layout.secondary_layer_effect)$scope.model.list_item_layout.secondary_layer_effect="none";if(void 0==$scope.model.list_item_layout.displayed_vars)$scope.model.list_item_layout.displayed_vars={main:$scope.availVars,secondary:[]};console.log("availVars",$scope.availVars)},$scope.varIsChecked=function($item,$layer="main"){if(void 0==$scope.model.list_item_layout.displayed_vars[$layer])return false;else return $scope.model.list_item_layout.displayed_vars[$layer].includes($item)},$scope.varToggle=function($item,$layer="main"){if(void 0==$scope.model.list_item_layout.displayed_vars[$layer])$scope.model.list_item_layout.displayed_vars[$layer]=[];if($scope.model.list_item_layout.displayed_vars[$layer].includes($item))$scope.model.list_item_layout.displayed_vars[$layer]=$scope.model.list_item_layout.displayed_vars[$layer].filter($v=>$v!=$item);else $scope.model.list_item_layout.displayed_vars[$layer].push($item)},$scope.updateStyles=function($styles){$scope.model.list_item_layout.styles=$styles}}),siApp.controller("listingsSearchEngineEditDialogCtrl",function listingsSearchEngineEditDialogCtrl($scope,$rootScope,$siUI){$scope.model={type:"full",focus_category:null,orientation:"h",sticky:false},$scope.fieldList=[{key:"searchbox",caption:"Search box".translate()},{key:"cities",caption:"Cities".translate()},{key:"transactions",caption:"Transactions".translate()},{key:"price",caption:"Price".translate()},{key:"bedrooms",caption:"Bedrooms".translate()},{key:"bathrooms",caption:"Bathrooms".translate()},{key:"types",caption:"Types".translate()},{key:"categories",caption:"Categories".translate()},{key:"available_area",caption:"Available area".translate()},{key:"parkings",caption:"Parkings".translate()},{key:"features",caption:"Features".translate()},{key:"filters",caption:"Filters".translate()},{key:"ages",caption:"Ages".translate()}],$scope.actions=[{label:"OK",action:function(){$scope.closeAndReturn($scope.model)}},{label:"Cancel",action:function(){$scope.cancel()}}],$scope.init=function($params){if($scope.model=Object.assign($scope.model,$params),void 0!=$scope.model.search_engine_options)delete $scope.model.search_engine_options;console.log("init listingSearchEngine",$params,$scope.model)},$scope.toggleField=function($key){if(void 0==$scope.model.fields)$scope.model.fields=[];if(!$scope.model.fields.includes($key))$scope.model.fields.push($key);else $scope.model.fields=$scope.model.fields.filter($f=>$f!=$key)},$scope.tabsContains=function($tabToCheck){return $tabToCheck.some($t=>$scope.model.tabs.includes($t))}}),siApp.controller("listingsListItemEditDialogCtrl",function listingsListItemEditDialogCtrl($scope,$rootScope,$mdDialog,$siUI){BaseListItemEditController($scope,$rootScope),$scope.layoutList=[],$scope.availVars=[],$scope.model={},$scope.actions=[{label:"OK",action:function(){$scope.closeAndReturn($scope.model)}}],$scope.init=function($params){if(console.log("init listingListItemEdit",$params,$rootScope.global_list.list_item_vars[$scope.model.type]),$scope.model=Object.assign($scope.model,$params),$scope.layoutList=$rootScope.global_list.list_item_layouts[$scope.model.type],$scope.availVars=$rootScope.global_list.list_item_vars[$scope.model.type],$scope.imageHoverEffects=$rootScope.global_list.list_item_image_hover_effects[$scope.model.type],$scope.layerHoverEffects=$rootScope.global_list.list_item_show_layer_effects[$scope.model.type],$scope.layerPositions=$rootScope.global_list.list_item_layer_positions[$scope.model.type],Array.isArray($scope.model.list_item_layout.displayed_vars))delete $scope.model.list_item_layout.displayed_vars;if(void 0==$scope.model.list_item_layout.image_hover_effect)$scope.model.list_item_layout.image_hover_effect="none";if(void 0==$scope.model.list_item_layout.secondary_layer_effect)$scope.model.list_item_layout.secondary_layer_effect="none";if(void 0==$scope.model.list_item_layout.displayed_vars)$scope.model.list_item_layout.displayed_vars={main:$scope.availVars,secondary:[]};console.log("availVars",$scope.availVars)},$scope.varIsChecked=function($item,$layer="main"){if(void 0==$scope.model.list_item_layout.displayed_vars[$layer])return false;else return $scope.model.list_item_layout.displayed_vars[$layer].includes($item)},$scope.varToggle=function($item,$layer="main"){if(void 0==$scope.model.list_item_layout.displayed_vars[$layer])$scope.model.list_item_layout.displayed_vars[$layer]=[];if($scope.model.list_item_layout.displayed_vars[$layer].includes($item))$scope.model.list_item_layout.displayed_vars[$layer]=$scope.model.list_item_layout.displayed_vars[$layer].filter($v=>$v!=$item);else $scope.model.list_item_layout.displayed_vars[$layer].push($item)},$scope.updateStyles=function($styles){$scope.model.list_item_layout.styles=$styles}}),siApp.controller("citiesSearchEngineEditDialogCtrl",function citiesSearchEngineEditCtrl($scope,$rootScope,$siUI){$scope.model={type:"full",focus_category:null,orientation:"h",sticky:false},$scope.fieldList=[{key:"searchbox",caption:"Search box".translate()},{key:"regions",caption:"Alphabetical".translate()}],$scope.actions=[{label:"OK",action:function(){$scope.closeAndReturn($scope.model)}},{label:"Cancel",action:function(){$scope.cancel()}}],$scope.init=function($params){if($scope.model=Object.assign($scope.model,$params),void 0!=$scope.model.search_engine_options)delete $scope.model.search_engine_options;console.log("init brokerSearchEngine",$params,$scope.model)},$scope.toggleField=function($key){if(void 0==$scope.model.fields)$scope.model.fields=[];if(!$scope.model.fields.includes($key))$scope.model.fields.push($key);else $scope.model.fields=$scope.model.fields.filter($f=>$f!=$key)}}),siApp.controller("citiesListItemEditDialogCtrl",function citiesListItemEditCtrl($scope,$rootScope,$mdDialog,$siUI){BaseListItemEditController($scope,$rootScope),$scope.model={},$scope.init=function($params){console.log("init cityListItemEdit",$params,$rootScope.global_list.list_item_vars[$scope.model.type]),$scope.base.init($params),console.log("availVars",$scope.availVars)}}),siApp.controller("officesSearchEngineEditDialogCtrl",function officesSearchEngineEditCtrl($scope,$rootScope,$mdDialog,$siUI){$scope.model={type:"full",focus_category:null,orientation:"h",sticky:false},$scope.fieldList=[{key:"searchbox",caption:"Search box".translate()},{key:"regions",caption:"Alphabetical".translate()}],$scope.actions=[{label:"OK",action:function(){$scope.closeAndReturn($scope.model)}},{label:"Cancel",action:function(){$scope.cancel()}}],$scope.init=function($params){if($scope.model=Object.assign($scope.model,$params),void 0!=$scope.model.search_engine_options)delete $scope.model.search_engine_options;console.log("init brokerSearchEngine",$params,$scope.model)},$scope.toggleField=function($key){if(void 0==$scope.model.fields)$scope.model.fields=[];if(!$scope.model.fields.includes($key))$scope.model.fields.push($key);else $scope.model.fields=$scope.model.fields.filter($f=>$f!=$key)}}),siApp.controller("officesListItemEditDialogCtrl",function officesListItemEditCtrl($scope,$rootScope,$mdDialog,$siUI){BaseListItemEditController($scope,$rootScope),$scope.model={},$scope.init=function($params){console.log("init officeListItemEdit",$params,$rootScope.global_list.list_item_vars[$scope.model.type]),$scope.base.init($params),console.log("availVars",$scope.availVars)}}),siApp.controller("agenciesSearchEngineEditDialogCtrl",function agenciesSearchEngineEditCtrl($scope,$rootScope,$mdDialog,$siUI){$scope.model={type:"full",focus_category:null,orientation:"h",sticky:false},$scope.fieldList=[{key:"searchbox",caption:"Search box".translate()}],$scope.actions=[{label:"OK",action:function(){$scope.closeAndReturn($scope.model)}},{label:"Cancel",action:function(){$scope.cancel()}}],$scope.init=function($params){if($scope.model=Object.assign($scope.model,$params),void 0!=$scope.model.search_engine_options)delete $scope.model.search_engine_options},$scope.toggleField=function($key){if(void 0==$scope.model.fields)$scope.model.fields=[];if(!$scope.model.fields.includes($key))$scope.model.fields.push($key);else $scope.model.fields=$scope.model.fields.filter($f=>$f!=$key)}}),siApp.controller("agenciesListItemEditDialogCtrl",function agenciesListItemEditCtrl($scope,$rootScope,$mdDialog,$siUI){BaseListItemEditController($scope,$rootScope),$scope.model={},$scope.init=function($params){$scope.base.init($params)}}),siApp.controller("langItemEditDialogCtrl",function langItemEditDialogCtrl($scope,$rootScope,$q,$siApi,$siConfigs,$siUI,$siUtils){$scope.global_list=$rootScope.global_list,$scope.data_views=$rootScope.data_views,$scope.configs={},$scope.routes=null,$scope.groupType=null,$scope.shortCodeMaps={listings:"[si_listing]",brokers:"[si_broker]",offices:"[si_office]",agencies:"[si_agency]",cities:"[si_city]"},$scope.details_defaults={fr:{listings:{route:{route:"proprietes/{{item.location.region}}/{{item.location.city}}/{{item.transaction}}/{{item.ref_number}}/",shortcut:"propriete/{{item.ref_number}}/"},layout:{}},brokers:{route:{route:"courtiers/{{item.first_name}}-{{item.last_name}}/{{item.ref_number}}/",shortcut:"courtier/{{item.ref_number}}/"},layout:{}},offices:{route:{route:"bureaux/{{item.name}}/{{item.ref_number}}/",shortcut:"bureau/{{item.ref_number}}/"},layout:{}},agencies:{route:{route:"agences/{{item.name}}/{{item.ref_number}}/",shortcut:"agence/{{item.ref_number}}/"},layout:{communication_mode:"basic",form_id:null}},cities:{route:{route:"villes/{{item.location.region}}/{{item.name}}/{{item.ref_number}}/",shortcut:"ville/{{item.ref_number}}/"},layout:{}}},en:{listings:{route:{route:"listings/{{item.location.region}}/{{item.location.city}}/{{item.transaction}}/{{item.ref_number}}/",shortcut:"listing/{{item.ref_number}}/"},layout:{}},brokers:{route:{route:"brokers/{{item.first_name}}-{{item.last_name}}/{{item.ref_number}}/",shortcut:"broker/{{item.ref_number}}/"},layout:{}},offices:{route:{route:"offices/{{item.name}}/{{item.ref_number}}/",shortcut:"office/{{item.ref_number}}/"},layout:{}},agencies:{route:{route:"agencies/{{item.name}}/{{item.ref_number}}/",shortcut:"agency/{{item.ref_number}}/"},layout:{}},cities:{route:{route:"cities/{{item.location.region}}/{{item.name}}/{{item.ref_number}}/",shortcut:"city/{{item.ref_number}}/"},layout:{}}},es:{listings:{route:{route:"propiedades/{{item.location.region}}/{{item.location.city}}/{{item.transaction}}/{{item.ref_number}}/",shortcut:"propiedad/{{item.ref_number}}/"},layout:{}},brokers:{route:{route:"agentes/{{item.first_name}}-{{item.last_name}}/{{item.ref_number}}/",shortcut:"agente/{{item.ref_number}}/"},layout:{}},offices:{route:{route:"oficinas/{{item.name}}/{{item.ref_number}}/",shortcut:"despacho/{{item.ref_number}}/"},layout:{}},agencies:{route:{route:"agencias/{{item.name}}/{{item.ref_number}}/",shortcut:"agencia/{{item.ref_number}}/"},layout:{}},cities:{route:{route:"ciudad/{{item.location.region}}/{{item.name}}/{{item.ref_number}}/",shortcut:"ciudades/{{item.ref_number}}/"},layout:{}}}},$scope.route_default={listing:{fr:"proprietes/{{item.location.region}}/{{item.location.city}}/{{item.transaction}}/{{item.ref_number}}",en:"listings/{{item.location.region}}/{{item.location.city}}/{{item.transaction}}/{{item.ref_number}}",es:"casas/{{item.location.region}}/{{item.location.city}}/{{item.transaction}}/{{item.ref_number}}"},broker:{fr:"courtiers/{{item.first_name}}-{{item.last_name}}/{{item.ref_number}}",en:"brokers/{{item.first_name}}-{{item.last_name}}/{{item.ref_number}}",es:"agentes/{{item.first_name}}-{{item.last_name}}/{{item.ref_number}}"},city:{fr:"villes/{{item.location.region}}/{{item.name}}/{{item.ref_number}}",en:"cities/{{item.location.region}}/{{item.name}}/{{item.ref_number}}",es:"ciudades/{{item.location.region}}/{{item.name}}/{{item.ref_number}}"},office:{fr:"bureaux/{{item.location.city}}/{{item.name}}/{{item.ref_number}}",en:"offices/{{item.location.city}}/{{item.name}}/{{item.ref_number}}",es:"oficinas/{{item.location.city}}/{{item.name}}/{{item.ref_number}}"},agency:{fr:"agences/{{item.name}}/{{item.ref_number}}",en:"agencies/{{item.name}}/{{item.ref_number}}",es:"agencias/{{item.name}}/{{item.ref_number}}"}},$scope.actions=[{label:"OK",action:function(){
$scope.buildAndClose($scope.model)}},{label:"Cancel",action:function(){$scope.cancel()}}],$scope.init=function($params){$scope.routes=$params.routes,$scope.groupType=$params.type,$scope.model=$params.model,$scope.detailsComponentShortcode=$scope.shortCodeMaps[$params.type],$siConfigs.load().then(function($response){$scope.configs=$response})},$scope.getDisplayedVarSelectionText=function($selections){const lLabels=$scope.availVars.filter($v=>$selections.includes($v.name)).reduce(($result,$cur)=>($result.push($cur.label.translate()),$result),[]);if(lLabels.length>6)return"{0} out of {1} selected".translate().siFormat(lLabels.length,$scope.availVars.length);else return lLabels.join(", ")},$scope.validate=function(){if(void 0==$scope.model.priority_group_sort)$scope.model.priority_group_sort=null;if(void 0==$scope.model.search_engine_options)$scope.model.search_engine_options={type:"full",search_box_placeholder:{fr:"",en:""},tabs:[],fields:[]};if($scope.model.list_layout.item_row_space.mobile>2)$scope.model.list_layout.item_row_space.desktop=Math.round(100/$scope.model.list_layout.item_row_space.desktop),$scope.model.list_layout.item_row_space.laptop=Math.round(100/$scope.model.list_layout.item_row_space.laptop),$scope.model.list_layout.item_row_space.tablet=Math.round(100/$scope.model.list_layout.item_row_space.tablet),$scope.model.list_layout.item_row_space.mobile=Math.round(100/$scope.model.list_layout.item_row_space.mobile)},$scope.validateAlias=function(){if($scope.aliasIsValid=true,$scope.usedAliasName.includes($scope.model.alias))$scope.aliasIsValid=false},$scope.buildAndClose=function(){return $scope.closeAndReturn($scope.model)},$scope.selectPage=function(){const dialogParams={lang:$scope.model.lang};if(void 0==$scope.model.layout)$scope.model.layout={page:""};dialogParams.page=$scope.model.layout.page,dialogParams.type=$scope.groupType,$siUI.dialog("page-picker",dialogParams).then($newPage=>{$scope.model.layout.page=$newPage})},$scope.selectForm=function(){const dialogParams={lang:$scope.model.lang};if(void 0==$scope.model.layout)$scope.model.layout.form_id="";dialogParams.form_id=$scope.model.layout.form_id,$siUI.dialog("form-picker",dialogParams).then($form=>{$scope.model.layout.form_id=$form,$scope.$emit("save-request")})},$scope.isActionValid=function($button){return true},$scope.resetDetails=function(){const $lang=$scope.model.lang,lDefault=$scope.details_defaults[$lang][$scope.groupType];$scope.model.route=Object.assign($scope.model.route,lDefault.route),$scope.model.layout=Object.assign($scope.model.route,{page:null,communication_mode:"basic",form_id:null},lDefault.route)},$scope.copyShortcodeToClipboard=function(){$siUtils.copyToClipboard($scope.detailsComponentShortcode)}}),siApp.controller("listEditDialogCtrl",function listEditDialogCtrl($scope,$rootScope,$q,$siApi,$siConfigs,$siUI){$scope.global_list=$rootScope.global_list,$scope.data_views=$rootScope.data_views,$scope.listItemLayoutList=[],$scope.listItemImageHoverEffects=[],$scope.listItemLayerHoverEffects=[],$scope.aliasIsValid=true,$scope.usedAliasName=[],$scope.actions=[{label:"OK",action:function(){$scope.buildAndClose($scope.model)}},{label:"Cancel",action:function(){$scope.cancel()}}],$scope.layerVariations={sold:false},$scope.tab={selectedIndex:0},$scope.init=function($params){if($scope.model=structuredClone($params),null!=$scope.model.source)$scope.model.$$source_id=$scope.model.source.id;$scope.usedAliasName=$siConfigs.configs.lists.filter($l=>$l!=$params).map($l=>$l.alias),$scope.listItemLayoutList=$rootScope.global_list.list_item_layouts[$scope.model.type],$scope.availVars=$rootScope.global_list.list_item_vars[$scope.model.type],$scope.listItemImageHoverEffects=$rootScope.global_list.list_item_image_hover_effects[$scope.model.type],$scope.listItemLayerHoverEffects=$rootScope.global_list.list_item_show_layer_effects[$scope.model.type],$scope.validate(),$scope.$on("siListPreview/editListItem",function(){console.log("listEditDialogCtrl@siListPreview/editListItem"),$scope.tab.selectedIndex=2})},$scope.displayedVarsChanged=function($layer){$scope.$broadcast("listItemLayer/vars:changed",$layer)},$scope.getDisplayedVarSelectionText=function($selections){const lLabels=$scope.availVars.filter($v=>$selections.includes($v.name)).reduce(($result,$cur)=>($result.push($cur.label.translate()),$result),[]);if(lLabels.length>6)return"{0} out of {1} selected".translate().siFormat(lLabels.length,$scope.availVars.length);else return lLabels.join(", ")},$scope.validate=function(){if(void 0==$scope.model.priority_group_sort)$scope.model.priority_group_sort=null;if(void 0==$scope.model.search_engine_options)$scope.model.search_engine_options={type:"full",search_box_placeholder:{fr:"",en:""},tabs:[],fields:[]};if($scope.model.list_layout.item_row_space.mobile>2)$scope.model.list_layout.item_row_space.desktop=Math.round(100/$scope.model.list_layout.item_row_space.desktop),$scope.model.list_layout.item_row_space.laptop=Math.round(100/$scope.model.list_layout.item_row_space.laptop),$scope.model.list_layout.item_row_space.tablet=Math.round(100/$scope.model.list_layout.item_row_space.tablet),$scope.model.list_layout.item_row_space.mobile=Math.round(100/$scope.model.list_layout.item_row_space.mobile)},$scope.validateAlias=function(){if($scope.aliasIsValid=true,$scope.usedAliasName.includes($scope.model.alias))$scope.aliasIsValid=false},$scope.buildAndClose=function(){$scope.renewSearchToken().then(function($searchToken){$scope.model.search_token=$searchToken;const lResult=structuredClone($scope.model);if(lResult.show_list_meta=void 0==lResult.show_list_meta?false:lResult.show_list_meta,void 0==lResult.source||lResult.source.id!=lResult.$$source_id)lResult.source=$scope.data_views.find(function($e){return $e.id==lResult.$$source_id});delete lResult.$$source_id,console.log("SaveOrClose",lResult,$scope.model),$scope.closeAndReturn(lResult)})},$scope.renewSearchToken=function(){let lFilters=$scope.buildFilters(),lPromise=$q(function($resolve,$reject){if(null!=lFilters)$scope.api("",lFilters,{url:wpSiApiSettings.api_root+"/api/utils/search_encode"}).then(function($response){$resolve($response)});else $resolve("")});return lPromise},$scope.buildFilters=function(){let lResult=null;if($scope.model.limit>0)lResult={max_item_count:$scope.model.limit};if(null!=$scope.model.sort&&""!=$scope.model.sort&&"auto"!=$scope.model.sort){if(null==lResult)lResult={};if(lResult.sort_fields=[{field:$scope.model.sort,desc:$scope.model.sort_reverse}],!isNullOrEmpty($scope.model.priority_group_sort)){const lPriorityDesc=$scope.model.priority_group_sort.indexOf("-desc")>0?true:false;lResult.sort_fields.unshift({field:"priority",desc:lPriorityDesc})}}if($scope.model.shuffle){if(null==lResult)lResult={};lResult.shuffle=$scope.model.shuffle}if(null!=$scope.model.filter_group){if(null==lResult)lResult={};lResult.filter_group=$scope.normalizeFilterGroup(angular.copy($scope.model.filter_group))}return lResult},$scope.normalizeFilterGroup=function($filter_group){if($filter_group.filters)$filter_group.filters.forEach(function($filter){if(["in","not_in"].indexOf($filter.operator)>=0){if("undefined"==typeof $filter.value.push)$filter.value=$filter.value.split(","),$filter.value.forEach(function($val){if(!isNaN($val))$val=Number($val)})}else if(!isNaN($filter.value))$filter.value=Number($filter.value)});if($filter_group.filter_groups)$filter_group.filter_groups.forEach(function($group){$scope.normalizeFilterGroup($group)});return $filter_group},$scope.switchSortReverse=function(){$scope.model.sort_reverse=!$scope.model.sort_reverse},$scope.configureSearchBar=function(){type=$scope.model.type,$siUI.dialog(type+"-search-engine-edit",$scope.model.search_engine_options).then($result=>{$scope.model.search_engine_options=$result})},$scope.renewSearchToken=function(){let lFilters=$scope.buildFilters(),lPromise=$q(function($resolve,$reject){if(null!=lFilters)$siApi.call("",lFilters,{url:wpSiApiSettings.api_root+"/api/utils/search_encode"}).then(function($response){$resolve($response)});else $resolve("")});return lPromise},$scope.buildFilters=function(){let lResult=null;if($scope.model.limit>0)lResult={max_item_count:$scope.model.limit};if(null!=$scope.model.sort&&""!=$scope.model.sort&&"auto"!=$scope.model.sort){if(null==lResult)lResult={};if(lResult.sort_fields=[{field:$scope.model.sort,desc:$scope.model.sort_reverse}],!isNullOrEmpty($scope.model.priority_group_sort)){const lPriorityDesc=$scope.model.priority_group_sort.indexOf("-desc")>0?true:false;lResult.sort_fields.unshift({field:"priority",desc:lPriorityDesc})}}if($scope.model.shuffle){if(null==lResult)lResult={};lResult.shuffle=$scope.model.shuffle}if(null!=$scope.model.filter_group){if(null==lResult)lResult={};lResult.filter_group=$scope.normalizeFilterGroup(angular.copy($scope.model.filter_group))}return lResult},$scope.normalizeFilterGroup=function($filter_group){if($filter_group.filters)$filter_group.filters.forEach(function($filter){if(["in","not_in"].indexOf($filter.operator)>=0){if("undefined"==typeof $filter.value.push)$filter.value=$filter.value.split(","),$filter.value.forEach(function($val){if(!isNaN($val))$val=Number($val)})}else if(!isNaN($filter.value))$filter.value=Number($filter.value)});if($filter_group.filter_groups)$filter_group.filter_groups.forEach(function($group){$scope.normalizeFilterGroup($group)});return $filter_group},$scope.isActionValid=function($button){if("OK"==$button.label)return $scope.aliasIsValid;else return true}}),siApp.controller("newListDialogCtrl",function newListDialogCtrl($scope,$rootScope,$q,$siConfigs,$siApi,$siUI){$scope.global_list=$rootScope.global_list,$scope.usedNames=[],$scope.data_views=$rootScope.data_views,$scope.listItemLayoutList=[],$scope.listItemImageHoverEffects=[],$scope.listItemLayerHoverEffects=[],$scope.actions=[{label:"OK",action:function(){$scope.buildAndClose()}},{label:"Cancel",action:function(){$scope.cancel()}}],$scope.presets={selected:"normal",list:[{value:"normal",label:"Normal",description:"Complete list with search engine"},{value:"small",label:"Small",description:"List with a limited amount of items, no search engine"},{value:"featured",label:"Featured",description:"Tiny list of item to display on a homepage"}]},$scope.init=function($params){$scope.model={type:$params.type},$scope.usedNames=$params.otherList.map($l=>$l.alias),console.log("newListDialogCtrl/init",$scope.usedNames),$scope.listItemLayoutList=$rootScope.global_list.list_item_layouts[$scope.model.type],$scope.availVars=$rootScope.global_list.list_item_vars[$scope.model.type],$scope.listItemImageHoverEffects=$rootScope.global_list.list_item_image_hover_effects[$scope.model.type],$scope.listItemLayerHoverEffects=$rootScope.global_list.list_item_show_layer_effects[$scope.model.type],$scope.initlializeModel(),$scope.updateModel()},$scope.updateModel=function(){const layoutPresetDefault=$rootScope.global_list.list_layouts[$scope.model.type][0].name,layoutPresetDefaultVars=$rootScope.global_list.list_item_layouts[$scope.model.type][0].vars,defaultMaps={normal:_=>{$scope.model.searchable=true,$scope.model.sortable=true,$scope.model.mappable=true,$scope.model.limit=0,$scope.model.alias=$scope.getValidAlias($scope.model.type+"-all"),$scope.model.list_layout.preset=layoutPresetDefault,$scope.model.list_layout.scope_class="si-border",$scope.model.search_engine_options.scope_class="si-border",$scope.model.list_item_layout.scope_class="si-border",$scope.model.list_item_layout.displayed_vars.main=layoutPresetDefaultVars},small:_=>{$scope.model.searchable=false,$scope.model.sortable=false,$scope.model.mappable=false,$scope.model.limit=3*$scope.model.list_layout.item_row_space.desktop,$scope.model.alias=$scope.getValidAlias($scope.model.type+"-list"),$scope.model.list_layout.preset=layoutPresetDefault,$scope.model.list_item_layout.displayed_vars.main=layoutPresetDefaultVars,$scope.model.list_item_layout.scope_class="si-border"},featured:_=>{$scope.model.searchable=false,$scope.model.sortable=false,$scope.model.mappable=false,$scope.model.limit=$scope.model.list_layout.item_row_space.desktop,$scope.model.shuffle=true,$scope.model.alias=$scope.getValidAlias($scope.model.type+"-featured"),$scope.model.list_layout.preset="direct",$scope.model.list_item_layout.scope_class="si-border",$scope.model.list_item_layout.displayed_vars.main=layoutPresetDefaultVars}};defaultMaps[$scope.presets.selected]()},$scope.getValidAlias=function($draft){let lResult=$draft,index=1;while($scope.usedNames.includes(lResult))lResult=$draft+"-"+index,index++;return lResult},$scope.initlializeModel=function(){$scope.model.$$source_id=$scope.data_views[0].id,$scope.model.filter_group={operator:"and",filters:[],filter_groups:[]},$scope.model.sort=null,$scope.model.sort_reverse=false,$scope.model.default_zoom_level="auto",$scope.model.smart_focus_tolerance=5,$scope.model.priority_group_sort=null,$scope.model.list_layout={preset:"standard",layout:"standard",scope_class:"",styles:null,use_styles:true,custom_css:"",item_row_space:{desktop:4,laptop:3,tablet:2,mobile:1}},$scope.model.list_item_layout={preset:"standard",layout:"standard",scope_class:"",image_hover_effect:"none",secondary_layer_effect:"fade",displayed_vars:{main:$scope.availVars.filter($v=>["price","address","city","category","subcategory","rooms","name","first_name","last_name","region","contacts","listing_count","agency-name"].includes($v.name)).map($v=>$v.name),secondary:null},styles:null,use_styles:true,primary_layer_position:"fix",secondary_layer_bg_opacity:75,custom_css:""},$scope.model.search_engine_options={type:"full",orientation:"h",focus_category:null,sticky:false,tabs:[],tabbed:false,filter_tags:"none",search_box_placeholder:{en:"Type here to begin your search...",fr:"Tapez ici pour commencer votre recherche ..."},fields:[]}},$scope.buildAndClose=function(){$scope.renewSearchToken().then(function($searchToken){$scope.model.search_token=$searchToken;const lResult=angular.copy($scope.model);if(lResult.show_list_meta=void 0==lResult.show_list_meta?false:lResult.show_list_meta,void 0==lResult.source)lResult.source=$scope.data_views.find(function($e){return $e.id==lResult.$$source_id});delete lResult.$$source_id,console.log("SaveOrClose",lResult,$scope.model),$scope.closeAndReturn(lResult)})},$scope.renewSearchToken=function(){let lFilters=$scope.buildFilters(),lPromise=$q(function($resolve,$reject){if(null!=lFilters)$siApi.call("",lFilters,{url:wpSiApiSettings.api_root+"/api/utils/search_encode"}).then(function($response){$resolve($response)});else $resolve("")});return lPromise},$scope.buildFilters=function(){let lResult=null;if($scope.model.limit>0)lResult={max_item_count:$scope.model.limit};if(null!=$scope.model.sort&&""!=$scope.model.sort&&"auto"!=$scope.model.sort){if(null==lResult)lResult={};if(lResult.sort_fields=[{field:$scope.model.sort,desc:$scope.model.sort_reverse}],!isNullOrEmpty($scope.model.priority_group_sort)){const lPriorityDesc=$scope.model.priority_group_sort.indexOf("-desc")>0?true:false;lResult.sort_fields.unshift({field:"priority",desc:lPriorityDesc})}}if($scope.model.shuffle){if(null==lResult)lResult={};lResult.shuffle=$scope.model.shuffle}if(null!=$scope.model.filter_group){if(null==lResult)lResult={};lResult.filter_group=$scope.normalizeFilterGroup(angular.copy($scope.model.filter_group))}return lResult},$scope.normalizeFilterGroup=function($filter_group){if($filter_group.filters)$filter_group.filters.forEach(function($filter){if(["in","not_in"].indexOf($filter.operator)>=0){if("undefined"==typeof $filter.value.push)$filter.value=$filter.value.split(","),$filter.value.forEach(function($val){if(!isNaN($val))$val=Number($val)})}else if(!isNaN($filter.value))$filter.value=Number($filter.value)});if($filter_group.filter_groups)$filter_group.filter_groups.forEach(function($group){$scope.normalizeFilterGroup($group)});return $filter_group}}),siApp.controller("accountLoginDialogCtrl",function($scope,$rootScope,$siApi,$siUI,$siUser){$scope.login_infos={email:"",password:""},$scope.actions=[{label:"Login",action:_=>{$scope.login()}},{label:"Cancel",action:_=>{$scope.cancel()}}],$scope.init=function(){},$scope.login=function(){$scope.actions[0]._working=true,$siApi.portal("auth/login",$scope.login_infos).then($response=>{if($scope.actions[0]._working=false,void 0==$response.statusCode||[10,20].includes($response.statusCode))return $siUI.alert($response.message.translate()),false;$siUser.info={token:$response.authTokenKey,user:{name:$response.context.user.name}},$scope.closeAndReturn($response),console.log("login",$response)},$error=>{const message=Object.keys($error.modelState).map($k=>$error.modelState[$k].join(" ").translate());$siUI.alert(message.join(" ")),$scope.actions[0]._working=false})},$scope.isActionValid=function($button){if("Login"==$button.label)return Object.keys($scope.login_infos).every($k=>""!=$scope.login_infos[$k]);else return true}}),siApp.controller("layerVarAddCustomDialogCtrl",function layerVarAddCustomDialogCtrl($scope,$rootScope){$scope.model={key:"",content:{fr:"",en:"",es:""}},$scope.actions=[{label:"OK",action:function(){$scope.buildAndClose($scope.model)}},{label:"Cancel",action:function(){$scope.cancel()}}],$scope.availableVarList=[],$scope.init=function($params){},$scope.buildAndClose=function($data){$data.key=$data.key.siSanitize(),$scope.closeAndReturn($data)},$scope.isValidAction=function($button){if("OK"==$button.label)return""!=$scope.model.key&&["fr","en","es"].some(k=>""!=$scope.model.content[k]);else return true}}),siApp.controller("layerVarEditDialogCtrl",function layerVarEditDialogCtrl($scope,$rootScope){$scope.model={classes:""},$scope.actions=[{label:"OK",action:function(){$scope.buildAndClose($scope.model)}},{label:"Cancel",action:function(){$scope.cancel()}}],$scope.availableVarList=[],$scope.init=function($params){if($scope.model=$params.var,["link_button"].includes($params.var.key))if(void 0==$scope.model.label)$scope.model.label={};$scope.availableVarList=$rootScope.global_list.list_item_vars[$params.type]},$scope.buildAndClose=function($data){$scope.closeAndReturn($data)}}),siApp.controller("registerDialogCtrl",function registerCtrl($scope,$rootScope,$timeout,$mdDialog,$q,$siUtils,$siUI,$siApi,$siConfigs,$siWP){$scope.login_infos={email:"",password:""},$scope.steps=["account","api_key","default_view","layout"],$scope.model={state:"login",credentials:null,account_id:null,api_key:null,default_view:null,layouts:[{icon:"home",type_name:"Listings",type:"listing",page:"NEW",detail_page:"NEW"},{icon:"users",type_name:"Brokers",type:"broker",page:"NEW",detail_page:"NEW"}]},$scope.accounts=[],$scope.api_keys=[],$scope.data_views=[],$scope.pages={},$scope.pageList={},$scope.languages={selected:"",list:[]},$scope.wizard_step=null,$scope.working=false,$scope.actions=[],$scope.init=function(){console.log("register dialog init"),$siWP.loadPages().then($pages=>{$scope.pageList=$pages,$scope.languages.list=$siWP.languages,$scope.languages.selected=$scope.languages.list[0].code}),$scope.$watch(function(){return $scope.wizard_step},function($new,$old){if($new!==$old)if(console.log("wizard_step:updated",$new,$old),null!=$new)$scope.updateWizard()})},$scope.signin=function(){$scope.signin_message=null,$scope.working=true,$siApi.portal("auth/login",$scope.login_infos).then($response=>{if($scope.working=false,[10,20].includes($response.statusCode))return $scope.signin_message=$response.message.translate(),false;$scope.model.state="configs",$scope.model.credentials=$response,$scope.startWizard()})},$scope.restorePreviousInstallation=function(){$siConfigs.restoreBackup({directMethod:"restoreEverything"})},$scope.hasBackup=function(){return null!=$siConfigs.configsBackup},$scope.selectAccount=function($account){$scope.model.global_account_id=$account.id,$scope.nextStep()},$scope.selectApiKey=function($key){$scope.model.account_id=$key.accountId,$scope.model.api_key=$key.id,$scope.nextStep()},$scope.selectDefaultView=function($view){if($scope.model.default_view=$view,$scope.hasBackup())$siUI.confirm("","A backup of your old configuration has been detected.\nWould you like to keep these settings?",{ok:"Yes",cancel:"No"}).then(function keep(){$scope.finishWithBackupMerge()},function continueNext(){$scope.nextStep()});else $scope.nextStep()},$scope.finishWithBackupMerge=function(){$siConfigs.data_views=$scope.data_views,$scope.wizard_step=0;const lConfigs=$scope.buildConfig(),lMergeConfigs=$siConfigs.mergeBackupToConfigs(lConfigs);$scope.model.state="complete",console.log("configs",lMergeConfigs),$siConfigs.clearBackup().then(_=>{$siApi.rest("configs",{settings:lMergeConfigs}).then(_=>{$timeout(_=>{window.location.reload(true)},1e3)})})},$scope.applyPageShortcodes=function(){$scope.actions=[];const lPageCalls=[],lPageDefMap={listing:{title:"Our listings",content:'[si alias="listings-all"]',title_details:"Listing details",content_details:"[si_listing]"},broker:{title:"Our team",content:'[si alias="brokers-all"]',title_details:"Broker details",content_details:"[si_broker]"}};if($scope.model.state="building",$scope.model.layouts.forEach($layout=>{if(lMap=lPageDefMap[$layout.type],"NONE"!=$layout.page){const params={page_id:$layout.page,title:lMap.title.translate(),content:lMap.content};lPageCalls.push({create:_=>$siApi.rest("page",params),layout:$layout,attr:"page"})}if("NONE"!=$layout.detail_page){const params={page_id:$layout.detail_page,title:lMap.title_details.translate(),content:lMap.content_details};lPageCalls.push({create:_=>$siApi.rest("page",params),layout:$layout,attr:"detail_page"})}}),0==lPageCalls.length)return $q.resolve();else return $q(($resolve,$reject)=>{$q.all(lPageCalls.map($c=>$c.create())).then($responses=>{console.log("All page done",$responses),$responses.forEach(($response,$index)=>{const lCall=lPageCalls[$index];if("NEW"==lCall.layout[lCall.attr])lCall.layout[lCall.attr]=$response}),$resolve()})})},$scope.preloadStep=function(){const credentialInfos={credentials:$scope.model.credentials},lStepDataLoader={account:_=>$siApi.portal("linked_account/list",null,null,credentialInfos).then($response=>{if($scope.accounts=$response,1==$scope.accounts.items.length)$scope.selectAccount($scope.accounts.items[0])}),api_key:_=>(credentialInfos.account_id=$scope.model.global_account_id,$siApi.portal("api_key/list",null,null,credentialInfos).then($response=>{if($scope.api_keys=$response,1==$scope.api_keys.items.length)$scope.selectApiKey($scope.api_keys.items[0])})),default_view:_=>$siApi.rest("account",{account_id:$scope.model.account_id,api_key:$scope.model.api_key},{method:"GET"}).then($response=>{if($scope.data_views=$response.data_views,1==$scope.data_views.length)$scope.selectDefaultView($scope.data_views[0])}),layout:_=>$scope.updatePageList()},lStepName=$scope.steps[$scope.wizard_step];if(void 0!=lStepDataLoader[lStepName])return lStepDataLoader[lStepName]();else return $q.resolve()},$scope.updatePageList=function(){const lDefer=$q.defer();return $timeout(_=>{console.log("updatePageList",$scope.languages.selected),$scope.pages=$scope.pageList[$scope.languages.selected],$scope.model.layouts.forEach($layout=>{const lContentMap={listing:{list:/\[si\s+alias="[^"]*listings[^"]*"\]/gi,details:"[si_listing]"},broker:{list:/\[si\s+alias="[^"]*brokers[^"]*"\]/gi,details:"[si_broker]"}},lContentMatches=lContentMap[$layout.type],lFoundPage=$scope.pages.find($p=>lContentMatches.list.test($p.post_content)),lFoundDetailPage=$scope.pages.find($p=>$p.post_content.includes(lContentMatches.details));$layout.page=null!=lFoundPage?lFoundPage.ID:"NEW",$layout.detail_page=null!=lFoundDetailPage?lFoundDetailPage.ID:"NEW"}),lDefer.resolve()}),lDefer.promise},$scope.startWizard=function(){$scope.wizard_step=0},$scope.finishWizard=function(){$scope.model.state="complete";const lConfigs=$scope.buildConfig();console.log("configs",lConfigs),$siApi.rest("configs",{settings:lConfigs}).then(_=>{$timeout(_=>{window.location.reload(true)},1e3)})},$scope.buildConfig=function(){const lTypeMap={listing:{en:{route:"listings/{{item.location.region}}/{{item.location.city}}/{{item.transaction}}/{{item.ref_number}}/",route_shortcut:"listing/{{item.ref_number}}/"},fr:{route:"proprietes/{{item.location.region}}/{{item.location.city}}/{{item.transaction}}/{{item.ref_number}}/",route_shortcut:"propriete/{{item.ref_number}}/"}},broker:{en:{route:"brokers/{{item.first_name}}-{{item.last_name}}/{{item.ref_number}}/",route_shortcut:"broker/{{item.ref_number}}/"},fr:{route:"courtiers/{{item.first_name}}-{{item.last_name}}/{{item.ref_number}}/",route_shortcut:"courtier/{{item.ref_number}}/"}}},lResult={account_id:$scope.model.account_id,api_key:$scope.model.api_key,default_view:$scope.model.default_view.id,lists:[$siUtils.createList($scope.model.default_view,"listings","listings-all","contract_start_date",true,30),$siUtils.createList($scope.model.default_view,"brokers","brokers-all","last_name")],listing_routes:$scope.languages.list.map($locale=>$locale.code).filter($locale=>$locale==$scope.languages.selected).map($locale=>({lang:$locale,route:lTypeMap.listing[$locale].route,shortcut:lTypeMap.listing[$locale].route_shortcut})),listing_layouts:$scope.languages.list.map($locale=>$locale.code).filter($locale=>$locale==$scope.languages.selected).map($locale=>{const detailPageId=$locale==$scope.languages.selected?$scope.model.layouts.find($l=>"listing"==$l.type).detail_page:null,detailPage=$scope.pages.find(p=>p.ID==detailPageId).post_name;return{lang:$locale,communication_mode:"basic",item_row_space:[33,33,50,100],page:detailPage}}),broker_routes:$scope.languages.list.map($locale=>$locale.code).filter($locale=>$locale==$scope.languages.selected).map($locale=>({lang:$locale,route:lTypeMap.broker[$locale].route,shortcut:lTypeMap.broker[$locale].route_shortcut})),broker_layouts:$scope.languages.list.map($locale=>$locale.code).filter($locale=>$locale==$scope.languages.selected).map($locale=>{const detailPageId=$locale==$scope.languages.selected?$scope.model.layouts.find($l=>"broker"==$l.type).detail_page:null,detailPage=$scope.pages.find(p=>p.ID==detailPageId).post_name;return{lang:$locale,communication_mode:"basic",page:detailPage}})};return lResult},$scope.updateWizard=function(){console.log("updateWizard:triggered",$scope.wizard_step);const lActions=[{key:"previous",label:"Previous step",action:function(){$scope.previousStep()}},{key:"next",label:"Next step",action:function(){$scope.nextStep()}}];if($scope.wizard_step==$scope.steps.length-1)lActions.pop(),lActions.push({key:"finish",label:"Finish",action:function(){$scope.applyPageShortcodes().then(function(){$scope.finishWizard()})}});const lWizardSteps=Array.from(document.querySelectorAll("#register-dialog .wizard-step"));console.log($scope.wizard_step,lWizardSteps,lWizardSteps[$scope.wizard_step]),lWizardSteps.forEach(function($e,$i){$e.classList.remove("show")}),document.querySelector("#register-dialog").classList.add("si-state-loading"),$scope.preloadStep().then(function(){document.querySelector("#register-dialog").classList.remove("si-state-loading"),lWizardSteps[$scope.wizard_step].classList.add("show"),$timeout(function(){$scope.actions=lActions})})},$scope.previousStep=function(){$scope.wizard_step-=1},$scope.nextStep=function(){$scope.wizard_step+=1},$scope.validateStep=function($index){const lStepValidator={account:_=>null!=$scope.model.account_id,api_key:_=>null!=$scope.model.api_key,default_view:_=>null!=$scope.default_view,layouts:_=>$scope.model.layouts.length>0},lStepName=$scope.steps[$index];if(void 0!=lStepValidator[lStepName])return lStepValidator[lStepName]();else return true},$scope.isNavButtonEnabled=function($button,$step){if("previous"==$button.key)if(0==$step)return false;else return true;return $scope.validateStep($step)}}),siApp.controller("changeDatasourcesDialogCtrl",function changeDatasourcesDialogCtrl($scope,$rootScope,$element,$timeout,$q,$siUtils,$siUI,$siApi){$scope.tab={selectedIndex:0},$scope.model={credentials:null,account_id:null,api_key:null,default_view:null},$scope.lists={fetching:null,accounts:null,views:null,api_keys:null},$scope.actions=[{label:"Select",action:_=>{$scope.buildAndClose()}},{label:"Cancel",action:_=>{$scope.cancel()}}],$scope.init=function($params){$scope.model.credentials=$params,$scope.fetchAccounts().then(_=>{if(1==$scope.lists.accounts.items.length)$siUI.alert("There's no other account in Bah Sin Se").then(_=>{$scope.close()})})},$scope.fetchAccounts=function(){const credentialInfos={credentials:$scope.model.credentials};return $scope.lists.fetching="accounts",$siApi.portal("linked_account/list",null,null,credentialInfos).then($response=>{$scope.lists.fetching=null,$scope.lists.accounts=$response})},$scope.selectAccount=function($account){$scope.lists.accounts.items.forEach($e=>delete $e._selected),$account._selected=true,$scope.tab.selectedIndex=1,$scope.model.account_id=$account.id,$scope.model.default_view=null,$scope.model.api_key=null,$scope.fetchApiKeys()},$scope.fetchApiKeys=function(){const credentialInfos={credentials:$scope.model.credentials,account_id:$scope.model.account_id};return $scope.lists.fetching="keys",$scope.lists.api_keys=null,$siApi.portal("api_key/list",null,null,credentialInfos).then($response=>{if($scope.lists.api_keys=$response,$scope.lists.fetching=null,1==$scope.lists.api_keys.items.length)$scope.selectKey($scope.lists.api_keys.items[0])})},$scope.selectKey=function($key){$scope.lists.api_keys.items.forEach($e=>delete $e._selected),$key._selected=true,$scope.tab.selectedIndex=2,$scope.model.account_id=$key.accountId,$scope.model.api_key=$key.id,$scope.model.default_view=null,$scope.fetchViews()},$scope.fetchViews=function(){return $scope.lists.fetching="views",$scope.lists.views=null,$siApi.rest("account",{account_id:$scope.model.account_id,api_key:$scope.model.api_key},{method:"GET"}).then($response=>{if($scope.lists.views=$response.data_views,$scope.lists.fetching=null,1==$scope.lists.views.length)$scope.selectView($scope.lists.views[0])})},$scope.selectView=function($view){$scope.lists.views.forEach($e=>delete $e._selected),$view._selected=true,$scope.model.default_view=$view},$scope.isActionValid=function($button){if("Select"==$button.label)return Object.keys($scope.model).every($k=>null!=$scope.model[$k]);else return true},$scope.buildAndClose=function(){delete $scope.model.credentials,$scope.closeAndReturn($scope.model)}}),siApp.controller("styleEditorDialogCtrl",function styleEditorDialogCtrl($scope,$rootScope,$element,$timeout,$q,$siUtils,$siUI){$scope.defaultStyles=$rootScope.global_list.styles,$scope.model={},$scope.actions=[{label:"Apply",action:_=>{$scope.buildAndClose()}},{label:"Cancel",action:_=>{$scope.cancel()}}],$scope.init=function($params){let lModel=angular.copy($params);if(console.log("styleEditorDialogCtrl/init",$params),"string"==typeof lModel){if(""==lModel)lModel="{}";try{lModel=JSON.parse(lModel)}catch($e){lModel={}}}lModel=$scope.validateModel(lModel),$scope.model=lModel,console.log("styleEditorDialogCtrl/init",lModel),$timeout(_=>{$scope.showPalette()},500)},$scope.validateModel=function($model){if(Object.keys($model).filter($k=>$k.startsWith("--")).forEach($k=>{let newKey=$k.replace(/(\-{2,3})/g,"").replace(/(\-[a-z])/g,$match=>$match.replace("-","_"));$model[newKey]=$model[$k],delete $model[$k]}),void 0==$model.border_style)$model.border_style="";if(void 0==$model.listing_item_picture_fit)$model.listing_item_picture_fit="";if(void 0==$model.broker_item_picture_fit)$model.broker_item_picture_fit="";return $model},$scope.showPalette=function($event=null){console.log($event);const lPaletteToShow=null==$event?"highlight":$event.currentTarget.dataset.palette;Array.from($element[0].querySelectorAll(".style-menu-item, .palette")).forEach($elm=>{if($elm.classList.remove("active"),lPaletteToShow==$elm.dataset.palette)$elm.classList.add("active")})},$scope.exists=function(){},$scope.toggle=function(){},$scope.reset=function(){$scope.model={}},$scope.buildAndClose=function(){
$scope.closeAndReturn($scope.model)}}),siApp.controller("pagePickerDialogCtrl",function pagePickerDialogCtrl($scope,$rootScope,$element,$timeout,$q,$siApi,$siWP){$scope.model={},$scope.selectedPage=null,$scope.pageList=[],$scope.isLoading=true,$scope.isAddingPage=false,$scope.newpage={name:""},$scope.init=function($params){$scope.model=$params,$scope.model.type={listings:"listing",brokers:"broker",offices:"office",agencies:"agency",cities:"city"}[$scope.model.type],console.log($scope.model),$scope.fetchPages().then(_=>{$scope.resetActions()})},$scope.resetActions=function(){$scope.actions=[{label:"Select",action:_=>{$scope.buildAndClose()},isValid:_=>$scope.pageList.some($p=>true===$p._selected)},{label:"Cancel",action:_=>{$scope.cancel()},isValid:_=>true}]},$scope.addPage=function(){$scope.newpage={name:"Page for "+$scope.model.type,content:`[si_${$scope.model.type}]`},$scope.isAddingPage=true,$scope.actions=[{label:"Create",action:_=>{$scope.createPage()},isValid:_=>""!=$scope.newpage.name},{label:"Cancel",action:_=>{$scope.cancelCreatePage()},isValid:_=>true}]},$scope.cancelCreatePage=function(){$scope.isAddingPage=false,$scope.resetActions()},$scope.createPage=function(){console.log("creating page",$scope.newpage),$siWP.addPage($scope.newpage.name,$scope.newpage.content,$scope.model.lang).then($newPageInfo=>{console.log("creating page:result",$newPageInfo),$scope.isAddingPage=false,$scope.model.page=$newPageInfo,$scope.fetchPages().then(_=>{$scope.buildAndClose()})})},$scope.fetchPages=function(){return $scope.isLoading=true,$siWP.loadPagesForLang($scope.model.lang).then($pages=>{$pages.forEach($p=>{if(delete $p.post_content,$p.post_name==$scope.model.page)$p._selected=true;if($p.ID==$scope.model.page)$p._selected=true}),$scope.pageList=$pages,$scope.isLoading=false})},$scope.selectPage=function($page){$scope.pageList.forEach($p=>{delete $p._selected}),$page._selected=true},$scope.buildAndClose=function(){const selected=$scope.pageList.find($p=>true===$p._selected);if(selected.post_parent>0){const fullpath=[selected.post_name];let parentId=selected.post_parent;do{const parent=$scope.pageList.find($p=>$p.ID==parentId);fullpath.unshift(parent.post_name),parentId=parent.post_parent}while(parentId>0);selected.post_name=fullpath.join("/")}console.log("pagePickerDialog/buildAndClose",selected),$scope.closeAndReturn(selected.post_name)}}),siApp.controller("formPickerDialogCtrl",function formPickerDialogCtrl($scope,$rootScope,$element,$timeout,$q,$siApi,$siWP){$scope.model={},$scope.selectedForm=null,$scope.formList=[],$scope.isLoading=true,$scope.actions=[{label:"Select",action:_=>{$scope.buildAndClose()},isValid:_=>$scope.formList.some($p=>true===$p._selected)},{label:"Cancel",action:_=>{$scope.cancel()},isValid:_=>true}],$scope.init=function($params){$scope.model=$params,$scope.fetchForms().then(_=>{})},$scope.fetchForms=function(){return $scope.isLoading=true,$siApi.rest("form/list",null,{method:"GET"}).then(function($response){$response.forEach($p=>{if($p.title==$scope.model.form_id)$p._selected=true;if($p.id==$scope.model.form_id)$p._selected=true}),$scope.isLoading=false,$scope.formList=$response})},$scope.selectForm=function($form){$scope.formList.forEach($p=>{delete $p._selected}),$form._selected=true},$scope.buildAndClose=function(){const selected=$scope.formList.find($p=>true===$p._selected);console.log("formPickerDialog/buildAndClose",selected),$scope.closeAndReturn(selected.id)}}),siApp.controller("siDialogController",function($scope,$rootScope,$mdDialog,$params){$scope.$params=$params,$scope.actions=[{label:"OK",action:function(){$scope.cancel()}}],$scope.cancel=function(){$mdDialog.cancel()},$scope.closeAndReturn=function($result){$mdDialog.hide($result)}}),siApp.controller("logInfoDialogCtrl",function logInfoDialogCtrl($scope,$rootScope,$siApi,$q){$scope.content="",$scope.version=wpSiApiSettings.app_version,$scope.isLoading=true,$scope.init=function(){$scope.loadContent()},$scope.loadContent=function(){$scope.isLoading=true,$siApi.rest("readme").then($content=>{const converter=new showdown.Converter,html=converter.makeHtml($content);$scope.content=html,$scope.isLoading=false})}}),siApp.controller("documentationDialogCtrl",function documentationDialogCtrl($scope,$rootScope,$siUtils,$q){$scope.shortcodes=[{name:"Standalone calculator",description:"Display a calculator combining mortgage and tax transfer.",code:"[si_tool_calculator]"},{name:"Search",description:"Display a standalone search engine. You must provide a list alias and a valid result page.",code:'[si_search alias="listing-all" result_page="/listings"]'},{name:"Searchbox",description:"Display a simple search input box. You must provide a list alias and a valid result page.",code:'[si_searchbox alias="listing-all" result_page="/listings"]'},{name:"List slider",description:"Display slider of either listings, brokers, offices or agencies. You must provide a list alias.",code:'[si_list_slider alias="listing-all"]'},{name:"List of items",description:"Display a list of either listings, brokers, offices or agencies. You must provide a list alias.",code:'[si alias="listing-all"]'},{name:"Listing details",description:"Display all information about a listing",code:"[si_listing]"},{name:"Broker details",description:"Display all information about a broker",code:"[si_broker]"},{name:"Office details",description:"Display all information about a office",code:"[si_office]"},{name:"Agency details",description:"Display all information about a agency",code:"[si_agency]"}],$scope.hooks=[{name:"Page template",description:"Return the page template path for listing, broker, office or agency details",type:"filter",key:"si/page_builder/get_page_template",params:["$page_template"]},{name:"Label",description:"Change the label",type:"filter",key:"si/label",params:["$label"]},{name:"Lexicon label",description:"Change the label of a lexicon item",type:"filter",key:"si/lexicon/label",params:["$label"]},{name:"Lexicon file path",description:"Change the path for the lexicon base JSON file.",type:"filter",key:"si/lexicon/path",params:["$path","$locale"]},{name:"Listing details content",description:"Change the inner content of the listing details",type:"filter",key:"si/listing/detail/content",params:["$content","$ref_number","$listing_data"]},{name:"Listing details class",description:"Change the class for listing details",type:"filter",key:"si/single-listing/class",params:["$class"]},{name:"Broker details content",description:"Change the inner content of the broker details",type:"filter",key:"si/broker/detail/content",params:["$content","$ref_number","$broker_data"]},{name:"Broker details class",description:"Change the class for broker details",type:"filter",key:"si/single-broker/class",params:["$class"]},{name:"Office details content",description:"Change the inner content of the office details",type:"filter",key:"si/office/detail/content",params:["$content","$ref_number","$office_data"]},{name:"Office details class",description:"Change the class for office details",type:"filter",key:"si/single-office/class",params:["$class"]}],$scope.search={text:""},$scope.init=function(){},$scope.copyToClipboard=function($text){$siUtils.copyToClipboard($text)},$scope.getHookCode=function($hook){if("filter"==$hook.type)return`\n      add_filter('${$hook.key}', function(${$hook.params.join(", ")}){\n        // Do your stuff here\n\n        return ${$hook.params[0]};\n      },10,${$hook.params.length});\n      `;else return`\n      add_action('${$hook.key}', function(${$hook.params.join(", ")}){\n        // Do your stuff here\n\n      },10,${$hook.params.length});\n      `}}),siAdminDirectiveTemplatePath=function($path,$useTimeVersioning){$useTimeVersioning=void 0==$useTimeVersioning?true:$useTimeVersioning;let lTimeQS="";if($useTimeVersioning)lTimeQS="?t="+(new Date).getTime();return"/"+wpSiApiSettings.base_path.trimChar("/")+"/views/admin/statics/"+$path+".html"+lTimeQS},siApp.directive("siClickScope",function siClickScope(){return{restrict:"A",link:function($scope,$element,$attr){$element[0].addEventListener("click",e=>{e.stopPropagation(),e.preventDefault()})}}}),siApp.directive("lstr",["$parse","$compile","$timeout",function lstr($parse,$compile,$timeout){return{restrict:"E,A",compile:function compile(tElement,tAttrs,transclude){return{pre:function preLink(scope,iElement,iAttrs,controller){if(void 0==iElement.html())return"NA";let lTranslatedContent=iElement.html().translate(),lFormatParams=iAttrs.params;if(null==lFormatParams&&""!=iAttrs.lstr)lFormatParams=iAttrs.lstr;if(null!=lFormatParams){if(lFnFormatParams=$parse(lFormatParams),lFormatParams=lFnFormatParams(scope),!Array.isArray(lFormatParams))lFormatParams=[lFormatParams];lTranslatedContent=lTranslatedContent.format.apply(lTranslatedContent,lFormatParams)}scope._originalTranslation=lTranslatedContent,lTranslatedContent=scope.parseContent(lTranslatedContent),iElement.html("<span>"+lTranslatedContent+"</span>")}}},controller:function($scope,$element,$timeout){$scope.reparseTimeoutHdl=null,$scope.reparse=function(){if(null!=$scope.reparseTimeoutHdl)$timeout.cancel($scope.reparseTimeoutHdl),$scope.reparseTimeoutHdl=null;$scope.reparseTimeoutHdl=$timeout(_=>{$element.html($scope.parseContent($scope._originalTranslation))})},$scope.parseContent=($content=>{if($content.indexOf("{{")>=0){let lWatchApplied=false;$content=$content.replace(/(\{\{(?:[^}]+)}})/g,$match=>{const lExpression=$match.replace(/(\{|\})/g,""),lParseFn=$parse(lExpression);let lParsed=lParseFn($scope);if(void 0==lParsed&&!lWatchApplied)return $scope.$watch(lExpression,function($old,$new){if($old!=$new)$scope.reparse()}),lWatchApplied=true,$match;else return lParsed})}return $content})}}}]),["Title","Placeholder"].forEach($k=>{siApp.directive("ls"+$k,["$parse","$compile","$timeout",function($parse,$compile,$timeout){return{restrict:"A",compile:function compile(tElement,tAttrs,transclude){return{pre:function preLink(scope,iElement,iAttrs,controller){const attValue=iAttrs[`ls${$k}`];iElement[0].setAttribute($k.toLowerCase(),attValue.translate())}}}}}])}),siApp.directive("siWpMedia",["$parse",function siWpMedia($parse){return{restrict:"E",templateUrl:siAdminDirectiveTemplatePath("si-wp-media"),replace:true,scope:{model:"=siModel",type:"@?",caption:"@?",placeholder:"@?",onChange:"&?siChange"},link:function($scope,$elm,$attr){if(void 0==$scope.type)$scope.type="image";$scope.init($elm[0])},controller:function($scope,$rootScope,$timeout,$q,$siUI,$siUtils){$scope._wpDialog=null,$scope.init=function(){},$scope.selectMedia=function(){$scope.openMedia()},$scope.openMedia=function(){const lDialog=$scope.getDialog();lDialog.open()},$scope.getDialog=function(){if(null!=$scope._wpDialog)return $scope._wpDialog;const wpDialog=wp.media({title:"Select Media",multiple:false,library:{type:$scope.type}});return wpDialog.on("close",function(){const lSelection=wpDialog.state().get("selection"),lMedia=[];if(lSelection.each(function($item){console.log("attachement",$item);const lAttr=$item.attributes;lMedia.push(lAttr)}),lMedia.length>0)$timeout(function(){$scope.model=lMedia[0],$scope.triggerChange()})}),$scope._wpDialog=wpDialog,wpDialog},$scope.clearMedia=function(){$scope.model=null,$scope.triggerChange()},$scope.triggerChange=function(){if("function"==typeof $scope.onChange)$scope.onChange({$media:$scope.model})}}}}]),siApp.directive("layoutGap",function layoutGap(){return{restrict:"A",link:function($scope,$element,$attrs){const gap=$attrs.layoutGap||1;$element[0].style.gap=gap+"rem"}}}),siApp.directive("siWorkingState",function siWorkingState(){return{restrict:"E",replace:true,template:`\n    <div class="si-working-state {{model.class}}" ng-init="init()">\n      <div class="state-container">\n        <div class="state-icon"><i class="fal {{model.icon}}"></i></div>\n        <div class="state-text">{{model.text.translate()}}</div>\n      </div>\n    </div>\n    `,controller:function($scope,$element,$timeout,$q){$scope.model={icon:"fa-check",text:"Done",class:"normal",hide_timeout:0},$scope.init=function(){$scope.$on("si/working-state/changed",function($event,$data){$scope.model.hide_timeout=0,$scope.show($data).then(visibilityChanged=>{if(!visibilityChanged)return console.log("already shown, update model"),$scope.updateModel($data)}).then(_=>{if(console.log("update of model done, component displayed",$scope.model,$data),$scope.model.hide_timeout>0)$timeout(_=>{$scope.hide()},$scope.model.hide_timeout)})})},$scope.show=function($data){if($element[0].classList.contains("show"))return $q.resolve(false);const defer=$q.defer();return $element[0].addEventListener("transitionend",()=>{defer.resolve(true)},{once:true}),$timeout(_=>{angular.merge($scope.model,$data)}),$timeout(_=>{$element[0].classList.add("show")},250),defer.promise},$scope.hide=function(){$element[0].classList.remove("show")},$scope.updateModel=function($newValue){const defer=$q.defer();return $element[0].addEventListener("transitionend",()=>{angular.merge($scope.model,$newValue),$element[0].classList.remove("si-switch"),defer.resolve()},{once:true}),$element[0].classList.add("si-switch"),defer.promise}}}}),siApp.directive("siDataGroupEditor",[function siDataGroupEditor(){return{restrict:"E",replace:true,scope:true,templateUrl:siAdminDirectiveTemplatePath("si-data-group-editor"),link:function($scope,$element,$attrs){const lAssoc={listings:"listing",cities:"city",brokers:"broker",offices:"office",agencies:"agency"};$scope.groupType=$attrs.siType,$scope.routes=lAssoc[$scope.groupType]+"_routes",$scope.layout=lAssoc[$scope.groupType]+"_layouts",$scope.init()},controller:function($scope,$siUtils,$siApi,$q,$timeout,$siUI,$siWP){$scope.lang_codes=[{key:"fr",label:"Français"},{key:"en",label:"English"},{key:"es",label:"Español"}],$scope.details_defaults={fr:{listings:{route:{route:"proprietes/{{item.location.region}}/{{item.location.city}}/{{item.transaction}}/{{item.ref_number}}/",shortcut:"propriete/{{item.ref_number}}/"},layout:{}},brokers:{route:{route:"courtiers/{{item.first_name}}-{{item.last_name}}/{{item.ref_number}}/",shortcut:"courtier/{{item.ref_number}}/"},layout:{}},offices:{route:{route:"bureaux/{{item.name}}/{{item.ref_number}}/",shortcut:"bureau/{{item.ref_number}}/"},layout:{}},agencies:{route:{route:"agences/{{item.name}}/{{item.ref_number}}/",shortcut:"agence/{{item.ref_number}}/"},layout:{communication_mode:"basic",form_id:null}},cities:{route:{route:"villes/{{item.location.region}}/{{item.name}}/{{item.ref_number}}/",shortcut:"ville/{{item.ref_number}}/"},layout:{}}},en:{listings:{route:{route:"listings/{{item.location.region}}/{{item.location.city}}/{{item.transaction}}/{{item.ref_number}}/",shortcut:"listing/{{item.ref_number}}/"},layout:{}},brokers:{route:{route:"brokers/{{item.first_name}}-{{item.last_name}}/{{item.ref_number}}/",shortcut:"broker/{{item.ref_number}}/"},layout:{}},offices:{route:{route:"offices/{{item.name}}/{{item.ref_number}}/",shortcut:"office/{{item.ref_number}}/"},layout:{}},agencies:{route:{route:"agencies/{{item.name}}/{{item.ref_number}}/",shortcut:"agency/{{item.ref_number}}/"},layout:{}},cities:{route:{route:"cities/{{item.location.region}}/{{item.name}}/{{item.ref_number}}/",shortcut:"city/{{item.ref_number}}/"},layout:{}}},es:{listings:{route:{route:"propiedades/{{item.location.region}}/{{item.location.city}}/{{item.transaction}}/{{item.ref_number}}/",shortcut:"propiedad/{{item.ref_number}}/"},layout:{}},brokers:{route:{route:"agentes/{{item.first_name}}-{{item.last_name}}/{{item.ref_number}}/",shortcut:"agente/{{item.ref_number}}/"},layout:{}},offices:{route:{route:"oficinas/{{item.name}}/{{item.ref_number}}/",shortcut:"despacho/{{item.ref_number}}/"},layout:{}},agencies:{route:{route:"agencias/{{item.name}}/{{item.ref_number}}/",shortcut:"agencia/{{item.ref_number}}/"},layout:{}},cities:{route:{route:"ciudad/{{item.location.region}}/{{item.name}}/{{item.ref_number}}/",shortcut:"ciudades/{{item.ref_number}}/"},layout:{}}}},$scope.init=function(){$scope.$on("si/ready",function(){$scope.prepare()})},$scope.prepare=function(){const langList=$scope.configs[$scope.routes].map($r=>{let layoutItem=$scope.configs[$scope.layout].filter($l=>null!=$l).find($l=>$l.lang==$r.lang);if(null==layoutItem)return console.error("layout item for",$r,"seems to be corrupted"),null;else return{lang:$r.lang,route:$r,layout:layoutItem}});$scope.langList=langList.filter(l=>null!=l),console.log("siDataGroupEditor/prepare",langList)},$scope.hasMinLangCount=function(){return $scope.langList.length>1},$scope.rebuild=function(){const{routes:routes,layouts:layouts}=$scope.langList.reduce(($result,$langItem)=>($result.routes.push($langItem.route),$result.layouts.push($langItem.layout),$result),{routes:[],layouts:[]});$scope.configs[$scope.layout]=layouts,$scope.configs[$scope.routes]=routes,console.log("siDataGroupEditor/rebuild",$scope.configs),$scope.$emit("save-request"),console.log("save-request emitted")},$scope.langNotConfigure=function($item){if(void 0==$scope.langList)return false;if(null==$scope.langList)return false;else return 0==$scope.langList.filter($l=>$l.lang==$item.key).length},$scope.addLangItem=function($lang){const lDefault=$scope.details_defaults[$lang][$scope.groupType];$scope.langList.push({lang:$lang,route:Object.assign({lang:$lang},lDefault.route),layout:Object.assign({lang:$lang,page:null,communication_mode:"basic",form_id:null},lDefault.layout)}),$scope.rebuild()},$scope.editLangItem=function($langItem){$siUI.dialog("lang-item-edit",{model:angular.copy($langItem),type:$scope.groupType,routes:$scope.routes}).then($modified=>{angular.merge($langItem,$modified),$scope.rebuild()})},$scope.editLayoutPage=function($langItem){const defer=$q.defer();if(defer.promise.then($page=>{$siWP.getPage($page).then($pageInfo=>{if(null==$pageInfo)return $siAlert("Unable to find the page");window.open(`/wp-admin/post.php?post=${$pageInfo.ID}&action=edit`)})}),null==$langItem.layout.page)$siUI.confirm("There is no layout page configured for this item. Would you like to select one?").then(_=>{$scope.selectPage($langItem).then($page=>{defer.resolve($page)})});else defer.resolve($langItem.layout.page)},$scope.removeLang=function($index){$scope.langList.splice($index,1),$scope.rebuild()},$scope.add=function($type){const lOtherList=$scope.configs.lists.filter($l=>$l.type==$type);$siUI.dialog("new-list",{type:$type,otherList:lOtherList}).then($result=>{if($scope.configs.lists.push($result),null==$scope.langList||0==$scope.langList.length)$scope.addLangItem("fr"),$scope.addLangItem("en");$scope.rebuild()})},$scope.edit=function($list){$scope.modify($list)},$scope.modify=function($list){return $siUI.dialog("list-edit",$list).then($result=>{console.log($result);for(const key in $result)if($result.hasOwnProperty(key)){const element=$result[key];$list[key]=element}if(true==$list.is_default_type_configs)$scope.configs.lists.filter($l=>$l.type==$list.type).filter($l=>$l!=$list).forEach($l=>{$l.is_default_type_configs=false});$scope.$emit("save-request")})},$scope.clone=function($list){$siUI.confirm("Are you sure you want to clone this list?").then(_=>{const listCopy=angular.copy($list);listCopy.alias=$scope.getValidAlias(listCopy.alias),listCopy.is_default_type_configs=false,$scope.configs.lists.push(listCopy),$scope.$emit("save-request")})},$scope.remove=function($list){$scope.confirm("Are you sure you want to remove this list?","This action could renders some sections of your site blank",{ok:"Continue"}).then(function(){let lNewlists=[];$scope.configs.lists.forEach(function($e){if($e!=$list)lNewlists.push($e)}),$scope.configs.lists=lNewlists,$scope.show_toast("List removed"),$scope.rebuild()})},$scope.getListShortcode=function($list,$type=null){switch($type){case"search":return'[si_search alias="'+$list.alias+'" result_page="/proprietes/" standalone="true"]';break;case"searchbox":return'[si_searchbox alias="'+$list.alias+'" placeholder="Type here to begin your search..." result_page="/proprietes/"]';break;case"gallery":return'[si_list_slider alias="'+$list.alias+'" limit="10"]';break;default:return'[si alias="'+$list.alias+'"]'}},$scope.countFilters=function($list){let lResult=0;if(null!=$list.filter_groups)$list.filter_groups.forEach(function($e){lResult+=$e.filters.length});return lResult},$scope.getValidAlias=function($draft){let lResult=$draft,index=1;const usedNames=$scope.configs.lists.filter($l=>$l.type==$scope.groupType).map($l=>$l.alias);while(usedNames.includes(lResult))lResult=$draft+"-"+index,index++;return lResult}}}}]),siApp.directive("siRouteBox",function siRouteBox($siUtils,$siList,$siUI){return{restrict:"E",scope:{route:"=",removeHandler:"&onRemove",list:"=",type:"@",changeHandler:"&siChange"},templateUrl:siAdminDirectiveTemplatePath("si-route-box"),replace:true,link:function($scope,$elm,$attr){$scope.init()},controller:function($scope){const lAssoc={listings:"listing",cities:"city",brokers:"broker",offices:"office",agengies:"agency"};$scope.lang_codes={fr:"Français",en:"English",es:"Español"},$scope.route_listing_elements={"{{item.ref_number}}":"ID","{{item.transaction}}":"Transaction type","{{item.location.region}}":"Region","{{item.location.city}}":"City","{{item.location.street}}":"Street","{{item.location.civic_address}}":"Address"},$scope.route_broker_elements={"{{item.ref_number}}":"ID","{{item.first_name}}":"First name","{{item.last_name}}":"Last name"},$scope.route_city_elements={"{{item.ref_number}}":"ID","{{item.location.region}}":"Region","{{item.name}}":"Name"},$scope.route_office_elements={"{{item.ref_number}}":"ID","{{item.location.region}}":"Region","{{item.location.city}}":"City","{{item.name}}":"Name"},$scope.route_agency_elements={"{{item.ref_number}}":"ID","{{item.name}}":"Name"},$scope.route_default={listing:{fr:"proprietes/{{item.location.region}}/{{item.location.city}}/{{item.transaction}}/{{item.ref_number}}",en:"listings/{{item.location.region}}/{{item.location.city}}/{{item.transaction}}/{{item.ref_number}}",es:"casas/{{item.location.region}}/{{item.location.city}}/{{item.transaction}}/{{item.ref_number}}"},broker:{fr:"courtiers/{{item.first_name}}-{{item.last_name}}/{{item.ref_number}}",en:"brokers/{{item.first_name}}-{{item.last_name}}/{{item.ref_number}}",es:"agentes/{{item.first_name}}-{{item.last_name}}/{{item.ref_number}}"},city:{fr:"villes/{{item.location.region}}/{{item.name}}/{{item.ref_number}}",en:"cities/{{item.location.region}}/{{item.name}}/{{item.ref_number}}",es:"ciudades/{{item.location.region}}/{{item.name}}/{{item.ref_number}}"},office:{fr:"bureaux/{{item.location.city}}/{{item.name}}/{{item.ref_number}}",en:"offices/{{item.location.city}}/{{item.name}}/{{item.ref_number}}",es:"oficinas/{{item.location.city}}/{{item.name}}/{{item.ref_number}}"},agency:{fr:"agences/{{item.name}}/{{item.ref_number}}",en:"agencies/{{item.name}}/{{item.ref_number}}",es:"agencias/{{item.name}}/{{item.ref_number}}"}},$scope.route_elements={},$scope.init=function(){console.log("Init routeBox with type",$scope.type),$scope.route_elements=$scope["route_"+lAssoc[$scope.type]+"_elements"]},$scope.hasMinRouteCount=function(){if(null==$scope.list||void 0==$scope.list)return true;if($scope.list.length<=1)return true;else return false},$scope.langIsUsed=function($lang){if(null==$scope.list||void 0==$scope.list)return true;else return $scope.list.some($e=>$e.lang==$lang)},$scope.elementIsUsed=function($elm,$partKey){if(void 0==$scope.route)return false;if(""==$scope.route[$partKey])return false;else return $scope.route[$partKey].indexOf($elm)>=0},$scope.elementUseCount=function($partKey){let lResult=0;if(void 0==$scope.route)return 0;if(null==$scope.route_elements||void 0==$scope.route_elements)return 0;if(void 0==$scope.route[$partKey])return 0;let lRouteElms=$siUtils.toKeyArray($scope.route_elements);return lRouteElms.forEach(function($e){if($scope.route[$partKey].indexOf($e)>=0)lResult++}),lResult},$scope.reset=function(){$scope.route.route=$scope.route_default[$scope.type][$scope.route.lang]},$scope.elementAvailable=function($partKey){if(null==$scope.route_elements||void 0==$scope.route_elements)return 0;let lRouteElms=$siUtils.toKeyArray($scope.route_elements),lResult=lRouteElms.length-$scope.elementUseCount($partKey);return lResult},$scope.remove=function(){let fnRemove=function(){$scope.list.forEach(function($e,$i){if($e!=$scope.route);else $scope.list.splice($i,1)})};if(""==$scope.route.route)fnRemove();else $siUI.confirm("Are you sure you want to remove this route?").then(function(){fnRemove()})},$scope.update=function(){if("function"==typeof $scope.changeHandler)$scope.changeHandler({route:$scope.route})},$scope.addRouteElement=function($key,$partKey){$scope.route[$partKey]+=$key,$scope.update()}}}}),siApp.directive("siFilterGroup",function siFilterGroup(){let dir_controller=function($scope,$rootScope){$scope.filter_group_operators={and:"And",or:"Or"},$scope.$watch("model",function(){$scope.init()}),$scope.init=function(){console.log("filter_group model",$scope.model,$scope.parent)},$scope.addFilterGroup=function(){if(null==$scope.model.filter_groups)$scope.model.filter_groups=[];$scope.model.filter_groups.push({filters:null,operator:"and"})},$scope.removeGroup=function(){$scope.removeFromList($scope.model,$scope.parent,"filter_groups")},$scope.removeFromList=function($item,$parent,$name){let lNewList=[];if($list=$parent[$name],$list.forEach(function($elm){if(JSON.stringify($elm)!=JSON.stringify($item))lNewList.push($elm)}),0==lNewList.length)lNewList=null;$parent[$name]=lNewList},$scope.addFilter=function($group){if(null==$scope.model.filters)$scope.model.filters=[];$scope.model.filters.push({field:"",operator:"Equal",value:""})},$scope.switchOperator=function($newOperator){$scope.model.operator=$newOperator}};return{restrict:"E",scope:{model:"=ngModel",type:"=siType",parent:"=ngParent"},controllerAs:"ctrl",template:'<div ng-include="\'filter-group\'" class="si-filter-group group-operator-{{model.operator}}"></div>',controller:dir_controller}}),siApp.directive("siFilterItem",function siFilterItem($siUtils,$siList){return{restrict:"E",scope:{filter:"=ngModel",type:"=siType",removeHandler:"&onRemove"},templateUrl:siAdminDirectiveTemplatePath("si-filter-item"),replace:true,link:function($scope,$elm,$attr){$scope.init()},controller:function($scope){$scope.value_choices=[],$scope.selected_key="price.sell.amount",$scope.selected_filter_key=null,$scope.filter_key_list={listings:[{value:"ref_number",label:"Ref. number",value_type:"text",op_in:["in","not_in"]},{value:"price.sell.amount",label:"Selling price",value_type:"number",op_out:["like","not_like"]},{value:"price.lease.amount",label:"Leasing price",value_type:"number",op_out:["like","not_like"]},{value:"location.country_code",label:"Country",value_type:"list",choices:"getCountryList",op_in:["in","not_in"]},{value:"location.state_code",label:"State/Province",value_type:"list",choices:"getStateList",op_in:["in","not_in"]},{value:"location.region_code",label:"Region",value_type:"list",choices:"getRegionList",op_in:["in","not_in"]},{value:"location.city_code",label:"City",value_type:"list",choices:"getCityList",op_in:["in","not_in"]},{value:"category_code",label:"Category",value_type:"list",choices:"getCategoryList",op_in:["in","not_in"]},{value:"subcategory_code",label:"Subcategory",value_type:"list",choices:"getSubcategoryList",op_in:["in","not_in"]},{value:"open_houses[0].end_date",label:"Open house date",value_type:"text",choices:"udf.now():Now"},{value:"main_unit.bedroom_count",label:"Bedroom count",value_type:"number",op_out:["like","not_like"]},{value:"main_unit.bathroom_count",label:"Bathroom count",value_type:"number",op_out:["like","not_like"]},{value:"attributes.PARKING",label:"Parking count",value_type:"number",op_out:["like","not_like"]},{value:"attributes.GARAGE",label:"Garage",value_type:"bool",op_in:["equal","not_equal_to"]},{value:"attributes.POOL",label:"Pool",value_type:"bool",op_in:["equal","not_equal_to"]},{value:"status_code",label:"Status",value_type:"text",choices:"SOLD:Sold|AVAILABLE:Available",op_in:["equal","not_equal_to"]}],brokers:[{value:"ref_number",label:"Ref. number",value_type:"text",op_in:["in","not_in"]},{value:"first_name",label:"First name",value_type:"text",op_in:["like","not_like"]},{value:"last_name",label:"Last name",value_type:"text",op_in:["like","not_like"]},{value:"license_type_code",label:"License type",value_type:"list",choices:"getLicenseList",op_in:["in","not_in"]}]},$scope.filter_operators=[{key:"equal",value:"Equal to"},{key:"not_equal_to",value:"Different of"},{key:"less_than",value:"Less than"},{key:"less_or_equal_to",value:"Less or equals to"},{key:"greater_than",value:"Greater than"},{key:"greater_or_equal_to",value:"Greater or equals to"},{key:"in",value:"One of"},{key:"not_in",value:"Not one of"},{key:"like",value:"Contains"},{key:"not_like",value:"Does not contains"}],$scope.init=function(){$scope.selected_key=$scope.filter.field,console.log($scope.type),$scope.selected_filter_key=$scope.filter_key_list[$scope.type].find($e=>$e.value==$scope.selected_key),$scope.updateFilterChoices(),$scope.$watch("filter.value",function(){$scope.syncValueDisplay()})},$scope.remove=function(){if(void 0!=$scope.removeHandler)$scope.removeHandler()},$scope.syncValueDisplay=function(){if(!isNullOrEmpty($scope.filter.value))if(!Array.isArray($scope.filter.value))$scope.filter_value=$scope.filter.value.toString();else $scope.filter_value=$scope.filter.value.join(",");else $scope.filter_value=""},$scope.updateValue=function(){if(console.log("updateValue",$scope.f),isNullOrEmpty($scope.filter_value))return;const lUpdateProc={bool:$val=>"true"==$val,text:$val=>$val,list:$val=>$val.split(",")};$scope.filter.value=lUpdateProc[$scope.selected_filter_key.value_type]($scope.filter_value)},$scope.setValue=function($value){$scope.filter.value=$value,$scope.filter_value=$value.toString()},$scope.toggleValue=function($value){if(!Array.isArray($scope.filter.value))$scope.filter.value=[];console.log("toggleValue",$scope.filter.value,$value);const lValueIndex=$scope.filter.value.indexOf($value);if(lValueIndex>=0)$scope.filter.value.splice(lValueIndex,1);else $scope.filter.value.push($value);$scope.filter_value=$scope.filter.value.join(",")},$scope.filterFieldChanged=function(){$scope.filter.field=$scope.selected_key,$scope.value_choices=[],$scope.filter.value="",$scope.selected_filter_key=$scope.filter_key_list[$scope.type].find($e=>$e.value==$scope.selected_key),$scope.updateFilterChoices()},$scope.updateFilterChoices=function(){if(void 0!=$scope.selected_filter_key)if(console.log("filter choices from",$scope.selected_filter_key),["list","text"].indexOf($scope.selected_filter_key.value_type)>=0&&void 0!=$scope.selected_filter_key.choices)if(console.log("list from ",$scope.selected_filter_key.choices),"function"==typeof $siList[$scope.selected_filter_key.choices])console.log($scope.selected_filter_key.choices,"found"),$scope.value_choices=$siList[$scope.selected_filter_key.choices](),console.log($scope.selected_filter_key.choices,$scope.value_choices);else $scope.value_choices=$siUtils.stringToOptionList($scope.selected_filter_key.choices),console.log($scope.selected_filter_key.choices,$scope.value_choices);else $scope.value_choices=null;else $scope.value_choices=null},$scope.formatFilterValueList=function(){if(null!=$scope.filter.value)if("function"==typeof $scope.filter.value.push)if(1==$scope.filter.value.length)return"1 item selected".translate();else return"{0} items selected".translate().siFormat($scope.filter.value.length);return $scope.filter.value},$scope.operatorFilterByField=function($item){if(null==$item)return false;if(void 0==$scope.selected_filter_key)return false;if(void 0!=$scope.selected_filter_key.op_in)return $scope.selected_filter_key.op_in.indexOf($item.key)>=0;else if(void 0!=$scope.selected_filter_key.op_out)return!($scope.selected_filter_key.op_out.indexOf($item.key)>=0);return true}}}}),siApp.directive("siSvg",["$parse","$compile",function siSvg($parse,$compile){
return{restrict:"E",scope:{src:"@"},link:function($scope,$element,$attrs){if(""!=$element.html())$scope.src=$element.html(),$element.html("");$scope.init($element)},controller:function($scope){$scope.elm=null,$scope.init=function($element){$scope.elm=$element},$scope.$watch("src",function($new,$old){if(null!=$new)if(null!=$old)$scope.render()}),$scope.render=function(){const lTemplate='<ng-include src="getSvgPath()"></ng-include>';let elementContent=$compile(lTemplate)($scope);$scope.elm.append(elementContent)},$scope.getSvgPath=function(){let lPath=$scope.src;if(0==lPath.indexOf("~"))lPath=lPath.replace("~",wpSiApiSettings.base_path);return lPath}}}}]),siApp.directive("faIcon",["$parse","$compile",function faIcon($parse,$compile){return{restrict:"E",replace:true,scope:{icon:"@",iconStyle:"@?",size:"@",useSvg:"@"},link:function($scope,$element,$attrs){if(!$attrs.iconStyle)$scope.iconStyle="fal";if(!$attrs.size)$scope.size="1x";if("string"==typeof $attrs.icon&&$attrs.icon.indexOf("[")>=0){let lIconParse=$parse($attrs.icon);$scope.icon=lIconParse($scope)}else if(""!=$element.html())$scope.icon=$element.html(),$element.html("");$scope.init($element)},controller:function($scope){$scope.elm=null,$scope.init=function($element){$scope.elm=$element},$scope.$watch("icon",function($new,$old){if(null!=$new)if(null!=$old){if("string"==typeof $new&&$new.indexOf("[")>=0){let lIconParse=$parse($new);$scope.icon=lIconParse($scope)}$scope.render()}}),$scope.resetElement=function(){let lElm=$scope.elm[0],lClassToRemove=[];for(let i=0;i<lElm.classList.length;i++)if(lElm.classList.item(i).indexOf("fa-")>=0)lClassToRemove.push(lElm.classList.item(i));lElm.classList.remove.apply(lElm.classList,lClassToRemove),$scope.elm.html("")},$scope.render=function(){let lTemplate="";if($scope.resetElement(),$scope.useSvg){lTemplate='<ng-include src="getIconPath()"></ng-include>';let elementContent=$compile(lTemplate)($scope);$scope.elm.append(elementContent)}else if(Array.isArray($scope.icon))$scope.elm.addClass("fa-stack"),$scope.icon.forEach(function($e,$i){lTemplate='<i class="fal fa-'+$e+' fa-stack-1x"></i>',$scope.elm.append(lTemplate)});else $scope.elm.clearClass,$scope.elm.addClass($scope.iconStyle),$scope.elm.addClass("fa-"+$scope.icon),$scope.elm.addClass("fa-"+$scope.size)}}}}]),siApp.directive("siTooltip",["$parse","$q","$timeout",function siTooltip($parse,$q,$timeout){return{restrict:"E",transclude:true,template:'<div class="si-tooltip"><div class="si-tooltip-content"><label ng-transclude></label></div><i class="fal fa-info-circle" ng-mouseover="enter($event)" ng-mouseout="leave()"></i></div>',link:function($scope,$element,$attrs){$scope._elm=$element[0]},controller:function($scope){$scope.initTip=function(){$scope._tip=jQuery($scope._elm).find(".si-tooltip-content"),jQuery(document.body).append($scope._tip)},$scope.enter=function($event){if(void 0==$scope._tip)$scope.initTip();const lSourceBox=$scope._elm.getBoundingClientRect(),jElm=jQuery($event.target),lPos={left:Math.round(lSourceBox.left+lSourceBox.width/2),top:lSourceBox.top};console.log("mouse over ",$event.target,"positionned at",lPos),$scope._tip.css(lPos),$scope._tip.addClass("show")},$scope.leave=function(){if(void 0!=$scope._tip)$scope._tip.removeClass("show")}}}}]),siApp.directive("siOnEnter",["$parse",function siOnEnter($parse){return{restrict:"A",link:function($scope,$element,$attr){$element.on("keyup",function($event){if(13==$event.keyCode){const lHandler=$parse($attr.siOnEnter);lHandler($scope,{$event:$event})}})}}}]),siApp.directive("siStyleEditor",["$parse",function siStyleEditor($parse){return{restrict:"E",templateUrl:siAdminDirectiveTemplatePath("si-style-editor"),replace:true,scope:{rawModel:"=siModel",changeHandler:"&siChange",preview:"@?siPreview",showPreview:"=siShowPreview",editables:"=?siEditables"},link:function($scope,$element,$attrs){console.log("siStyleEditor.link",$scope.rawModel),$scope.init($element[0])},controller:function($scope,$timeout,$siUI){$scope.options={colorPicker:{hasBackdrop:false,materialPalette:false,sliders:false,genericPalette:false,history:false}},$scope._updateWatcherHndl=null,$scope._rawModelWatcherHndl=null,$scope.defaultValues={container_width:"1170px",font_name:"inherit",highlight:"#ff9900",highlight_text_color:"#333",text_color:"#333",background_color:"#fff",input_placeholder_color:"rgba(#333,0.5)",layout_gutter:"20px",padding:"20px","border-width":"1px","border-style":"solid","border-color":"currentColor","border-radius":"10px",high_contrast_color:"#333",high_contrast_text_color:"#fff",medium_contrast_color:"#b9b9b9",medium_contrast_text_color:"[text_color]",small_contrast_color:"#e2e2e2",small_contrast_text_color:"[text_color]",error_color:"#850000",button_border_color:"#aaa",button_border:"[border_style] [border_width] [border_color]",button_border_radius:"[border_radius]",button_bg_color:"#333",button_text_color:"#fff",button_font_name:"[font_name]",button_hover_bg_color:"#ff9900",button_hover_text_color:"#333",button_alt_bg_color:"#777",button_alt_text_color:"#fff",button_alt_hover_bg_color:"#9d9d9d",button_alt_hover_text_color:"#fff",uls_label:"ULS: ",listing_item_sold_bg_color:"#ff8800",listing_item_sold_text_color:"#fff",listing_item_column_width:"340px",listing_item_picture_ratio:"3 / 2",listing_item_picture_fit:"cover",thumbnail_picture_size:"100px",broker_item_column_width:"210px",broker_item_picture_ratio:"3.4 / 4",cover_item_picture_fit:"cover"},$scope.init=function($element){if($scope.$element=$element,$scope.previewPath=wpSiApiSettings.base_path+"/views/admin/statics/previews/style-editor-"+(void 0==$scope.preview?"general":$scope.preview)+".html",null!=$scope._updateWatcherHndl);if(console.log("styleEditor init:",$scope.rawModel),$scope.rawModel)$scope.model=$scope.parseModel($scope.rawModel);if($scope.registerRawModelWatcher(),$scope.registerModelWatcher(),null==$scope.editables)$scope.editables=["global","layout","buttons","containers","list-container","elements","bg-fg","components","listing","broker","office","custom-css"];const lFirstGroup=$scope.editables?$scope.editables[0]:"global";console.log("first group",lFirstGroup),$scope.openGroup(lFirstGroup)},$scope.registerRawModelWatcher=function(){$scope._rawModelWatcherHndl=$scope.$watch("rawModel",function($new,$old){if(void 0!=$new)if($new!=$old){if(console.log("rawModel new:",$new,"old:",$old),$scope.model=$scope.parseModel($scope.rawModel),$scope.updatePreviewBox(),$scope._rawModelWatcherHndl(),$scope._rawModelWatcherHndl=null,null!=$scope._updateWatcherHndl)$scope._updateWatcherHndl();$scope.registerModelWatcher()}},true)},$scope.registerModelWatcher=function(){$timeout(_=>{console.log("watcher register"),$scope._updateWatcherHndl=$scope.$watch("model",function($new,$old){if(console.log("model changed",$old,$new),!isNullOrEmpty($new))if($new!=$old)$scope.update()},true)},1e3)},$scope.openGroup=function($group){const lTargetGroup=$scope.$element.querySelector("#style-"+$group),lGroups=Array.from($scope.$element.querySelectorAll(".style-group"));lGroups.forEach(function($e){if($e.getAttribute("id")!="style-"+$group)if($e.classList.remove("open"),null!=$e.previousSibling)$e.previousElementSibling.classList.remove("active")}),lTargetGroup.classList.toggle("open"),lTargetGroup.previousElementSibling.classList.toggle("active")},$scope.stringifyModel=function(){const lModel=Object.keys($scope.model).reduce(($result,$k)=>{if(null!=$scope.model[$k]&&void 0!=$scope.model[$k]){const lNewKey="--si-"+$k.replace(/(_)/g,"-");$result[lNewKey]=$scope.model[$k]}return $result},{});return JSON.stringify(lModel)},$scope.parseModel=function($value){if(void 0==$value)return{};if(null==$value)return{};if(""==$value)return{};const lParsedModel=JSON.parse($value);console.log("rawModel parsed",lParsedModel);const lModel=Object.keys(lParsedModel).reduce(($result,$k)=>{const lNewKey=$k.replace("--si-","").replace(/(-)/g,"_");return $result[lNewKey]=lParsedModel[$k],$result},{});return $scope.validateModelValues(lModel),console.log("Parsed model",lModel),lModel},$scope.reset=function(){$siUI.confirm("Attention","All style customisation will be lost.\nDo you want to continue?",{ok:"Yes",cancel:"No"}).then(function($response){console.log("confirm",$response),$scope.model={},$scope.update()})},$scope.update=function(){$scope.validateModelValues($scope.model);const lModel=$scope.stringifyModel();if($scope.rawModel=lModel,console.log("styleModel changed",$scope.rawModel),"function"==typeof $scope.changeHandler)$scope.changeHandler({$styles:lModel})},$scope.updatePreviewBox=function(){const lModel=Object.keys($scope.model).reduce(($result,$key)=>{if(""!=$scope.model[$key])$result[$key]=$scope.model[$key];return $result},{}),lEffectiveStyle=Object.assign({},$scope.defaultValues,lModel),lPreviewElm=$scope.$element.querySelector(".si-style-editor-preview .si-preview-viewport");lPreviewElm.style.cssText="",Object.keys(lEffectiveStyle).forEach($k=>{const lStyleKey=$k.replace(/_/g,"-");let lValue=lEffectiveStyle[$k];const lSubVarRegex=/\[(.+)\]/g;if(lValue.match(lSubVarRegex))lValue=lValue.replace(lSubVarRegex,"var(--$1)"),lValue=lValue.replace(/_/g,"-");if("uls_label"==$k)lValue='"'+lValue+'"';console.log(lStyleKey),lPreviewElm.style.setProperty("--"+lStyleKey,lValue)})},$scope.validateModelValues=function($model){Object.keys($model).forEach($k=>{const lValue=$model[$k];if(void 0!=lValue&&""!=lValue)if(console.log("validate value",$k,lValue),$k.indexOf("padding")>0||$k.indexOf("radius")>0)if(lValue.indexOf("px")<0)console.log("px missing",$k,lValue),$model[$k]=lValue+"px"})},$scope.isEditable=function($item){if(void 0==$scope.editables)return true;if(!Array.isArray($scope.editables))return true;if(0==$scope.editables.length)return true;else return $scope.editables.includes($item)}}}}]),siApp.directive("siInclude",["$parse","$timeout",function siInclude($parse,$timeout){return{restrict:"E",link:function($scope,$element,$attrs){const fnUpdatePath=function($format,$params){if(void 0==$attrs.path)if(void 0!=$format&&void 0!=$params){const lParams=$params.filter($p=>void 0!=$p);if(lParams.length>0)$scope.path=$format.siFormat(...lParams)}if(void 0!=$scope.path)$scope.path=$scope.path.replace("~",wpSiApiSettings.base_path);console.log("siInclude",$scope.path)};$scope.$watch($attrs.pathParams,function(){const lParsedParams=$parse($attrs.pathParams)($scope);fnUpdatePath($attrs.pathFormat,lParsedParams)})},replace:true,template:'<div ng-include="path"></div>'}}]),siApp.directive("siListPreview",function siListPreview(){return{restrict:"E",replace:true,require:"ngModel",scope:{model:"=ngModel"},template:`\n    <div class="si-list-preview si-style-editor-preview {{model.type}}-preview">\n      <div si-style-preview="computedStyles">\n        <div class="si-preview-viewport list-layout-{{model.list_layout.preset}} search-layout-orientation-{{model.search_engine_options.orientation}}">\n          <div ng-if="model.search_engine_options.type == 'full'" class="si-container search-engine-tabs-container search-type-{{model.type}} search-layout-type-{{model.search_engine_options.type}} search-layout-orientation-{{model.search_engine_options.orientation}}">\n              <div class="list-components">\n                  <div class="component tabs {{!model.search_engine_options.tabbed ? 'inactive':'' }}">\n                      <md-checkbox ng-model="model.search_engine_options.tabbed"></md-checkbox>\n                      <div class="component-elements">\n                          <si-search-tabs-editor si-model="model.search_engine_options"></si-search-tabs-editor>\n                      </div>\n                  </div>\n              </div>\n          </div>\n\n          <div class="si-container search-engine-container search-type-{{model.type}} {{model.search_engine_options.scope_class}} search-layout-type-{{model.search_engine_options.type}}  search-layout-orientation-{{model.search_engine_options.orientation}}">\n              <div class="list-components" >\n                  \n                  <div class="component  {{!model.searchable ? 'inactive':'' }}">\n                      <md-checkbox ng-model="model.searchable"></md-checkbox>\n                      <div class="component-elements">\n                          <si-include \n                              path-format="~/views/admin/statics/previews/{0}-search-{1}.html"\n                              path-params="[model.type, model.search_engine_options.type]"></si-include>\n                          <md-button class="config-button md-raised md-primary"  ng-click="editSearchEngine()"><lstr>Configure</lstr> <i class="fal fa-cog"></i></md-button>\n                      </div>\n                  </div>\n              </div>\n          </div>\n\n          <div class="si-container {{model.list_layout.scope_class}}">\n              <div class="list-components si-grid" >\n                  <div class="component list-sort {{!model.sortable ? 'inactive':'' }}">\n                      <md-checkbox ng-model="model.sortable"></md-checkbox>\n                      <div class="component-elements  sort">\n                          <i class="fal fa-2x fa-sort-amount-down"></i>\n                      </div>\n                  </div>\n\n                  <div class="component list-meta {{!model.show_list_meta ? 'inactive':'' }}">\n                      <md-checkbox ng-model="model.show_list_meta"></md-checkbox>\n                      <label class="component-elements">{{localModel.previewItems.length}} {{model.type.translate()}}</label>\n                  </div>\n\n                  <div class="component list-map-toggle {{!model.mappable ? 'inactive':'' }}">\n                      <md-checkbox ng-model="model.mappable"></md-checkbox>\n                      <div class="component-elements toggles">\n                          <i class="far fa-2x fa-list si-highlight"></i>\n                          <div class="si-split-icons" ng-if="model.allow_split_view">\n                              <i class="fal fa-list"></i>\n                              <i class="far fa-map-marker-alt"></i>\n                          </div>\n                          <i class="far fa-2x fa-map-marker-alt"></i>\n                          <md-button class="config-button md-raised md-primary" ng-show="false" ng-click="editSearchEngine()"><lstr>Configure</lstr> <i class="fal fa-cog"></i></md-button>\n                      </div>\n                      \n                  </div>\n\n                  \n                  <div class="component list-items">\n                      <md-checkbox ng-checked="true" disabled></md-checkbox>\n                      \n                      <div class="component-elements si-grid" style="--item-row-space:{{model.list_layout.item_row_space.desktop}}">\n                          \n                          <div class="si-element" ng-repeat="item in localModel.previewItems | limitTo : model.list_layout.item_row_space.desktop track by $index">\n                              <lstr>List item</lstr>\n                          </div>\n\n                          <md-button class="config-button si-configure-element-button md-raised md-primary"  ng-click="editListItem()"><lstr>Configure</lstr> <i class="fal fa-cog"></i></md-button>\n                      </div>\n                  </div>\n              </div>\n          </div>\n      </div>\n      </div>\n    </div>\n    `,link:function($scope,$element,$attrs){$scope.init()},controller:function($scope,$rootScope,$q,$siUI){$scope.localModel={previewItems:[]},$scope.init=function(){$scope.localModel.previewItems=[{label:"List item"},{label:"List item"},{label:"List item"},{label:"List item"}],console.log("siListPreview/init",$scope.localModel.previewItems)},$scope.editListItem=function(){$scope.$emit("siListPreview/editListItem")},$scope.editSearchEngine=function(){$siUI.dialog($scope.model.type+"-search-engine-edit",$scope.model.search_engine_options).then($result=>{$scope.model.search_engine_options=$result})}}}}),siApp.directive("siListItemLayer",[function siListItemLayer(){return{restrict:"E",require:"ngModel",scope:{model:"=ngModel",layer:"@siLayer"},replace:true,template:`\n    <div class="si-list-item-layer layer-{{layer}} si-style-editor-preview">\n      <div si-style-preview>\n        <div class="si-preview-viewport">\n          <div class="si-list-item {{singularType}}-item si-element si-background {{model.list_item_layout.scope_class}}">\n            <div class="layer" ng-sortable="sortableOptions">\n              <si-layer-var ng-repeat="var in vars.list" ng-model="var"  si-on-remove="remove($index)" type="{{model.type}}"></si-layer-var>\n            </div>\n          </div>\n        </div>\n        \n      </div>\n\n      <md-menu class="si-layer-menu">\n        <md-button class="md-raised md-primary md-icon-button" ng-click="$mdMenu.open()"><i class="fal fa-plus"></i></md-button>\n        <md-menu-content>\n            <md-menu-item><md-button ng-click="addVar('group')"><lstr>Group</lstr></md-button></md-menu-item>\n            <md-menu-item><md-button ng-click="addVar('link_button')"><lstr>Link button</lstr></md-button></md-menu-item>\n            <md-divider></md-divider>\n            <md-menu-item ng-repeat="var in availableVarList"><md-button ng-click="addVar(var.name)">{{var.label.translate()}}</md-button></md-menu-item>\n            <md-divider></md-divider>\n            <md-menu-item><md-button ng-click="addCustomVar()"><lstr>Custom data</lstr></md-button></md-menu-item>\n          </md-menu-content>\n      </md-menu>\n\n      <script type="text/ng-template" id="layout-for-group">\n        <div class="si-label-group " data-group="{{model.$$hashKey}}" ng-sortable="sortableOptions">\n          <si-layer-var ng-repeat="subvar in item.items" si-on-remove="removeItem($index)" ng-model="subvar" type="{{type}}"></si-layer-var>\n        </div>\n        <div class="si-group-var-action">\n          <md-button class="md-icon-button" ng-click="openConfig()" title="{{'Manage classes'.translate()}}"><i class="fal fa-tag"></i></md-button>\n          <md-menu class="si-var-group-menu">\n              <md-button class="md-icon-button md-raised" ng-click="$mdMenu.open()"><i class="fal fa-plus"></i></md-button>\n              <md-menu-content>\n                <md-menu-item><md-button ng-click="addVar('link_button')"><lstr>Link button</lstr></md-button></md-menu-item>\n                <md-divider></md-divider>\n                <md-menu-item ng-repeat="var in availableVarList"><md-button ng-click="addVar(var.name)">{{var.label.translate()}}</md-button></md-menu-item>\n                <md-divider></md-divider>\n                <md-menu-item><md-button ng-click="addCustomVar()"><lstr>Custom data</lstr></md-button></md-menu-item>\n              </md-menu-content>\n          </md-menu>\n          <md-button class="md-icon-button" ng-click="remove()" title="{{'Remove'.translate()}}"><i class="fal fa-trash"></i></md-button>\n        </div>\n      </script>\n\n      <script type="text/ng-template" id="layout-for-any">\n        {{item.key.translate()}}\n      </script> \n\n      <script type="text/ng-template" id="layout-for-link_button">\n        <div class="si-button">{{((item.label != undefined) ? item.label : 'Learn more') | translate }}</div>\n      </script> \n\n      <script type="text/ng-template" id="layout-for-photo">\n        <div class="image">\n          <img src="{{item.imageUrl}}" />\n        </div>\n      </script> \n\n      <script type="text/ng-template" id="layout-for-description">\n        Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.\n      </script>\n      <script type="text/ng-template" id="layout-for-namex">\n        Name (extracted)\n      </script>\n\n      <script type="text/ng-template" id="layout-for-tags">\n        <div class="si-tags">\n          <em class="si-tag-item">New</em>\n          <em class="si-tag-item">Open house</em>\n          <em class="si-tag-item">Water view</em>\n        </div>\n      </script>\n\n\n      <script type="text/ng-template" id="layout-for-address">\n        <div class="si-label civic-address">1597 boul. Dagenais O.</div>\n      </script>\n      \n      <script type="text/ng-template" id="layout-for-ref_number">\n        123910\n      </script> \n\n      <script type="text/ng-template" id="layout-for-phone">\n        <i class="icon fal fa-fw fa-phone"></i> <span class="prefix"><lstr>phone</lstr>:</span> <span class="label">514-555-8654</span>\n      </script>\n      \n      <script type="text/ng-template" id="layout-for-available_area">\n        1200 sqr.ft.\n      </script> \n\n      <script type="text/ng-template" id="layout-for-price">  \n          <div class="si-price">625 000$</div>\n          <div class="si-price-sold" lstr>Sold</div>\n      </script> \n\n      <script type="text/ng-template" id="layout-for-phones">\n        <div class="phone-list ">\n            <div class="si-phone mobile">\n                <i class="icon fal fa-fw fa-mobile"></i> <span class="prefix"><lstr>mobile</lstr>:</span> <span class="label">514-555-8654</span></div>\n            <div class="si-phone office">\n                <i class="icon fal fa-fw fa-building"></i> <span class="prefix"><lstr>office</lstr>:</span> <span class="label">450-967-8200</span></div>\n        </div>\n      </script>\n\n      <script type="text/ng-template" id="layout-for-contacts">\n        <div class="contacts ">\n            <div class="contact phone">\n                <i class="icon fal fa-fw fa-phone"></i> <span class="prefix"><lstr>mobile</lstr>:</span> <span class="label">514-555-8654</span></div>\n            <div class="contact email">\n                <i class="icon fal fa-fw fa-envelope"></i><span class="prefix"><lstr>email</lstr>:</span> <span class="label">info@realestate.com</span></div>\n        </div>\n      </script>\n\n      <script type="text/ng-template" id="layout-for-counters">\n        <div class="counters">\n            <div class="counter"><i class="icon fal fa-fw fa-home"></i> <span class="count">23</span> <span class="label"><lstr>listing</lstr>s</span></div>\n            <div class="counter" ng-if="['offices','agencies'].includes(type)"><i class="icon fal fa-fw fa-user-tie"></i> <span class="count">12</span> <span class="label"><lstr>broker</lstr>s</span></div>\n        </div>\n      </script>\n\n      <script type="text/ng-template" id="layout-for-rooms">\n        <div class="rooms">\n            <div class="room bed"><i class="icon fal fa-fw fa-bed"></i> <span class="count">3</span> <span class="label" lstr>Bedroom</span></div>\n            <div class="room bath"><i class="icon fal fa-fw fa-bath"></i> <span class="count">2</span> <span class="label" lstr>Bathroom</span></div>\n            <div class="room tint"><i class="icon fal fa-fw fa-tint"></i> <span class="count">1</span> <span class="label" lstr>Water room</span></div>\n        </div>\n      </script>\n\n\n      <script type="text/ng-template" id="layout-for-flags">\n        <div class="flags">\n          <i class="video far fa-video"></i>\n          <i class="virtual-tour far fa-vr-cardboard"></i>\n          <i class="new-item far fa-star"></i>\n        </div>\n      </script>\n    \n      <script type="text/ng-template" id="layout-for-open_houses">\n        \n          <div class="open-house-item">\n              <i class="fal fa-calendar-alt"></i> <span lstr>Open house</span> <span lstr>in 3 days</span>*\n          </div>\n        \n      </script>\n    </div>\n    `,link:function($scope,$element,$attr){$scope.layerInfo=null,$scope.init()},controller:function($scope,$rootScope,$element,$timeout,$q,$siUI){$scope.computedStyles={},$scope.vars={list:[]},$scope.availableVarList=[],$scope.sortableOptions={group:{name:"si-layer-var",put:function(to,from,dragged){let toLvl=0;parentContainer=to.el;do{if(toLvl++,null!=parentContainer.parentContainer)parentContainer=parentContainer.parentContainer.closest("[ng-sortable]");else parentContainer=null}while(null!=parentContainer&&toLvl<5);if(1==toLvl&&dragged.classList.contains("group"))return false;if(toLvl>1)return false;else return true}},animation:150,fallbackOnBody:true,swapThreshold:.7,emptyInsertThreshold:8},$scope.init=function(){const singularTypeMap={brokers:"broker",listings:"listing",offices:"office",agencies:"agency",cities:"city"};if($scope.availableVarList=$rootScope.global_list.list_item_vars[$scope.model.type],$scope.updateVarList($scope.validateVarList($scope.model.list_item_layout.displayed_vars[$scope.layer])),console.log("siListItemLayer/init",$scope.varList),$scope.layerInfo={},$scope.layerInfo.path=wpSiApiSettings.base_path+`views/admin/statics/previews/${$scope.model.type}-item-layer.html`,$scope.singularType=singularTypeMap[$scope.model.type],!["agencies","cities"].includes($scope.model.type))$scope.imageUrl=wpSiApiSettings.base_path+`styles/assets/shadow_${singularTypeMap[$scope.model.type]}.jpg`;$scope.styleActive="custom"!=$scope.model.list_item_layout.preset,$scope.$on("listItemLayer/vars:changed",function($event,$layer){$scope.updateModel()}),$scope.$on("si/layerVar/removed",function($event,$index,$groupIndex=null){console.log("si/layerVar/removed",$index,$groupIndex);const newVarList=$scope.vars.list;if(null!=$groupIndex)newVarList[$groupIndex].items.splice($index,1);else newVarList.splice($index,1);$scope.updateVarList(newVarList)}),$scope.$on("listItemLayer/vars/promote",function($event,$var){console.log("var promotion detected",$var),$scope.vars.list.filter($v=>"group"==$v.key).forEach($group=>{const foundIndex=$group.items.findIndex($v=>$v.key==$var.key);if(console.log("searched index=",foundIndex),foundIndex>=0)$group.items.splice(foundIndex,1),$scope.vars.list.push($var),console.log("var has been promoted",$var)}),$scope.updateVarList($scope.vars.list)}),$scope.$watch("vars.list",function($new,$old){$scope.updateModel()},true)},$scope.updateVarList=function($varList){$scope.varList=[],$timeout(_=>{console.log("updateVarList",$varList),$scope.vars.list=$varList,$timeout(_=>{$scope.applySortHandlers()},250)},500)},$scope.remove=function($index){$scope.vars.list.splice($index,1),console.log("remove root item at",$index,$scope.vars.list)},$scope.addVar=function($var,$type="preset",$options=null){if(void 0==$scope.vars.list)$scope.vars.list=[];const newVar={key:$var,var_type:$type,classes:[],options:$options};if("group"==$var)newVar.items=[];$scope.vars.list.push(newVar),$timeout(_=>{$scope.applySortHandlers()},250)},$scope.addCustomVar=function(){$siUI.dialog("layer-var-add-custom").then($customVarData=>{$scope.addVar($customVarData.key,"custom",{content:$customVarData.content})})},$scope.applySortHandlers=function(){let sortableCount=0;const sortContainers=Array.from($element[0].querySelectorAll(".si-sortable-container"));sortContainers.forEach($container=>{new Sortable($container,{group:{name:"si-layer-var",put:function(to,from,dragged){let toLvl=0;parentContainer=to.el;do{if(toLvl++,null!=parentContainer.parentContainer)parentContainer=parentContainer.parentContainer.closest(".si-sortable-container");else parentContainer=null}while(null!=parentContainer&&toLvl<5);if(1==toLvl&&dragged.classList.contains("group"))return false;if(toLvl>1)return false;else return true}},animation:150,fallbackOnBody:true,swapThreshold:.7,emptyInsertThreshold:8,onEnd:function($event){const elm=$event.item,workingList=$scope.vars.list,sourceList=void 0==$event.from.dataset.group?workingList:workingList.find($e=>$e.$$hashKey==$event.from.dataset.group).items,targetList=void 0==$event.to.dataset.group?workingList:workingList.find($e=>$e.$$hashKey==$event.to.dataset.group).items,varItem=sourceList.splice($event.oldIndex,1)[0];targetList.splice($event.newIndex,0,varItem),console.log("vars sort completed:",workingList,varItem),$scope.updateVarList(angular.copy(workingList))}})}),console.log("applySortHandlers",sortContainers.length,sortableCount)},$scope.validateVarList=function($list){if(void 0==$list)$list=[];if($list.forEach($e=>{if(["listing_count"].includes($e))$e="counters"}),$list.every($e=>"string"==typeof $e))return $scope.getStructuredVarList($list);const result=$list.map($item=>{if("string"!=typeof $item)return $item;const varItem={key:$item,classes:[],items:[]};return varItem});if(["listings","brokers"].includes($scope.type))if("main"==$scope.layer)if(!result.find($e=>"photo"==$e.key))result.splice(1,0,{key:"photo"});return result},$scope.getStructuredVarList=function($list){const structuredMap={listings:_=>$scope.getStructuredVarListForListings($list),brokers:_=>$scope.getStructuredVarListForBrokers($list),offices:_=>$scope.getStructuredVarListForOffices($list),agencies:_=>$scope.getStructuredVarListForAgencies($list),cities:_=>$scope.getStructuredVarListForCities($list)};if(void 0!=structuredMap[$scope.model.type])return structuredMap[$scope.model.type]();else return $list},$scope.getStructuredVarListForListings=function(){const structure=[];if("main"==$scope.layer)structure.push({key:"group",classes:"si-background-high-contrast si-padding",items:[{key:"address",classes:"si-text-upper si-text-truncate"},{key:"city",classes:"si-text-truncate"}]},{key:"photo",classes:"si-float-anchor"},{key:"price",classes:"si-background-small-contrast si-padding si-space-emphasis si-big-emphasis"},{key:"group",classes:"si-padding",items:[{key:"category",classes:"si-font-emphasis"},{key:"subcategory",classes:"si-text-truncate"},{key:"rooms"},{key:"open_houses",classes:"si-weight-emphasis"}]},{key:"flags",classes:"si-float-top-right"});else structure.push({key:"group",classes:"si-padding",items:[{key:"ref_number"},{key:"description"}]});return structure},$scope.getStructuredVarListForBrokers=function(){const structure=[{key:"photo"},{key:"group",classes:"si-background-high-contrast si-padding",items:[{key:"first_name",classes:"si-text-upper"},{key:"last_name",classes:"si-text-upper si-size-emphasis"},{key:"license"}]},{key:"phone",classes:"si-padding si-size-emphasis"}];return structure},$scope.getStructuredVarListForOffices=function(){const structure=[{key:"name",classes:"si-padding si-background-high-contrast si-big-emphasis si-text-align-center"},{key:"group",classes:"si-padding si-text-align-center",items:[{key:"address"},{key:"phone"}]},{key:"counters",classes:"si-padding si-background-small-contrast si-weight-emphasis si-text-align-center"}];return structure},$scope.getStructuredVarListForAgencies=function(){const structure=[{key:"group",classes:"si-padding si-background-high-contrast  si-text-align-center",items:[{key:"name",classes:"si-big-emphasis"},{key:"license",classes:"si-text-small"}]},{key:"group",classes:"si-padding si-text-align-center",items:[{key:"address"},{key:"phone"}]},{key:"counters",classes:"si-padding si-background-small-contrast si-weight-emphasis si-text-align-center"}];return structure},$scope.getStructuredVarListForCities=function(){const structure=[{key:"group",classes:"si-padding si-background-high-contrast  si-text-align-center",items:[{key:"name",classes:"si-big-emphasis"},{key:"region"}]},{key:"counters",classes:"si-padding si-background-small-contrast si-weight-emphasis si-text-align-center"}];return structure},$scope.updateModel=function(){$scope.model.list_item_layout.displayed_vars[$scope.layer]=$scope.vars.list,console.log("siListItemLayer/updateModel",$scope.model.list_item_layout,$scope.vars.list)}}}}]),siApp.directive("siLayerVar",function siLayerVar(){return{restrict:"E",replace:true,require:"^ngModel",scope:{model:"=ngModel",index:"=",rootIndex:"=?",onRemove:"&?siOnRemove",type:"@"},
template:`\n    <div class="si-layer-var {{item.key | toDashCase}} {{item.classes.join(' ')}}" si-anchor-to="si-float-anchor" style="{{item.style}}">\n      <div class="si-layer-var-content" ng-include="item.template"></div>\n      <div class="si-layer-var-options" ng-if="item.key != 'group'">\n          <md-button class="md-icon-button" ng-click="openConfig()" title="{{'Options'.translate()}}"><i class="fal fa-cog"></i></md-button>\n          <md-button class="md-icon-button" ng-click="remove()" title="{{'Remove'.translate()}}"><i class="fal fa-trash"></i></md-button>\n      </div>\n    </div>\n    `,link:function($scope,$element,$attr,$ngModelCtrl){$scope.$ngModelCtrl=$ngModelCtrl,$scope.init()},controller:function($scope,$rootScope,$element,$siUI){$scope.item={},$scope.sortableOptions={group:{name:"si-layer-var",put:function(to,from,dragged){let toLvl=0;parentContainer=to.el;do{if(toLvl++,null!=parentContainer.parentContainer)parentContainer=parentContainer.parentContainer.closest("[ng-sortable]");else parentContainer=null}while(null!=parentContainer&&toLvl<5);if(1==toLvl&&dragged.classList.contains("group"))return false;if(toLvl>1)return false;else return true}},animation:150,fallbackOnBody:true,swapThreshold:.7,emptyInsertThreshold:8,onUpdate:function($data){console.log("ngSort/update",$data)},onAdd:function($data){console.log("ngSort/add",$data,$scope.item.items)}},$scope.init=function(){const singularTypeMap={brokers:"broker",listings:"listing",offices:"office",agencies:"agency",cities:"city"};$scope.availableVarList=$rootScope.global_list.list_item_vars[$scope.type],$scope.item=angular.copy($scope.model);let templateItem=null;try{templateItem=document.querySelector("#layout-for-"+$scope.model.key)}catch(error){}if(null!=templateItem)$scope.item.template="layout-for-"+$scope.model.key;else $scope.item.template="layout-for-any";if(!["agencies","cities"].includes($scope.type))$scope.item.imageUrl=wpSiApiSettings.base_path+`styles/assets/shadow_${singularTypeMap[$scope.type]}.jpg`;$scope.applyClasses(),$scope.$on("listItemLayer/vars:changed",function($event){$scope.updateModel()})},$scope.updateModel=function(){if($scope.model.classes=$scope.item.classes.join(" "),$scope.model.fallback=$scope.item.fallback,$scope.model.style=$scope.item.style,$scope.model.var_type=$scope.item.var_type,$scope.model.options=$scope.item.options,["link_button"].includes($scope.model.key))$scope.model.label=$scope.item.label;console.log("updating model",$scope.item,$scope.model),$scope.model.items=$scope.item.items},$scope.applyClasses=function(){if(null==$scope.item.classes||void 0==$scope.item.classes)$scope.item.classes=[];if(!Array.isArray($scope.item.classes))$scope.item.classes=[$scope.item.classes];if(!["photo","group"].includes($scope.item.key))$scope.item.classes.push("si-label")},$scope.remove=function(){if("function"==typeof $scope.onRemove)$scope.onRemove()},$scope.removeItem=function($index){console.log("remove group item at",$index),$scope.item.items.splice($index,1),$scope.updateModel()},$scope.addVar=function($var,$type="preset",$options=null){if(void 0==$scope.item.items)$scope.item.items=[];const newVar={key:$var,var_type:$type,classes:[],options:$options};$scope.item.items.push(newVar),$scope.updateModel()},$scope.addCustomVar=function(){$siUI.dialog("layer-var-add-custom").then($customVarData=>{$scope.addVar($customVarData.key,"custom",{content:$customVarData.content})})},$scope.openConfig=function(){if(void 0==$scope.model.classes)$scope.model.classes="";$siUI.dialog("layer-var-edit",{var:angular.copy($scope.model),type:$scope.type}).then($result=>{if(console.log("siLayerVar/openConfig@layer-var-edit",$scope.model),$scope.item.classes=[$result.classes],$scope.item.fallback=$result.fallback,$scope.item.style=$result.style,$scope.item.var_type=$result.var_type,$scope.item.options=$result.options,["link_button"].includes($scope.model.key))$scope.item.label=$result.label;if($scope.updateModel(),$result.classes.indexOf("si-float-")>=0)$scope.$emit("listItemLayer/vars/promote",$scope.model);else $scope.$emit("listItemLayer/vars:changed")})}}}}),siApp.directive("siAnchorTo",function siAnchorTo(){return{restrict:"A",link:function($scope,$element,$attrs){let lTargetElmQuery=$attrs.siAnchorTo;if(void 0==lTargetElmQuery)return;if(![".","#"].includes(lTargetElmQuery[0]))lTargetElmQuery="."+lTargetElmQuery;const elm=$element[0];if(elm.classList.contains(lTargetElmQuery)||elm.querySelector(lTargetElmQuery))return;const parentElm=elm.closest(".si-list-item"),targetElm=parentElm.querySelector(lTargetElmQuery),fnApplyAnchorOffset=()=>{let lTargetElm=parentElm.querySelector(lTargetElmQuery);if(null==lTargetElm)lTargetElm=parentElm;if(lTargetElm!=parentElm)elm.style.setProperty("--si-anchor-offset-top",lTargetElm.offsetTop+"px"),elm.style.setProperty("--si-anchor-offset-left",lTargetElm.offsetLeft+"px");else elm.style.setProperty("--si-anchor-offset-top","0px"),elm.style.setProperty("--si-anchor-offset-left","0px");elm.style.setProperty("--si-anchor-offset-width",lTargetElm.offsetWidth+"px"),elm.style.setProperty("--si-anchor-offset-height",lTargetElm.offsetHeight+"px")};if(null!=targetElm)fnApplyAnchorOffset();const parentObserver=new MutationObserver(_=>{window.setTimeout(_=>{console.log("siAnchorTo@observer trigger"),fnApplyAnchorOffset()},500)});parentObserver.observe(parentElm,{childList:true});const elmObserver=new MutationObserver($mutations=>{if($mutations.some($m=>"class"==$m.attributeName))window.setTimeout(_=>{fnApplyAnchorOffset()},500)});elmObserver.observe(elm,{attributes:true})}}}),siApp.directive("siStylePreview",["$parse",function siStylePreview($parse){return{restrict:"A",scope:{model:"=siStylePreview"},link:function($scope,$element,$attrs){$scope.init()},controller:function($scope,$rootScope,$element,$siConfigs){$scope.workModel={},$scope.defaultValues=$rootScope.global_list.styles,$scope.init=function(){console.log("siStylePreview/init on",$element[0]),$scope.$on("siStyleUpdate",function($event){$scope.updateElement()}),$scope.$watch(function(){return JSON.stringify($scope.model)},$scope.updateElement),$scope.updateElement()},$scope.parseModel=function($value){if(void 0==$value)return{};if(null==$value)return{};if(""==$value)return{};let lParsedModel={};if(Array.isArray($value))$value.forEach($v=>{lParsedModel=Object.assign(lParsedModel,JSON.parse($v))});else if("string"==typeof $value)lParsedModel=JSON.parse($value);else lParsedModel=$value;const lModel=Object.keys(lParsedModel).filter(function($k){return"_custom_css"!=$k}).reduce(function($result,$k){const lNewKey=$k.replace("--si-","").replace(/(-)/g,"_");return $result[lNewKey]=lParsedModel[$k],$result},{});return lModel},$scope.updateElement=function(){const lModelToParse=void 0==$scope.model||0==Object.keys($scope.model).length?$siConfigs.configs.styles:$scope.model,lJSONModel=$scope.parseModel(lModelToParse);console.log("siStylePreview/updateElement",lJSONModel);const lModel=Object.keys(lJSONModel).reduce(($result,$key)=>{if(""!=lJSONModel[$key])$result[$key]=lJSONModel[$key];return $result},{}),lEffectiveStyle=Object.assign({},$scope.defaultValues,lModel),lPreviewElm=$element[0].querySelector(".si-preview-viewport");if(null==lPreviewElm)return console.log(".viewport on",$element,"not found"),false;lPreviewElm.style.cssText="",Object.keys(lEffectiveStyle).forEach($k=>{const lStyleKey=$k.replace(/_/g,"-");let lValue=lEffectiveStyle[$k];const lSubVarRegex=/\[(.+)\]/g;if(void 0!=lValue){if(lValue.match(lSubVarRegex))lValue=lValue.replace(lSubVarRegex,"var(--si-$1)"),lValue=lValue.replace(/_/g,"-");if("uls_label"==$k)lValue='"'+lValue+'"';lPreviewElm.style.setProperty("--si-"+lStyleKey,lValue)}})}}}}]),siApp.directive("siNotice",[function siNotice(){return{restrict:"E",templateUrl:wpSiApiSettings.base_path+"views/admin/statics/si-notice.html",replace:true,scope:{model:"=siModel"},link:function($scope,$element,$attrs){},controller:function($scope){}}}]),siApp.directive("siSearchTabsEditor",[function siSearchTabsEditor(){return{restrict:"E",templateUrl:siAdminDirectiveTemplatePath("si-search-tabs-editor",true),replace:true,scope:{model:"=siModel"},link:function($scope,$element,$attrs){$scope.init($element[0])},controller:function($scope,$rootScope,$siApi,$siUI,$timeout){$scope.$element=null,$scope.init=function($element){$scope.$element=$element,$scope.$watch(function(){return $scope.model},function($new,$old){if(null!=$new)if(void 0==$scope.model.tabs)$scope.model.tabs=[]}),$scope.fetchData()},$scope.fetchData=function(){$siApi.rest("account",null,{method:"GET"}).then($response=>{$scope.data_views=$response.data_views})},$scope.addTab=function($item){$scope.model.tabs.push({view_id:$item.id,caption:{fr:$item.name,en:$item.name}})},$scope.removeTab=function($index){$scope.model.tabs.splice($index,1)},$scope.edit=function($event,$index){$event.stopPropagation(),$event.preventDefault(),document.addEventListener("click",function($event){$scope.apply()},{once:true}),$scope.editingIndex=$index,$timeout(function(){const lInput=$scope.$element.querySelector(".si-tab.edit-mode input");lInput.focus()},500)},$scope.preventClickTrap=function($event){$event.preventDefault(),$event.stopPropagation()},$scope.checkKey=function($event){if(13==$event.keyCode)$scope.apply();$event.stopPropagation()},$scope.apply=function(){$timeout(function(){delete $scope.editingIndex})},$scope.isUsed=function($item){const lTab=$scope.model.tabs.find($t=>$t.view_id==$item.id);return void 0!=lTab},$scope.isEditing=function($index){return $index==$scope.editingIndex},$scope.moveTab=function($index,$moveBy){const lNewIndex=$index+$moveBy,lElm=$scope.model.tabs.splice($index,1)[0];if(lNewIndex>$scope.model.tabs.length)$scope.model.tabs.push(lElm);$scope.model.tabs.splice(lNewIndex,0,lElm)}}}}]),siApp.directive("siLocalized",["$parse","$compile",function siLocalized($parse,$compile){return{restrict:"E",transclude:true,replace:true,template:'<div class="si-localized-input"><ng-transclude></ng-transclude><md-menu class="si-locale-selector"><md-button ng-click="$mdMenu.open()">{{$localized.current}}</md-button><md-menu-content><md-menu-item ng-repeat="locale in locales"><md-button ng-click="changeLocale(locale)">{{locale}}</md-button></md-menu-item></md-menu-content></md-menu></div>',link:function($scope,$element,$attrs){},controller:function($scope,$rootScope){this.$onInit=function(){$scope.locales=$locales.supported_languages,$scope.$watch("model",function($new,$old){if(null!=$new&&""!=$new)$scope.validateModel()})},$scope.$localized={current:$locales._current_lang_},$scope.changeLocale=function($new){$scope.$localized.current=$new},$scope.validateModel=function(){if("string"==typeof $scope.model);}}}}]),siApp.directive("siAddonConfig",["$parse",function siAddonConfig($parse){return{restrict:"E",scope:{model:"=siModel",active_addons:"=siActiveAddons"},templateUrl:siAdminDirectiveTemplatePath("si-addon"),replace:true,link:function($scope,$element,$attrs){$scope.init()},controller:function($scope,$q,$timeout,$rootScope){$scope.modelConfigs={},$scope.init=function(){if($scope.addonConfigPath="/"+wpSiApiSettings.base_path.trimChar("/")+"/addons/"+$scope.model.name+"/views/addon.settings.html?t="+(new Date).getTime(),null==$scope.active_addons||Array.isArray($scope.active_addons))$scope.active_addons={};console.log("addon init",$scope.model,$scope.active_addons),$scope.modelConfigs=void 0!=$scope.active_addons[$scope.model.name]?Object.assign($scope.model.default_configuration,$scope.active_addons[$scope.model.name].configs):$scope.model.default_configuration},$scope.isActive=function(){if(null==$scope.active_addons)return false;else return void 0!=$scope.active_addons[$scope.model.name]},$scope.toggleActive=function(){console.log("toggle active"),$timeout(_=>{if($scope.isActive())console.log("already active, delete settings"),delete $scope.active_addons[$scope.model.name];else console.log("Add settings to active_addons"),$scope.active_addons[$scope.model.name]={configs:$scope.getModelConfigs()};console.log("new active_addons",$scope.active_addons),$rootScope.$broadcast("save-request")})},$scope.getModelConfigs=function(){const lConfigs=$scope.model.default_configuration;return lConfigs},$scope.saveAddonSettings=function(){$scope.active_addons[$scope.model.name]={configs:$scope.modelConfigs},$rootScope.$broadcast("save-request")}}}}]),siApp.directive("siLargeTextInput",function siLargeTextInput(){return{restrict:"C",link:function($scope,$element,$attr){$element[0].addEventListener("keydown",function($event){if("Tab"==$event.key){$event.preventDefault();var start=this.selectionStart,end=this.selectionEnd;this.value=this.value.substring(0,start)+"\t"+this.value.substring(end),this.selectionStart=this.selectionEnd=start+1}})}}}),siApp.directive("siClassSelector",function siClassSelector(){return{restrict:"E",require:"^ngModel",scope:{filter:"@?",model:"=ngModel"},template:`\n      <md-chips ng-model="selectedItems" \n          md-autocomplete-snap\n          md-transform-chip="transformChip($chip)"\n          md-add-on-blur="true"\n          md-on-add="updateModel()" md-on-remove="updateModel()"\n        >\n        <md-autocomplete\n            md-selected-item="selectedItem"\n            md-search-text="searchText"\n            md-items="item in querySearch(searchText)"\n            md-require-match="false"\n            placeholder="{{'Add a class'.translate()}}"\n            >\n          <span md-highlight-text="searchText">{{item}}</span>\n        </md-autocomplete>\n        <md-chip-template>\n          <span>\n            <strong>{{$chip}}</strong>\n          </span>\n        </md-chip-template>\n      </md-chips>\n    `,controllerAs:"ctrl",link:function($scope,$element,$attr,$ngModelCtrl){$scope.$ngModelCtrl=$ngModelCtrl,$scope.init()},controller:function($scope,$q,$timeout){$scope.selectedItems=[],$scope.searchText="",$scope.selectedItem=null,$scope.classList=["si-padding","si-padding-inline","si-padding-block","si-padding-size-slim","si-padding-size-half","si-padding-size-quarter","si-padding-size-three-quarter","si-border","si-border-top","si-border-bottom","si-border-curved","si-border-curved-sm","si-border-curved-lg","si-border-curved-max","si-border-round","si-box-shadow","si-box-shadow-weak","si-box-shadow-strong","si-no-background","si-background-small-contrast","si-background-medium-contrast","si-background-high-contrast","si-text-align-left","si-text-align-center","si-text-align-right","si-content-gap","si-content-small-gap","si-content-big-gap","si-animate-fade-in","si-animate-push-up","si-animate-push-down","si-animate-push-left","si-animate-push-right","si-animate-slide-in-bottom","si-animate-slide-in-top","si-animate-slide-in-left","si-animate-slide-in-right","si-animate-scale-up","si-animate-scale-down","si-animate-fast","si-animate-slower","si-animate-slow","si-animate-delay","si-animate-delay-slight","si-animate-delay-chain","si-animate-wait-viewport"],$scope.typeSpecificClassList={listItem:["si-horizontal-layout"],listings:[],brokers:[],offices:[],agencies:[],search:["si-input-background-small-contrast","si-input-background-medium-contrast","si-input-background-high-contrast","si-input-radius","si-input-big-radius","si-input-border-top","si-input-border-bottom"],layerVar:["si-show-labels","si-hide-icons","si-show-prefixes","si-emphasis","si-big-emphasis","si-2x-emphasis","si-space-emphasis","si-font-emphasis","si-size-emphasis","si-weight-emphasis","si-text-truncate","si-text-small","si-text-upper","si-text-lower","si-font-2x","si-pull-up","si-pull-left","si-pull-up-left","si-pull-up-right","si-pull-right","si-pull-down","si-pull-down-left","si-pull-down-right","si-slim-pull-up","si-slim-pull-left","si-slim-pull-up-left","si-slim-pull-up-right","si-slim-pull-right","si-slim-pull-down","si-slim-pull-down-left","si-slim-pull-down-right","si-float-anchor","si-float-center","si-float-top","si-float-left","si-float-right","si-float-bottom","si-float-top-left","si-float-top-center","si-float-top-right","si-float-center-left","si-float-center-center","si-float-center-right","si-float-bottom-left","si-float-bottom-center","si-float-bottom-right"]},$scope.init=function(){if($scope.model&&""!=$scope.model)$scope.selectedItems=$scope.model.split(" ")},$scope.querySearch=function($text){if(!$text)return[];const allClasses=[...$scope.classList];if(void 0!=$scope.filter&&$scope.typeSpecificClassList[$scope.filter])allClasses.push(...$scope.typeSpecificClassList[$scope.filter]);const result=allClasses.filter($c=>$c.indexOf($text.toLowerCase().replace(/\s/g,"-"))>=0);return console.log("querySearch",result.length),result},$scope.transformChip=function($chip){return console.log("transformChip",$chip),$chip},$scope.updateModel=function(){console.log("siClassSelector/updateModel",$scope.selectedItems),$timeout(_=>{$scope.$ngModelCtrl.$setViewValue($scope.selectedItems.join(" "))})}}}}),siApp.factory("$siUtils",["$siApi","$q","$mdToast",function $siUtils($siApi,$q,$mdToast){let $scope={stringToOptionList:function($source){if(null==$source||void 0==$source)return null;if($source.indexOf("|")<0&&$source.indexOf(":")<0)return[$source];let lKeyValues=$source.split("|"),lResult=[];return lKeyValues.forEach(function($e){let lItemArr=$e.split(":");console.log("splited item",lItemArr);let lItem={key:lItemArr[0],label:lItemArr.length>1?lItemArr[1]:lItemArr[0]};lResult.push(lItem)}),lResult},toArray:function($source){let lResult=[];for($key in $source)if("function"!=typeof $source[$key])lResult.push($source[$key]);return lResult},toKeyArray:function($source){let lResult=[];for($key in $source)if("function"!=typeof $source[$key])lResult.push($key);return lResult},toKeyValueArray:function($source){let lResult=[];for($key in $source)if("function"!=typeof $source[$key])lResult.push({key:$key,value:$source[$key]});return lResult},renewListSearchToken:function($list){let lFilters=$scope.buildListFilter($list);return $q(function($resolve,$reject){if(null!=lFilters)$siApi.call("",lFilters,{url:wpSiApiSettings.api_root+"/api/utils/search_encode"}).then(function($response){$resolve($response)});else $resolve("")})},buildListFilter:function($list){let lResult=null;if($list.limit>0)lResult={max_item_count:$list.limit};if(""!=$list.sort&&"auto"!=$list.sort){if(null==lResult)lResult={};lResult.sort_fields=[{field:$list.sort,desc:$list.sort_reverse}]}if($list.shuffle){if(null==lResult)lResult={};lResult.shuffle=$list.shuffle}if(null!=$list.filter_group){if(null==lResult)lResult={};lResult.filter_group=$scope.normalizeFilterGroup(angular.copy($list.filter_group))}return lResult},normalizeFilterGroup:function($filter_group){if($filter_group.filters)$filter_group.filters.forEach(function($filter){if(["in","not_in"].indexOf($filter.operator)>=0){if("undefined"==typeof $filter.value.push)$filter.value=$filter.value.split(","),$filter.value.forEach(function($val){if(!isNaN($val))$val=Number($val)})}else if(!isNaN($filter.value))$filter.value=Number($filter.value)});if($filter_group.filter_groups)$filter_group.filter_groups.forEach(function($group){$scope.normalizeFilterGroup($group)});return $filter_group},createList:function($view,$type,$alias,$sort="",$sortReverse=false,$limit=0,$list=null){const lList=null==$list?{alias:$alias,type:$type}:$list,lTypedDatas={listings:{search_engine_options:{type:"full",filter_tags:"none",scope_class:"si-border"},displayed_vars:{main:["address","city","price","rooms","category","subcategory"]}},brokers:{search_engine_options:{type:"full"},displayed_vars:{main:["first_name","last_name","phone","title"]}}};if(lList.sort=""==$sort?null:$sort,lList.sort_reverse=$sortReverse,lList.limit=$limit,lList.list_layout={type:"standard",preset:"standard",scope_class:"si-border"},lList.list_item_layout={type:"standard",preset:"standard",scope_class:"si-border"},lList.searchable=true,lList.sortable=true,lList.mappable=true,void 0!=lTypedDatas[$type])lList.search_engine_options=lTypedDatas[$type].search_engine_options,lList.list_item_layout.displayed_vars=lTypedDatas[$type].displayed_vars;return lList.source=$view,lList.search_token="",lList},strToJson:function($source){},copyToClipboard:function($data){let lContent="";if(null!==$data&&"object"===typeof $data)lContent=JSON.stringify($data);else lContent=$data;let lTextarea=document.createElement("textarea");lTextarea.textContent=lContent,lTextarea.style.position="fixed",document.body.appendChild(lTextarea),lTextarea.select();try{$scope.toast("Copied to clipboard"),document.execCommand("copy")}catch(ex){return console.warn("Copy to clipboard failed.",ex),false}finally{document.body.removeChild(lTextarea)}},toast:function($message){try{$mdToast.show($mdToast.simple().textContent($message.translate()).position("top right").hideDelay(2e3))}catch($ex){console.log($ex)}}};return $scope}]),siApp.factory("$siUser",["$siApi","$siUI","$q","$rootScope",function $siUser($siApi,$siUI,$q,$rootScope){const $scope={info:null,isLoggedIn:false,credentials:null,init:function(){if($scope.load(),null!=$scope.info)$scope.isLoggedIn=true},load:function(){$scope.info=wpSiApiSettings.si_user_account},getCredentials:function(){return $scope.login()},login:function(){const lDefer=$q.defer();return $siUI.dialog("account-login",null,{clickOutsideToClose:false}).then($result=>{$scope.credentials=$result,lDefer.resolve($result)}),lDefer.promise}};return $scope.init(),$scope}]),siApp.factory("$siList",["$siApi",function $siList($siApi){let $scope={dictionary:null,init:function($view_id){console.log("loading lexicon",$view_id),$scope.fetchDictionary($view_id)},fetchDictionary:function($view_id){if(null!=$view_id)$siApi.rest("dictionary").then(function($response){$scope.dictionary=$response})},getCountryList:function(){if(console.log($scope.dictionary),null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.country)},getStateList:function(){if(console.log($scope.dictionary),null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.state)},getRegionList:function(){if(console.log($scope.dictionary),null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.region)},getCityList:function(){if(console.log($scope.dictionary),null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.city)},getCategoryList:function(){if(console.log($scope.dictionary),null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.listing_category)},getSubcategoryList:function(){if(console.log($scope.dictionary),null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.listing_subcategory)},getBuildingCategoryList:function(){if(console.log($scope.dictionary),null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.building_category)},getLicenseList:function(){if(null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.broker_license_type)},getOfficeList:async function(){if(null==$scope.offices)return[];if(void 0!=$scope.offices)return $scope.offices;const lResponse=await $siApi.call("office/view/"+$configs.source.id+"/fr/items");console.log("getOffice await response",lResponse)},toArray:function($source){let lResult=[];for($key in $source)lResult.push({key:$key,label:$source[$key].caption});return console.log("toArray:",lResult),lResult}};return $scope}]),siApp.factory("$siApi",["$http","$q","$interval",function $siApi($http,$q,$interval){const $scope={nonceTimeout:2,init:function(){$interval(_=>{},60*$scope.nonceTimeout*1e3),console.log("$siApi/init")},renewNonce:function(){console.log("$siApi/renewNonce"),$options={url:wpSiApiSettings.root+"si-rest/new_nonce",method:"GET"},$q(function($resolve,$reject){$http($options).then(function success($result){if("200"==$result.status)wpSiApiSettings.nonce=$result.data,$resolve();else $reject(null)},function fail($error){console.log("Fail on path",$path,"with data",$data,$error)})})},rest:function($path,$data,$options){if($options=angular.merge({url:wpSiApiSettings.root+"si-rest/"+$path,method:"undefined"==typeof $data?"GET":"POST",headers:{"X-WP-Nonce":wpSiApiSettings.nonce}},$options),"GET"==$options.method)$options.params=$data;else $options.data=$data;let lPromise=$q(function($resolve,$reject){$http($options).then(function success($result){if("200"==$result.status)$resolve($result.data);else $reject($result.status)},function fail($error){$reject($error.status),console.log("Fail on path",$path,"with data",$data,$error)})});return lPromise},call:function($path,$data,$options,$credentialInfos){if($path="function"==typeof $path.push?$path.join("/"):$path,$options=angular.merge({url:wpSiApiSettings.api_root+"/api/"+$path,method:"undefined"==typeof $data?"GET":"POST"},$options),"GET"==$options.method)$options.params=$data;else $options.data=$data;if(void 0!=$credentialInfos)$options.headers={"x-si-account":$credentialInfos.account_id,"x-si-api":$credentialInfos.api_key,"x-si-appId":$credentialInfos.app_id,"x-si-appVersion":$credentialInfos.app_version};let lPromise=$q(function($resolve,$reject){$http($options).then(function onSuccess($response){if("200"==$response.status)$resolve($response.data);else $reject(null)},function onFail($error){console.log("Fail on path",$path,"with data",$data,$error),$reject($error)})});return lPromise},portal:function($path,$data,$options,$credentialInfos){const lOptions=Object.assign({method:"POST"},$options);if(lOptions.url="https://portal-api.source.immo/api/"+$path,null!=$data)if("POST"==lOptions.method)lOptions.data=$data;else lOptions.params=$path;if(void 0!=$credentialInfos){if(!lOptions.params)lOptions.params={};if(lOptions.params.at=$credentialInfos.credentials.authTokenKey,null!=$credentialInfos.account_id)lOptions.params.la=$credentialInfos.account_id}return $q(($resolve,$reject)=>{$http(lOptions).then($response=>{if(200==$response.status)$resolve($response.data);else $reject($response.data)},$error=>{console.log("call to",lOptions.url,"return an error",$error),$reject($error.data)}).catch($err=>{console.log($path,"call failed",$err)})})}};return $scope.init(),$scope}]),siApp.factory("$siConfigs",["$rootScope","$q","$siApi","$siUI","$timeout",function $siConfigs($rootScope,$q,$siApi,$siUI,$timeout){const $scope={configsBackup:null,load:function(){return $q(function($resolve,$reject){$siApi.rest("configs").then(function($configs){$scope.configs=$configs,$resolve($scope.configs)}).then(function(){return $scope.loadBackup()}).then($backup=>{if(null!=$backup&&""!=$backup)$scope.configsBackup=JSON.parse($backup)})})},loadNetwork:function(){return $q(function($resolve,$reject){$siApi.rest("configs/network").then(function($configs){$scope.networkConfigs=$configs,$resolve($scope.networkConfigs)})})},save:function($configs){return $scope.configs=$configs,$siApi.rest("configs",{settings:$configs},{method:"POST"})},saveNetwork:function($configs){return $scope.networkConfigs=$configs,$siApi.rest("configs/network",{settings:$configs},{method:"POST"})},backup:function(){return $scope.configsBackup=angular.copy($scope.configs),$siApi.rest("configs/backup",null,{method:"POST"})},loadBackup:function(){return $siApi.rest("configs/backup")},clearBackup:function(){return $scope.configsBackup=null,$siApi.rest("configs/backup",null,{method:"DELETE"})},restoreBackup:function($options){if($options=Object.assign({directMethod:null},$options),null!=$options.directMethod&&"function"==typeof $scope[$options.directMethod])return $scope[$options.directMethod]();const fnConfirm=_=>$siUI.confirm("Attention","Are you sure?\nThis will replace your current configuration");$siUI.confirm("Attention","Would you like to restore everything (including credentials token) or merge with the current configuration?",{ok:"Merge",cancel:"Everything"}).then(function merge(){fnConfirm().then(_=>{$scope.restoreMerge()})},function everything(){fnConfirm().then(_=>{$scope.restoreEverything()})})},restoreEverything:function(){console.log("restoring everything from",$scope.configsBackup);const lConfigs=angular.copy($scope.configsBackup);$scope.clearBackup().then(_=>$scope.save(lConfigs)).then(_=>{$scope.configsBackup=null,$siUI.show_toast("Settings restored"),window.location.reload(true)})},restoreMerge:function(){const lNewConfigs=$scope.mergeBackupToConfigs($scope.configs);$scope.clearBackup().then(_=>$scope.save(lNewConfigs)).then(_=>{$scope.configsBackup=null,$siUI.show_toast("Settings restored"),window.location.reload(true)})},mergeBackupToConfigs:function($configs){const lBackup=angular.copy($scope.configsBackup),lExceptionKeys=["account_id","api_key","app_id","app_version","default_view"],lDefaultView=$scope.data_views.find($e=>$e.id==$configs.default_view);return Object.keys($configs).filter($k=>lExceptionKeys.includes($k)).forEach($k=>{lBackup[$k]=$configs[$k]}),lBackup.lists.forEach($l=>{$l.source=lDefaultView}),lBackup},replaceAccount:function($newCredentials){const lPreviousValues={account_id:$scope.configs.account_id,api_key:$scope.configs.api_key,default_view:$scope.configs.default_view};return console.log("$siConfigs/replaceAccount",angular.copy($scope.configs)),$scope.configs.account_id=$newCredentials.account_id,$scope.configs.api_key=$newCredentials.api_key,$scope.configs.default_view=$newCredentials.default_view.id,$scope.configs.lists.forEach($e=>{if($e.source.id==lPreviousValues.default_view)$e.source=$newCredentials.default_view}),console.log("$siConfigs/replaceAccount",$scope.configs),$scope.save($scope.configs)}};return $scope}]),siApp.factory("$siUI",["$mdDialog","$mdToast","$q","$rootScope",function $siUI($mdDialog,$mdToast,$q,$rootScope){return $scope={},$scope.alert=function($message,$options){$message="undefined"==typeof $message?"":$message,$options=angular.merge({ev:null,ok:"OK"},$options);const lDialog=$mdDialog.alert().clickOutsideToClose(false).textContent($message.translate()).ok($options.ok).multiple(true).targetEvent($options.ev);return lDialog._options.parent=angular.element(document.body),$mdDialog.show(lDialog)},$scope.prompt=function($message,$options){$message="undefined"==typeof $message?"":$message,$options=angular.merge({ev:null,ok:"OK"},$options);const lDialog=$mdDialog.prompt().clickOutsideToClose(false).textContent($message.translate()).ok($options.ok).multiple(true).targetEvent($options.ev);return lDialog._options.parent=angular.element(document.body),$mdDialog.show(lDialog)},$scope.confirm=function($title,$message,$options){const lTitle=void 0==$message?"":$title,lMessage=void 0==$message?$title:$message;$options=angular.merge({ev:null,ok:"OK",cancel:"Cancel",multiple:true},$options);var confirm=$mdDialog.confirm().title(lTitle.translate()).htmlContent(lMessage.translate().replace("\n","<br>")).multiple($options.multiple).targetEvent($options.ev).ok($options.ok.translate()).cancel($options.cancel.translate());return confirm._options.parent=angular.element(document.body),$q(($resolve,$reject)=>{$mdDialog.show(confirm).then(function acknowledge(){console.log(`user has acknowledged ${lMessage}`),$resolve()},function reject(){console.log(`user has rejected ${lMessage}`),$reject()})})},$scope.show_toast=function($message){try{$mdToast.show($mdToast.simple().textContent($message.translate()).position("top right").hideDelay(2e3))}catch($ex){console.log($ex),console.log($message)}},$scope.dialog=function($name,$params=null,$options=null){const lOptions=Object.assign({parent:angular.element(document.body),targetEvent:null,clickOutsideToClose:true,fullscreen:true,multiple:true,id:$name+"-dialog",locals:{$params:$params}},$options);return normalizeName=$name.replace(/(-\D)/gi,$m=>$m.substr(1,2).toUpperCase()+$m.substr(2)),templatePath=wpSiApiSettings.base_path+"views/admin/dialogs/"+$name+".html?t="+(new Date).getTime(),dialogController=normalizeName+"DialogCtrl",console.log("$siUI/dialog",templatePath,dialogController,$params),
lOptions.template=`<md-dialog id="${$name}-dialog" ng-controller="${dialogController}" ng-init="init($params)"><ng-include src="'${templatePath}'"></ng-include></md-dialog>`,lOptions.controller="siDialogController",$q(($resolve,$reject)=>{$mdDialog.show(lOptions).then($result=>{if(null==$result||void 0==$result)return $reject();$resolve($result)},$error=>{$reject($error)})})},$scope.getLocalFile=function($fileFilter=""){if(!window.File||!window.FileReader||!window.FileList||!window.Blob)return console.log("The File APIs are not fully supported in this browser."),$q.reject();const lDefer=$q.defer(),inputElm=document.createElement("input");return inputElm.setAttribute("type","file"),inputElm.setAttribute("accept",$fileFilter),inputElm.style.opaciy=0,inputElm.style.position="absolute",inputElm.addEventListener("change",_=>{if(!inputElm.files)console.log("This browser doesn't seem to support the `files` property of file inputs."),lDefer.reject();else if(!inputElm.files[0])console.log("No file selected."),lDefer.reject(),inputElm.remove();else{let file=inputElm.files[0],fr=new FileReader;fr.onload=(_=>{lDefer.resolve(fr.result),inputElm.remove()}),fr.readAsText(file)}}),document.body.appendChild(inputElm),inputElm.click(),lDefer.promise},$scope.getPortalCredentials=function(){return $q(($resolve,$reject)=>{$scope.dialog("signin").then($credentials=>{$resolve($credentials)},_=>{$reject()})})},$scope}]),siApp.factory("$siWP",["$rootScope","$q","$siApi",function $siWP($rootScope,$q,$siApi){const $scope={pages:{},languages:null,loadPages:function(){return $q(function($resolve,$reject){$scope.loadLanguages().then($languages=>{callList=$languages.map($l=>(function(){return $scope.loadPagesForLang($l.code)})),$q.all(callList.map($c=>$c())).then($results=>{$languages.forEach(($l,$index)=>{$scope.pages[$l.code]=$results[$index]}),console.log("loadPages",$scope.pages),$resolve($scope.pages)}).catch($err=>{console.error($err)})})})},loadPagesForLang:function($lang){return $siApi.rest("page/list",{locale:$lang,type:""},{method:"GET"})},loadLanguages:function(){return $q(function($resolve,$reject){if(null==$scope.languages)$siApi.rest("language/list",null,{method:"GET"}).then($result=>{$scope.languages=$result,$resolve($scope.languages)}).catch($err=>{console.error($err)});else $resolve($scope.languages)})},updatePage:function($id,$newContent){},getPage:function(page){return $siApi.rest("page/get",{page:page},{method:"GET"})},addPage:function($title,$content,$lang,$originalId){return $q(($resolve,$reject)=>{$siApi.rest("page",{lang:$lang,page_id:"NEW",title:$title,content:$content,original_page_id:$originalId}).then($response=>{$resolve($response)})})}};return $scope}]),siApp.filter("isIn",function(){return function($needle,$stack){if(null==$needle||void 0==$needle)return false;else return $stack.indexOf($needle)>=0}}),siApp.filter("translate",function(){return function($value){if(void 0==$value)return"";if(void 0!=$value[$locales._current_lang_])return $value[$locales._current_lang_];else return $value.toString().translate()}}),siApp.filter("math_floor",function(){return function($value){return Math.floor($value)}}),siApp.filter("toDashCase",function(){return function($value){if(void 0==$value)return"";else return $value.replace(/[A-Z]/,$c=>$c.toLowerCase()).replace(/(\s|_)/g,"-").replace(/[A-Z]/g,$c=>"-"+$c.toLowerCase())}}),siApp.filter("truncate",function(){return function($source,$limit){let lResult=$source;if(lResult)if(lResult.length>$limit)lResult=lResult.substr(0,$limit/2)+"..."+lResult.substr(lResult.length-$limit/2);return lResult}}),siApp.filter("siRelativePath",function(){return function($path){return $path.replace("~",wpSiApiSettings.base_path)}}),siApp.filter("siElementExists",function(){return function($element){return document.querySelectorAll($element).length>0}}),siApp.filter("siRoutePreview",["$sce",function($sce){return function($route){const sanitizedRoute=$route.replace(/(\{\{([^\}]+)\}\})/gi,(m,g,g2)=>"<em>"+g2.split(".").last()+"</em>");return $sce.trustAsHtml("/"+sanitizedRoute)}}]),siApp.filter("pluginRootRelative",function(){return function($path){return wpSiApiSettings.base_path+$path}});