function brokersSearchEngineEditCtrl($scope,$rootScope,$mdDialog,$siUI,$params){BaseDialogController($scope,$mdDialog,$rootScope),$scope.model={type:"full",focus_category:null,orientation:"h",sticky:false},$scope.fieldList=[{key:"searchbox",caption:"Search box".translate()},{key:"letters",caption:"Alphabetical".translate()},{key:"licenses",caption:"Licenses".translate()},{key:"offices",caption:"Offices".translate()}],$scope.actions=[{label:"OK",action:function(){$scope.closeAndReturn($scope.model)}},{label:"Cancel",action:function(){$scope.cancel()}}],$scope.init=function(){if($scope.model=Object.assign($scope.model,$params),void 0!=$scope.model.search_engine_options)delete $scope.model.search_engine_options;console.log("init brokerSearchEngine",$params,$scope.model)},$scope.toggleField=function($key){if(void 0==$scope.model.fields)$scope.model.fields=[];if(!$scope.model.fields.includes($key))$scope.model.fields.push($key);else $scope.model.fields=$scope.model.fields.filter($f=>$f!=$key)}}function brokersListItemEditCtrl($scope,$rootScope,$mdDialog,$siUI,$params){BaseDialogController($scope,$mdDialog,$rootScope),$scope.layoutList=[],$scope.availVars=[],$scope.model={},$scope.actions=[{label:"OK",action:function(){$scope.closeAndReturn($scope.model)}}],$scope.init=function(){if(console.log("init brokerListItemEdit",$params,$rootScope.global_list.list_item_vars[$scope.model.type]),$scope.model=Object.assign($scope.model,$params),$scope.layoutList=$rootScope.global_list.list_item_layouts[$scope.model.type],$scope.availVars=$rootScope.global_list.list_item_vars[$scope.model.type],$scope.imageHoverEffects=$rootScope.global_list.list_item_image_hover_effects[$scope.model.type],$scope.layerHoverEffects=$rootScope.global_list.list_item_show_layer_effects[$scope.model.type],$scope.layerPositions=$rootScope.global_list.list_item_layer_positions[$scope.model.type],Array.isArray($scope.model.list_item_layout.displayed_vars))delete $scope.model.list_item_layout.displayed_vars;if(void 0==$scope.model.list_item_layout.image_hover_effect)$scope.model.list_item_layout.image_hover_effect="none";if(void 0==$scope.model.list_item_layout.secondary_layer_effect)$scope.model.list_item_layout.secondary_layer_effect="none";if(void 0==$scope.model.list_item_layout.displayed_vars)$scope.model.list_item_layout.displayed_vars={main:$scope.availVars,secondary:[]};console.log("availVars",$scope.availVars)},$scope.varIsChecked=function($item,$layer="main"){if(void 0==$scope.model.list_item_layout.displayed_vars[$layer])return false;else return $scope.model.list_item_layout.displayed_vars[$layer].includes($item)},$scope.varToggle=function($item,$layer="main"){if(void 0==$scope.model.list_item_layout.displayed_vars[$layer])$scope.model.list_item_layout.displayed_vars[$layer]=[];if($scope.model.list_item_layout.displayed_vars[$layer].includes($item))$scope.model.list_item_layout.displayed_vars[$layer]=$scope.model.list_item_layout.displayed_vars[$layer].filter($v=>$v!=$item);else $scope.model.list_item_layout.displayed_vars[$layer].push($item)},$scope.updateStyles=function($styles){$scope.model.list_item_layout.styles=$styles}}function listingsSearchEngineEditCtrl($scope,$rootScope,$mdDialog,$siUI,$params){BaseDialogController($scope,$mdDialog,$rootScope),$scope.model={type:"full",focus_category:null,orientation:"h",sticky:false},$scope.fieldList=[{key:"searchbox",caption:"Search box".translate()},{key:"cities",caption:"Cities".translate()},{key:"transactions",caption:"Transactions".translate()},{key:"price",caption:"Price".translate()},{key:"bedrooms",caption:"Bedrooms".translate()},{key:"bathrooms",caption:"Bathrooms".translate()},{key:"types",caption:"Types".translate()},{key:"categories",caption:"Categories".translate()},{key:"available_area",caption:"Available area".translate()},{key:"parkings",caption:"Parkings".translate()},{key:"features",caption:"Features".translate()},{key:"filters",caption:"Filters".translate()},{key:"ages",caption:"Ages".translate()}],$scope.actions=[{label:"OK",action:function(){$scope.closeAndReturn($scope.model)}},{label:"Cancel",action:function(){$scope.cancel()}}],$scope.init=function(){if($scope.model=Object.assign($scope.model,$params),void 0!=$scope.model.search_engine_options)delete $scope.model.search_engine_options;console.log("init listingSearchEngine",$params,$scope.model)},$scope.toggleField=function($key){if(void 0==$scope.model.fields)$scope.model.fields=[];if(!$scope.model.fields.includes($key))$scope.model.fields.push($key);else $scope.model.fields=$scope.model.fields.filter($f=>$f!=$key)},$scope.tabsContains=function($tabToCheck){return $tabToCheck.some($t=>$scope.model.tabs.includes($t))}}function listingsListItemEditCtrl($scope,$rootScope,$mdDialog,$siUI,$params){BaseDialogController($scope,$mdDialog,$rootScope),$scope.layoutList=[],$scope.availVars=[],$scope.model={},$scope.actions=[{label:"OK",action:function(){$scope.closeAndReturn($scope.model)}}],$scope.init=function(){if(console.log("init listingListItemEdit",$params,$rootScope.global_list.list_item_vars[$scope.model.type]),$scope.model=Object.assign($scope.model,$params),$scope.layoutList=$rootScope.global_list.list_item_layouts[$scope.model.type],$scope.availVars=$rootScope.global_list.list_item_vars[$scope.model.type],$scope.imageHoverEffects=$rootScope.global_list.list_item_image_hover_effects[$scope.model.type],$scope.layerHoverEffects=$rootScope.global_list.list_item_show_layer_effects[$scope.model.type],$scope.layerPositions=$rootScope.global_list.list_item_layer_positions[$scope.model.type],Array.isArray($scope.model.list_item_layout.displayed_vars))delete $scope.model.list_item_layout.displayed_vars;if(void 0==$scope.model.list_item_layout.image_hover_effect)$scope.model.list_item_layout.image_hover_effect="none";if(void 0==$scope.model.list_item_layout.secondary_layer_effect)$scope.model.list_item_layout.secondary_layer_effect="none";if(void 0==$scope.model.list_item_layout.displayed_vars)$scope.model.list_item_layout.displayed_vars={main:$scope.availVars,secondary:[]};console.log("availVars",$scope.availVars)},$scope.varIsChecked=function($item,$layer="main"){if(void 0==$scope.model.list_item_layout.displayed_vars[$layer])return false;else return $scope.model.list_item_layout.displayed_vars[$layer].includes($item)},$scope.varToggle=function($item,$layer="main"){if(void 0==$scope.model.list_item_layout.displayed_vars[$layer])$scope.model.list_item_layout.displayed_vars[$layer]=[];if($scope.model.list_item_layout.displayed_vars[$layer].includes($item))$scope.model.list_item_layout.displayed_vars[$layer]=$scope.model.list_item_layout.displayed_vars[$layer].filter($v=>$v!=$item);else $scope.model.list_item_layout.displayed_vars[$layer].push($item)},$scope.updateStyles=function($styles){$scope.model.list_item_layout.styles=$styles}}function citiesSearchEngineEditCtrl($scope,$rootScope,$mdDialog,$siUI,$params){BaseDialogController($scope,$mdDialog,$rootScope),$scope.model={type:"full",focus_category:null,orientation:"h",sticky:false},$scope.fieldList=[{key:"searchbox",caption:"Search box".translate()},{key:"regions",caption:"Alphabetical".translate()}],$scope.actions=[{label:"OK",action:function(){$scope.closeAndReturn($scope.model)}},{label:"Cancel",action:function(){$scope.cancel()}}],$scope.init=function(){if($scope.model=Object.assign($scope.model,$params),void 0!=$scope.model.search_engine_options)delete $scope.model.search_engine_options;console.log("init brokerSearchEngine",$params,$scope.model)},$scope.toggleField=function($key){if(void 0==$scope.model.fields)$scope.model.fields=[];if(!$scope.model.fields.includes($key))$scope.model.fields.push($key);else $scope.model.fields=$scope.model.fields.filter($f=>$f!=$key)}}function citiesListItemEditCtrl($scope,$rootScope,$mdDialog,$siUI,$params){BaseDialogController($scope,$mdDialog,$rootScope),BaseListItemEditController($scope,$rootScope),$scope.model={},$scope.init=function(){console.log("init cityListItemEdit",$params,$rootScope.global_list.list_item_vars[$scope.model.type]),$scope.base.init($params),console.log("availVars",$scope.availVars)}}function officesSearchEngineEditCtrl($scope,$rootScope,$mdDialog,$siUI,$params){BaseDialogController($scope,$mdDialog,$rootScope),$scope.model={type:"full",focus_category:null,orientation:"h",sticky:false},$scope.fieldList=[{key:"searchbox",caption:"Search box".translate()},{key:"regions",caption:"Alphabetical".translate()}],$scope.actions=[{label:"OK",action:function(){$scope.closeAndReturn($scope.model)}},{label:"Cancel",action:function(){$scope.cancel()}}],$scope.init=function(){if($scope.model=Object.assign($scope.model,$params),void 0!=$scope.model.search_engine_options)delete $scope.model.search_engine_options;console.log("init brokerSearchEngine",$params,$scope.model)},$scope.toggleField=function($key){if(void 0==$scope.model.fields)$scope.model.fields=[];if(!$scope.model.fields.includes($key))$scope.model.fields.push($key);else $scope.model.fields=$scope.model.fields.filter($f=>$f!=$key)}}function officesListItemEditCtrl($scope,$rootScope,$mdDialog,$siUI,$params){BaseDialogController($scope,$mdDialog,$rootScope),BaseListItemEditController($scope,$rootScope),$scope.model={},$scope.init=function(){console.log("init officeListItemEdit",$params,$rootScope.global_list.list_item_vars[$scope.model.type]),$scope.base.init($params),console.log("availVars",$scope.availVars)}}function BaseDialogController($scope,$mdDialog,$rootScope){return $scope.actions=[{label:"OK",action:function(){$scope.cancel()}}],$scope.cancel=function(){$mdDialog.cancel()},$scope.closeAndReturn=function($result){$mdDialog.hide($result)},$scope}function BaseListItemEditController($scope,$rootScope){$scope.layoutList=[],$scope.availVars=[],$scope.base={init:function($params){if($scope.model=Object.assign($scope.model,$params),$scope.layoutList=$rootScope.global_list.list_item_layouts[$scope.model.type],$scope.availVars=$rootScope.global_list.list_item_vars[$scope.model.type],$scope.imageHoverEffects=$rootScope.global_list.list_item_image_hover_effects[$scope.model.type],$scope.layerHoverEffects=$rootScope.global_list.list_item_show_layer_effects[$scope.model.type],Array.isArray($scope.model.list_item_layout.displayed_vars))delete $scope.model.list_item_layout.displayed_vars;if(void 0==$scope.model.list_item_layout.image_hover_effect)$scope.model.list_item_layout.image_hover_effect="none";if(void 0==$scope.model.list_item_layout.secondary_layer_effect)$scope.model.list_item_layout.secondary_layer_effect="none";if(void 0==$scope.model.list_item_layout.displayed_vars)$scope.model.list_item_layout.displayed_vars={main:$scope.availVars,secondary:[]}}},$scope.actions=[{label:"OK",action:function(){$scope.closeAndReturn($scope.model)}}],$scope.varIsChecked=function($item,$layer="main"){if(void 0==$scope.model.list_item_layout.displayed_vars[$layer])return false;else return $scope.model.list_item_layout.displayed_vars[$layer].includes($item)},$scope.varToggle=function($item,$layer="main"){if(void 0==$scope.model.list_item_layout.displayed_vars[$layer])$scope.model.list_item_layout.displayed_vars[$layer]=[];if($scope.model.list_item_layout.displayed_vars[$layer].includes($item))$scope.model.list_item_layout.displayed_vars[$layer]=$scope.model.list_item_layout.displayed_vars[$layer].filter($v=>$v!=$item);else $scope.model.list_item_layout.displayed_vars[$layer].push($item)},$scope.updateStyles=function($styles){$scope.model.list_item_layout.styles=$styles}}function BasePageController($pageId,$scope,$rootScope){return $scope.pageId=$pageId,$scope.callback=null,$scope.actions=[{label:"OK",action:function(){$scope.cancel()}}],$scope._pageInit_=function(){console.log("pageInit for",$scope.pageId,"called"),$scope.$on("on-"+$scope.pageId,function($event,$params,$callback){if(console.log("instance of page",$scope.pageId,"called with",$params),"function"==typeof $scope.init)$scope.init($params);$scope.open_page($scope.pageId),$scope.callback=$callback})},$scope.cancel=function(){$scope.close_page()},$scope.return=function($result){$scope.callback($result),$scope.close_page()},$scope.open_page=function($page_id){$rootScope.current_page=$page_id},$scope.close_page=function(){$rootScope.current_page="home"},$scope}var siApp=angular.module("siApplication",["ngRoute","ngMaterial","ngMessages","mdColorPicker","ngSanitize"]);siApp.config(function($routeProvider,$mdThemingProvider,$httpProvider,$mdAriaProvider){$mdAriaProvider.disableWarnings(),$mdThemingProvider.theme("default").primaryPalette("blue").accentPalette("deep-orange"),$mdThemingProvider.theme("docs-dark","default").primaryPalette("blue").dark()}),siApp.controller("homeCtrl",function($scope,$rootScope,$timeout){console.log("configs controller loaded"),$scope.route_listing_elements={"{{item.ref_number}}":"ID","{{item.transaction}}":"Transaction type","{{item.location.region}}":"Region","{{item.location.city}}":"City","{{item.location.street}}":"Street","{{item.location.civic_address}}":"Civic address"},$scope.route_broker_elements={"{{item.ref_number}}":"ID","{{item.first_name}}":"First name","{{item.last_name}}":"Last name"},$scope.route_city_elements={"{{item.code}}":"ID","{{item.location.region}}":"Region","{{item.name}}":"Name"},$scope._pageInit_=function(){$scope.show("general")},$scope.addRouteElement=function($item,$elm){$item.route+=$elm},$scope.addRoute=function($list,$lang){let lLocale=$lang;if(!$list.some(function($e){return $e.lang==$lang}))$list.push({lang:lLocale,route:""})},$scope.removeRoute=function($index,$list_name){$scope.configs[$list_name].splice($index,1)},$scope.addLayout=function($list,$lang){if(!$list.some(function($e){return $e.lang==$lang}))$list.push({lang:$lang,page:null,communication_mode:"basic"})},$scope.removeLayout=function($index,$list){$timeout(_=>{$list.splice($index,1),$scope.save_configs()})},$scope.hasMinRouteCount=function($list){return 1==$list.length},$scope.hasMaxRouteCount=function($list){let lResult=true;if($list)for(let $key in $scope.wp_languages)if($list.map(function(e){return e.lang}).indexOf($key)<0)lResult=false;return lResult},$scope.clearAccessToken=function(){$scope.api("access_token",null,{method:"PATCH"}).then(function($response){$scope.show_toast("Access token cleared")})},$scope.show=function($panel_id){const lAdminPanel=document.querySelector("#si-admin-configs"),lNavButtons=Array.from(lAdminPanel.querySelectorAll(".nav-button")),lSections=Array.from(lAdminPanel.querySelectorAll(".sections section")),lButton=lAdminPanel.querySelector(".nav-button."+$panel_id),lTarget=lAdminPanel.querySelector("#"+$panel_id);lNavButtons.forEach($e=>$e.classList.remove("selected")),lSections.forEach($e=>$e.classList.remove("selected")),lTarget.classList.add("selected"),lButton.classList.add("selected")}}),siApp.controller("listCollectionCtrl",function($scope,$rootScope){$scope.init=function(){},$scope.add=function($type){$scope.show_page("listEdit",$type).then(function($result){lNew=$result,$scope.configs.lists.push(lNew),$scope.$emit("save-request")})},$scope.edit=function($list){$scope.show_page("listEdit",$list).then(function($result){console.log("new list data",$result);for(const key in $result)if($result.hasOwnProperty(key)){const element=$result[key];$list[key]=element}$scope.$emit("save-request")})},$scope.remove=function($list){$scope.confirm("Are you sure you want to remove this list?","This action could renders some sections of your site blank",{ok:"Continue"}).then(function(){let lNewlists=[];$scope.configs.lists.forEach(function($e){if($e!=$list)lNewlists.push($e)}),$scope.configs.lists=lNewlists,$scope.show_toast("List removed"),$scope.$emit("save-request")})},$scope.getListShortcode=function($list,$type=null){switch($type){case"search":return'[si_search alias="'+$list.alias+'" placeholder="Find a property, city, street, #sia, etc." result_page="/proprietes/" standalone="true"]';break;case"searchbox":return'[si_searchbox alias="'+$list.alias+'" placeholder="Find a property, city, street, #sia, etc." result_page="/proprietes/"]';break;case"gallery":return'[si_list_slider alias="'+$list.alias+'" limit="10"]';break;default:return'[si alias="'+$list.alias+'"]'}},$scope.countFilters=function($list){let lResult=0;if(null!=$list.filter_groups)$list.filter_groups.forEach(function($e){lResult+=$e.filters.length});return lResult}}),siApp.controller("mainCtrl",function($scope,$rootScope,$mdDialog,$q,$http,$mdToast,$timeout,$siApi,$siList,$siUI,$siUtils){$scope._status="initializing",$scope.loaded_components=[],$scope.wpSiApiSettings=wpSiApiSettings,$scope.notices=[],$scope.configs={},$scope.lang_codes={fr:"Français",en:"English",es:"Español"},$scope.wp_languages=null,$rootScope.global_list={sources:[],list_types:[{key:"listings",label:"Listings"},{key:"brokers",label:"Brokers"},{key:"cities",label:"Cities"},{key:"offices",label:"Offices"}],list_layouts:{listings:[{name:"standard",label:"Client side (Default)"},{name:"direct",label:"Server side (no search tool)"}],brokers:[{name:"standard",label:"Client side (Default)"},{name:"direct",label:"Server side (no search tool)"}],cities:[{name:"direct",label:"Server side (no search tool)"}],offices:[{name:"direct",label:"Server side (no search tool)"}]},list_item_layouts:{listings:[{name:"standard",label:"Standard"},{name:"double-layer",label:"Double Layers (advanced)"}],brokers:[{name:"standard",label:"Standard"},{name:"double-layer",label:"Double Layers (advanced)"}],cities:[{name:"standard",label:"Standard"}],offices:[{name:"standard",label:"Standard"}]},list_item_vars:{listings:[{name:"ref_number",label:"Ref. number"},{name:"price",label:"Price"},{name:"address",label:"Address"},{name:"city",label:"City"},{name:"description",label:"Description"},{name:"category",label:"Category"},{name:"subcategory",label:"Subcategory"},{name:"rooms",label:"Rooms"},{name:"region",label:"Region"},{name:"available_area",label:"Available area"},{name:"flags",label:"Flags"},{name:"open_houses",label:"Open houses"}],brokers:[{name:"fullname",label:"Fullname"},{name:"first_name",label:"First name"},{name:"last_name",label:"Last name"},{name:"title",label:"Title"},{name:"phone",label:"Phone"},{name:"email",label:"Email"},{name:"office",label:"Office"},{name:"listing_count",label:"Listings"}],cities:[{name:"name",label:"Name"},{name:"region",label:"Region"},{name:"listing_count",label:"Listings"},{name:"code",label:"Code"}],offices:[{name:"name",label:"Name"},{name:"region",label:"Region"},{name:"listing_count",label:"Listings"},{name:"address",label:"Address"},{name:"code",label:"Code"}]},list_item_image_hover_effects:{listings:[{name:"none",label:"None"},{name:"zoom",label:"Zoom"},{name:"gallery",label:"Gallery"}],brokers:[{name:"none",label:"None"},{name:"zoom",label:"Zoom"}],cities:[],offices:[]},list_item_show_layer_effects:{listings:[{name:"none",label:"None"},{name:"slide",label:"Slide"},{name:"flip",label:"Flip"},{name:"fade",label:"Fade"}],brokers:[{name:"none",label:"None"},{name:"slide",label:"Slide"},{name:"flip",label:"Flip"},{name:"fade",label:"Fade"}],cities:[{name:"none",label:"None"},{name:"slide",label:"Slide"},{name:"flip",label:"Flip"},{name:"fade",label:"Fade"}],offices:[{name:"none",label:"None"},{name:"slide",label:"Slide"},{name:"flip",label:"Flip"},{name:"fade",label:"Fade"}]},list_item_layer_positions:{listings:[{name:"fix",label:"Fix"},{name:"overlay",label:"Overlay"}],brokers:[{name:"fix",label:"Fix"},{name:"overlay",label:"Overlay"}],cities:[{name:"fix",label:"Fix"},{name:"overlay",label:"Overlay"}],offices:[{name:"fix",label:"Fix"},{name:"overlay",label:"Overlay"}]},detail_layouts:[{name:"standard",label:"Standard"},{name:"custom_page",label:"Custom layout from page"}],list_ordering_field:{listings:[{name:"contract_start_date",label:"Inscription date"},{name:"price",label:"Price"}],brokers:[{name:"last_name",label:"Name"},{name:"listing_count",label:"Number of listings"}],cities:[{name:"name",label:"Name"},{name:"region",label:"Region"}],offices:[{name:"name",label:"Name"},{name:"region",label:"Region"}]}},$scope.registration_steps=[{name:"Linked account"},{name:"API key"},{name:"Data feed(s)"},{name:"Integration"}],$rootScope.current_page="home",$scope.pages={home:{label:"Home".translate(),style:""},listEdit:{label:"List editing".translate(),style:"transform:translateX(-100%);"}},$scope.configuration_step=0,$scope.credentials=null,$scope.data_views=[],$scope.wp_pages=[],$scope.login_infos={email:"",password:""},$scope.api_keys=null,$scope.page_languages=[],$scope.languages={fr:"Français",en:"English",es:"Español"},$scope.message=null,$scope.default_page={fr:{listing:"NEW",listing_details:"NEW",broker:"NEW",broker_details:"NEW",city:"NONE",city_details:"NONE",office:"NONE",office_details:"NONE"},en:{listing:"NEW",listing_details:"NEW",broker:"NEW",broker_details:"NEW",city:"NONE",city_details:"NONE",office:"NONE",office_details:"NONE"}},$scope.init=function(){$scope.load_configs().then(_=>{$q.all([$scope.load_wp_pages(),$scope.load_wp_menus(),$scope.load_data_views(),$scope.load_wp_forms(),$scope.load_dictionary(),$scope.load_addons()]).then(_=>{if($scope._status="ready",false!=$scope.configs.registered)$scope.checkIntegrity();else $scope.startRegistration()},_=>{$scope._status="ready"}).catch($err=>{$scope._status="ready"})}),$scope.$on("save-request",function(){$scope.save_configs()}),$scope.$on("reload-pages",function(){$scope.load_wp_pages()})},$scope.load_configs=function(){return $q(function($resolve,$reject){$scope.api("configs").then(function($response){if($scope.configs=$response,null==$scope.configs.default_view)return $scope.reset_configs(),void $resolve();if("undefined"!=typeof $scope.configs.default_view.id)$scope.configs.default_view=$scope.configs.default_view.id;if($scope.configs.default_view.indexOf('{"id":')>=0)$scope.configs.default_view=JSON.parse($scope.configs.default_view).id;$resolve()})})},$scope.load_addons=function(){$scope.api("addons/list",null,{method:"GET"}).then(function($response){$scope.loaded_components.push("cogs"),$scope.addons=$response})},$scope.load_wp_forms=function(){$scope.api("form/list",null,{method:"GET"}).then(function($response){$scope.loaded_components.push("clipboard-check"),$scope.formList=$response})},$scope.load_dictionary=function(){$scope.api("dictionary",{lang:$locales._current_lang_},{method:"GET"}).then(function($response){$scope.loaded_components.push("book"),$siList.dictionary=$response})},$scope.reset_all_configs=function(){$siUI.confirm("All your configurations will be lost.\nAre you sure you want to reset all settings?").then(function(){return $scope.reset_configs()}).then(function(){$siUI.show_toast("Configurations cleared")}).then(function(){$scope.startRegistration()})},$scope.reset_configs=function(){return $scope.api("configs/reset",null,{method:"POST"}).then(function($response){$scope.configs=$response})},$scope.save_configs=function($silent){return $silent="undefined"==typeof $silent?false:$silent,$q(function($resolve,$reject){$scope.validateListConfigs().then(_=>{console.log("saving configs",$scope.configs),$scope.api("configs",{settings:$scope.configs}).then(function($response){if(!$silent)$scope.show_toast("Save completed");$scope.checkIntegrity(),$resolve()})})})},$scope.validateListConfigs=function(){const lDefaultSearchTokenRenew=$scope.configs.lists.filter($l=>""==$l.search_token).map($l=>$q(($resolve,$reject)=>{$siUtils.renewListSearchToken($l).then($token=>{$l.search_token=$token,console.log("After token renew",$l),$resolve()})}));return $q.all(lDefaultSearchTokenRenew)},$scope.isInitializing=function(){return"initializing"==$scope._status},$scope.load_wp_languages=function(){return $q(function($resolve,$reject){if(null==$scope.wp_languages)$scope.api("language/list",null,{method:"GET"}).then($result=>{$scope.wp_languages=$result,$resolve($scope.wp_languages)}).catch($err=>{console.error($err)});else $resolve($scope.wp_languages)})},$scope.load_wp_pages=function(){return $q(function($resolve,$reject){$scope.load_wp_languages().then($languages=>{$q.all([$scope.api("page/list",{locale:"fr",type:""},{method:"GET"}),$scope.api("page/list",{locale:"en",type:""},{method:"GET"})]).then($results=>{$scope.wp_pages.fr=$results[0],$scope.wp_pages.en=$results[1],$scope.loaded_components.push("file"),$resolve($scope.wp_pages)}).catch($err=>{console.error($err)})})})},$scope.load_wp_menus=function(){return $scope.api("menu/list",null,{method:"GET"}).then($result=>{$scope.wp_menus=Object.keys($result).map($k=>({key:$k,name:$result[$k]}))})},$scope.load_data_views=function(){return $q(function($resolve,$reject){$scope.api("account").then(function($response){if(null!=$response)$scope.data_views=$response.data_views,$scope.loaded_components.push("list"),$resolve($response.data_views);else $resolve()})})},$scope.signin=function(){$scope.signin_in=true,$scope.portalApi("auth/login",$scope.login_infos).then($response=>{if($scope.signin_in=false,[10,20].includes($response.statusCode))return void $siUI.alert($response.message);console.log("signin configs",$scope.configs),$scope.credentials=$response,$scope.configs.account_id=null,$scope.configs.api_key=null;const lRegistrationSequence=[$scope.selectAccount,$scope.selectApiKey,$scope.selectDefaultView,$scope.setDisplayPages];lRegistrationSequence.reduce(($previous,$current)=>$previous.then(_=>$current()),Promise.resolve()).then($result=>{$scope.message={show_icon:true,title:"Configuration completed",text:"Thank you! Please wait while the interface reloads"},$scope.configs.registered=true,$scope.save_configs().then(_=>{window.setTimeout(_=>{$scope.configuration_step=0,$scope.api_keys=null,window.location.reload(true)},2e3)})})})},$scope.signout=function(){$siUI.confirm("Attention","Once disconnected from your account, all your real estate data will disapear from your site.\nAre you sure you want to continue?").then(function(){$scope.reset_configs().then(function(){$scope.show_toast("Configuration reset")}).then(function(){$scope.startRegistration()})})},$scope.startRegistration=function(){console.log("startRegistration"),$siUI.dialog("~/views/admin/dialogs/register.html",null,{multiple:true,clickOutsideToClose:false,hasBackdrop:false}).then(function(){window.location.reload(true)})},$scope.selectAccount=function(){return $q(function($resolve,$reject){console.log("Account selection"),$scope.configuration_step+=1,$scope.portalApi("linked_account/list").then($response=>{$response.items.forEach($e=>{$e.clickHandler=function(){console.log("selected account",$e),$scope.portal_account_id=$e.id,$resolve()}}),$scope.accounts=$response})})},$scope.selectApiKey=function(){return $q(function($resolve,$reject){console.log("Api Key selection"),$scope.configuration_step+=1,$scope.portalApi("api_key/list").then($response=>{if(1==$response.items.length)$scope.configs.account_id=$response.items[0].accountId,$scope.configs.api_key=$response.items[0].id,$scope.save_configs(true).then(_=>{$resolve()});else $response.items.forEach($e=>{$e.clickHandler=function(){$scope.configs.account_id=$e.accountId,$scope.configs.api_key=$e.id,$scope.save_configs(true).then(_=>{$resolve()})}}),$scope.api_keys=$response})})},$scope.selectDefaultView=function(){return $q(function($resolve,$reject){console.log("Default view selection"),$scope.configuration_step+=1,$scope.load_data_views().then($views=>{if(console.log("views",$views),1==$views.length)$scope.configs.default_view=$views[0].id,$scope.updateListsView(),$resolve();else $views.forEach($e=>{$e.clickHandler=function(){$scope.configs.default_view=$e.id,$scope.updateListsView(),$resolve()}})})})},$scope.setDisplayPages=function(){$scope.configuration_step+=1,console.log("setDisplayPages",$scope.wp_languages),$scope.wp_languages.forEach($l=>{$scope.addPageLanguage($l)});const lShortcodeMap={listing:{title:"Our listings",content:'[si alias="listings"]',list:_=>{$scope.addList("listings","listings","contract_start_date",true,30)}},listing_details:{title:"Listing details",content:"[si_listing]",layout:"listing_layouts"},broker:{title:"Our team",content:'[si alias="brokers"]',list:_=>{$scope.addList("brokers","brokers","last_name")}},broker_details:{title:"Broker details",content:"[si_broker]",layout:"broker_layouts"},office:{title:"Our offices",content:'[si alias="offices"]',list:_=>{$scope.addList("offices","offices","name")}},office_details:{title:"Office details",content:"[si_office]",layout:"office_layouts"},city:{title:"Cities",content:'[si alias="cities"]',list:_=>{$scope.addList("cities","cities","name")}},city_details:{title:"City details",content:"[si_city]",layout:"city_layouts"}};return["listing","listing_details","broker","broker_details"].forEach($k=>{const lPageEn=$scope.wp_pages.en.find($page=>$page.post_title==lShortcodeMap[$k].title),lPageFr=$scope.wp_pages.fr.find($page=>$page.post_title==lShortcodeMap[$k].title.translate());if(null!=lPageEn)$scope.default_page.en[$k]=lPageEn.ID;if(null!=lPageFr)$scope.default_page.fr[$k]=lPageFr.ID}),$q(function($resolve,$reject){$scope.applyShortCodeHandler=function(){$scope.configs.lists=[];const lSourcePages=[],lChildPages=[];return $scope.wp_languages.forEach(($language,$language_index)=>{Object.keys($scope.default_page[$language.code]).forEach($pKey=>{if("NONE"==$scope.default_page[$language.code][$pKey])return;const lMap=lShortcodeMap[$pKey];if(void 0==lMap)return void console.log("Map undefined",$pKey,$language.code,lShortcodeMap);if("function"==typeof lMap.list)lMap.list();const params={page_id:$scope.default_page[$language.code][$pKey],title:lMap.title.translate(void 0,$language.code),content:lMap.content,lang:$language.code},lCall=_=>{const lLayout=void 0==lMap.layout?null:$scope.configs[lMap.layout].find($layout=>$layout.lang==$language.code);if($language_index>0)if(void 0!=lMap.pages&&void 0!=lMap.pages[$scope.wp_languages[0].code])params.original_page_id=lMap.pages[$scope.wp_languages[0].code];return $scope.api("page",params).then($response=>{if("NEW"==$scope.default_page[$language.code][$pKey]&&!isNaN($response+1)){if(void 0==lMap.pages)lMap.pages={};if(lMap.pages[$language.code]=$response,null!=lLayout)lLayout.page=$response,lLayout.type="custom"}else if("NEW"!=$scope.default_page[$language.code][$pKey])if(null!=lLayout)lLayout.page=$scope.default_page[$language.code][$pKey],lLayout.type="custom"})};if(0==$language_index)lSourcePages.push(lCall);else lChildPages.push(lCall)})}),$timeout(_=>{$scope.message={show_icon:false,title:"Work in progress",text:"Please wait while we apply your configuration"}}),lSourcePages.reduce((promiseChain,currentTask)=>promiseChain.then(chainResults=>currentTask().then(currentResult=>[...chainResults,currentResult])),Promise.resolve([])).then(arrayOfResults=>(console.log("All main page created"),lChildPages.reduce((promiseChain,currentTask)=>promiseChain.then(chainResults=>currentTask().then(currentResult=>[...chainResults,currentResult])),Promise.resolve([])).then(arrayOfResults=>{console.log("All child page created"),$resolve()}))).catch($error=>{console.log("An error occured while creating page")})},$scope.skipPageBuilding=function(){$resolve()}})},$scope.addList=function($type,$alias,$sort="",$sortReverse=false,$limit=0){const lExistingList=$scope.configs.lists.find($l=>$l.alias==$alias),lView=$scope.data_views.find($e=>$e.id==$scope.configs.default_view),lList=$siUtils.createList(lView,$type,$alias,$sort,$sortReverse,$limit,lExistingList);if(null==lExistingList)$scope.configs.lists.push(lList)},$scope.addPageLanguage=function($lang){const lPageTitleByLangMap={fr:{"propriétés":"listing",courtiers:"broker",bureaux:"office",villes:"city"},en:{properties:"listing",brokers:"broker",offices:"office",cities:"city"}},lLocaleCode=$lang.code;if(void 0==$scope.default_page[lLocaleCode])$scope.default_page[lLocaleCode]={};$scope.wp_pages[lLocaleCode].forEach($p=>{const lMapKey=Object.keys(lPageTitleByLangMap[lLocaleCode]).find($k=>$k==$p.post_title.toLowerCase())
;if(null!=lMapKey)$scope.default_page[lLocaleCode][lMapKey]=$p.ID}),$scope.page_languages.push(lLocaleCode),console.log("page_languages",$scope.page_languages)},$scope.removePageLanguage=function($lang){$scope.page_languages=$scope.page_languages.filter($l=>$l!=$lang)},$scope.showPage=function($layout){if(void 0!=$layout.page)$scope.api("page/permalink",{page_id:$layout.page}).then($response=>{window.open($response)})},$scope.languageIsAvailable=function($lang){return!$scope.page_languages.includes($lang.code)},$scope.applyListingShortCode=function(){return $q(function($resolve,$reject){const params={page_id:$scope.default_page.listing,title:"Our Listings".translate(),content:'[si alias="listings"]'};$scope.api("page",params).then($result=>{$resolve()})})},$scope.applyBrokerShortCode=function(){return $q(function($resolve,$reject){const params={page_id:$scope.default_page.broker,title:"Our Teams".translate(),content:'[si alias="brokers"]'};$scope.api("page",params).then($result=>{$resolve()})})},$scope.updateListsView=function(){$scope.configs.lists.forEach($e=>{if(""==$e.source)$e.source=$scope.data_views.find($e=>$e.id==$scope.configs.default_view),$e.search_token=""}),console.log("config lists",$scope.configs.lists)},$scope.updateStyles=function($styles){$scope.configs.styles=$styles,$scope.save_configs()},$scope.initListSearchToken=function(){let lFilters=null,lPromise=$q(function($resolve,$reject){if(null!=lFilters)$scope.api("",lFilters,{url:wpSiApiSettings.api_root+"/api/utils/search_encode"}).then(function($response){$resolve($response)});else $resolve("")});return lPromise},$scope.changeApiKey=function(){$siUI.getPortalCredentials().then($credentials=>{console.log($credentials),$scope.credentials=$credentials,$scope.portalApi("linked_account/list").then($response=>{const lPortalAccount=$response.items.find($e=>$e.account.id==$scope.configs.account_id);if(null!=lPortalAccount)$scope.portal_account_id=lPortalAccount.id,$scope.portalApi("api_key/list").then($response=>{if(1!=$response.items.length)$scope.api_keys=$response.items;else $siUI.show_toast("There's only one API key for this account")})})})},$scope.checkIntegrity=function(){if($scope.notices=[],$scope.hasEmptyLayouts()){const lMissingLayout=$scope.getEmptyLayouts().map(function($l){return $l.translate()});console.log("missing layout",lMissingLayout),$scope.addNotice("Missing layouts","Some list are missing a detail page layout. Please check the following section{1}: {0}".translate().format(lMissingLayout.join(", "),lMissingLayout.length>1?"s":""),{actions:{"Create missing pages":function(){$siUI.confirm("Attention","Creating missing layout may duplicate some page under certain circonstance.\nContinue anyway?",{ok:"Yes",cancel:"No"}).then(function(){$scope.fillEmptyLayouts()})}}})}if(isNullOrEmpty($scope.configs.map_api_key))$scope.addNotice("Map API key","The map API key is not configured. Maps will not be available in list or details.");if(0==$scope.notices.length)$scope.addNotice("All good","The plugin is properly configured",{type:"success",color:"#4AB448",icon:"fa-check-circle"})},$scope.hasErrorNotices=function(){return $scope.notices.some(function($n){return"warning"==$n.type})},$scope.addNotice=function($title,$message,$options){const lNotice=Object.assign({title:$title,message:$message,color:"#ff9900",actions:[],icon:"fa-exclamation-triangle",type:"warning"},$options);$scope.notices.push(lNotice)},$scope.generateLayoutPage=function($layout,$groupType){const lTypeMaps={listings:{title:"Listing details",content:"[si_listing]",layouts:$scope.configs.listing_layouts},brokers:{title:"Broker details",content:"[si_broker]",layouts:$scope.configs.broker_layouts},offices:{title:"Office details",content:"[si_office]",layouts:$scope.configs.office_layouts},cities:{title:"City details",content:"[si_city]",layouts:$scope.configs.city_layouts}},lLayoutInfos=lTypeMaps[$groupType],lPageTitle="en"==$layout.lang?lLayoutInfos.title:lLayoutInfos.title.translate(),lPageContent=lLayoutInfos.content,lOriginalPageId=lLayoutInfos.layouts.filter($l=>null!=$l.page&&$l.lang!=$layout.lang).reduce(($result,$cur)=>$cur.page,null);$scope.api("page",{lang:$layout.lang,page_id:"NEW",title:lPageTitle,content:lPageContent,original_page_id:lOriginalPageId}).then($response=>{$layout.page=$response,$scope.save_configs()})},$scope.clearAllLayoutPage=function(){const lLayoutMap=["listing_layouts","broker_layouts","office_layouts","city_layouts"];lLayoutMap.forEach($layoutGroup=>{$scope.configs[$layoutGroup].forEach($layout=>{$layout.page=null})}),$scope.save_configs()},$scope.clearLayoutPage=function($layout){$layout.page=null,$scope.save_configs()},$scope.getEmptyLayouts=function(){const lLayoutMap={listings:"listing_layouts",brokers:"broker_layouts",offices:"office_layouts",cities:"city_layouts"},lFiltered=Object.keys(lLayoutMap).filter(function($type){return $scope.configs.lists.some(function($l){return $l.type==$type})});return lFiltered.filter(function($type){return $scope.configs[lLayoutMap[$type]].some(function($layout){return null==$layout.page})})},$scope.hasEmptyLayouts=function(){return $scope.getEmptyLayouts().length>0},$scope.fillEmptyLayouts=function(){const lLayoutMap={listings:"listing_layouts",brokers:"broker_layouts",offices:"office_layouts",cities:"city_layouts"},lPages={listings:{title:"Listing details",content:"[si_listing]"},brokers:{title:"Broker details",content:"[si_broker]"},offices:{title:"Office details",content:"[si_office]"},cities:{title:"City details",content:"[si_city]"}},lLayoutCreationPromises=[];return Object.keys(lLayoutMap).filter(function($type){return $scope.configs.lists.some(function($l){return $l.type==$type})}).forEach(function($type){let lOrignalPageId=null;$scope.configs[lLayoutMap[$type]].forEach(function($layout){if(null==$layout.page)lLayoutCreationPromises.push(_=>{const lPageTitle="en"==$layout.lang?lPages[$type].title:lPages[$type].title.translate(),lPageContent=lPages[$type].content;return $q(($resolve,$reject)=>{$scope.api("page",{lang:$layout.lang,page_id:"NEW",title:lPageTitle,content:lPageContent,original_page_id:lOrignalPageId}).then($response=>{$layout.page=$response,lOrignalPageId=$layout.page,console.log("apply page layout",$response,$layout.page),$resolve()})})})})}),$siUI.show_toast("Generating empty layout pages"),lLayoutCreationPromises.reduce((promiseChain,currentTask)=>promiseChain.then(chainResults=>currentTask().then(currentResult=>[...chainResults,currentResult])),Promise.resolve([])).then(arrayOfResults=>{console.log("saving these",$scope.configs),$scope.save_configs(),$rootScope.$broadcast("reload-pages")})},$scope.show_page=function($page_id,$params){console.log("page is called",$page_id);let lPromise=$q(function($resolve,$reject){$rootScope.$broadcast("on-"+$page_id,$params,function($result){$resolve($result)})});return lPromise},$scope.confirm=function($title,$message,$options){return $siUI.confirm($title,$message,$options)},$scope.show_toast=function($message){$siUI.show_toast($message)},$scope.api=function($path,$data,$options){return $siApi.rest($path,$data,$options)},$scope.portalApi=function($path,$data,$options){const lOptions=Object.assign({method:"POST"},$options);if(lOptions.url="https://portal-api.source.immo/api/"+$path,null!=$data)if("POST"==lOptions.method)lOptions.data=$data;else lOptions.params=$path;if(null!=$scope.credentials){if(!lOptions.params)lOptions.params={};if(lOptions.params.at=$scope.credentials.authTokenKey,null!=$scope.portal_account_id)lOptions.params.la=$scope.portal_account_id}return $q(($resolve,$reject)=>{$http(lOptions).then($response=>{if(200==$response.status)$resolve($response.data)}).catch($err=>{console.log($path,"call failed",$err)})})},$scope.copy=function($data){let lContent="";if(null!==$data&&"object"===typeof $data)lContent=JSON.stringify($data);else lContent=$data;let lTextarea=document.createElement("textarea");lTextarea.textContent=lContent,lTextarea.style.position="fixed",document.body.appendChild(lTextarea),lTextarea.select();try{$scope.show_toast("Copied to clipboard"),document.execCommand("copy")}catch(ex){return console.warn("Copy to clipboard failed.",ex),false}finally{document.body.removeChild(lTextarea)}},$scope.isSame=function($objA,$objB){if(null!=$objA&&null!=$objB){for(const key in $objA)if("$$hashKey"!=key)if(0!=key.indexOf("$$"))if(null!=$objA[key]&&null!=$objB[key])if("undefined"!=typeof $objA[key]&&"undefined"!=typeof $objB[key]){if("function"==typeof $objA[key].push){if($objA[key].length!=$objB[key].length)return false;else for(let i=0;i<$objA[key].length;i++)if(!$scope.isSame($objA[key][i],$objB[key][i]))return false}else if("object"==typeof $objA[key]){if(!$scope.isSame($objA[key],$objB[key]))return false}else if($objA[key]!=$objB[key])return false}else return false;else if(null!=$objA[key]||null!=$objB[key])return false}else if(null==$objA||null==$objB)return false;return true}}),siApp.controller("listEditCtrl",function($scope,$rootScope,$q,$siUtils,$siUI){BasePageController("listEdit",$scope,$rootScope),$scope.model={},$scope._original=null,$scope.previewElements=[],$scope.computedStyles=null,$scope.actions=[{label:"Apply".translate(),action:function(){$scope.return($scope.model)}},{label:"Cancel".translate(),action:$scope.cancel}],$scope.init=function($params){if(console.log("listEdit init",$scope.configs),"string"==typeof $params)$scope.model={alias:"New {0} list".translate().format($params.translate()),$$source_id:$scope.configs.default_view,type:$params},$scope.reset_default_value();else{if($scope.model=angular.copy($params),null!=$scope.model.source)$scope.model.$$source_id=$scope.model.source.id;$scope.validate()}$scope._original=$params,$scope.buildPreviewElement(),$scope.computeStyles(),$scope.$watch("model.list_item_layout.preset",function($new,$old){if($new!=$old)$scope.buildPreviewElement()})},$scope.reset_default_value=function(){switch($scope.model=angular.merge($scope.model,{sort:null,sort_reverse:false,limit:0,searchable:true,search_engine_options:{type:"full",focus_category:null,orientation:"h",filter_tags:"none"},sortable:true,mappable:true,filter_group:{filters:[],filter_groups:[],operator:"and"}}),$scope.model.type){case"listings":$scope.model=angular.merge($scope.model,{list_layout:{preset:"standard",scope_class:"",custom:null,item_row_space:{desktop:33,laptop:33,tablet:50,mobile:100}},list_item_layout:{preset:"standard",scope_class:"",custom:null,primary_layer_position:"fix",secondary_layer_bg_opacity:80,layout:"standard",displayed_vars:{main:["address","city","price","category","rooms","subcategory"]}}});break;case"brokers":$scope.model=angular.merge($scope.model,{list_layout:{preset:"standard",scope_class:"",custom:null,item_row_space:{desktop:25,laptop:25,tablet:50,mobile:100}},list_item_layout:{preset:"standard",scope_class:"",custom:null,displayed_vars:{main:["first_name","last_name","licence","phone"]}}});break;case"cities":$scope.model=angular.merge($scope.model,{list_layout:{preset:"direct",scope_class:"",custom:null,item_row_space:{desktop:25,laptop:25,tablet:50,mobile:100}},list_item_layout:{preset:"standard",scope_class:"",custom:null,displayed_vars:{main:["name","region","listing_count"]}}});case"offices":$scope.model=angular.merge($scope.model,{list_layout:{preset:"direct",scope_class:"",custom:null,item_row_space:{desktop:25,laptop:25,tablet:50,mobile:100}},list_item_layout:{preset:"standard",scope_class:"",custom:null,displayed_vars:{main:["name","region","listing_count","address"]}}})}},$scope.computeStyles=function(){console.log("computeStyles",$scope.configs.styles,$scope.model.style);const lGlobalStyles=isNullOrEmpty($scope.configs.styles)?{}:JSON.parse($scope.configs.styles),lLocalStyles=isNullOrEmpty($scope.model.list_item_layout.styles)?{}:JSON.parse($scope.model.list_item_layout.styles);console.log(lGlobalStyles,lLocalStyles),$scope.computedStyles=JSON.stringify(Object.assign({},lGlobalStyles,lLocalStyles))},$scope.updateSource=function(){$scope.model.source=$scope.data_views.find(function($e){return $e.id==$scope.model.$$source_id})},$scope.buildPreviewElement=function(){$scope.previewElements=[];const lModelCount={listings:3,brokers:4,cities:3,offices:3};$scope.previewElements=Array.from(new Array(lModelCount[$scope.model.type])).map($e=>{const lElement={layout:wpSiApiSettings.base_path+"/views/admin/statics/previews/"+$scope.model.type+"-element-"+$scope.model.list_item_layout.layout+".html"};switch($scope.model.type){case"listings":lElement.price=$scope.getPrice(),lElement.address=$scope.getAddress(),lElement.city=$scope.getCity(),lElement.category=$scope.getCategory(),lElement.subcategory=$scope.getSubcategory(),lElement.ref_number=$scope.getNumber(12345,19999),lElement.bedrooms=$scope.getNumber(2,5),lElement.bathrooms=$scope.getNumber(1,lElement.bedrooms),lElement.region=$scope.getRegion(),lElement.avail_area=100*$scope.getNumber(10,20);break;case"brokers":lElement.first_name=$scope.getFirstname(),lElement.last_name=$scope.getLastname(),lElement.licence=$scope.getLicence(),lElement.phone=$scope.getPhone(),lElement.office=$scope.getOffice(),lElement.listing_count=$scope.getListingCount(),lElement.email=lElement.first_name.toLowerCase()+"."+lElement.last_name.toLowerCase()+"@example.com";break;case"cities":lElement.name=$scope.getCity(),lElement.region=$scope.getRegion(),lElement.listings_count=$scope.getListingCount(),lElement.code=$scope.getNumber(1234,6543);break;case"offices":lElement.name=$scope.getCity(),lElement.region=$scope.getRegion(),lElement.listings_count=$scope.getListingCount(),lElement.location={street_address:$scope.getAddress(),city:lElement.name,state:$scope.getSate(),postal_code:$scope.getPostalCode()};default:break}return lElement}),console.log("previewElements",$scope.previewElements)},$scope.getCustomCss=function(){if(void 0==$scope.model.list_item_layout)return"";if("custom"!=$scope.model.list_item_layout.preset)return"";const lStyles=$scope.model.list_item_layout.custom_css.split("\n"),lScopedStyles=lStyles.map($s=>".component-elements .si-element "+$s);return lScopedStyles.join("\n")},$scope.buildSearchElement=function(){$scope.model.search_engine_options.layout=wpSiApiSettings.base_path+"/views/admin/statics/previews/"+$scope.model.type+"-search-"+$scope.model.search_engine_options.type+".html"},$scope.saveOrClose=function(){if($scope.hasChanged())$scope.renewSearchToken().then(function($searchToken){$scope.model.search_token=$searchToken;const lResult=angular.copy($scope.model);if(lResult.show_list_meta=void 0==lResult.show_list_meta?false:lResult.show_list_meta,void 0==lResult.source)lResult.source=$scope.data_views.find(function($e){return $e.id==lResult.$$source_id});delete lResult.$$source_id,console.log("SaveOrClose",lResult,$scope.model),$scope.return(lResult)});else console.log("SaveOrClose",$scope.model),$scope.cancel()},$scope.renewSearchToken=function(){let lFilters=$scope.buildFilters(),lPromise=$q(function($resolve,$reject){if(null!=lFilters)$scope.api("",lFilters,{url:wpSiApiSettings.api_root+"/api/utils/search_encode"}).then(function($response){$resolve($response)});else $resolve("")});return lPromise},$scope.buildFilters=function(){let lResult=null;if($scope.model.limit>0)lResult={max_item_count:$scope.model.limit};if(null!=$scope.model.sort&&""!=$scope.model.sort&&"auto"!=$scope.model.sort){if(null==lResult)lResult={};lResult.sort_fields=[{field:$scope.model.sort,desc:$scope.model.sort_reverse}]}if($scope.model.shuffle){if(null==lResult)lResult={};lResult.shuffle=$scope.model.shuffle}if(null!=$scope.model.filter_group){if(null==lResult)lResult={};lResult.filter_group=$scope.normalizeFilterGroup(angular.copy($scope.model.filter_group))}return lResult},$scope.normalizeFilterGroup=function($filter_group){if($filter_group.filters)$filter_group.filters.forEach(function($filter){if(["in","not_in"].indexOf($filter.operator)>=0){if("undefined"==typeof $filter.value.push)$filter.value=$filter.value.split(","),$filter.value.forEach(function($val){if(!isNaN($val))$val=Number($val)})}else if(!isNaN($filter.value))$filter.value=Number($filter.value)});if($filter_group.filter_groups)$filter_group.filter_groups.forEach(function($group){$scope.normalizeFilterGroup($group)});return $filter_group},$scope.switchSortReverse=function(){$scope.model.sort_reverse=!$scope.model.sort_reverse},$scope.hasChanged=function(){return!$scope.isSame($scope.model,$scope._original)},$scope.validate=function(){if(void 0==$scope.model.search_engine_options)$scope.model.search_engine_options={type:"full",search_box_placeholder:"",tabs:[],fields:[]}},$scope.editSearchEngine=function($type){$siUI.dialog("~/views/admin/dialogs/"+$type+"SearchEngineEdit.html",$scope.model.search_engine_options).then($result=>{$scope.model.search_engine_options=$result})},$scope.editListItem=function($type){$siUI.dialog("~/views/admin/dialogs/"+$type+"ListItemEdit.html",$scope.model).then($result=>{$scope.model=$result,$scope.computeStyles(),console.log("editListItem return with",$result)})},$scope.previewLayerHasVar=function($item,$layer="main"){if(void 0==$scope.model.list_item_layout.displayed_vars)return false;if(void 0==$scope.model.list_item_layout.displayed_vars[$layer])return false;else return $scope.model.list_item_layout.displayed_vars[$layer].includes($item)},$scope.getNumber=function($min,$max){return $min+Math.round(Math.random()*($max-$min))},$scope.getAddress=function(){const lNumber=$scope.getNumber(1e3,2e3),lStreetName=$scope.getLastname();return lNumber+" "+lStreetName},$scope.getCity=function(){return["San Francisco","Montréal","Washington","Paris","Springfield","Franklin","Greenville","London","Los Angeles","New York","Vanconver","Calgary","St-John","Halifax","Ottawa","Toronto","Québec","Victoria","Edmonton","Regina","Winnipeg","Fredericton","Charlottetown"].any()},$scope.getRegion=function(){return"Region".translate()},$scope.getPrice=function(){const lPrice=1e3*$scope.getNumber(200,500);return lPrice.formatPrice()},$scope.getCategory=function(){return"Residential"},$scope.getSubcategory=function(){return["Two-storey house","Bungalow","Split-level"].any().translate()},$scope.getLastname=function(){return["Riordan","Tolkien","Montpellier","Vernes","Dumas","Poe","Doyle","Martin","Proust","Hugo","Balzac","Rimbaud","Camus","Austen"].any()},$scope.getFirstname=function(){return["Rick","Honoré","Alexandre","George","Edgar","Jules","Arthur","Victor","Marcel","Pierre","Albert","Jane"].any()},$scope.getLicence=function(){return["Real estate broker","Residential real estate broker","Certified real estate broker"].any().translate()},$scope.getListingCount=function(){return $scope.getNumber(2,30)},$scope.getOffice=function(){return $scope.getCity()},$scope.getPhone=function(){return[["819","514","450"].any(),"555",$scope.getNumber(1234,9876)].join("-")},$scope.getPostalCode=function(){return[["J7H","J0T","H7K","J4B"].any(),["1B4","3E4","5W2","7N8"].any()].join(" ")},$scope.getSate=function(){return["Québec","Ontario","Alberta","Manitoba","Saskatchewan","New-York","Washington","California","Florida","Nova Scotia"].any()}}),siApp.controller("signinCtrl",function signinCtrl($scope,$rootScope,$mdDialog,$siUI){BaseDialogController("signin",$scope,$rootScope,$mdDialog),$scope.login_infos={email:"",password:""},$scope.title="Please signin",$scope.actions=[{label:"Submit",action:_=>{$scope.login()}}],$scope.login=function(){$scope.portalApi("auth/login",$scope.login_infos).then($response=>{if(200==$response.statusCode)$scope.closeAndReturn($response);else $siUI.show_toast($response.message.translate())})}}),siApp.controller("registerCtrl",function registerCtrl($scope,$rootScope,$timeout,$mdDialog,$q,$siUtils,$siUI,$siApi){BaseDialogController($scope,$mdDialog,$rootScope),$scope.login_infos={email:"",password:""},$scope.steps=["account","api_key","default_view","layout"],$scope.model={state:"login",credentials:null,account_id:null,api_key:null,default_view:null,layouts:[{icon:"home",type_name:"Listings",type:"listing",page:"NEW",detail_page:"NEW"},{icon:"users",type_name:"Brokers",type:"broker",page:"NEW",detail_page:"NEW"}]},$scope.accounts=[],$scope.api_keys=[],$scope.data_views=[],$scope.pages={},$scope.wizard_step=null,$scope.actions=[],$scope.init=function(){console.log("register dialog init"),$scope.$watch(function(){return $scope.wizard_step},function($new,$old){if($new!==$old)if(console.log("wizard_step:updated",$new,$old),null!=$new)$scope.preloadStep().then(function(){$scope.updateWizard()})})},$scope.signin=function(){$scope.signin_message=null,$siApi.portal("auth/login",$scope.login_infos).then($response=>{if([10,20].includes($response.statusCode))return $scope.signin_message=$response.message.translate(),false;$scope.model.state="configs",$scope.model.credentials=$response,$scope.startWizard()})},$scope.selectAccount=function($account){$scope.model.global_account_id=$account.id,$scope.nextStep()},$scope.selectApiKey=function($key){$scope.model.account_id=$key.accountId,$scope.model.api_key=$key.id,$scope.nextStep()},$scope.selectDefaultView=function($view){$scope.model.default_view=$view,$scope.nextStep()},$scope.applyPageShortcodes=function(){$scope.actions=[];const lPageCalls=[],lPageDefMap={listing:{title:"Our listings",content:'[si alias="listings"]',title_details:"Listing details",content_details:"[si_listing]"},broker:{title:"Our team",content:'[si alias="brokers"]',title_details:"Broker details",content_details:"[si_broker]"}};return $scope.model.state="building",$scope.model.layouts.forEach($layout=>{if("NONE"!=$layout.page){if(lMap=lPageDefMap[$layout.type],"NONE"!=$layout.page){const params={page_id:$layout.page,title:lMap.title.translate(),content:lMap.content};lPageCalls.push({create:_=>$siApi.rest("page",params),layout:$layout,attr:"page"})}if("NONE"!=$layout.detail_page){const params={page_id:$layout.detail_page,title:lMap.title_details.translate(),content:lMap.content_details};lPageCalls.push({create:_=>$siApi.rest("page",params),layout:$layout,attr:"detail_page"})}}}),$q(($resolve,$reject)=>{$q.all(lPageCalls.map($c=>$c.create())).then($responses=>{console.log("All page done",$responses),$responses.forEach(($response,$index)=>{const lCall=lPageCalls[$index];if("NEW"==lCall.layout[lCall.attr])lCall.layout[lCall.attr]=$response}),$resolve()})})},$scope.preloadStep=function(){const credentialInfos={credentials:$scope.model.credentials},lStepDataLoader={account:_=>$siApi.portal("linked_account/list",null,null,credentialInfos).then($response=>{$scope.accounts=$response}),api_key:_=>(credentialInfos.account_id=$scope.model.global_account_id,$siApi.portal("api_key/list",null,null,credentialInfos).then($response=>{$scope.api_keys=$response})),default_view:_=>$siApi.rest("account",{account_id:$scope.model.account_id,api_key:$scope.model.api_key},{method:"GET"}).then($response=>{$scope.data_views=$response.data_views}),layout:_=>$siApi.rest("page/list",{locale:null,type:"page"},{method:"GET"}).then($response=>{$scope.pages=$response,$scope.model.layouts.forEach($layout=>{const lContentMatches="listing"==$layout.type?['[si alias="listings"]',"[si_listing]"]:['[si alias="brokers"]',"[si_broker]"],lFoundPage=$scope.pages.find($p=>$p.post_content==lContentMatches[0]),lFoundDetailPage=$scope.pages.find($p=>$p.post_content==lContentMatches[1]);if(null!=lFoundPage)$layout.page=lFoundPage.ID;if(null!=lFoundDetailPage)$layout.detail_page=lFoundDetailPage.ID})})},lStepName=$scope.steps[$scope.wizard_step];if(void 0!=lStepDataLoader[lStepName])return lStepDataLoader[lStepName]();else return $q.resolve()},$scope.startWizard=function(){$scope.wizard_step=0},$scope.finishWizard=function(){$scope.model.state="complete";const lConfigs=$scope.buildConfig();console.log("configs",lConfigs),$siApi.rest("configs",{settings:lConfigs}).then(_=>{$timeout(_=>{window.location.reload(true)},1e3)})},$scope.buildConfig=function(){const lLocale=wpSiApiSettings.locale,lTypeMap={listing:{en:{route:"listings/{{item.location.region}}/{{item.location.city}}/{{item.transaction}}/{{item.ref_number}}/",route_shortcut:"listing/{{item.ref_number}}/"},fr:{route:"proprietes/{{item.location.region}}/{{item.location.city}}/{{item.transaction}}/{{item.ref_number}}/",route_shortcut:"propriete/{{item.ref_number}}/"}},broker:{en:{route:"brokers/{{item.first_name}}-{{item.last_name}}/{{item.ref_number}}/",route_shortcut:"broker/{{item.ref_number}}/"},fr:{route:"courtiers/{{item.first_name}}-{{item.last_name}}/{{item.ref_number}}/",route_shortcut:"courtier/{{item.ref_number}}/"}}},lResult={account_id:$scope.model.account_id,api_key:$scope.model.api_key,default_view:$scope.model.default_view.id,lists:[$siUtils.createList($scope.model.default_view,"listings","listings","contract_start_date",true,30),$siUtils.createList($scope.model.default_view,"brokers","brokers","last_name")],listing_routes:[{lang:lLocale,route:lTypeMap.listing[lLocale].route,shortcut:lTypeMap.listing[lLocale].route_shortcut}],listing_layouts:[{lang:lLocale,communication_mode:"basic",page:$scope.model.layouts.find($l=>"listing"==$l.type).detail_page}],broker_routes:[{lang:lLocale,route:lTypeMap.broker[lLocale].route,shortcut:lTypeMap.broker[lLocale].route_shortcut}],broker_layouts:[{lang:lLocale,communication_mode:"basic",page:$scope.model.layouts.find($l=>"broker"==$l.type).detail_page}]};return lResult},$scope.updateWizard=function(){console.log("updateWizard:triggered",$scope.wizard_step);const lActions=[{key:"previous",label:"Previous step",action:function(){$scope.previousStep()}},{key:"next",label:"Next step",action:function(){$scope.nextStep()}}];if($scope.wizard_step==$scope.steps.length-1)lActions.pop(),lActions.push({key:"finish",label:"Finish",action:function(){$scope.applyPageShortcodes().then(function(){$scope.finishWizard()})}});const lWizardSteps=Array.from(document.querySelectorAll("#register .wizard-step"));console.log($scope.wizard_step,lWizardSteps,lWizardSteps[$scope.wizard_step]),lWizardSteps.forEach(function($e,$i){$e.classList.remove("show")}),lWizardSteps[$scope.wizard_step].classList.add("show"),$timeout(function(){$scope.actions=lActions})},$scope.previousStep=function(){$scope.wizard_step-=1},$scope.nextStep=function(){$scope.wizard_step+=1},$scope.validateStep=function($index){const lStepValidator={account:_=>null!=$scope.model.account_id,api_key:_=>null!=$scope.model.api_key,default_view:_=>null!=$scope.default_view,layouts:_=>$scope.model.layouts.length>0},lStepName=$scope.steps[$index];if(void 0!=lStepValidator[lStepName])return lStepValidator[lStepName]();else return true},$scope.isNavButtonEnabled=function($button,$step){if("previous"==$button.key)if(0==$step)return false;else return true;return $scope.validateStep($step)}}),siApp.directive("lstr",["$parse",function lstr($parse){return{restrict:"E,A",compile:function compile(tElement,tAttrs,transclude){return{pre:function preLink(scope,iElement,iAttrs,controller){let lTranslatedContent=iElement.html().translate(),lFormatParams=iAttrs.params;if(null==lFormatParams&&""!=iAttrs.lstr)lFormatParams=iAttrs.lstr;if(null!=lFormatParams){if(lFnFormatParams=$parse(lFormatParams),lFormatParams=lFnFormatParams(scope),!Array.isArray(lFormatParams))lFormatParams=[lFormatParams];lTranslatedContent=lTranslatedContent.format.apply(lTranslatedContent,lFormatParams)}iElement.html("<span>"+lTranslatedContent+"</span>")}}}}}]),siApp.directive("siRouteBox",function siRouteBox($siUtils,$siList,$siUI){return{restrict:"E",scope:{route:"=",removeHandler:"&onRemove",list:"=",type:"@",changeHandler:"&siChange"},templateUrl:wpSiApiSettings.base_path+"/views/admin/statics/si-route-box.html",replace:true,link:function($scope,$elm,$attr){$scope.init()},controller:function($scope){const lAssoc={listings:"listing",cities:"city",brokers:"broker",offices:"office"};$scope.lang_codes={fr:"Français",en:"English",es:"Español"},$scope.route_listing_elements={"{{item.ref_number}}":"ID","{{item.transaction}}":"Transaction type","{{item.location.region}}":"Region","{{item.location.city}}":"City","{{item.location.street}}":"Street","{{item.location.civic_address}}":"Address"},$scope.route_broker_elements={"{{item.ref_number}}":"ID","{{item.first_name}}":"First name","{{item.last_name}}":"Last name"},$scope.route_city_elements={"{{item.ref_number}}":"ID","{{item.location.region}}":"Region","{{item.name}}":"Name"},$scope.route_office_elements={"{{item.ref_number}}":"ID","{{item.location.region}}":"Region","{{item.location.city}}":"City","{{item.name}}":"Name"},$scope.route_default={listing:{fr:"proprietes/{{item.location.region}}/{{item.location.city}}/{{item.transaction}}/{{item.ref_number}}",en:"listings/{{item.location.region}}/{{item.location.city}}/{{item.transaction}}/{{item.ref_number}}",es:"casas/{{item.location.region}}/{{item.location.city}}/{{item.transaction}}/{{item.ref_number}}"},broker:{fr:"courtiers/{{item.first_name}}-{{item.last_name}}/{{item.ref_number}}",en:"brokers/{{item.first_name}}-{{item.last_name}}/{{item.ref_number}}",es:"agentes/{{item.first_name}}-{{item.last_name}}/{{item.ref_number}}"},city:{fr:"villes/{{item.location.region}}/{{item.name}}/{{item.ref_number}}",en:"cities/{{item.location.region}}/{{item.name}}/{{item.ref_number}}",es:"ciudades/{{item.location.region}}/{{item.name}}/{{item.ref_number}}"},office:{fr:"bureaux/{{item.location.city}}/{{item.name}}/{{item.ref_number}}",en:"offices/{{item.location.city}}/{{item.name}}/{{item.ref_number}}",es:"oficinas/{{item.location.city}}/{{item.name}}/{{item.ref_number}}"}},$scope.route_elements={},$scope.init=function(){console.log("Init routeBox with type",$scope.type),$scope.route_elements=$scope["route_"+lAssoc[$scope.type]+"_elements"]},$scope.hasMinRouteCount=function(){if(null==$scope.list||void 0==$scope.list)return true;if($scope.list.length<=1)return true;else return false},$scope.langIsUsed=function($lang){if(null==$scope.list||void 0==$scope.list)return true;else return $scope.list.some($e=>$e.lang==$lang)},$scope.elementIsUsed=function($elm,$partKey){if(""==$scope.route[$partKey])return false;else return $scope.route[$partKey].indexOf($elm)>=0},$scope.elementUseCount=function($partKey){let lResult=0;if(null==$scope.route_elements||void 0==$scope.route_elements)return 0;if(void 0==$scope.route[$partKey])return 0;let lRouteElms=$siUtils.toKeyArray($scope.route_elements);return lRouteElms.forEach(function($e){if($scope.route[$partKey].indexOf($e)>=0)lResult++}),lResult},$scope.reset=function(){$scope.route.route=$scope.route_default[$scope.type][$scope.route.lang]},$scope.elementAvailable=function($partKey){if(null==$scope.route_elements||void 0==$scope.route_elements)return 0;let lRouteElms=$siUtils.toKeyArray($scope.route_elements),lResult=lRouteElms.length-$scope.elementUseCount($partKey);return lResult},$scope.remove=function(){let fnRemove=function(){$scope.list.forEach(function($e,$i){if($e!=$scope.route);else $scope.list.splice($i,1)})};if(""==$scope.route.route)fnRemove();else $siUI.confirm("Are you sure you want to remove this route?").then(function(){fnRemove()})},$scope.update=function(){if("function"==typeof $scope.changeHandler)$scope.changeHandler({route:$scope.route})},$scope.addRouteElement=function($key,$partKey){$scope.route[$partKey]+=$key,$scope.update()}}}}),siApp.directive("siFilterGroup",function siFilterGroup(){let dir_controller=function($scope,$rootScope){$scope.filter_group_operators={and:"And",or:"Or"},$scope.$watch("model",function(){$scope.init()}),$scope.init=function(){console.log("filter_group model",$scope.model,$scope.parent)},$scope.addFilterGroup=function(){if(null==$scope.model.filter_groups)$scope.model.filter_groups=[];$scope.model.filter_groups.push({filters:null,operator:"and"})},$scope.removeGroup=function(){$scope.removeFromList($scope.model,$scope.parent,"filter_groups")},$scope.removeFromList=function($item,$parent,$name){let lNewList=[];if($list=$parent[$name],$list.forEach(function($elm){if(JSON.stringify($elm)!=JSON.stringify($item))lNewList.push($elm)}),
0==lNewList.length)lNewList=null;$parent[$name]=lNewList},$scope.addFilter=function($group){if(null==$scope.model.filters)$scope.model.filters=[];$scope.model.filters.push({field:"",operator:"Equal",value:""})},$scope.switchOperator=function($newOperator){$scope.model.operator=$newOperator}};return{restrict:"E",scope:{model:"=ngModel",type:"=siType",parent:"=ngParent"},controllerAs:"ctrl",template:'<div ng-include="\'filter-group\'" class="si-filter-group group-operator-{{model.operator}}"></div>',controller:dir_controller}}),siApp.directive("siFilterItem",function siFilterItem($siUtils,$siList){return{restrict:"E",scope:{filter:"=ngModel",type:"=siType",removeHandler:"&onRemove"},templateUrl:wpSiApiSettings.base_path+"/views/admin/statics/si-filter-item.html",replace:true,link:function($scope,$elm,$attr){$scope.init()},controller:function($scope){$scope.value_choices=[],$scope.selected_key="price.sell.amount",$scope.selected_filter_key=null,$scope.filter_key_list={listings:[{value:"price.sell.amount",label:"Selling price",value_type:"number",op_out:["like","not_like"]},{value:"price.lease.amount",label:"Leasing price",value_type:"number",op_out:["like","not_like"]},{value:"location.country_code",label:"Country",value_type:"list",choices:"getCountryList",op_in:["in","not_in"]},{value:"location.state_code",label:"State/Province",value_type:"list",choices:"getStateList",op_in:["in","not_in"]},{value:"location.region_code",label:"Region",value_type:"list",choices:"getRegionList",op_in:["in","not_in"]},{value:"location.city_code",label:"City",value_type:"list",choices:"getCityList",op_in:["in","not_in"]},{value:"category_code",label:"Category",value_type:"list",choices:"getCategoryList",op_in:["in","not_in"]},{value:"subcategory_code",label:"Subcategory",value_type:"list",choices:"getSubcategoryList",op_in:["in","not_in"]},{value:"open_houses[0].end_date",label:"Open house date",value_type:"text",choices:"udf.now():Now"},{value:"main_unit.bedroom_count",label:"Bedroom count",value_type:"number",op_out:["like","not_like"]},{value:"main_unit.bathroom_count",label:"Bathroom count",value_type:"number",op_out:["like","not_like"]},{value:"attributes.PARKING",label:"Parking count",value_type:"number",op_out:["like","not_like"]},{value:"attributes.GARAGE",label:"Garage",value_type:"bool",op_in:["equal","not_equal_to"]},{value:"attributes.POOL",label:"Pool",value_type:"bool",op_in:["equal","not_equal_to"]},{value:"status_code",label:"Status",value_type:"text",choices:"SOLD:Sold|AVAILABLE:Available",op_in:["equal","not_equal_to"]}],brokers:[{value:"first_name",label:"First name",value_type:"text",op_in:["like","not_like"]},{value:"last_name",label:"Last name",value_type:"text",op_in:["like","not_like"]},{value:"license_type_code",label:"License type",value_type:"list",choices:"getLicenseList",op_in:["in","not_in"]}]},$scope.filter_operators=[{key:"equal",value:"Equal to"},{key:"not_equal_to",value:"Different of"},{key:"less_than",value:"Less than"},{key:"less_or_equal_to",value:"Less or equals to"},{key:"greater_than",value:"Greater than"},{key:"greater_or_equal_to",value:"Greater or equals to"},{key:"in",value:"One of"},{key:"not_in",value:"Not one of"},{key:"like",value:"Contains"},{key:"not_like",value:"Does not contains"}],$scope.init=function(){$scope.selected_key=$scope.filter.field,console.log($scope.type),$scope.selected_filter_key=$scope.filter_key_list[$scope.type].find($e=>$e.value==$scope.selected_key),$scope.updateFilterChoices()},$scope.remove=function(){if(void 0!=$scope.removeHandler)$scope.removeHandler()},$scope.filterFieldChanged=function(){$scope.filter.field=$scope.selected_key,$scope.value_choices=[],$scope.filter.value="",$scope.selected_filter_key=$scope.filter_key_list[$scope.type].find($e=>$e.value==$scope.selected_key),$scope.updateFilterChoices()},$scope.updateFilterChoices=function(){if(void 0!=$scope.selected_filter_key)if(console.log("filter choices from",$scope.selected_filter_key),["list","text"].indexOf($scope.selected_filter_key.value_type)>=0&&void 0!=$scope.selected_filter_key.choices)if(console.log("list from ",$scope.selected_filter_key.choices),"function"==typeof $siList[$scope.selected_filter_key.choices])console.log($scope.selected_filter_key.choices,"found"),$scope.value_choices=$siList[$scope.selected_filter_key.choices](),console.log($scope.selected_filter_key.choices,$scope.value_choices);else $scope.value_choices=$siUtils.stringToOptionList($scope.selected_filter_key.choices),console.log($scope.selected_filter_key.choices,$scope.value_choices);else $scope.value_choices=null;else $scope.value_choices=null},$scope.formatFilterValueList=function(){if(null!=$scope.filter.value)if("function"==typeof $scope.filter.value.push)if(1==$scope.filter.value.length)return"1 item selected".translate();else return"{0} items selected".translate().format($scope.filter.value.length);return $scope.filter.value},$scope.operatorFilterByField=function($item){if(null==$item)return false;if(void 0==$scope.selected_filter_key)return false;if(void 0!=$scope.selected_filter_key.op_in)return $scope.selected_filter_key.op_in.indexOf($item.key)>=0;else if(void 0!=$scope.selected_filter_key.op_out)return!($scope.selected_filter_key.op_out.indexOf($item.key)>=0);return true}}}}),siApp.directive("siDataGroupEditor",["$siUtils","$siApi","$q","$timeout",function siDataGroupEditor($siUtils,$siApi,$q,$timeout){return{restrict:"E",replace:true,scope:true,templateUrl:wpSiApiSettings.base_path+"/views/admin/statics/si-data-group-editor.html",link:function($scope,$element,$attrs){const lAssoc={listings:"listing",cities:"city",brokers:"broker",offices:"office"};$scope.groupType=$attrs.siType,$scope.routes=lAssoc[$scope.groupType]+"_routes",$scope.layout=lAssoc[$scope.groupType]+"_layouts",$scope.lang_codes={fr:"Français",en:"English",es:"Español"}},controller:function($scope){}}}]),siApp.directive("siSvg",["$parse","$compile",function siSvg($parse,$compile){return{restrict:"E",scope:{src:"@"},link:function($scope,$element,$attrs){if(""!=$element.html())$scope.src=$element.html(),$element.html("");$scope.init($element)},controller:function($scope){$scope.elm=null,$scope.init=function($element){$scope.elm=$element},$scope.$watch("src",function($new,$old){if(null!=$new)if(null!=$old)$scope.render()}),$scope.render=function(){const lTemplate='<ng-include src="getSvgPath()"></ng-include>';let elementContent=$compile(lTemplate)($scope);$scope.elm.append(elementContent)},$scope.getSvgPath=function(){let lPath=$scope.src;if(0==lPath.indexOf("~"))lPath=lPath.replace("~",wpSiApiSettings.base_path);return lPath}}}}]),siApp.directive("faIcon",["$parse","$compile",function faIcon($parse,$compile){return{restrict:"E",replace:true,scope:{icon:"@",iconStyle:"@?",size:"@",useSvg:"@"},link:function($scope,$element,$attrs){if(!$attrs.iconStyle)$scope.iconStyle="fal";if(!$attrs.size)$scope.size="1x";if("string"==typeof $attrs.icon&&$attrs.icon.indexOf("[")>=0){let lIconParse=$parse($attrs.icon);$scope.icon=lIconParse($scope)}else if(""!=$element.html())$scope.icon=$element.html(),$element.html("");$scope.init($element)},controller:function($scope){$scope.elm=null,$scope.init=function($element){$scope.elm=$element},$scope.$watch("icon",function($new,$old){if(null!=$new)if(null!=$old){if("string"==typeof $new&&$new.indexOf("[")>=0){let lIconParse=$parse($new);$scope.icon=lIconParse($scope)}$scope.render()}}),$scope.resetElement=function(){let lElm=$scope.elm[0],lClassToRemove=[];for(let i=0;i<lElm.classList.length;i++)if(lElm.classList.item(i).indexOf("fa-")>=0)lClassToRemove.push(lElm.classList.item(i));lElm.classList.remove.apply(lElm.classList,lClassToRemove),$scope.elm.html("")},$scope.render=function(){let lTemplate="";if($scope.resetElement(),$scope.useSvg){lTemplate='<ng-include src="getIconPath()"></ng-include>';let elementContent=$compile(lTemplate)($scope);$scope.elm.append(elementContent)}else if(Array.isArray($scope.icon))$scope.elm.addClass("fa-stack"),$scope.icon.forEach(function($e,$i){lTemplate='<i class="fal fa-'+$e+' fa-stack-1x"></i>',$scope.elm.append(lTemplate)});else $scope.elm.clearClass,$scope.elm.addClass($scope.iconStyle),$scope.elm.addClass("fa-"+$scope.icon),$scope.elm.addClass("fa-"+$scope.size)}}}}]),siApp.directive("siTooltip",["$parse","$q","$timeout",function siTooltip($parse,$q,$timeout){return{restrict:"E",transclude:true,template:'<div class="si-tooltip"><div class="si-tooltip-content"><label ng-transclude></label></div><i class="fal fa-info-circle" ng-mouseover="enter($event)" ng-mouseout="leave()"></i></div>',link:function($scope,$element,$attrs){$scope._elm=$element[0]},controller:function($scope){$scope.initTip=function(){$scope._tip=jQuery($scope._elm).find(".si-tooltip-content"),jQuery(document.body).append($scope._tip)},$scope.enter=function($event){if(void 0==$scope._tip)$scope.initTip();const lSourceBox=$scope._elm.getBoundingClientRect(),jElm=jQuery($event.target),lPos={left:Math.round(lSourceBox.left+lSourceBox.width/2),top:lSourceBox.top};console.log("mouse over ",$event.target,"positionned at",lPos),$scope._tip.css(lPos),$scope._tip.addClass("show")},$scope.leave=function(){if(void 0!=$scope._tip)$scope._tip.removeClass("show")}}}}]),siApp.directive("siOnEnter",["$parse",function siOnEnter($parse){return{restrict:"A",link:function($scope,$element,$attr){$element.on("keyup",function($event){if(13==$event.keyCode){const lHandler=$parse($attr.siOnEnter);lHandler($scope,{$event:$event})}})}}}]),siApp.directive("siStyleEditor",["$parse",function siStyleEditor($parse){return{restrict:"E",templateUrl:wpSiApiSettings.base_path+"/views/admin/statics/si-style-editor.html",replace:true,scope:{rawModel:"=siModel",changeHandler:"&siChange",preview:"@?siPreview",showPreview:"=siShowPreview",editables:"=siEditables"},link:function($scope,$element,$attrs){console.log("siStyleEditor.link",$scope.rawModel),$scope.init($element[0])},controller:function($scope,$timeout,$siUI){$scope.options={colorPicker:{hasBackdrop:false,materialPalette:false,sliders:false,genericPalette:false,history:false}},$scope._updateWatcherHndl=null,$scope._rawModelWatcherHndl=null,$scope.defaultValues={container_width:"1170px",font_name:"inherit",highlight:"#ff9900",highlight_text_color:"#333",text_color:"#333",background_color:"#fff",input_placeholder_color:"rgba(#333,0.5)",layout_gutter:"20px",container_border_color:" [element_border_color]",container_border:" solid 1px [container_border_color]",container_border_radius:" [element_border_radius]",container_padding:" [layout_gutter]",element_border_color:"#aaa",element_border:"solid 1px [element_border_color]",element_border_radius:"0px",element_padding:"10px",high_contrast_color:"#333",high_contrast_text_color:"#fff",medium_contrast_color:"#b9b9b9",medium_contrast_text_color:"[text_color]",small_contrast_color:"#e2e2e2",small_contrast_text_color:"[text_color]",error_color:"#850000",button_bg_color:"#333",button_text_color:"#fff",button_font_name:"[font_name]",button_hover_bg_color:"#ff9900",button_hover_text_color:"#333",button_alt_bg_color:"#777",button_alt_text_color:"#fff",button_alt_hover_bg_color:"#9d9d9d",button_alt_hover_text_color:"#fff",uls_label:"ULS: ",listing_item_sold_bg_color:"#ff8800",listing_item_sold_text_color:"#fff",listing_item_column_width:"340px",listing_item_picture_ratio:"0.75",thumbnail_picture_size:"100px",broker_item_column_width:"210px",broker_item_picture_ratio:"1.25",office_item_column_width:"320px"},$scope.init=function($element){if($scope.$element=$element,$scope.previewPath=wpSiApiSettings.base_path+"/views/admin/statics/previews/style-editor-"+(void 0==$scope.preview?"general":$scope.preview)+".html",null!=$scope._updateWatcherHndl);if(console.log("styleEditor init:",$scope.rawModel),$scope.rawModel)$scope.model=$scope.parseModel($scope.rawModel);$scope.registerRawModelWatcher(),$scope.registerModelWatcher();const lFirstGroup=$scope.editables?$scope.editables[0]:"global";console.log("first group",lFirstGroup),$scope.openGroup(lFirstGroup)},$scope.registerRawModelWatcher=function(){$scope._rawModelWatcherHndl=$scope.$watch("rawModel",function($new,$old){if(void 0!=$new)if($new!=$old)console.log("rawModel new:",$new,"old:",$old),$scope.model=$scope.parseModel($scope.rawModel),$scope._rawModelWatcherHndl(),$scope._rawModelWatcherHndl=null})},$scope.registerModelWatcher=function(){$timeout(_=>{console.log("watcher register"),$scope._updateWatcherHndl=$scope.$watch("model",function($new,$old){if(console.log("model changed",$old,$new),!isNullOrEmpty($new))if($new!=$old)$scope.update()},true)},1e3)},$scope.openGroup=function($group){const lTargetGroup=$scope.$element.querySelector("#style-"+$group),lGroups=Array.from($scope.$element.querySelectorAll(".style-group"));lGroups.forEach(function($e){if($e.getAttribute("id")!="style-"+$group)if($e.classList.remove("open"),null!=$e.previousSibling)$e.previousElementSibling.classList.remove("active")}),lTargetGroup.classList.toggle("open"),lTargetGroup.previousElementSibling.classList.toggle("active")},$scope.stringifyModel=function(){const lModel=Object.keys($scope.model).reduce(($result,$k)=>{if(null!=$scope.model[$k]&&void 0!=$scope.model[$k]){const lNewKey="--"+$k.replace(/(_)/g,"-");$result[lNewKey]=$scope.model[$k]}return $result},{});return JSON.stringify(lModel)},$scope.parseModel=function($value){if(void 0==$value)return{};if(null==$value)return{};if(""==$value)return{};const lParsedModel=JSON.parse($value);console.log("rawModel parsed",lParsedModel);const lModel=Object.keys(lParsedModel).reduce(($result,$k)=>{const lNewKey=$k.replace("--","").replace(/(-)/g,"_");return $result[lNewKey]=lParsedModel[$k],$result},{});return $scope.validateModelValues(lModel),console.log("Parsed model",lModel),lModel},$scope.reset=function(){$siUI.confirm("Attention","All style customisation will be lost.\nDo you want to continue?",{ok:"Yes",cancel:"No"}).then(function(){$scope.model={},$scope.update()})},$scope.update=function(){$scope.validateModelValues($scope.model);const lModel=$scope.stringifyModel();if($scope.rawModel=lModel,console.log("styleModel changed",$scope.rawModel),"function"==typeof $scope.changeHandler)$scope.changeHandler({$styles:lModel})},$scope.updatePreviewBox=function(){const lModel=Object.keys($scope.model).reduce(($result,$key)=>{if(""!=$scope.model[$key])$result[$key]=$scope.model[$key];return $result},{}),lEffectiveStyle=Object.assign({},$scope.defaultValues,lModel),lPreviewElm=$scope.$element.querySelector(".si-style-editor-preview .viewport");lPreviewElm.style.cssText="",Object.keys(lEffectiveStyle).forEach($k=>{const lStyleKey=$k.replace(/_/g,"-");let lValue=lEffectiveStyle[$k];const lSubVarRegex=/\[(.+)\]/g;if(lValue.match(lSubVarRegex))lValue=lValue.replace(lSubVarRegex,"var(--preview-$1)"),lValue=lValue.replace(/_/g,"-");if("uls_label"==$k)lValue='"'+lValue+'"';lPreviewElm.style.setProperty("--preview-"+lStyleKey,lValue)})},$scope.validateModelValues=function($model){Object.keys($model).forEach($k=>{const lValue=$model[$k];if(void 0!=lValue&&""!=lValue)if(console.log("validate value",$k,lValue),$k.indexOf("padding")>0||$k.indexOf("radius")>0)if(lValue.indexOf("px")<0)console.log("px missing",$k,lValue),$model[$k]=lValue+"px"})},$scope.isEditable=function($item){if(void 0==$scope.editables)return true;if(!Array.isArray($scope.editables))return true;if(0==$scope.editables.length)return true;else return $scope.editables.includes($item)}}}}]),siApp.directive("siInclude",["$parse","$timeout",function siInclude($parse,$timeout){return{restrict:"E",link:function($scope,$element,$attrs){const fnUpdatePath=function($format,$params){if(void 0==$attrs.path)if(void 0!=$format&&void 0!=$params){const lParams=$params.filter($p=>void 0!=$p);if(lParams.length>0)$scope.path=$format.format(...lParams)}if(void 0!=$scope.path)$scope.path=$scope.path.replace("~",wpSiApiSettings.base_path);console.log("siInclude",$scope.path)};$scope.$watch($attrs.pathParams,function(){const lParsedParams=$parse($attrs.pathParams)($scope);fnUpdatePath($attrs.pathFormat,lParsedParams)})},replace:true,template:'<div ng-include="path"></div>'}}]),siApp.directive("siStylePreview",["$parse",function siStylePreview($parse){return{restrict:"A",scope:{model:"=siStylePreview"},link:function($scope,$element,$attrs){$scope.$element=$element[0],$scope.init()},controller:function($scope){$scope.defaultValues={container_width:"1170px",font_name:"inherit",highlight:"#ff9900",highlight_text_color:"#333",text_color:"#333",background_color:"#fff",input_placeholder_color:"rgba(#333,0.5)",layout_gutter:"20px",container_border_color:"[element_border_color]",container_border:" solid 1px [container_border_color]",container_border_radius:"[element_border_radius]",container_padding:" [layout_gutter]",element_border_color:"#aaa",element_border:"solid 1px [element_border_color]",element_border_radius:"0px",element_padding:"10px",high_contrast_color:"#333",high_contrast_text_color:"#fff",medium_contrast_color:"#b9b9b9",medium_contrast_text_color:"[text_color]",small_contrast_color:"#e2e2e2",small_contrast_text_color:"[text_color]",error_color:"#850000",button_bg_color:"#333",button_text_color:"#fff",button_font_name:"[font_name]",button_hover_bg_color:"#ff9900",button_hover_text_color:"#333",button_alt_bg_color:"#777",button_alt_text_color:"#fff",button_alt_hover_bg_color:"#9d9d9d",button_alt_hover_text_color:"#fff",uls_label:"ULS: ",listing_item_sold_bg_color:"#ff8800",listing_item_sold_text_color:"#fff",listing_item_column_width:"340px",listing_item_picture_ratio:"0.75",thumbnail_picture_size:"100px",broker_item_column_width:"210px",broker_item_picture_ratio:"1.25",office_item_column_width:"320px"},$scope.init=function(){$scope.$watch("model",function(){$scope.updateElement()})},$scope.parseModel=function($value){if(void 0==$value)return{};if(null==$value)return{};if(""==$value)return{};let lParsedModel={};if(Array.isArray($value))$value.forEach($v=>{lParsedModel=Object.assign(lParsedModel,JSON.parse($v))});else lParsedModel=JSON.parse($value);console.log("rawModel parsed",lParsedModel);const lModel=Object.keys(lParsedModel).reduce(($result,$k)=>{const lNewKey=$k.replace("--","").replace(/(-)/g,"_");return $result[lNewKey]=lParsedModel[$k],$result},{});return console.log("Parsed model",lModel),lModel},$scope.updateElement=function(){const lJSONModel=$scope.parseModel($scope.model),lModel=Object.keys(lJSONModel).reduce(($result,$key)=>{if(""!=lJSONModel[$key])$result[$key]=lJSONModel[$key];return $result},{}),lEffectiveStyle=Object.assign({},$scope.defaultValues,lModel);console.log("Model",lModel,"Effective",lEffectiveStyle);const lPreviewElm=$scope.$element.querySelector(".viewport");if(null==lPreviewElm)return console.log(".viewport on",$scope.$element,"not found"),false;lPreviewElm.style.cssText="",Object.keys(lEffectiveStyle).forEach($k=>{const lStyleKey=$k.replace(/_/g,"-");let lValue=lEffectiveStyle[$k];const lSubVarRegex=/\[(.+)\]/g;if(void 0!=lValue){if(lValue.match(lSubVarRegex))lValue=lValue.replace(lSubVarRegex,"var(--preview-$1)"),lValue=lValue.replace(/_/g,"-");if("uls_label"==$k)lValue='"'+lValue+'"';lPreviewElm.style.setProperty("--preview-"+lStyleKey,lValue)}})}}}}]),siApp.directive("siNotice",[function siNotice(){return{restrict:"E",templateUrl:wpSiApiSettings.base_path+"/views/admin/statics/si-notice.html",replace:true,scope:{model:"=siModel"},link:function($scope,$element,$attrs){},controller:function($scope){}}}]),siApp.directive("siAddonConfig",["$parse",function siAddonConfig($parse){return{restrict:"E",scope:{model:"=siModel",active_addons:"=siActiveAddons"},templateUrl:wpSiApiSettings.base_path+"/views/admin/statics/si-addon-config.html?v"+(new Date).getTime(),replace:true,link:function($scope,$element,$attrs){$scope.init()},controller:function($scope,$q,$timeout,$rootScope){$scope.modelConfigs={},$scope.init=function(){if($scope.addonConfigPath=wpSiApiSettings.base_path+"addons/"+$scope.model.name+"/views/addon.settings.html?v="+(new Date).getTime(),null==$scope.active_addons||Array.isArray($scope.active_addons))$scope.active_addons={};console.log("addon init",$scope.model,$scope.active_addons),$scope.modelConfigs=void 0!=$scope.active_addons[$scope.model.name]?Object.assign($scope.model.default_configuration,$scope.active_addons[$scope.model.name].configs):$scope.model.default_configuration},$scope.isActive=function(){if(null==$scope.active_addons)return false;else return void 0!=$scope.active_addons[$scope.model.name]},$scope.toggleActive=function(){console.log("toggle active"),$timeout(_=>{if($scope.isActive())console.log("already active, delete settings"),delete $scope.active_addons[$scope.model.name];else console.log("Add settings to active_addons"),$scope.active_addons[$scope.model.name]={configs:$scope.modelConfigs};console.log("new active_addons",$scope.active_addons),$rootScope.$broadcast("save-request")})},$scope.saveAddonSettings=function(){$scope.active_addons[$scope.model.name]={configs:$scope.modelConfigs},$rootScope.$broadcast("save-request")}}}}]),siApp.factory("$siUtils",["$siApi","$q",function $siUtils($siApi,$q){let $scope={stringToOptionList:function($source){if(null==$source||void 0==$source)return null;if($source.indexOf("|")<0&&$source.indexOf(":")<0)return[$source];let lKeyValues=$source.split("|"),lResult=[];return lKeyValues.forEach(function($e){let lItemArr=$e.split(":");console.log("splited item",lItemArr);let lItem={key:lItemArr[0],label:lItemArr.length>1?lItemArr[1]:lItemArr[0]};lResult.push(lItem)}),lResult},toArray:function($source){let lResult=[];for($key in $source)if("function"!=typeof $source[$key])lResult.push($source[$key]);return lResult},toKeyArray:function($source){let lResult=[];for($key in $source)if("function"!=typeof $source[$key])lResult.push($key);return lResult},toKeyValueArray:function($source){let lResult=[];for($key in $source)if("function"!=typeof $source[$key])lResult.push({key:$key,value:$source[$key]});return lResult},renewListSearchToken:function($list){let lFilters=$scope.buildListFilter($list);return $q(function($resolve,$reject){if(null!=lFilters)$siApi.call("",lFilters,{url:wpSiApiSettings.api_root+"/api/utils/search_encode"}).then(function($response){$resolve($response)});else $resolve("")})},buildListFilter:function($list){let lResult=null;if($list.limit>0)lResult={max_item_count:$list.limit};if(""!=$list.sort&&"auto"!=$list.sort){if(null==lResult)lResult={};lResult.sort_fields=[{field:$list.sort,desc:$list.sort_reverse}]}if($list.shuffle){if(null==lResult)lResult={};lResult.shuffle=$list.shuffle}if(null!=$list.filter_group){if(null==lResult)lResult={};lResult.filter_group=$scope.normalizeFilterGroup(angular.copy($list.filter_group))}return lResult},normalizeFilterGroup:function($filter_group){if($filter_group.filters)$filter_group.filters.forEach(function($filter){if(["in","not_in"].indexOf($filter.operator)>=0){if("undefined"==typeof $filter.value.push)$filter.value=$filter.value.split(","),$filter.value.forEach(function($val){if(!isNaN($val))$val=Number($val)})}else if(!isNaN($filter.value))$filter.value=Number($filter.value)});if($filter_group.filter_groups)$filter_group.filter_groups.forEach(function($group){$scope.normalizeFilterGroup($group)});return $filter_group},createList:function($view,$type,$alias,$sort="",$sortReverse=false,$limit=0,$list=null){const lList=null==$list?{alias:$alias,type:$type}:$list,lTypedDatas={listings:{search_engine_options:{type:"full",filter_tags:"none"},displayed_vars:{main:["address","city","price","rooms","category","subcategory"]}},brokers:{search_engine_options:{type:"full"},displayed_vars:{main:["first_name","last_name","phone","title"]}}};if(lList.sort=""==$sort?null:$sort,lList.sort_reverse=$sortReverse,lList.limit=$limit,lList.list_layout={type:"standard",preset:"standard",scope_class:""},lList.list_item_layout={type:"standard",preset:"standard",scope_class:""},lList.searchable=true,lList.sortable=true,lList.mappable=true,void 0!=lTypedDatas[$type])lList.search_engine_options=lTypedDatas[$type].search_engine_options,lList.list_item_layout.displayed_vars=lTypedDatas[$type].displayed_vars;return lList.source=$view,lList.search_token="",lList}};return $scope}]),siApp.factory("$siList",["$siApi",function $siList($siApi){let $scope={dictionary:null,init:function($view_id){console.log("loading lexicon",$view_id),$scope.fetchDictionary($view_id)},fetchDictionary:function($view_id){if(null!=$view_id)$siApi.rest("dictionary").then(function($response){$scope.dictionary=$response})},getCountryList:function(){if(console.log($scope.dictionary),null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.country)},getStateList:function(){if(console.log($scope.dictionary),null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.state)},getRegionList:function(){if(console.log($scope.dictionary),null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.region)},getCityList:function(){if(console.log($scope.dictionary),null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.city)},getCategoryList:function(){if(console.log($scope.dictionary),null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.listing_category)},getSubcategoryList:function(){if(console.log($scope.dictionary),null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.listing_subcategory)},getBuildingCategoryList:function(){if(console.log($scope.dictionary),null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.building_category)},getLicenseList:function(){if(null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.broker_license_type)},getOfficeList:async function(){if(null==$scope.offices)return[];if(void 0!=$scope.offices)return $scope.offices;const lResponse=await $siApi.call("office/view/"+$configs.source.id+"/fr/items");console.log("getOffice await response",lResponse)},toArray:function($source){let lResult=[];for($key in $source)lResult.push({key:$key,label:$source[$key].caption});return console.log("toArray:",lResult),lResult}};return $scope}]),siApp.factory("$siApi",["$http","$q",function $siApi($http,$q){return $scope={},$scope.rest=function($path,$data,$options){if($options=angular.merge({url:wpSiApiSettings.root+"si-rest/"+$path,method:"undefined"==typeof $data?"GET":"POST",headers:{"X-WP-Nonce":wpSiApiSettings.nonce}},$options),"GET"==$options.method)$options.params=$data;else $options.data=$data;let lPromise=$q(function($resolve,$reject){$http($options).then(function success($result){if("200"==$result.status)$resolve($result.data);else $reject(null)},function fail($error){console.log("Fail on path",$path,"with data",$data,$error),$scope.show_toast($error)})});return lPromise},$scope.call=function($path,$data,$options,$credentialInfos){if($path="function"==typeof $path.push?$path.join("/"):$path,$options=angular.merge({url:wpSiApiSettings.api_root+"/api/"+$path,method:"undefined"==typeof $data?"GET":"POST"},$options),"GET"==$options.method)$options.params=$data;else $options.data=$data;if(void 0!=$credentialInfos)$options.headers={"x-si-account":$credentialInfos.account_id,"x-si-api":$credentialInfos.api_key,"x-si-appId":$credentialInfos.app_id,"x-si-appVersion":$credentialInfos.app_version};let lPromise=$q(function($resolve,$reject){$http($options).then(function onSuccess($response){if("200"==$response.status)$resolve($response.data);else $reject(null)},function onFail($error){console.log("Fail on path",$path,"with data",$data,$error),$reject($error)})});return lPromise},$scope.portal=function($path,$data,$options,$credentialInfos){const lOptions=Object.assign({method:"POST"},$options);if(lOptions.url="https://portal-api.source.immo/api/"+$path,null!=$data)if("POST"==lOptions.method)lOptions.data=$data;else lOptions.params=$path;if(void 0!=$credentialInfos){if(!lOptions.params)lOptions.params={};if(lOptions.params.at=$credentialInfos.credentials.authTokenKey,null!=$credentialInfos.account_id)lOptions.params.la=$credentialInfos.account_id}return $q(($resolve,$reject)=>{$http(lOptions).then($response=>{if(200==$response.status)$resolve($response.data)}).catch($err=>{console.log($path,"call failed",$err)})})},$scope}]),siApp.factory("$siUI",["$mdDialog","$mdToast","$q","$rootScope",function $siUI($mdDialog,$mdToast,$q,$rootScope){return $scope={},$scope.alert=function($message,$options){$message="undefined"==typeof $message?"":$message,$options=angular.merge({ev:null,ok:"OK"},$options);const lDialog=$mdDialog.alert().clickOutsideToClose(false).textContent($message.translate()).ok($options.ok).targetEvent($options.ev);lDialog._options.parent=angular.element(document.body),$mdDialog.show(lDialog)},$scope.confirm=function($title,$message,$options){const lTitle=void 0==$message?"":$title,lMessage=void 0==$message?$title:$message;$options=angular.merge({ev:null,ok:"OK",cancel:"Cancel"},$options);var confirm=$mdDialog.confirm().title(lTitle).htmlContent(lMessage.translate().replace("\n","<br>")).targetEvent($options.ev).ok($options.ok.translate()).cancel($options.cancel.translate());return confirm._options.parent=angular.element(document.body),$mdDialog.show(confirm)},$scope.show_toast=function($message){try{$mdToast.show($mdToast.simple().textContent($message.translate()).position("top right").hideDelay(3e3))}catch($ex){console.log($ex),console.log($message)}},$scope.dialog=function($template,$params=null,$options=null){const lOptions=Object.assign({parent:angular.element(document.body),targetEvent:null,clickOutsideToClose:true,fullscreen:true,multiple:true,locals:{$params:$params}},$options);if($template.match(/^~.+\.(html|php|vbhtml|cshtml)/).length>0){if(lOptions.templateUrl=$template.replace("~",wpSiApiSettings.base_path)+"?t="+(new Date).getTime(),void 0==lOptions.controller){const lPageName=$template.split("/").last().match(/(.+)\./)[1],lCtrlName=lPageName.replace(/-|\./g,"_")+"Ctrl";if(console.log("search for controller",lCtrlName,typeof window[lCtrlName]),"function"==typeof window[lCtrlName])console.log("assign root base function as dialog controller"),lOptions.controller=window[lCtrlName];else{const lCtrlProvider=siApp._invokeQueue.filter($p=>"$controllerProvider"==$p[0]).find($p=>$p[2][0]==lCtrlName);if(null!=lCtrlProvider)lOptions.controller=lCtrlProvider[2][1]}}}else lOptions.template=$template.replace(/~/g,wpSiApiSettings.base_path);return $mdDialog.show(lOptions)},$scope.getPortalCredentials=function(){return $q(($resolve,$reject)=>{$scope.dialog("signin").then($credentials=>{$resolve($credentials)},_=>{$reject()})})},$scope}]),siApp.filter("isIn",function(){return function($needle,$stack){if(null==$needle||void 0==$needle)return false;else return $stack.indexOf($needle)>=0}}),siApp.filter("truncate",function(){return function($source,$limit){let lResult=$source;if(lResult)if(lResult.length>$limit)lResult=lResult.substr(0,$limit/2)+"..."+lResult.substr(lResult.length-$limit/2);return lResult}}),siApp.filter("siRelativePath",function(){return function($path){return $path.replace("~",wpSiApiSettings.base_path)}});