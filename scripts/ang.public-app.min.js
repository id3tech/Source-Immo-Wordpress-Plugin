function $lateBind($callback){let $scope={__callback:$callback,resolve:function(){$scope.__callback},then:function($listener){$scope.__callback($listener)}};return $scope}var siApp=angular.module("siApplication",["ngSanitize","angularMoment"]);siApp.run(function(amMoment){amMoment.changeLocale(siCtx.locale)}),siApp.controller("publicCtrl",function publicCtrl($scope,$rootScope,$siDictionary,$siUtils,$siHooks,$siConfig){$scope.model=null,$scope.broker_count=0,$scope.listing_count=0,$scope.statics={isNullOrEmpty:function($value){return null==$value||""==$value||0==$value.length}},$scope.init=function(){$siConfig.get().then(function($configs){if($scope.configs=$configs,void 0!=$configs.styles)if(!isNullOrEmpty($configs.styles)){const lStyles=JSON.parse($configs.styles),lFormatStyles=Object.keys(lStyles).filter(function($key){return console.log("body style filter",$key),"---custom-style"!=$key}).map(function($key){console.log("style",$key,lStyles[$key]);const lRawStyle=lStyles[$key],lStyle=lRawStyle.indexOf("[")>=0?lRawStyle.replace(/(\[)(.+)(\])/gm,"var(--$2)").replace(/_/g,"-"):lRawStyle;return $key+":"+lStyle}),lCurrentBodyStyle=document.body.getAttribute("style");lFormatStyles.push(lCurrentBodyStyle),document.body.setAttribute("style",lFormatStyles.join(";"))}})},$scope.$on("si-listings-update",function($event,$list,$meta){$scope.listing_count=$siHooks.filter("listing_count",$meta.item_count)}),$scope.$on("si-brokers-update",function(ev,$list,$meta){$scope.broker_count=$siHooks.filter("broker_count",$meta.item_count)}),$scope.$on("si-static-data",function($event,$configs,$data){$scope.addStatic($configs.alias,$data),console.log($scope.statics)}),$scope.addStatic=function($alias,$data){const lStatic={_data:$data},lVarName=$siUtils.sanitize($alias,true),lSanitizedName=$siUtils.sanitize($alias);lStatic.getClasses=function(){const lClasses=[];if(null==lStatic._data||""==lStatic._data||0==lStatic._data.length)lClasses.push("empty");return lClasses.map(function($e){return lSanitizedName+"-"+$e}).join(" ")},$scope.statics[lVarName]=lStatic},$scope.getCaption=function($key,$domain,$asAbbr){return $siDictionary.getCaption($key,$domain,$asAbbr)},$rootScope.formatPrice=function($item){return $siUtils.formatPrice($item)},$scope.scrollTo=function($target){let opt={duration:250,easing:"swing"},position=angular.element($target).offset().top;angular.element("html, body").animate({scrollTop:position},opt)},$scope.cancelEvent=function($event){$event.stopPropagation()},$scope.$on("modal-opened",function(){angular.element(document.body).addClass("si-modal-open")}),$scope.$on("modal-closed",function(){angular.element(document.body).removeClass("si-modal-open")}),$scope.hasMapKeyApi=function(){if(void 0==$scope.configs)return false;if(null==$scope.configs)return false;if(""==$scope.configs.map_api_key)return false;else return true}}),siApp.controller("staticDataCtrl",function staticDataCtrl($scope,$rootScope,$siDictionary,$siUtils,$siHooks){$scope.init=function($alias){const $configs=$statics[$alias].configs,$data=$statics[$alias].data;console.log($configs,$data),$scope.$emit("si-static-data",$configs,$data)}}),siApp.controller("singleListingCtrl",function singleListingCtrl($scope,$q,$siApi,$siDictionary,$siUtils,$siConfig,$sce,$siHooks,$siFavorites,$siShare){$scope.model=null,$scope.permalinks=null,$scope.configs=null,$scope.sections={addendum:{opened:false},building:{opened:false},lot:{opened:false},other:{opened:false},in_exclusions:{opened:false},rooms:{opened:false},financials:{opened:false}},$scope.selected_media="pictures",$scope.calculator_result={},$scope.message_model={},$scope.favorites=$siFavorites,$scope.init=function($ref_number){if(void 0!=$ref_number)$scope.fetchPrerequisites().then(function($prerequisits){$scope.permalinks=$prerequisits,$scope.loadSingleData($ref_number)})},$scope.fetchPrerequisites=function(){let lPromise=$q(function($resolve,$reject){$siConfig.get().then(function($configs){$scope.configs=$configs,$resolve({brokers:$configs.broker_routes,listings:$configs.listing_routes})})});return lPromise},$scope.loadSingleData=function($ref_number){let lPromise=$q(function($resolve,$reject){if("undefined"!=typeof siListingData)$resolve(siListingData);else $siApi.getDefaultDataView().then(function($view){$siApi.api("listing/view/{0}/{1}/items/ref_number/{2}".format($view,siApiSettings.locale,$ref_number)).then(function($data){$resolve($data)})})});lPromise.then(function($data){$scope.model=$data,$siDictionary.source=$data.dictionary,$scope.preprocess(),$scope.message_model.subject="Request information for : {0} ({1})".translate().format($scope.model.location.full_address,$scope.model.ref_number);let lUserInfo=sessionStorage.getItem("user_infos");if("undefined"!=typeof lUserInfo)if(lUserInfo=JSON.parse(lUserInfo),null!=lUserInfo)$scope.message_model.firstname=lUserInfo.firstname,$scope.message_model.lastname=lUserInfo.lastname,$scope.message_model.phone=lUserInfo.phone,$scope.message_model.email=lUserInfo.email;$siHooks.do("listing-message-model-post-process",$scope.message_model),$siHooks.do("listing-ready",$scope.model),$siHooks.addFilter("si.share.data",$scope.setShareData)})},$scope.preprocess=function(){if($scope.model.location.city=$scope.getCaption($scope.model.location.city_code,"city"),$scope.model.location.region=$scope.getCaption($scope.model.location.region_code,"region"),$scope.model.location.country=$scope.getCaption($scope.model.location.country_code,"country"),$scope.model.location.state=$scope.getCaption($scope.model.location.state_code,"state"),$scope.model.category=$scope.getCaption($scope.model.category_code,"listing_category"),$scope.model.subcategory=$scope.getCaption($scope.model.subcategory_code,"listing_subcategory"),$scope.model.addendum=$scope.model.addendum?$scope.model.addendum.trim():null,""!=$scope.model.location.address.street_number&&""!=$scope.model.location.address.street_name)$scope.model.location.civic_address="{0} {1}".format($scope.model.location.address.street_number,$scope.model.location.address.street_name);else if(""!=$scope.model.location.address.street_name)$scope.model.location.civic_address=$scope.model.location.address.street_name;else $scope.model.location.civic_address="";if(""!=$scope.model.location.civic_address){if($scope.model.location.full_address="{0} {1}, {2}".format($scope.model.location.address.street_number,$scope.model.location.address.street_name,$scope.model.location.city),!isNullOrEmpty($scope.model.location.address.door)&&"undefined"!=typeof $scope.model.location.address.door)$scope.model.location.full_address+=", "+"apt. {0}".translate().format($scope.model.location.address.door)}else $scope.model.location.full_address=$scope.model.location.city;$scope.model.building.attributes=[],$scope.model.land.attributes=[],$scope.model.other={attributes:[]},$scope.model.important_flags=[],$scope.model.long_price=$siUtils.formatPrice($scope.model,"long"),$scope.model.short_price=$siUtils.formatPrice($scope.model);let lMainUnit=$scope.model.units.find(function($u){return"MAIN"==$u.category_code});if(null!=lMainUnit){if(lMainUnit.bedroom_count)$scope.model.important_flags.push({icon:"bed",value:lMainUnit.bedroom_count,caption:"Bedroom".translate()});if(lMainUnit.bathroom_count)$scope.model.important_flags.push({icon:"bath",value:lMainUnit.bathroom_count,caption:"Bathroom".translate()});if(lMainUnit.waterroom_count)$scope.model.important_flags.push({icon:"hand-holding-water",value:lMainUnit.waterroom_count,caption:"Water room".translate()})}if($scope.model.attributes.forEach(function($e){$e.caption=$scope.getCaption($e.code,"attribute"),$e.values.forEach(function($v){if($v.caption=$scope.getCaption($v.code,"attribute_value"),$v.count)$v.caption=$v.caption.concat(" ({0})".format($v.count));if($v.details)$v.caption=$v.details});const lBuildingCodes=["CUPBOARD","WINDOWS","WINDOW TYPE","ROOFING","FOUNDATION","GARAGE","SIDING","BATHR./WASHR","BASEMENT","EASY ACCESS"],lLotCodes=["LANDSCAPING","DRIVEWAY","PARKING","POOL","TOPOGRAPHY","VIEW","ZONING","PROXIMITY"],lOtherCodes=["HEATING SYSTEM","HEATING ENERGY","HEART STOVE","WATER SUPPLY","SEWAGE SYST.","EQUIP. AVAIL"];if(lBuildingCodes.includes($e.code))$scope.model.building.attributes.push($e);else if(lLotCodes.includes($e.code))$scope.model.land.attributes.push($e);else if(![].concat(lBuildingCodes,lLotCodes).includes($e.code))$scope.model.other.attributes.push($e);if("PARKING"==$e.code){let lParkingCount=0;if($e.values.forEach(function($v){lParkingCount+=$v.count}),lParkingCount>0)$scope.model.important_flags.push({icon:"car",value:lParkingCount,caption:$e.caption})}if("POOL"==$e.code)$scope.model.important_flags.push({icon:"swimmer",value:0,caption:$e.caption});if("HEART STOVE"==$e.code)$scope.model.important_flags.push({icon:"fire",value:0,caption:$e.caption})}),$scope.model.units.forEach(function($u){if($u.category=$siDictionary.getCaption({src:$u,key:"category_code"},"unit_category"),$u.flags=[],$u.room_count)$u.flags.push({icon:"door-open",value:$u.room_count,caption:"Rooms".translate()});if($u.bedroom_count)$u.flags.push({icon:"bed",value:$u.bedroom_count,caption:"Bedrooms".translate()});if($u.bathroom_count)$u.flags.push({icon:"bath",value:$u.bathroom_count,caption:"Bathrooms".translate()})}),$scope.model.expenses.forEach(function($ex){$ex.type=$siDictionary.getCaption({src:$ex,key:"type_code"},"expense_type")}),$scope.model.incomes.forEach(function($ex){$ex.type=$siDictionary.getCaption({src:$ex,key:"type_code"},"income_type")}),$scope.model.documents.forEach(function($doc){$doc.category=$siDictionary.getCaption({src:$doc,key:"category_code"},"document_category")}),$scope.model.rooms.forEach(function($r){$r.category=$siDictionary.getCaption({src:$r,key:"category_code"},"room_category"),$r.level_category=$siDictionary.getCaption({src:$r,key:"level_category_code"},"level_category"),$r.short_dimension=$siUtils.formatDimension($r.dimension);let lRoomInfos=[];$r.flooring=$siDictionary.getCaption({src:$r,key:"flooring_code"},"flooring")}),void 0!=$scope.model.virtual_tour)$scope.model.virtual_tour.trusted_url=$sce.trustAsResourceUrl($scope.model.virtual_tour.url.replace("http:",""));if(void 0!=$scope.model.video){let lEmbedVideo=$scope.model.video.url;const lEmbedFormatFn={youtube:function(){return"//www.youtube.com/embed/{0}?rel=0&showinfo=0&enablejsapi=1&origin=*".format($scope.model.video.id)},vimeo:function(){return"//player.vimeo.com/video/{0}".format($scope.model.video.id)}};if("function"==typeof lEmbedFormatFn[$scope.model.video.type])lEmbedVideo=lEmbedFormatFn[$scope.model.video.type]();$scope.model.video.trusted_url=$sce.trustAsResourceUrl(lEmbedVideo)}$scope.model.permalink=window.location.pathname,$siUtils.compileBrokerList($scope.model.brokers),console.log("permalink",$scope.model.permalink),$siHooks.do("single-listing-preprocess",$scope.model)},$scope.getBrokerListFilter=function(){if(null==$scope.model)return null;if(void 0!=$scope.broker_list_filter)return $scope.broker_list_filter;const lBrokerIds=$scope.model.brokers_ref_numbers||$scope.model.brokers.map(function($e){return $e.ref_number});return $scope.broker_list_filter={field:"ref_number",operator:"in",value:lBrokerIds},$scope.broker_list_filter},$scope.setShareData=function($data){return $data.description=$scope.model.description,$data.media=$scope.model.photos[0].source_url,$data},$scope.sectionOpened=function($section){if(void 0==$scope.sections[$section])return false;else return $scope.sections[$section].opened},$scope.toggleSection=function($section){$scope.sections[$section].opened=!$scope.sections[$section].opened},$scope.onMortgageChange=function($calculatorResult){$scope.calculator_result=$calculatorResult},$scope.sendMessage=function(){sessionStorage.setItem("user_infos",JSON.stringify({firstname:$scope.message_model.firstname,lastname:$scope.message_model.lastname,phone:$scope.message_model.phone,email:$scope.message_model.email}));let lSent=$siHooks.do("single-listing-send-message",$scope.message_model);if(true!==lSent){let lDestEmails=$scope.model.brokers.map(function($e){return $e.email});lDestEmails=$siHooks.filter("single-listing-message-emails",lDestEmails,$scope.model.brokers),lMessage={type:"information_request",metadata:{id:$scope.model.id,ref_number:$scope.model.ref_number,address:$scope.model.location.civic_address},destination:lDestEmails,data:$scope.message_model},$siApi.rest("message",{params:lMessage}).then(function($response){$scope.request_sent=true})}},$scope.print=function(){const lSegmentToKeep=1+(siCtx.use_lang_in_path?1:0),lPermalinkParts=$scope.model.permalink.split("/").filter(function($p){return""!=$p}),lPrintLink=lPermalinkParts.filter(function($e,$i){return $i<lSegmentToKeep});lPrintLink.push("print"),window.open("/"+lPrintLink.join("/")+"/"+lPermalinkParts[lPermalinkParts.length-1])},$scope.hasDimension=function($dimension){return $siUtils.hasDimension($dimension)},$scope.shareTo=function($social_media){$siShare.execute($social_media)},$scope.hasListOf=function($type){return console.log($scope.configs),$scope.configs.lists.some(function($l){return $l.type==$type})},$scope.allowCalculator=function(){if(null==$scope.model)return false;if("SOLD"==$scope.model.status_code)return false;if(void 0==$scope.model.price.sell)return false;if("SF"==$scope.model.price.sell.unit_code)return false;else return true}}),siApp.controller("singleBrokerCtrl",function singleBrokerCtrl($scope,$q,$siApi,$siDictionary,$siUtils,$siConfig,$siHooks){$scope.filter_keywords="",$scope.message_model={},$scope.model=null,$scope.permalinks=null,$scope.message_model={},$scope.init=function($ref_number){if(void 0!=$ref_number)$scope.fetchPrerequisites().then(function(){$scope.loadSingleData($ref_number)}),$scope.$on("si-list-loaded",function($event,$type,$list){if(console.log("si-list-loaded",$type,$list),"listings"==$type)$siConfig.get().then(function($configs){const lHasCityPage=$configs.city_layouts.filter(function($c){return $c.lang==siApiSettings.locale}).some(function($c){return null!=$c.page});if(!lHasCityPage)return;const lCities=[];$list.forEach(function($l){const lCity=lCities.find(function($c){return $c.ref_number==$l.location.city_code});if(null==lCity){const lNewCity={ref_number:$l.location.city_code,name:$l.location.city,listing_count:1,location:$l.location};$siUtils.compileCityItem(lNewCity),lCities.push(lNewCity)}else lCity.listing_count++}),$scope.cities=lCities})})},$scope.fetchPrerequisites=function(){let lPromise=$q(function($resolve,$reject){$siConfig.get().then(function($configs){$resolve({brokers:$configs.broker_routes,listings:$configs.listing_routes})})});return lPromise},$scope.loadSingleData=function($ref_number){let lPromise=$q(function($resolve,$reject){if("undefined"!=typeof siBrokerData)$resolve(siBrokerData);else $siApi.getDefaultDataView().then(function($view){$siApi.api("broker/view/{0}/{1}/items/ref_number/{2}".format($view,siApiSettings.locale,$ref_number)).then(function($data){$resolve($data)})})});lPromise.then(function($data){$scope.model=$data,$siDictionary.source=$data.dictionary,$scope.preprocess()})},$scope.loadListings=function(){if(null==$scope.listings)$siApi.getDefaultDataView().then(function($view){const $filters={filter_group:{filters:[{field:"brokers",operator:"in",value:[$scope.model.id]}]}};$siApi.api("utils/search_encode",$filters).then(function($response){$resolve($response)})})},$scope.preprocess=function(){$scope.model.license_type=$scope.getCaption($scope.model.license_type_code,"broker_license_type"),$scope.model.languages="N/A".translate();let lExpertises=[];$scope.model.listings.forEach(function($e,$i,$arr){let lNewItem=$scope.getCaption($e.category_code,"listing_category");if(lExpertises.indexOf(lNewItem)<0)lExpertises.push(lNewItem)}),$scope.model.expertises=lExpertises.join(", "),$scope.list=$scope.model.listings,$scope.model.photo=null!=$scope.model.photo?$scope.model.photo:{url:siCtx.base_path+"styles/assets/shadow_broker.jpg"},$siUtils.compileOfficeItem($scope.model.office),$scope.model.location=$scope.model.office.location,$siUtils.compileListingList($scope.model.listings)},$scope.getPhoneIcon=function($key){$siUtils.getPhoneIcon($key)},$scope.filterListings=function($listing){if(void 0==$scope.filter_keywords||""==$scope.filter_keywords)return true;let lLowerKeyword=$scope.filter_keywords.toLowerCase(),lNumKeyword=Number($scope.filter_keywords),lStringContentChecks=["description","subcategory","category","location.city","location.address.street_name","ref_number"],lNumContentChecks=["price.sell.amount","price.lease.amount"];if(lStringContentChecks.some(function($e){let lValue=findProperty($listing,$e);if(null!=lValue&&lValue.toLowerCase().indexOf(lLowerKeyword)>=0)return true}))return true;if(lNumContentChecks.some(function($e){let lValue=findProperty($listing,$e);if(null!=lValue&&lValue.toString().indexOf(lLowerKeyword)>=0)return true}))return true;else return false},$scope.sectionOpened=function($section){return $scope.sections[$section].opened},$scope.toggleSection=function($section){$scope.sections[$section].opened=!$scope.sections[$section].opened},$scope.onMortgageChange=function($calculatorResult){$scope.calculator_result=$calculatorResult},$scope.getClassList=function($item){let lResult=$siUtils.getClassList($item);return lResult},$scope.sendMessage=function(){sessionStorage.setItem("user_infos",JSON.stringify({firstname:$scope.message_model.firstname,lastname:$scope.message_model.lastname,phone:$scope.message_model.phone,email:$scope.message_model.email}));let lSent=$siHooks.do("single-broker-send-message",$scope.message_model);if(true!==lSent){let lDestEmails=$scope.model.email;lDestEmails=$siHooks.filter("single-broker-message-emails",lDestEmails,$scope.model),lMessage={type:"broker_message",destination:lDestEmails,data:$scope.message_model},$siApi.rest("message",{params:lMessage}).then(function($response){$scope.request_sent=true})}},$scope.validateMessage=function(){},$scope.getPhoneIcon=function($key){return $siUtils.getPhoneIcon($key)}}),siApp.controller("singleOfficeCtrl",function singleOfficeCtrl($scope,$q,$siApi,$siDictionary,$siUtils,$siConfig,$siHooks){$scope.model=null,$scope.init=function($ref_number){if(void 0!=$ref_number)$scope.fetchPrerequisites().then(function(){$scope.loadSingleData($ref_number)})},$scope.fetchPrerequisites=function(){let lPromise=$q(function($resolve,$reject){$siConfig.get().then(function($configs){$resolve({brokers:$configs.broker_routes,listings:$configs.listing_routes})})});return lPromise},$scope.loadSingleData=function($ref_number){let lPromise=$q(function($resolve,$reject){if("undefined"!=typeof siBrokerData)$resolve(siBrokerData);else $siApi.getDefaultDataView().then(function($view){$siApi.api("office/view/{0}/{1}/items/ref_number/{2}".format($view,siApiSettings.locale,$ref_number)).then(function($data){$resolve($data)})})});lPromise.then(function($data){$scope.model=$data,$siDictionary.source=$data.dictionary,$scope.preprocess()})},$scope.getPhoneIcon=function($key){return $siUtils.getPhoneIcon($key)},$scope.preprocess=function(){$siUtils.compileOfficeItem($scope.model)}}),siApp.directive("siInputContainer",["$parse",function siInputContainer($parse){return{restrict:"E",transclude:true,replace:true,template:'<div class="si-input-container" ng-transclude></div>',link:function($scope,$element,$attrs){const lLabel=$element[0].querySelector(":scope > label"),lInput=$element[0].querySelector(":scope > input,:scope > .si-select");if(null!=lLabel&&null!=lInput){const lLabelWidth=Number(window.getComputedStyle(lLabel).width.replace("px","")),lInputStyle=window.getComputedStyle(lInput),lPaddingH=Number(lInputStyle.paddingLeft.replace("px",""))+Number(lInputStyle.paddingRight.replace("px",""));$element[0].style.minWidth=lLabelWidth+lPaddingH+"px"}}}}]),siApp.directive("siCheckbox",["$parse",function siCheckbox($parse){return{retrict:"E",transclude:true,scope:{label:"@",model:"=?ngModel",checked:"=?siChecked",changeHandler:"&?siChange",checkedValue:"@?siValue"},link:function($scope,$element,$attrs){$scope.selected=$scope.checked,$scope.compareModelToValue()},controller:function($scope,$timeout){$scope.$watch("model",function($new,$old){if(console.log("siCheckbox:model changed"),null!=$new)$scope.compareModelToValue()}),$scope.$watch("checkedValue",function($new,$old){if(null!=$new)$scope.compareModelToValue()}),$scope.$watch("checked",function($new,$old){$scope.selected=$scope.checked}),$scope.toggleCheck=function($event){if(void 0!==$scope.model){if($scope.selected=!$scope.selected,Array.isArray($scope.model))if($scope.selected)$scope.model.push($scope.checkedValue);else $scope.model=$scope.model.filter(function($e){return $e!=$scope.checkedValue});else $scope.model=$scope.selected?$scope.checkedValue:null;if("function"==typeof $scope.changeHandler)$timeout(function(){$scope.changeHandler()})}else $event.preventDefault()},$scope.compareModelToValue=function(){if(null==$scope.model)$scope.selected=false;$timeout(function(){if(Array.isArray($scope.model)){if($scope.model.length>0);$scope.selected=$scope.model.includes($scope.checkedValue)}else $scope.selected=$scope.model==$scope.checkedValue})},$scope.isSelected=function(){if(Array.isArray($scope.model)){if($scope.model.length>0);return $scope.model.includes($scope.checkedValue)}else return $scope.model==$scope.checkedValue}},template:'<div class="pretty p-icon p-pulse" ng-click="toggleCheck($event)">'+'<input type="checkbox" ng-checked="isSelected()" title="{{label}}">'+'<div class="si-input-state">'+'<i class="icon fas fa-check"></i>'+"<label>{{label}}</label>"+"</div>"+"</div>"}}]),siApp.directive("siSelect",["$parse",function siSelect(){return{restrict:"E",scope:{model:"=siModel",changeCallback:"&?siChange"},transclude:true,template:'<div class="si-select"><div class="si-selected-value"><span class="si-label">{{selectedCaption}}</span> <i class="fal fa-lg fa-fw fa-angle-down"></i></div><div class="si-select-panel"><i class="fal fa-times" ng-click="closeMenu()"></i><div class="si-panel-child-container" ng-transclude></div></div></div>',replace:true,link:function($scope,$element,$attrs){$scope.allowMultiple=void 0!=$attrs.siMultiple,$scope.placeholder=void 0!=$attrs.placeholder?$attrs.placeholder:"",$scope.init($element)},controller:function($scope,$rootScope,$siUtils,$timeout,$q){$scope.options=[],$scope.init=function($element){$scope.$element=$element[0],$scope.$element.addEventListener("click",function($event){$scope.clickHandler($event)}),$scope.$watch("model",$scope.modelChangeHandler,true),$scope.selectedCaption=$scope.placeholder,$scope.$watch("checked",function(){$scope.selected=$scope.checked}),$scope.applyEvents()},this.allowMultipleSelection=function(){return $scope.allowMultiple},this.addToChildList=$scope.addToChildList=function($child){if($scope.options.push($child),null!=$scope.model&&void 0!=$scope.model){const lChildValue="function"==typeof $child.getValue?$child.getValue():void 0;if($scope.model==lChildValue)$scope.updateValue(lChildValue)}},this.toggleValue=$scope.toggleValue=function($value){if(!Array.isArray($scope.model))$scope.model=[];$timeout(function(){if($scope.model.includes($value))$scope.model=$scope.model.filter(function($e){return $e!=$value});else $scope.model.push($value);if("function"==typeof $scope.changeCallback)$scope.changeCallback()})},this.hasValue=$scope.hasValue=function($value){if(void 0==$value)return false;if(null==$scope.model)return false;if(!Array.isArray($scope.model))return false;else return $scope.model.includes($value)},this.selectValue=$scope.selectValue=function($value){const lChanged=$scope.model!=$value;$scope.model=$value,$scope.$apply(function(){if($scope.updateValue(),lChanged)$timeout(function(){if("function"==typeof $scope.changeCallback)$scope.changeCallback()})})},$scope.modelChangeHandler=function($new,$old){if($scope.updateElementClasses(),$scope.allowMultiple)$scope.updateValues();else $scope.updateValue()},$scope.updateElementClasses=function(){const lContainerParent=$scope.$element.closest(".si-input-container"),lRemoveValue=isNullOrEmpty($scope.model);if(lRemoveValue)$scope.$element.classList.remove("si-has-value");else $scope.$element.classList.add("si-has-value");if(null!=lContainerParent)if(lRemoveValue)lContainerParent.classList.remove("si-has-value");else lContainerParent.classList.add("si-has-value")},$scope.updateValues=function(){$scope.updateCaption()},$scope.updateValue=function(){const lRemoveValue=isNullOrEmpty($scope.model);let lSelectedElement=null;if($scope.options.forEach(function($o){if("function"==typeof $o.getValue&&$o.getValue()==$scope.model)$o.classList.add("selected"),lSelectedElement=$o;else $o.classList.remove("selected")}),lRemoveValue)$scope.updateCaption($scope.placeholder);else if(1==$scope.options.length)$scope.options[0].getCaption().then(function($caption){$scope.updateCaption($caption)});else if(null!=lSelectedElement)lSelectedElement.getCaption().then(function($caption){$scope.updateCaption($caption)})},$scope.updateCaption=function($caption){if($scope.allowMultiple){let lCaption=$scope.placeholder;if(Array.isArray($scope.model)&&$scope.model.length>0)lCaption+=" ({0})".format($scope.model.length);$scope.selectedCaption=lCaption}else{if(null==$caption)$caption=$scope.placeholder;$scope.selectedCaption=$caption}},$scope.applyEvents=function(){angular.element(document).on("click",function(){$rootScope.$broadcast("close-dropdown",null)}),$scope.$on("close-dropdown",function($event,$source){if($source!=$scope.$element)$scope.closeMenu()})},$scope.getContentHeight=function($element){const lElementBox=$scope.$element.getBoundingClientRect(),lPotentialHeight=[];let lSubElements=Array.from($element.querySelectorAll(".si-panel-child-container"));lSubElements.forEach(function($e){const lItemStyles=window.getComputedStyle($e),lItemHeight=["height","padding-top","padding-bottom","margin-top","margin-bottom"].map(function(key){return parseInt(lItemStyles.getPropertyValue(key),10)}).reduce(function(prev,cur){return prev+cur});lPotentialHeight.push(lItemHeight)});const lResult=lPotentialHeight.reduce(function($result,$cur){return $result+$cur},0);return Math.min(lResult,12*lElementBox.height)},$scope.closeMenu=function(){if(null!=$scope._menu_elm){$scope._menu_elm.classList.remove("expanded"),$scope._menu_elm.removeAttribute("style");const lClickTrap=$scope.ensureClickTrap();lClickTrap.classList.remove("active"),lClickTrap.style.removeProperty("z-index")}},$scope.clickHandler=function($event){$rootScope.$broadcast("close-dropdown",$scope.$element);const lElmZIndex=$siUtils.elmOffsetZIndex($scope.$element);$scope.extractMenu($scope.$element).then(function(lMenuElm){lMenuElm.style.zIndex=Number(lElmZIndex)+10;const lClickTrap=$scope.ensureClickTrap();lClickTrap.classList.add("active"),lMenuElm.addEventListener("transitionend",function(){if("auto"!=lElmZIndex)lClickTrap.style.zIndex=Number(lElmZIndex)+5;lClickTrap.addEventListener("click",function($event){lMenuElm.classList.remove("expanded"),lClickTrap.classList.remove("active"),$event.stopPropagation()},{once:true})},{once:true}),lMenuElm.classList.add("expanded")}),$event.stopPropagation()},$scope.ensureClickTrap=function(){let lClickTrap=document.body.querySelector(".si-click-trap");if(null==lClickTrap)lClickTrap=document.createElement("div"),lClickTrap.classList.add("si-click-trap"),document.body.prepend(lClickTrap);return lClickTrap},$scope.extractMenu=function($element){return $q(function($resolve,$reject){if(null==$scope._menu_elm){const lMenu=$element.querySelector(".si-select-panel");document.body.append(lMenu),$scope._menu_elm=lMenu,$scope._menu_elm.addEventListener("click",function($event){$event.stopPropagation(),$scope.closeMenu()})}$timeout(function(){const lMainElmRect=$scope.$element.getBoundingClientRect(),lRelativeAttr={};lRelativeAttr.left=lMainElmRect.left,lRelativeAttr.top=lMainElmRect.top,lRelativeAttr.width=lMainElmRect.width,lRelativeAttr.height=lMainElmRect.height,lRelativeAttr.inner_cx=lRelativeAttr.width/2,lRelativeAttr.inner_cy=lRelativeAttr.height/2,lRelativeAttr.cx=lMainElmRect.left+lRelativeAttr.inner_cx,lRelativeAttr.cy=lMainElmRect.top+lRelativeAttr.inner_cy,lRelativeAttr.pageYOffset=window.pageYOffset;const lMenuRect=$scope._menu_elm.getBoundingClientRect(),lMenuHeight=$scope.getContentHeight($scope._menu_elm);Object.keys(lRelativeAttr).forEach(function($k){$scope._menu_elm.style.setProperty("--relative-"+$k,lRelativeAttr[$k]+"px")}),$scope._menu_elm.style.setProperty("--potential-height",lMenuHeight+"px"),$resolve($scope._menu_elm)},20)})}}}}]),siApp.directive("siOption",["$parse","$timeout","$q",function siOption($parse,$timeout,$q){return{restrict:"E",require:["^siSelect"],transclude:true,replace:true,template:'<div class="si-select-child si-option"><si-checkbox si-checked="isChecked()" ng-show="showCheckbox()"></si-checkbox><div ng-transclude></div></div>',link:function($scope,$element,$attrs,$parentCtls){const lValue=void 0==$attrs.ngValue?$attrs.value:$parse($attrs.ngValue)($scope);$scope.showCheckbox=function(){return $parentCtls.some(function($ctl){if(null!=$ctl)return $ctl.allowMultipleSelection()})},$scope.isChecked=function(){return $parentCtls.some(function($ctl){if(null!=$ctl)return $ctl.hasValue(lValue)})},$element[0].getValue=function(){return lValue},$element[0].getCaption=function(){return $q(function($resolve,$reject){$timeout(function(){$resolve($element[0].innerText)})})},$element[0].addEventListener("click",function($event){$parentCtls.forEach(function($ctl){if(null!=$ctl)if($ctl.allowMultipleSelection())$event.stopPropagation(),$event.preventDefault(),$ctl.toggleValue(lValue);else $ctl.selectValue(lValue)})}),$parentCtls.forEach(function($ctl){if(null!=$ctl)$ctl.addToChildList($element[0],lValue)})}}}]),siApp.directive("siOptionGroup",["$parse",function siOptionGroup($parse){return{restrict:"E",require:"^siSelect",replace:true,template:'<div class="si-select-child si-option-group"><div class="si-group-title">{{groupTitle}}</div><div class="si-group-child" ng-transclude></div></div>',transclude:true,scope:{groupTitle:"@siLabel"},link:function($scope,$element,$attrs,$parentCtl){$scope.init($element[0],$parentCtl)},controller:function($scope){$scope.init=function($element,$parentCtl){$scope.$element=$element,$scope.$siParent=$parentCtl,$scope.$siParent.addToChildList($element.querySelector(".si-group-title"))},this.allowMultipleSelection=function(){return $scope.$siParent.allowMultipleSelection()},this.addToChildList=$scope.addToChildList=function($child){$scope.$siParent.addToChildList($child)},this.selectValue=$scope.selectValue=function($value){$scope.$siParent.selectValue($value)},this.toggleValue=$scope.toggleValue=function($value){$scope.$siParent.toggleValue($value)},this.hasValue=$scope.hasValue=function($value){return $scope.$siParent.hasValue($value)}}}}]),siApp.directive("siOptionPanel",["$parse",function siOptionGroup($parse){return{restrict:"E",require:"^siSelect",scope:{captionFormat:"&?siCaptionFormat"},template:'<div class="si-select-child si-option-panel" ng-transclude></div>',transclude:true,replace:true,link:function($scope,$element,$attrs,$parentCtl){$scope.init($element[0],$parentCtl)},controller:function($scope,$timeout,$q){$scope.caption="",$scope.init=function($element,$parentCtl){$scope.$element=$element,$scope.$siParent=$parentCtl,$scope.$element.addEventListener("mousedown",function($event){$event.stopPropagation(),$event.preventDefault()}),$scope.$element.addEventListener("mouseup",function($event){$event.stopPropagation(),$event.preventDefault()}),$scope.$element.getCaption=$scope.getCaption,$scope.$element.getValue=function(){return $parentCtl.model},$parentCtl.addToChildList($element)},$scope.getCaption=function(){return $q(function($resolve,$reject){let caption=null;if("function"==typeof $scope.captionFormat)caption=$scope.captionFormat();$resolve(caption)})},this.addToChildList=$scope.addToChildList=function($child){
$scope.$siParent.addToChildList($child)},this.selectValue=$scope.selectValue=function($value){$scope.$siParent.selectValue($value)}}}}]),siApp.directive("siDropdown",["$rootScope",function siDropdown($rootScope){return{restrict:"C",scope:{showButtonIcon:"@?",hasValue:"@?"},link:function($scope,$element,$attr){$scope.init($element)},controller:function($scope,$q,$timeout,$siUtils){$scope._menu_elm=null,$scope.$watch("hasValue",function($new,$old){if(true==$new)$scope.$element.classList.add("has-value");else $scope.$element.classList.remove("has-value")}),$scope.init=function($element){if($scope.$element=$element[0],$scope.showButtonIcon="undefined"==typeof $scope.showButtonIcon?true:$scope.showButtonIcon,$scope.hasValue="undefined"==typeof $scope.hasValue?false:null!=$scope.hasValue,$scope.buttonIcon="anchor-down",$scope.hasValue)$scope.$element.classList.add("has-value");if(true===$scope.showButtonIcon||"false"!=$scope.showButtonIcon)if($scope.$element.classList.add("has-button-icon"),"string"==typeof $scope.showButtonIcon&&"true"!=$scope.showButtonIcon)$scope.buttonIcon=$scope.showButtonIcon;$scope.applyEvents()},$scope.applyEvents=function(){angular.element(document).on("click",function(){$rootScope.$broadcast("close-dropdown",null)}),angular.element($scope.$element).find(".dropdown-button").on("click",$scope.clickHandler),$scope.$on("close-dropdown",function($event,$source){if($source!=$scope.$element)$scope.closeMenu()})},$scope.getContentHeight=function($element){return $element.querySelector(".si-dropdown-panel-content").getBoundingClientRect().height},$scope.getContentWidth=function($element){return $element.querySelector(".si-dropdown-panel-content").getBoundingClientRect().width},$scope.closeMenu=function(){if(null!=$scope._menu_elm){$scope._menu_elm.classList.remove("expanded"),$scope._menu_elm.removeAttribute("style");const lClickTrap=$scope.ensureClickTrap();lClickTrap.classList.remove("active"),lClickTrap.style.removeProperty("z-index")}},$scope.clickHandler=function($event){$event.stopPropagation(),$rootScope.$broadcast("close-dropdown",$scope.$element);const lElmZIndex=$siUtils.elmOffsetZIndex($scope.$element);$scope.extractMenu($scope.$element).then(function($menuElm){const lMenuElm=$menuElm;if(lMenuElm.classList.add("expanded"),"auto"!=lElmZIndex)lMenuElm.style.zIndex=Number(lElmZIndex)+10;else lMenuElm.style.zIndex=100;const lClickTrap=$scope.ensureClickTrap();if(lClickTrap.classList.add("active"),"auto"!=lElmZIndex)lClickTrap.style.zIndex=Number(lElmZIndex)+5;lClickTrap.addEventListener("click",function($event){lMenuElm.classList.remove("expanded"),lClickTrap.classList.remove("active"),lClickTrap.style.removeProperty("z-index"),$event.stopPropagation()},{once:true})})},$scope.ensureClickTrap=function(){let lClickTrap=document.body.querySelector(".si-click-trap");if(null==lClickTrap)lClickTrap=document.createElement("div"),lClickTrap.classList.add("si-click-trap"),document.body.prepend(lClickTrap);return lClickTrap},$scope.extractMenu=function($element){return $q(function($resolve,$reject){if(null==$scope._menu_elm){const lMenu=$element.querySelector(".si-dropdown-panel");document.body.append(lMenu),$scope._menu_elm=lMenu,$scope._menu_elm.addEventListener("click",function($event){$event.stopPropagation(),$scope.closeMenu()})}$timeout(function(){const lMainElmRect=$scope.$element.getBoundingClientRect(),lRelativeAttr={};lRelativeAttr.left=lMainElmRect.left,lRelativeAttr.top=lMainElmRect.top,lRelativeAttr.width=lMainElmRect.width,lRelativeAttr.height=lMainElmRect.height,lRelativeAttr.inner_cx=lRelativeAttr.width/2,lRelativeAttr.inner_cy=lRelativeAttr.height/2,lRelativeAttr.cx=lMainElmRect.left+lRelativeAttr.inner_cx,lRelativeAttr.cy=lMainElmRect.top+lRelativeAttr.inner_cy,lRelativeAttr.pageYOffset=window.pageYOffset;const lMenuHeight=$scope.getContentHeight($scope._menu_elm),lMenuWidth=$scope.getContentWidth($scope._menu_elm),lScrollbarWidth=20;lRelativeAttr.cx=Math.max(lMenuWidth/2,Math.min(lRelativeAttr.cx,window.innerWidth-lScrollbarWidth-lMenuWidth/2)),Object.keys(lRelativeAttr).forEach(function($k){$scope._menu_elm.style.setProperty("--relative-"+$k,lRelativeAttr[$k]+"px")}),$scope._menu_elm.style.setProperty("--potential-height",lMenuHeight+"px"),$scope._menu_elm.style.setProperty("--potential-width",lMenuWidth+"px"),$resolve($scope._menu_elm)},20)})}}}}]),siApp.directive("siDropdownPanel",[function siDropdownPanel(){return{restrict:"C",transclude:true,template:'<div class="si-dropdown-panel-content" ng-transclude></div>'}}]),siApp.directive("inputContainer",function inputContainer(){return{restrict:"C",scope:{},link:function(scope,element,attr){let lElm=angular.element(element);if(lElm.find("[required]").length>0)lElm.addClass("is-required");scope.$watch(function(){return lElm.find("input,textarea").attr("class")},function(newValue){if(null==newValue||"undefined"==typeof newValue)return null;["ng-invalid","ng-dirty","ng-pristine","ng-touched"].forEach(function($c){if(newValue.indexOf($c)>=0)lElm.addClass($c);else lElm.removeClass($c)})})}}}),siApp.directive("siPriceRangeSlider",["$document",function siPriceRangeSlider($document){return{restrict:"E",scope:{model:"=",max:"=siMax",onChange:"&",valueFormat:"&",property:"@",startLabel:"@",endLabel:"@"},replace:true,templateUrl:siCtx.base_path+"views/ang-templates/si-price-range-slider.html",link:function($scope,$element,attrs){const element=$element[0].querySelector(".inner");return $scope.init(element),$scope.$watch("model",function(){$scope.updatePositions()},true)},controller:function($scope,$timeout){$scope.handles=[],$scope.rangeHandle=null,$scope.pTotal=0,$scope.eventMaps={mouse:{down:"mousedown",move:"mousemove",up:"mouseup"},touch:{down:"touchstart",move:"touchmove",up:"touchend"}},$scope.init=function($element){$scope.element=$element,$scope.rangeHandle=$element.querySelector(".slider-range-handle"),$scope.handles.push($element.querySelector(".slider-handle.min")),$scope.handles.push($element.querySelector(".slider-handle.max")),$scope.handles.forEach(function($h,$i){$scope.applyPointerEvent($h,$i,"mouse"),$scope.applyPointerEvent($h,$i,"touch")}),$scope.applyRangeHandleEvent("mouse")},$scope.boundaryClasses=function(){},$scope.applyPointerEvent=function($elm,$elm_index,$type){angular.element($elm).on($scope.eventMaps[$type].down,function(event){lPositionRef=event;const lPointerMoveHndl=function(event){return $scope.$apply(function(){let lPositionRef=event;if("touch"==$type)lPositionRef=event.originalEvent.touches[0];const lElmBox=$scope.element.getBoundingClientRect(),lScopedPositionX=lPositionRef.clientX-lElmBox.left,lPctPositionX=Math.max(0,Math.min(1,lScopedPositionX/lElmBox.width));$scope.setP($elm_index,lPctPositionX)})},lPointerUpHndl=function(){if($document.unbind($scope.eventMaps[$type].move,lPointerMoveHndl),$document.unbind($scope.eventMaps[$type].up,lPointerUpHndl),"function"==typeof $scope.onChange)$scope.onChange()};if("touch"==$type)lPositionRef=event.originalEvent.touches[0];return event.preventDefault(),$document.on($scope.eventMaps[$type].move,lPointerMoveHndl),$document.on($scope.eventMaps[$type].up,lPointerUpHndl)})},$scope.applyRangeHandleEvent=function($type){angular.element($scope.rangeHandle).on($scope.eventMaps[$type].down,function(event){lPositionRef=event;const lElmBox=$scope.element.getBoundingClientRect();let lScopedPositionStartX=lPositionRef.clientX-lElmBox.left;const lPointerMoveHndl=function(event){return $scope.$apply(function(){let lPositionRef=event;if("touch"==$type)lPositionRef=event.originalEvent.touches[0];const lValues=[$scope.getP(0)*lElmBox.width,$scope.getP(1)*lElmBox.width],lRange=(lValues[1]-lValues[0])/lElmBox.width,lScopedPositionX=lPositionRef.clientX-lElmBox.left,lScopedDeltaPositionX=lScopedPositionX-lScopedPositionStartX;lValues.forEach(function($v,$i,$arr){const lNewValue=Math.max(0,Math.min(1,($v+lScopedDeltaPositionX)/lElmBox.width));$arr[$i]=lNewValue}),lValues[0]=Math.max(0,Math.min(lValues[1]-lRange,lValues[0])),lValues[1]=Math.max(lValues[0]+lRange,Math.min(1,lValues[1])),$scope.setPs(lValues),lScopedPositionStartX=lPositionRef.clientX-lElmBox.left})},lPointerUpHndl=function(){if($document.unbind($scope.eventMaps[$type].move,lPointerMoveHndl),$document.unbind($scope.eventMaps[$type].up,lPointerUpHndl),"function"==typeof $scope.onChange)$scope.onChange()};if("touch"==$type)lPositionRef=event.originalEvent.touches[0];return event.preventDefault(),$document.on($scope.eventMaps[$type].move,lPointerMoveHndl),$document.on($scope.eventMaps[$type].up,lPointerUpHndl)})},$scope.getLowerValue=function(){let lResult=$scope.getP(0);if("function"==typeof $scope.valueFormat)return $scope.valueFormat();else return lResult},$scope.getUpperValue=function(){let lResult=$scope.getP(2);if("function"==typeof $scope.valueFormat)return $scope.valueFormat();else return lResult},$scope.getStep=function(){if(null!=$scope.step)return parseFloat($scope.step);else return 0},$scope.getP=function(i){if(null!=$scope.property)return $scope.model[i][$scope.property];else return $scope.model[i]},$scope.getValue=function($i){return null!=$scope.property?$scope.model[$i][$scope.property]:$scope.model[$i]},$scope.getValuePercent=function($i){const lValue=$scope.getValue($i);return 100*lValue},$scope.setP=function(i,p){const lTolerance=.01,lValue=$scope.model.slice(0,2).reduce(function($result,$cur,$index){if($index<i)$result=Math.max($cur+lTolerance,$result);else if($index>i)$result=Math.min($cur-lTolerance,$result);return $result},p);if(null!=$scope.property)return $scope.model[i][$scope.property]=lValue;else return $scope.model[i]=lValue},$scope.setPs=function($values){$values.forEach(function($v,$i){if(null!=$scope.property)return $scope.model[$i][$scope.property]=$v;else return $scope.model[$i]=$v})},$scope.updatePositions=function(){const lPositions=[];$scope.handles.forEach(function($h,$i){const lHandleRefValue=$scope.getValuePercent($i);lPositions.push(lHandleRefValue),$h.style.left=lHandleRefValue+"%"}),angular.element($scope.rangeHandle).css({left:lPositions[0]+"%",width:lPositions[1]-lPositions[0]+"%"})}}}}]),siApp.directive("siRadio",[function siRadio(){return{retrict:"E",transclude:true,scope:{label:"@",name:"@",value:"@?siValue",model:"=?ngModel",changeHandler:"&?siChange"},link:function($scope){$scope.init()},template:'<div class="any-selector pretty p-icon p-pulse p-round">'+'<input type="radio" name="{{name}}"  title="{{label}}" ng-click="onClick()" ng-checked="checked">'+'<div class="si-input-state">'+'<i class="icon fas fa-circle fa-xs"></i>'+"<label>{{label}}</label>"+"</div>"+"</div>",controller:function($scope,$timeout){$scope.init=function(){$timeout(function(){if(""==$scope.value)$scope.value=null})},$scope.$watch("model",function($new,$old){if(""==$new)$new=null;let lSelected=false;if($scope.value==$new)lSelected=true;$timeout(function(){$scope.checked=lSelected})}),$scope.onClick=function(){$scope.model=$scope.value,$timeout(function(){if("function"==typeof $scope.changeHandler)$scope.changeHandler()})}}}}]),siApp.directive("siSlider",function siSlider($document,$timeout){return{restrict:"E",scope:{model:"=",max:"=siMax",onChange:"&",valueFormat:"&",property:"@",step:"@",startLabel:"@",endLabel:"@"},replace:true,template:'<div class="si-slider"><div class="label start">{{startLabel}}</div><div class="inner"><div class="slider {{boundaryClasses()}}" style="--lower-value:{{getLowerValue()}};--upper-value:{{getUpperValue()}}"></div></div><div class="label end">{{endLabel}}</div></div>',link:function($scope,element,attrs){var getP,handles,rangeHandle,i,j,len,mv,pTotal,ref,setP,step,updatePositions;return element=angular.element(element[0].querySelector(".inner")),handles=[],$scope.init(element),$scope.$watch("model",function(){$scope.updatePositions()},true)},controller:function($scope){$scope.handles=[],$scope.rangeHandle=null,$scope.pTotal=0,$scope.init=function(element){let ref=$scope.model,i,j,len;for($scope.element=element,$scope.rangeHandle=angular.element('<div class="slider-range-handle"></div>'),$scope.rangeHandle.css("position","absolute"),$scope.element.append($scope.rangeHandle),i=j=0,len=ref.length;j<len;i=++j){let handle,startPleft,startPright,startX;if(mv=ref[i],i===$scope.model.length-1)return;handle=angular.element('<div class="slider-handle"></div>'),handle.css("position","absolute"),$scope.handles.push(handle),$scope.element.append(handle),startX=0,startPleft=startPright=0,$scope.pTotal=0,$scope.applyPointerEvent(handle,i,"mouse"),$scope.applyPointerEvent(handle,i,"touch")}},$scope.boundaryClasses=function(){},$scope.applyPointerEvent=function($elm,$elm_index,$type){let lEvents={mouse:{down:"mousedown",move:"mousemove",up:"mouseup"},touch:{down:"touchstart",move:"touchmove",up:"touchend"}},startX=0,startPleft=startPright=0;return $elm.on(lEvents[$type].down,function(event){var lPointerMoveHndl,lPointerUpHndl;if(lPositionRef=event,jQuery(".slider-handle").css("z-index",1),jQuery($elm).css("z-index",2),lPointerMoveHndl=function(event){return $scope.$apply(function(){let lPositionRef=event;if("touch"==$type)lPositionRef=event.originalEvent.touches[0];var lDeltaPosition;if(lDeltaPosition=(lPositionRef.screenX-startX)/$scope.element.prop("clientWidth")*$scope.pTotal,!(lDeltaPosition<-startPleft||lDeltaPosition>startPright))return $scope.setP($elm_index,startPleft+lDeltaPosition),$scope.setP($elm_index+1,startPright-lDeltaPosition),$scope.updatePositions()})},lPointerUpHndl=function(){if($document.unbind(lEvents[$type].move,lPointerMoveHndl),"function"==typeof $scope.onChange)$scope.onChange();return $document.unbind(lEvents[$type].up,lPointerUpHndl)},"touch"==$type)lPositionRef=event.originalEvent.touches[0];return event.preventDefault(),startX=lPositionRef.screenX,startPleft=$scope.getP($elm_index),startPright=$scope.getP($elm_index+1),$document.on(lEvents[$type].move,lPointerMoveHndl),$document.on(lEvents[$type].up,lPointerUpHndl)})},$scope.getLowerValue=function(){let lResult=$scope.getP(0);if("function"==typeof $scope.valueFormat)return $scope.valueFormat();else return lResult},$scope.getUpperValue=function(){let lResult=$scope.getP(2);if("function"==typeof $scope.valueFormat)return $scope.valueFormat();else return lResult},$scope.getStep=function(){if(null!=$scope.step)return parseFloat($scope.step);else return 0},$scope.getP=function(i){if(null!=$scope.property)return $scope.model[i][$scope.property];else return $scope.model[i]},$scope.setP=function(i,p){var s;if(s=$scope.getStep(),s>0)p=Math.round(p/s)*s;if(null!=$scope.property)return $scope.model[i][$scope.property]=p;else return $scope.model[i]=p},$scope.updatePositions=function(){var handle,i,j,len,p,pRunningTotal,results,x,positions=[];for($scope.pTotal=$scope.model.reduce(function(sum,item,i){return sum+$scope.getP(i)},0),pRunningTotal=0,results=[],i=j=0,len=$scope.handles.length;j<len;i=++j)handle=$scope.handles[i],p=$scope.getP(i),pRunningTotal+=p,x=pRunningTotal/$scope.pTotal*100,positions.push(x),results.push(handle.css({left:x+"%"}));return $scope.rangeHandle.css({left:positions[0]+"%",width:positions[1]-positions[0]+"%"}),results}}}}),siApp.directive("siAdaptativeClass",["$parse","$timeout",function($parse,$timeout){return{restrict:"A",scope:true,link:function($scope,$element,$attrs){$scope.$element=$element[0],$timeout(function(){$scope.init()},500)},controller:function($scope,$rootScope){$scope._resizeTimeoutHndl=null,$scope.init=function(){$scope.updateClass(),$scope.addResizeListener()},$scope.addResizeListener=function(){window.addEventListener("resize",function($event){if(null!=$scope._resizeTimeoutHndl)window.clearTimeout($scope._resizeTimeoutHndl);$scope._resizeTimeoutHndl=window.setTimeout(function(){$scope.updateClass()},100)})},$scope.updateClass=function(){const lSizeMap={"si-adapt-small-phone-size":320,"si-adapt-phone-size":640,"si-adapt-tablet-size":800,"si-adapt-laptop-size":1e3};Object.keys(lSizeMap).forEach(function($k){$scope.$element.classList.remove($k)});let lReferenceElement=$scope.$element;if(!lReferenceElement.classList.contains("si-content"))lReferenceElement=lReferenceElement.closest(".si-content");const lElementBox=lReferenceElement.parentNode.getBoundingClientRect();if(0==lElementBox.width)return;const lClass=Object.keys(lSizeMap).filter(function($k){return lSizeMap[$k]<=window.innerWidth}).find(function($k){return lSizeMap[$k]>=lElementBox.width});if(null!=lClass)$scope.$element.classList.add(lClass),$rootScope.$broadcast("container-resize")}}}}]),siApp.directive("onBottomReached",function onBottomReached($document){return{restrict:"A",link:function(scope,element,attrs){const lObservable=angular.element("<span></span>");element.append(lObservable);const raw=element[0];let doc=$document[0];if("undefined"==typeof window.IntersectionObserver)$document.bind("scroll",function(){let lTop=(window.pageYOffset||doc.scrollTop)-(doc.clientTop||0),lBottomLimit=raw.offsetHeight+raw.offsetTop-window.innerHeight/3*2;if(lTop>=lBottomLimit)scope.$apply(attrs.onBottomReached)});else{const lMargin=window.innerHeight>1080?.25*window.innerHeight:window.innerHeight,options={rootMargin:lMargin+"px",threshold:0},observer=new IntersectionObserver(function($entries,$observer){$entries.forEach(function($entry){if($entry.isIntersecting)scope.$apply(attrs.onBottomReached)})},options);observer.observe(lObservable[0])}}}}),siApp.directive("siContainer",function siContainer(){return{restrict:"E",replace:true,transclude:true,scope:true,template:"",controller:function($element,$transclude){$element.append($transclude())}}}),siApp.directive("siDelayedRenderer",["$http","$timeout","$siHooks",function siDelayedRenderer($http,$timeout,$siHooks){return{restrict:"A",link:function($scope,$element,$attrs){$scope.init($element,$attrs)},controller:function($scope){$scope._elm=null,$scope.init=function($element,$attrs){if($scope._elm=$element,$scope.trigger=$attrs.siDelayedRenderer,$scope.content=$element.html(),$element.html(""),isNaN($scope.trigger))$siHooks.addAction($scope.trigger,function(){$scope.render()});else $timeout(function(){$scope.render()},Number($scope.trigger))},$scope.render=function(){const expression=/^(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]+\.[^\s]{2,}|www\.[a-zA-Z0-9]+\.[^\s]{2,})/gi,regex=new RegExp(expression);if(regex.test($scope.content)||0==$scope.content.indexOf("/wp-json/si-rest"))$scope.content=$scope.content.replace(/\&amp;/gi,"&"),$http.get($scope.content).then(function($response){if(200==$response.status)$scope._elm.html(""),$scope._elm.append($response.data)});else $scope._elm.append($scope.content)}}}}]),siApp.directive("includeReplace",function includeReplace(){return{require:"ngInclude",restrict:"A",link:function(scope,el,attrs){el.replaceWith(el.children())}}}),siApp.directive("siImageAutoFit",function siImageAutoFit(){return{restrict:"A",link:function($scope,$element,$attrs){if("IMG"!=$element[0].tagName)return;const lImg=$element[0],lDefaultFit=$attrs.siImageAutoFit||"cover",fnGetOrientation=function($width,$height){return $width>=$height?"landscape":"portrait"};lImg.addEventListener("load",function($event){const lNaturalOrientation=fnGetOrientation(lImg.naturalWidth,lImg.naturalHeight),lComputedOrientation=fnGetOrientation(lImg.width,lImg.height);if(lNaturalOrientation==lComputedOrientation)lImg.style.objectFit=lDefaultFit;else if("landscape"==lNaturalOrientation)lImg.style.objectFit="cover";else lImg.style.objectFit="contain"},{once:true}),lImg.addEventListener("resize",function($event){if(null==document.fullscreenElement);else lImg.style.objectFit="contain"})}}}),siApp.directive("siModal",function siModal(){let dir_controller=function siModalCtrl($scope,$q,$siApi,$rootScope,$siHooks){$scope.modal_element=null,$scope.forms={},$scope.options={close_label:null,ok_label:"OK"},$scope.$on("show-"+$scope.modal_id,function(){$scope.open(),$siHooks.do("si-modal-open")}),$scope.init=function(){if(null==$scope.model)$scope.model={};const lForm=$scope.modal_element.find("form").eq(0);if(null!=lForm)$scope.forms.modalForm=lForm.controller("form");else $scope.forms.modalForm=null},$scope.cancelEvent=function($event){$event.stopPropagation()},$scope.open=function(){$scope.modal_element.addClass("opened"),$scope.$emit("modal-opened")},$scope.close=function(){$scope.modal_element.removeClass("opened"),$scope.$emit("modal-closed")},$scope.closeWithValue=function(){if($scope.forms.modalForm.$valid){if("function"==typeof $scope.onOK)$scope.onOK();$scope.close()}},$scope.$watch("modal_title",function(){if(null!=$scope.amount)$scope.init()}),$scope.$watch("ok_label",function(){if(null!=$scope.ok_label)$scope.options.ok_label=$scope.ok_label}),$scope.$watch("close_label",function(){if(null!=$scope.close_label)$scope.options.close_label=$scope.close_label}),$scope.isFormValid=function(){if(null==$scope.forms.modalForm)return true;else return $scope.forms.modalForm.$valid}};return{restrict:"E",scope:{modal_id:"@modalId",modal_title:"@modalTitle",onOK:"&?onOk",model:"=?ngModel",ok_label:"@?okLabel",cancel_label:"@?cancelLabel",onValidate:"&?onValidate",showControls:"@?showControls"},controllerAs:"modalCtrl",replace:true,transclude:true,templateUrl:siCtx.base_path+"views/ang-templates/si-modal.html?v=3",link:function(scope,element,attr){if(scope.modal_element=element,true!==scope.modal_element_moved)jQuery(element[0]).appendTo(document.body),scope.modal_element_moved=true,scope.init()},controller:dir_controller}}),siApp.directive("siModalTrigger",function siModalTrigger(){return{restrict:"C",scope:{target:"@"},link:function($scope,element,attr){angular.element(element).bind("click",function(){$scope.openModal()})},controller:function($scope,$rootScope){$scope.openModal=function(){$rootScope.$broadcast("show-"+$scope.target)}}}}),siApp.directive("siLazyLoad",["$timeout",function siLazyLoad($timeout){return{restrict:"A",link:function($scope,$element,$attrs){if("undefined"==typeof window.IntersectionObserver)$scope.applyAllImageSource();else{const lMargin=window.innerHeight>1080?.25*window.innerHeight:window.innerHeight,options={rootMargin:lMargin+"px",threshold:0};$scope.observer=new IntersectionObserver(function($entries,$observer){$entries.forEach(function($entry){if($entry.isIntersecting)$scope.applyImageSource($entry.target),$scope.observer.unobserve($entry.target)})},options),$scope.applyObserver()}},controller:function($scope){$scope.$on("si-list-loaded",function(){console.log("list loaded triggered"),$timeout(function(){if(void 0!=$scope.observer)$scope.applyObserver();else $scope.applyAllImageSource()})}),$scope.applyAllImageSource=function(){let lLazyLoadImages=Array.from(document.querySelectorAll(".si-lazy-loading"));console.log("applyAllImageSource",lLazyLoadImages.length),lLazyLoadImages.forEach(function($element){const lImg=$element.querySelector("img");if(null==lImg.getAttribute("src"))$scope.applyImageSource($element)})},$scope.applyImageSource=function($lazyContainerElm){console.log("applyImageSource:triggered");const $imgElm=$lazyContainerElm.querySelector("img");let lImgSource=$imgElm.getAttribute("si-src")||$imgElm.getAttribute("data-si-src");const lImgSourceset=$scope.getSourceSet($imgElm);if($imgElm.getBoundingClientRect().width>1200)lImgSource=lImgSource.replace("-sm.","-lg.");if($imgElm.getBoundingClientRect().width>400)lImgSource=lImgSource.replace("-sm.","-md.");if(void 0!=lImgSource)$imgElm.setAttribute("src",lImgSource);if(void 0!=lImgSourceset)$imgElm.setAttribute("srcset",lImgSourceset)},$scope.applyObserver=function(){let lLazyLoadImages=document.querySelectorAll(".si-lazy-loading");if(void 0==lLazyLoadImages.forEach)lLazyLoadImages=Array.from(lLazyLoadImages);console.log("applyObserver for ",lLazyLoadImages.length,"elements"),lLazyLoadImages.forEach(function($element){const lImg=$element.querySelector("img");if(null==lImg.getAttribute("src"))$scope.observer.observe($element)})},$scope.getSourceSet=function($imgElm){if(!$imgElm.hasAttribute("si-srcset")&&!$imgElm.hasAttribute("data-si-srcset"))return;const lSrcset=$imgElm.getAttribute("si-srcset")||$imgElm.getAttribute("data-si-srcset");if(lSrcset.indexOf("-sm.")<0)return lSrcset;const lOriginalPicture=lSrcset,lPictureSets=[];if($imgElm.getBoundingClientRect().width<400)lPictureSets.push(lOriginalPicture+" 1x");return["md"].forEach(function($size,$index){lPictureSets.push(lOriginalPicture.replace("-sm.","-"+$size+".")+" "+($index+lPictureSets.length+1)+"x")}),lPictureSets.join(", ")}}}}]),siApp.directive("siLoading",[function siLoading(){return{restrict:"E",replace:true,scope:{label:"@siLabel"},template:'<div class="si-loading"><i class="fal fa-spinner fa-spin"></i> {{label.translate()}}</div>',controller:function($scope){}}}]),siApp.directive("lstr",["$parse",function lstr($parse){return{restrict:"E,A",compile:function compile(tElement,tAttrs,transclude){return{pre:function preLink(scope,iElement,iAttrs,controller){let lTranslatedContent=iElement.html().translate(),lFormatParams=iAttrs.params;if(null==lFormatParams&&""!=iAttrs.lstr)lFormatParams=iAttrs.lstr;if(null!=lFormatParams){if(lFnFormatParams=$parse(lFormatParams),lFormatParams=lFnFormatParams(scope),!Array.isArray(lFormatParams))lFormatParams=[lFormatParams];lTranslatedContent=lTranslatedContent.format.apply(lTranslatedContent,lFormatParams)}iElement.html("<span>"+lTranslatedContent+"</span>")}}}}}]),siApp.directive("siTabs",["$q",function siTabs($q){return{restrict:"E",replace:true,transclude:true,template:'<div class="si-tabs" style="--selected-tab:{{selected_tab_index}};--tab-count:{{button_elms.length}}">'+'<div class="si-tab-button-container"></div>'+'<div class="si-tab-content-container">'+'<div class="si-tab-trolley" ng-transclude></div>'+"</div>"+"</div>",link:function($scope,$element,$attrs){$scope.init($element)},controller:function($scope){$scope._element=null,$scope.button_elms=[],$scope.content_elms=[],$scope.selected_tab_index=0,$scope.init=function($element){$scope._element=$element,$scope._button_container=$scope._element.find(".si-tab-button-container"),$scope._content_container=$scope._element.find(".si-tab-content-container"),$scope.button_elms.forEach(function($e,$i){if($i==$scope.selected_tab_index)$e.addClass("active");$scope._button_container.append($e)}),$scope.showTab($scope.selected_tab_index)},$scope.addTabButton=function($tabButtonElement){$scope.button_elms.push($tabButtonElement)},$scope.addTabContent=function($tabContentElement){const lResult=$scope.content_elms.length;return $scope.content_elms.push($tabContentElement),lResult},$scope.showTab=function($tabContentElementIndex){$scope.button_elms.forEach(function($e,$i){if($i==$tabContentElementIndex)$e.addClass("active");else $e.removeClass("active")}),$scope.selected_tab_index=$tabContentElementIndex,$scope.tabContentResize()},$scope.tabContentResize=function(){const lContentElm=$scope.content_elms[$scope.selected_tab_index],lContentHeight=jQuery(lContentElm[0]).height();$scope._content_container.css({height:lContentHeight})}}}}]),siApp.directive("siTab",["$q",function siTab($q){return{restrict:"E",required:"^siTabs",scope:true,link:function($scope,$element,$attr){$scope.init($element)},controller:function($scope){$scope._element=null,$scope._button_elm=null,$scope._content_elm=null,$scope.init=function($element){$scope._element=$element,$scope._button_elm=$element.find(".si-tab-label"),$scope._content_elm=$element.find(".si-tab-content"),$scope.addTabButton($scope._button_elm),$scope._content_elm._si_tab_index=$scope.addTabContent($scope._content_elm)},$scope.tabClick=function(){$scope.showTab($scope._content_elm._si_tab_index)}}}}]),siApp.directive("siTabLabel",function siTabLabel(){return{restrict:"E",required:"^siTab",transclude:true,scope:true,replace:true,template:'<div class="si-tab-label" ng-click="tabClick()"><span ng-transclude></span></div>',link:function($scope,$element,$attrs){$scope._element=$element},controller:function($scope){}}}),siApp.directive("siTabContent",function siTabContent(){return{restrict:"E",required:"^siTab",transclude:true,scope:true,replace:true,template:'<div class="si-tab-content" ng-transclude></div>',link:function($scope,$element,$attrs){$scope.init($element,$attrs.siElement)},controller:function($scope){$scope.init=function($element,$contentQuery){if($scope._element=$element,$scope._element_node=$element[0],void 0!=$contentQuery){const lContent=angular.element($contentQuery);$scope._element.append(lContent)}$scope.$watch("_element_node.offsetHeight",function($a,$b){$scope.tabContentResize()})}}}}),siApp.directive("siList",["$siFavorites","$siConfig","$siList",function siList(){return{restrict:"E",scope:{alias:"@siAlias",class:"@siClass"},controllerAs:"ctrl",template:'<div ng-include="\'si-template-for-\' + alias" class="{{class}}"></div>',link:function($scope){$scope.init()},controller:function($scope,$q,$siApi,$rootScope,$siDictionary,$siUtils,$siFavorites,$siConfig,$siList){$scope.configs=null,$scope.list=null,$scope.page=1,$scope.meta=null,$scope.dictionary={},$scope.auth_token=null,$scope.is_ready=false,$scope.display_mode="list",$scope.page_index=0,$scope.is_loading_data=false,$scope.client={search_token:null},$scope.city_list=[],$scope.region_list=[],$scope.subcategory_list=[],$scope.client_sort=null,$scope.favorites=$siFavorites,$scope.init=function(){$scope.ghost_list=[];for(let $i=0;$i<12;$i++)$scope.ghost_list.push({location:{city:"City",civic_address:"00 address",region:"Region"},price:{sell:{amount:0}},category:"Category",subcategory:"Subcategory",ref_number:"XXXXXX",first_name:"First name",last_name:"Last name",license_type:"License type",listing_count:0,office:{name:"Office"},email:"email@example.com",phones:{mobile:"555-555-5555"},description:"Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident."});$rootScope.$on($scope.alias+"FilterTokenChanged",$scope.onFilterTokenChanged),$scope.$on("si-{0}-display-switch-map".format($scope.alias),function(){$scope.display_mode="map"}),$scope.$on("si-{0}-display-switch-list".format($scope.alias),function(){$scope.display_mode="list"}),$scope.$on("auth_token_refresh",function(){sessionStorage.removeItem("si.list.{0}.{1}".format($scope.configs.type,siCtx.locale)),sessionStorage.removeItem("si.listMeta.{0}.{1}".format($scope.configs.type,siCtx.locale)),sessionStorage.removeItem("si.pageIndex.{0}.{1}".format($scope.configs.type,siCtx.locale))}),$siApi.getListConfigs($scope.alias).then(function($configs){$scope.configs=$configs;let lClientSearchToken=sessionStorage.getItem("si.{0}.st".format($scope.configs.alias));if(void 0!=lClientSearchToken)$scope.client.search_token=lClientSearchToken;$siApi.renewToken().then(function(){$scope.start()})})},$scope.start=function(){$siConfig.get().then(function($global_configs){const lPrerequisites={meta:function(){return $siApi.getViewMeta($scope.configs.type,$scope.configs.source.id)},pages:function(){if(!$global_configs.enable_custom_page)return null;else return $siApi.rest_call("page/list",{locale:siCtx.locale,type:$scope.configs.type},{method:"GET"})},offices:function(){if("brokers"!=$scope.configs.type)return null;else return $siApi.call("office/view/"+$global_configs.default_view+"/fr/items")}};$siUtils.all(lPrerequisites).then(function($responses){$siDictionary.init($responses.meta.dictionary),$scope.dictionary=$responses.meta.dictionary,$siUtils.page_list=$responses.pages||null,$siList.offices=$responses.offices?$responses.offices.items:[],$scope.is_ready=true,$scope.getList()})})},$scope.getList=function(){let lVer=1,lSearchToken=$scope.getSearchToken()
;if(lSearchToken==$scope.configs.search_token&&"undefined"!=typeof $preloadDatas&&"undefined"!=typeof $preloadDatas[$scope.configs.alias]){const lItems=$preloadDatas[$scope.configs.alias].items;if("undefined"==typeof $scope._preloadedList)if("listings"==$scope.configs.type)$scope._preloadedList=$siUtils.compileListingList(lItems);else $scope._preloadedList=$siUtils.compileBrokerList(lItems);return $scope.list=$scope._preloadedList,$scope.ghost_list=[],$scope.listMeta=$preloadDatas[$scope.configs.alias].metadata,$scope.page_index=0,$rootScope.$broadcast("si-list-loaded"),$rootScope.$broadcast("si-"+$scope.configs.type+"-update",$scope.list,$scope.listMeta),$scope.$emit("si-"+$scope.configs.type+"-update",$scope.list,$scope.listMeta),true}$scope.search(lSearchToken)},$scope.getSearchToken=function(){if(null!=$scope.client.search_token)return $scope.client.search_token;else return $scope.configs.search_token},$scope.onFilterTokenChanged=function($event,$newToken){if($newToken==$scope.configs.search_token)$scope.client.search_token=null;else $scope.client.search_token=$newToken;$scope.isReady().then(function(){if($scope.getLatestSearchToken()!=$newToken)sessionStorage.removeItem("si.{0}.latestSearchToken.{1}".format($scope.configs.alias,siCtx.locale)),sessionStorage.removeItem("si.list.{0}.{1}".format($scope.configs.type,siCtx.locale));$scope.getList()})},$scope.isReady=function(){return $q(function($resolve,$reject){if($scope.is_ready)$resolve();else{let lIntervalHnd=null;lIntervalHnd=window.setInterval(function(){if($scope.is_ready)window.clearInterval(lIntervalHnd),$resolve()},500)}})},$scope.setLoadingState=function($is_loading){$scope.is_loading_data=$is_loading;try{$scope.$digest()}catch(error){}},$scope.search=function($token){if(lParams={st:$token},$scope.page_index=0,"list"==$scope.display_mode)if(!$scope.loadListFromStorage($scope.configs.type)){if(false==$scope.is_loading_data)$scope.setLoadingState(true),$siApi.api($scope.getEndpoint()+"/items",lParams,{method:"GET"}).then(function($response){const lSingularType=$siUtils.getSingularType($scope.configs.type,false);if(null!=lSingularType){const lCompileMethod="compile{0}List".format(lSingularType);if("function"==typeof $siUtils[lCompileMethod])$siUtils[lCompileMethod]($response.items)}$scope.list=$response.items,$scope.ghost_list=[],$scope.listMeta=$response.metadata,$scope.setLoadingState(false),$rootScope.$broadcast("si-list-loaded"),$rootScope.$broadcast("si-"+$scope.configs.type+"-update",$scope.list,$scope.listMeta),$scope.$emit("si-"+$scope.configs.type+"-update",$scope.list,$scope.listMeta),$scope.saveListToStorage($scope.configs.type),$scope.saveLatestSearchToken($token)})}else $rootScope.$broadcast("si-list-loaded"),$rootScope.$broadcast("si-"+$scope.configs.type+"-update",$scope.list,$scope.listMeta),$scope.$emit("si-"+$scope.configs.type+"-update",$scope.list,$scope.listMeta)},$scope.checkNextPage=function(){if("list"==$scope.display_mode)if(null!=$scope.listMeta)if($scope.page_index<2&&$scope.listMeta.next_token)$scope.showNextPage()},$scope.showNextPage=function($reset){if($reset="undefined"==typeof $reset?false:$reset,lParams={st:$scope.listMeta.search_token,nt:$scope.listMeta.next_token},!$scope.is_loading_data)$scope.setLoadingState(true),$siApi.api($scope.getEndpoint()+"/items",lParams,{method:"GET"}).then(function($response){let lNewItems=$response.items;if("listings"==$scope.configs.type)lNewItems=$siUtils.compileListingList(lNewItems);else lNewItems=$siUtils.compileBrokerList(lNewItems);if($scope.list=$scope.list.concat(lNewItems),$scope.listMeta=$response.metadata,$scope.page_index++,$rootScope.$broadcast("si-list-loaded"),$scope.$emit("si-"+$scope.configs.type+"-update",$scope.list,$scope.listMeta),window.setTimeout(function(){$scope.setLoadingState(false)},500),$reset)$scope.page_index=0;$scope.saveListToStorage($scope.configs.type)})},$scope.loadListFromStorage=function($type){let lListDate=sessionStorage.getItem("si.list.date.{0}.{1}".format($type,siCtx.locale));if(void 0==lListDate)return false;else{lListDate=new Date(Date.parse(lListDate));let lNow=moment();if(lNow.diff(lListDate,"minutes")>10)return false}let lList=sessionStorage.getItem("si.list.{0}.{1}".format($type,siCtx.locale)),lListMeta=sessionStorage.getItem("si.listMeta.{0}.{1}".format($type,siCtx.locale)),lPageIndex=sessionStorage.getItem("si.pageIndex.{0}.{1}".format($type,siCtx.locale));if(void 0!=lList)return $scope.list=JSON.parse(lList),$scope.listMeta=JSON.parse(lListMeta),$scope.page_index=lPageIndex,$rootScope.$broadcast("si-list-loaded"),true;else return false},$scope.saveListToStorage=function($type){sessionStorage.setItem("si.list.{0}.{1}".format($type,siCtx.locale),JSON.stringify($scope.list)),sessionStorage.setItem("si.listMeta.{0}.{1}".format($type,siCtx.locale),JSON.stringify($scope.listMeta)),sessionStorage.setItem("si.pageIndex.{0}.{1}".format($type,siCtx.locale),$scope.page_index)},$scope.getLatestSearchToken=function(){return sessionStorage.getItem("si.{0}.latestSearchToken.{1}".format($scope.configs.alias,siCtx.locale))},$scope.saveLatestSearchToken=function($token){sessionStorage.setItem("si.{0}.latestSearchToken.{1}".format($scope.configs.alias,siCtx.locale),$token)},$scope.getEndpoint=function(){let lOrigin=$scope.configs.type;switch(lOrigin){case"listings":lOrigin="listing";break;case"brokers":lOrigin="broker";break;case"cities":lOrigin="city";break}return lOrigin.concat("/view/",$scope.configs.source.id,"/",siApiSettings.locale)},$scope.todo=function(){alert("TODO")},$scope.sortByPrice=function($more_to_least){$scope.client_sort="price_"+($more_to_least?"desc":"asc");let lNewSortFields={field:"price",desc:$more_to_least};$rootScope.$broadcast($scope.alias+"SortDataChanged",lNewSortFields)},$scope.sortByDate=function($more_to_least){$scope.client_sort="date_"+($more_to_least?"desc":"asc");let lNewSortFields={field:"contract_start_date",desc:$more_to_least};$rootScope.$broadcast($scope.alias+"SortDataChanged",lNewSortFields)},$scope.sortByName=function($more_to_least){$scope.client_sort="name_"+($more_to_least?"desc":"asc");let lNewSortFields={field:"name",desc:$more_to_least};$rootScope.$broadcast($scope.alias+"SortDataChanged",lNewSortFields)},$scope.sortByListingCount=function($more_to_least){$scope.client_sort="listings_"+($more_to_least?"desc":"asc");let lNewSortFields={field:"listings_count",desc:$more_to_least};$rootScope.$broadcast($scope.alias+"SortDataChanged",lNewSortFields)},$scope.getCaption=function($key,$domain,$asAbbr){return $siDictionary.getCaption($key,$domain,$asAbbr)},$scope.formatPrice=function($item){return $siUtils.formatPrice($item)},$scope.getClassList=function($item){const lClassList=[$siUtils.getClassList($item)];if(null!=$scope.configs)lClassList.push("img-hover-effect-"+$scope.configs.list_item_layout.image_hover_effect);return lClassList.join(" ")},$scope.switchDisplayTo=function($mode){if($scope.display_mode!=$mode)$scope.display_mode=$mode,$rootScope.$broadcast("si-{0}-display-switch-{1}".format($scope.alias,$mode))},$scope.getCity=function($item,$sanitize){return $siUtils.getCity($item,$sanitize)},$scope.getRegion=function($item,$sanitize){return $siUtils.getRegion($item,$sanitize)},$scope.getTransaction=function($item,$sanitize){return $siUtils.getTransaction($item,$sanitize)},$scope.layoutAllowVar=function($item,$layer,$default){if($default=void 0!=$default?$default:"boolean"===typeof $layer?$layer:false,$layer=void 0==$layer?"main":"boolean"===typeof $layer?"main":$layer,null==$scope.configs)return $default;if(void 0==$scope.configs.list_item_layout)return $default;if(void 0==$scope.configs.list_item_layout.displayed_vars)return $default;if(void 0==$scope.configs.list_item_layout.displayed_vars[$layer])return $default;else return $scope.configs.list_item_layout.displayed_vars[$layer].includes($item)}}}}]),siApp.directive("siSmallList",["$sce","$compile","$siFavorites","$siConfig","$siUtils","$siApi","$siFilters","$siDictionary","$q","$siList","$timeout",function siSmallList($sce,$compile,$siFavorites,$siConfig,$siUtils,$siApi,$siFilters,$siDictionary,$q,$siList,$timeout){return{restrict:"E",scope:{type:"@siType",filters:"=siFilters",options:"=?siOptions"},template:'<div class="list-header" ng-show="options.show_header">'+"<h3 ng-cloak>{{getListTitle()}}</h3>"+'<div class="search-input" ng-show="list.length > 10"><input placeholder="Filtrez la liste par mots-cls" ng-model="filter_keywords"><i class="far fa-search"></i></div>'+"</div>"+'<div class="loader"><i class="fal fa-spinner fa-spin"></i></div>'+'<div class="list-container"  si-lazy-load><div ng-include="getItemTemplateInclude()" include-replace ng-repeat="item in list | filter : filter_keywords"></div></div>',link:function($scope,$element,$attrs){$scope.init($element)},controller:function($scope,$rootScope){$scope.view_id=null,$scope.list=[],$scope._element=null,$scope.typesHash={listings:"Listing",brokers:"Broker",offices:"Office",cities:"City"},$scope.$watch("filters",function($new,$old){if(null!=$new)if(null!=$old){if($new.value!=$old.value)$scope.fetchList()}else $scope.fetchList()}),$scope.$watch("filter_keywords",function($new,$old){if($new!=$old)$timeout(function(){$rootScope.$broadcast("si-list-loaded")})}),$scope.getItemTemplateInclude=function(){if(void 0!=$scope.options.item_template)return $scope.options.item_template.replace("~",siCtx.base_path+"/views");else return"si-template-for-"+$scope.type},$scope.init=function($element){$scope._element=$element,$siConfig.get().then(function($configs){$scope.configs=$configs}),$siApi.getDefaultDataView().then(function($view_id){$scope.view_id=$view_id,$scope.fetchList()})},$scope.fetchList=function(){if(null==$scope.filters)return;const lBaseFilter=$scope.getBaseFilter(),lFilters=angular.merge(lBaseFilter,{filter_group:{filters:Array.isArray($scope.filters)?$scope.filters:[$scope.filters]}}),lSingularType=$scope.typesHash[$scope.type];$siFilters.with().getSearchToken(lFilters).then(function($token){$siUtils.all({lexicon:function(){return $siApi.getViewDictionary($scope.view_id,$locales._current_lang_)},offices:function(){if("brokers"!=$scope.type)return null;else return $siApi.call("office/view/"+$scope.view_id+"/fr/items")},list:function(){return $siApi.call($scope.getApiEndpoint($scope.type,$scope.view_id,$locales._current_lang_),{st:$token},{method:"GET"})}}).then(function($results){$siDictionary.init($results.lexicon),$scope.meta=$results.list.metadata,$siList.offices=$results.offices?$results.offices.items:[],$scope.list=$siUtils["compile"+lSingularType+"List"]($results.list.items),$scope._element.addClass("loaded"),$timeout(function(){$rootScope.$broadcast("si-list-loaded",$scope.type,$scope.list)})})})},$scope.getBaseFilter=function(){if(!$scope.options||!$scope.options.filter)return{};const lResult={};if($scope.options.filter.max_item_count>0)lResult.max_item_count=$scope.options.filter.max_item_count;if($scope.options.filter.sort_fields&&$scope.options.filter.sort_fields.length>0)lResult.sort_fields=$scope.options.filter.sort_fields;return lResult},$scope.formatPrice=function($item){return $siUtils.formatPrice($item)},$scope.getListTitle=function(){const lTypeCaptions={listings:{single:"1 property",plural:"{0} properties"},brokers:{single:"1 broker",plural:"{0} brokers"},offices:{single:"1 office",plural:"{0} offices"},cities:{single:"1 city",plural:"{0} cities"}};if(void 0==$scope.meta)return"";if(0==$scope.meta.item_count)return"";if(1==$scope.meta.item_count)return lTypeCaptions[$scope.type].single.translate();if($scope.meta.item_count>1)return lTypeCaptions[$scope.type].plural.translate().format($scope.meta.item_count);else return},$scope.getApiEndpoint=function($type,$view,$lang){const lSingularType=$scope.typesHash[$scope.type].toLowerCase();return"{0}/view/{1}/{2}/items".format(lSingularType,$view,$lang)},$scope.removeFromList=function($event,$item){if($event.preventDefault(),$event.stopPropagation(),"function"==typeof $scope.$parent.removeFromList)$scope.$parent.removeFromList($event,$item)},$scope.hasListOf=function($type){return $scope.configs.lists.some(function($l){return $l.type==$type})}}}}]),siApp.directive("siListSlider",["$compile","$siConfig","$siApi","$siUtils","$siDictionary","$siHooks","$timeout",function siListSlider($compile,$siConfig,$siApi,$siUtils,$siDictionary,$siHooks,$timeout){return{restrict:"E",templateUrl:siCtx.base_path+"views/ang-templates/si-list-slider.html",transclude:true,replace:true,scope:{alias:"@siAlias",options:"=?siOptions"},link:function($scope,$element,$attrs){$scope.init($element)},controller:function($scope,$q){$scope.configs=null,$scope.typesHash={listings:"Listing",brokers:"Broker",offices:"Office",cities:"City"},$scope.init=function($element){$scope._element=$element,$siConfig.get().then(function($configs){$scope.configs=$configs,$scope.fetchList().then(function(){$scope.bindEvents()})})},$scope.fetchList=function(){const lListConfigs=$scope.configs.lists.find(function($l){return $l.alias==$scope.alias}),lSingularType=$scope.typesHash[lListConfigs.type];return $q(function($resolve,$reject){$siUtils.all({lexicon:function(){return $siApi.getViewDictionary(lListConfigs.source.id,$locales._current_lang_)},list:function(){return $siApi.call($scope.getApiEndpoint(lListConfigs.type,lListConfigs.source.id,$locales._current_lang_),{st:lListConfigs.search_token},{method:"GET"})}}).then(function($results){$siDictionary.init($results.lexicon),$scope.meta=$results.list.metadata,$scope.list=$siUtils["compile"+lSingularType+"List"]($results.list.items),$scope.list=$scope.list.filter(function($e,$i){return $i<$scope.options.limit}),$scope.list.forEach(function($e){$scope.postProcessListItem(lListConfigs.type,$e)}),$scope.applyProperties(),$scope._element.addClass("loaded"),$timeout(function(){$resolve()})})})},$scope.applyProperties=function(){const lListConfigs=$scope.configs.lists.find(function($l){return $l.alias==$scope.alias}),lSlideContainer=$scope._element[0].querySelector(".si-slide-container"),lElmBoundingRect=$scope._element[0].getBoundingClientRect();$scope._element[0].style.setProperty("--slider-width",lElmBoundingRect.width+"px"),lSlideContainer.style.setProperty("--list-count",$scope.list.length),lSlideContainer.style.setProperty("--current-index",0),$scope._element.addClass("list-of-"+lListConfigs.type)},$scope.postProcessListItem=function($type,$item){let lTitle;if($item.photo_url=$item.photo_url.replace("-sm.jpg","-lg.jpg"),"listings"==$type)if(lTitle=$item.subcategory,"RESIDENTIAL"==$item.category_code)if(void 0!=$item.rooms.bed&&$item.rooms.bed.count>0)lTitle=1==$item.rooms.bed.count?"1 Bedroom {0}".translate().format($item.subcategory):"{0} Bedrooms {1}".translate().format($item.rooms.bed.count,$item.subcategory);$item.title=$siHooks.filter("si-list-slider-item-title",lTitle,$item)},$scope.getApiEndpoint=function($type,$view,$lang){const lSingularType=$scope.typesHash[$type].toLowerCase();return"{0}/view/{1}/{2}/items".format(lSingularType,$view,$lang)},$scope.getItemTemplateInclude=function(){if(void 0!=$scope.options.item_template)return $scope.options.item_template.replace("~",siCtx.base_path+"/views");else return"si-list-slider-for-"+$scope.alias},$scope.scrollTo=function($index){const lContainer=$scope._element[0].querySelector(".si-slide-container"),lScrollBy=$scope._element[0].getBoundingClientRect().width;lContainer.scrollLeft=$index*lScrollBy},$scope.scroll=function($dir){const lContainer=$scope._element[0].querySelector(".si-slide-container"),lPreviousScrollPos=lContainer.scrollLeft,lScrollBy=$dir*$scope._element[0].getBoundingClientRect().width;if(lContainer.scrollLeft+lScrollBy>=lContainer.scrollWidth)lContainer.scrollLeft=0;else if(lContainer.scrollLeft+lScrollBy<0)lContainer.scrollLeft=lContainer.scrollWidth;else lContainer.scrollLeft=lPreviousScrollPos+lScrollBy},$scope.bindEvents=function(){const lObserverRoot=$scope._element[0],lRootBounds=lObserverRoot.getBoundingClientRect(),lObserverOptions={root:lObserverRoot,rootMargin:"0px -40%",thresholds:1},lSlideObserver=new IntersectionObserver($scope.slideIntersectHandle,lObserverOptions),lSlides=Array.from(lObserverRoot.querySelectorAll(".si-slide"));lSlides.forEach(function($elm){lSlideObserver.observe($elm)}),window.addEventListener("resize",function(){$scope.applyProperties();const lContainer=$scope._element[0].querySelector(".si-slide-container");lContainer.scrollLeft+=1})},$scope.slideIntersectHandle=function($entries,$observer){$entries.forEach(function(entry){$timeout(function(){if(entry.isIntersecting)entry.target.classList.add("in-viewport");else entry.target.classList.remove("in-viewport")},500)})}}}}]),siApp.directive("siCalculator",function siCalculator(){return{restrict:"E",scope:{amount:"=siAmount",dictionary:"=?siDictionary",downpayment_selection:"@?siDownpaymentSelection",region:"@?siRegion",cityCode:"@?siCity",on_change:"&onChange"},controllerAs:"ctrl",replace:true,templateUrl:siCtx.base_path+"views/ang-templates/si-calculator.html?v=2",controller:function($scope,$q,$rootScope){$scope.downpayment_selection="manual",$scope.data={amount:0,amortization:25,downpayment:20,interest:3,frequency:26,downpayment_method:"percent"},$scope.frequencies={12:"Monthly",26:"Every two weeks",52:"Weekly"},$scope.init=function(){$scope.preload(),$scope.data.amount=$scope.amount,$scope.process()},$scope.changeDownpaymentMethod=function(){console.log("changeDownpaymentMethod:triggered"),$scope["convertDownpaymentTo_"+$scope.data.downpayment_method](),$scope.process()},$scope.convertDownpaymentTo_cash=function(){let lResult=0;lResult=Math.round($scope.data.amount*($scope.data.downpayment/100)),$scope.data.downpayment=lResult},$scope.convertDownpaymentTo_percent=function(){let lResult=0;lResult=Math.round(100/($scope.data.amount/$scope.data.downpayment)),$scope.data.downpayment=lResult},$scope.setFrequency=function($value){$scope.data.frequency=$value,$scope.process()},$scope.process=function(){if("manual"==$scope.downpayment_selection)$scope.process_single();else $scope.process_multi();$scope.save()},$scope.process_single=function(){let lBranch={downpayment:0,insurance:0,mortgage:0,amortization:$scope.data.amortization,rate:$scope.data.interest,frequency:$scope.data.frequency,frequency_caption:$scope.frequencies[$scope.data.frequency],payment:0},lRatio="percent"==$scope.data.downpayment_method?$scope.data.downpayment/100:$scope.data.downpayment/$scope.data.amount;$scope.process_branch(lBranch,lRatio);let lResult={mortgage:lBranch,transfer_tax:$scope.getTransferTax($scope.data.amount,"06 "==$scope.region)};if($rootScope.$broadcast("si-mortgage-calculator-result-changed",lResult),"function"==typeof $scope.on_change)$scope.on_change({$result:lResult})},$scope.process_branch=function(branch,downpayment_ratio){branch.downpayment=getDownPayment($scope.data.amount,downpayment_ratio)+1e-6,branch.insurance=getMortgageInsurance($scope.data.amount,downpayment_ratio),branch.mortgage=$scope.data.amount-branch.downpayment+branch.insurance;const PrValue=branch.mortgage,IntRate=branch.rate/100,Period=branch.amortization,PPay=branch.frequency,intcandebase=Math.pow(1+IntRate/2,2/PPay)-1,paymperiobase=PrValue*intcandebase/(1-1/Math.pow(1+intcandebase,Period*PPay));branch.payment=paymperiobase},getDownPayment=function(price,downpayment_ratio){return price*downpayment_ratio},getMortgageInsurance=function(price,downpayment_ratio){return 0;let lResult=price-price*downpayment_ratio;switch(downpayment_ratio){case.05:lResult*=.036;break;case.1:lResult*=.024;break;case.15:lResult*=.018;break;case.2:lResult*=0;break}return lResult},$scope.getTransferTax=function(amount,in_montreal){in_montreal="undefined"==typeof in_montreal?false:in_montreal,parts=[];const lBoundaries=$scope.getTransferTaxBoundaries($scope.cityCode);let rates=lBoundaries.rates,bounds=lBoundaries.bounds,taxemutation=0;for(i=0;i<rates.length;i++){if(amount<=0)continue;const lRemovedAmount=0==i?Math.min(bounds[i],amount):Math.min(bounds[i]-bounds[i-1],amount);taxemutation+=lRemovedAmount*rates[i],amount-=lRemovedAmount}return Math.round(taxemutation)},$scope.getTransferTaxBoundaries=function($cityCode){const defaultBoundaries={code:"default",rates:[.005,.01,.015],bounds:[50900,254400,99e6]};if(void 0==$cityCode)return defaultBoundaries;const citiesBoundaries=[{code:"93042",name:"Alma",bounds:[50900,254400,5e5,99e6],rates:[.005,.01,.015,.03]},{code:"73005",name:"Boisbriand",bounds:[50900,254400,5e5,99e6],rates:[.005,.01,.015,.03]},{code:"59005",name:"Boucherville",bounds:[50900,254400,5e5,99e6],rates:[.005,.01,.015,.02]},{code:"58005",name:"Brossard",bounds:[50900,254400,75e4,1e6,99e6],rates:[.005,.01,.015,.02,.025]},{code:"57005",name:"Chambly",bounds:[50900,254400,5e5,99e6],rates:[.005,.01,.015,.025]},{code:"67050",name:"Chteauguay",bounds:[50900,254400,505200,99e6],rates:[.005,.01,.015,.03]},{code:"49057",name:"Drummondville",bounds:[50900,254400,5e5,99e6],rates:[.005,.01,.015,.025]},{code:["46085","46112"],name:"Farnham",bounds:[50900,254400,5e5,99e6],rates:[.005,.01,.015,.0225]},{code:"66100",name:"Kirkland",bounds:[50900,254400,5e5,1e6,99e6],rates:[.005,.01,.015,.02,.025]},{code:"60028",name:"L'assomption",bounds:[50900,254400,508700,99e6],rates:[.005,.01,.015,.03]},{code:["65101","65102","65103","65104","65105","65106","65107","65108","65109","65110","65111","65112","65113"],name:"Laval",bounds:[50900,254400,5e5,1e6,99e6],rates:[.005,.01,.015,.02,.025]},{code:["25214","25215","25216"],name:"Lvis",bounds:[50900,254400,5e5,99e6],rates:[.005,.01,.015,.03]},{code:["58015","58020","58227"],name:"Longueuil",bounds:[50900,254400,508699,99e6],rates:[.005,.01,.015,.03]},{code:"73025",name:"Lorraine",bounds:[50900,254400,5e5,99e6],rates:[.005,.01,.015,.03]},{code:"64015",name:"Mascouche",bounds:[50900,254400,5e5,99e6],rates:[.005,.01,.015,.03]},{code:"57035",name:"Mont-Saint-Hilaire",bounds:[50900,254400,5e5,99e6],rates:[.005,.01,.015,.03]},{code:["66020","66030","66040","66057","66065","66070","66075","66085","66125","66130","66140","66150","66501","66505","66506","66507","66508","66509","66511","66516"],name:"Montral",bounds:[50900,254400,508700,1017400,99e6],rates:[.005,.01,.015,.02,.025]},{code:"78102",name:"Mont-Tremblant",bounds:[50900,254400,503500,1007e3,99e6],rates:[.005,.01,.015,.02,.025]},{code:"77050",name:"Morin-Heights",bounds:[50900,254400,5e5,99e6],rates:[.005,.01,.015,.025]},{code:["60010","60013"],name:"Repentigny",bounds:[50900,254400,5e5,99e6],rates:[.005,.01,.015,.03]},{code:"10043",name:"Rimouski",bounds:[50900,254400,505100,757700,1010300,99e6],rates:[.005,.01,.015,.02,.025,.03]},{code:"75005",name:"Saint-Colomban",bounds:[50900,254400,5e5,99e6],rates:[.005,.01,.015,.03]},{code:"72005",name:"Saint-Eustache",bounds:[50900,254400,5e5,99e6],rates:[.005,.01,.015,.025]},{code:"56083",name:"Saint-Jean-Sur-Richelieu",bounds:[50900,254400,5e5,99e6],rates:[.005,.01,.015,.03]},{code:"59010",name:"Sainte-Julie",rates:[.005,.01,.015,.025],bounds:[50900,254400,5e5,99e6]},{code:"87120",name:"Saint-Lambert",bounds:[50900,254400,5e5,1e6,99e6],rates:[.005,.01,.015,.02,.025]},{code:"77040",name:"Saint-Sauveur",bounds:[50900,254400,5e5,99e6],rates:[.005,.01,.015,.03]},{code:["43010","43020","43023","43024","43025","43030"],name:"Sherbrooke",bounds:[50900,254400,5e5,99e6],rates:[.005,.01,.015,.03]},{code:"53052",name:"Sorel-Tracy",bounds:[50900,254400,5e5,7e5,9e5,99e6],rates:[.005,.01,.015,.02,.025,.03]},{code:["64005","64008","64020"],name:"Terrebonne",bounds:[50900,254400,5e5,99e6],rates:[.005,.01,.015,.03]},{code:"37067",name:"Trois-Rivires",bounds:[50900,254400,5e5,99e6],rates:[.005,.01,.015,.02]},{code:"78010",name:"Val David",bounds:[50900,254400,5e5,99e6],rates:[.005,.01,.015,.02]}],lBoundedCity=citiesBoundaries.find(function($e){if(Array.isArray($e.code))return $e.code.includes($cityCode.toString());else return $e.code==$cityCode});if(null!=lBoundedCity)return lBoundedCity;else return defaultBoundaries},$scope.preload=function(){let lData=sessionStorage.getItem("si.mortgage-calculator");if(null!=lData)$scope.data=JSON.parse(lData)},$scope.save=function(){sessionStorage.setItem("si.mortgage-calculator",JSON.stringify($scope.data))},$scope.$watch("amount",function(){if(null!=$scope.amount)$scope.init()})}}}),siApp.directive("siFavoritesButton",[function siFavoritesButton(){return{restrict:"E",templateUrl:siCtx.base_path+"views/ang-templates/si-favorites-button.html",replace:true,link:function($scope,$element,$attr){$scope.init($element)},controller:function($scope,$rootScope,$siFavorites,$timeout){$scope.favorites=$siFavorites,$scope._panel_elm=null,$scope._elm=null,$scope._button_elm=null,$scope.init=function($element){$scope._elm=$element[0],$scope._button_elm=$scope._elm.querySelector(".si-favorites-toggle-button");const lPanel=$scope._elm.querySelector(".si-favorites-panel"),lButtonRect=$scope._button_elm.getBoundingClientRect();lPanel.style.setProperty("--origin-y",lButtonRect.top+lButtonRect.height/2+"px"),lPanel.style.setProperty("--origin-x",lButtonRect.left+lButtonRect.width/2+"px"),angular.element(document.body).on("click",function(){$scope.closePanel()})},$scope._favorite_filter=null,$scope.getFavoriteFilter=function(){const lListingsRefNumbers=$siFavorites.getValues();if(null==$scope._favorite_filter||$scope._favorite_filter.value.length!=lListingsRefNumbers.length)$scope._favorite_filter={field:"ref_number",operator:"in",value:lListingsRefNumbers};return $scope._favorite_filter},$scope.togglePanel=function($event){if($event.preventDefault(),null==$scope._panel_elm)$scope._panel_elm=$scope._elm.querySelector(".si-favorites-panel"),angular.element("body").append($scope._panel_elm),angular.element($scope._panel_elm).on("click",function($event){$event.stopPropagation()});if(!$scope._panel_elm.classList.contains("opened"))$event.stopPropagation(),$rootScope.$broadcast("close-everything"),$scope.list=$siFavorites.favorites,$timeout(function(){$scope._panel_elm.classList.add("opened"),$rootScope.$broadcast("si-list-loaded")},100);else $scope.closePanel()},$scope.closePanel=function(){if(null!=$scope._panel_elm)$scope._button_elm.classList.remove("panel-opened"),$scope._panel_elm.classList.remove("opened")},$scope.removeFromList=function($event,$item){console.log("removeFromList"),$event.preventDefault(),$event.stopPropagation(),$siFavorites.toggle($item)}}}}]),siApp.directive("siImageSlider",function siImageSlider(){return{restrict:"E",scope:{pictures:"=siPictures",dictionary:"=?siDictionary",gap:"@siGap",index:"=?siIndex",showGrid:"=siShowPictureGrid"},controllerAs:"ctrl",replace:true,templateUrl:siCtx.base_path+"views/ang-templates/si-image-slider.html?v=4",link:function(scope,element,attrs){scope.$element=element[0];var mc=new Hammer(element[0]);let lPanHndl=null;scope.init()},controller:function($scope,$rootScope,$q,$siApi,$rootScope,$siDictionary,$siHooks,$siUtils,$timeout){$scope.expand_mode=false,$scope.picture_grid_mode=false,$scope.position={current_picture_index:0},$scope.init=function($element){if($scope.index=0,$scope.$on("thumbnails-slider-select",function($event,$picture){const lIndex=$scope.pictures.findIndex(function($e){return $e.url==$picture.url});$scope.set(lIndex,false)}),$scope.pictures);var options={root:document.documentElement},observer=new IntersectionObserver((entries,observer)=>{entries.forEach(entry=>{if(entry.intersectionRatio>0)console.log("ImageSlider is visible"),$scope.detectBoxSize()})},options);observer.observe($scope.$element),$scope.$on("container-resize",function(){console.log("container-resize"),$scope.detectBoxSize()});let lWindowResizeDebounce=null;window.addEventListener("resize",function(){if(null!=lWindowResizeDebounce)window.clearTimeout(lWindowResizeDebounce);lWindowResizeDebounce=window.setTimeout(function(){$scope.detectBoxSize(),lWindowResizeDebounce=null},500)}),document.addEventListener("fullscreenchange",function(){if(null==document.fullscreenElement)$timeout(function(){$scope.expand_mode=false});$scope.detectBoxSize()}),$timeout(function(){$scope.detectBoxSize()})},$scope.next=function(){let lNewIndex=$scope.index+1;if(lNewIndex>=$scope.pictures.length)lNewIndex=0;$scope.set(lNewIndex)},$scope.previous=function(){let lNewIndex=$scope.index-1;if(-1==lNewIndex)lNewIndex=$scope.pictures.length-1;$scope.set(lNewIndex)},$scope.set=function($index,$triggerEvents){$triggerEvents="undefined"==typeof $triggerEvents?true:$triggerEvents,$scope.index=$index;const lViewport=$scope.$element.querySelector(".viewport"),lViewportWidth=lViewport.getBoundingClientRect().width;if(!(window.innerWidth<=640)){if($scope.picture_grid_mode=false,$scope.updateTrolley(),$triggerEvents){const lItem=$scope.pictures[$index];$rootScope.$broadcast("mediabox-picture-select",lItem)}try{$scope.$digest()}catch($e){}}else lViewport.scrollTo($index*lViewportWidth,0)},$scope.toggleExpand=function(){$scope.expand_mode=!$scope.expand_mode},$scope.getPosition=function(){return"-"+100*$scope.position.current_picture_index+"%"},$scope.$watch("pictures",function(){if(null!=$scope.pictures)$scope.init()}),$scope.toggleFullscreen=function(){if(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement){if(document.exitFullscreen)document.exitFullscreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else if(document.webkitExitFullscreen)document.webkitExitFullscreen();else if(document.msExitFullscreen)document.msExitFullscreen();$scope.expand_mode=false,console.log("exit fullscreen")}else{if($scope.$element.requestFullscreen)$scope.$element.requestFullscreen();else if($scope.$element.mozRequestFullScreen)$scope.$element.mozRequestFullScreen();else if($scope.$element.webkitRequestFullscreen)$scope.$element.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);else if($scope.$element.msRequestFullscreen)$scope.$element.msRequestFullscreen();console.log("enter fullscreen"),$scope.expand_mode=true}},$scope.togglePictureGrid=function(){$scope.picture_grid_mode=!$scope.picture_grid_mode},$scope.getImageAlt=function($img){const lCaption=$siDictionary.getCaption({src:$img,key:"category_code"},"photo_category"),lResult=$siHooks.filter("listing-picture-alt",lCaption,$img);return lResult},$scope.getImageCaption=function($img){const lCaption=$siDictionary.getCaption({src:$img,key:"category_code"},"photo_category"),lResult=$siHooks.filter("listing-picture-caption",lCaption,$img);return lResult},$scope.updateTrolley=function(){},$scope.getTrolleyStyle=function(){if(null==$scope.pictures)return{};else return"--item-count:"+$scope.pictures.length+";--item-index:"+$scope.index},$scope.detectBoxSize=function(){const lElm=$scope.$element,lElmRect=lElm.getBoundingClientRect();if(lElm.style.setProperty("--viewport-width",lElmRect.width+"px"),lElm.style.setProperty("--viewport-height",lElmRect.height+"px"),$siUtils.isLegacyBrowser()){const lPictures=Array.from(lElm.querySelectorAll(".viewport .trolley .item"));lPictures.forEach(function($p){$p.style.width=lElmRect.width+"px"})}}}}}),siApp.directive("siImageRotator",["$parse",function siImageRotator($parse){return{restrict:"A",scope:true,link:function($scope,$element,$attrs){const lAttrsPairValues=$attrs.siImageRotator.split(":"),lOptions={ref_number:lAttrsPairValues[0],alias:lAttrsPairValues[1]};$scope.init($element,lOptions)},controller:function($scope,$timeout,$q,$siApi,$siConfig){$scope.rotator_start_timeout_hndl=null,$scope.rotator_stop_timeout_hndl=null,$scope.rotator_interval_hndl=null,$scope.image_list=null,$scope.picture_index=0,$scope.rotator_active=false,$scope.start_delay=750,$scope.init=function($element,$options){$scope.$element=$element[0],$scope.options=$options,$scope.$element.addEventListener("mouseout",function($event){if(null!=$scope.rotator_start_timeout_hndl)window.clearTimeout($scope.rotator_start_timeout_hndl);$scope.stopRotator()}),$scope.$element.addEventListener("mouseover",function($event){
if(null!=$scope.rotator_stop_timeout_hndl)window.clearTimeout($scope.rotator_stop_timeout_hndl);if(!$scope.rotator_active)$scope.rotator_start_timeout_hndl=window.setTimeout(function(){$scope.startRotator()},$scope.start_delay)})},$scope.getPictures=function(){if(null!=$scope.image_list)return $q.resolve($scope.image_list);else return $q(function($resolve,$reject){$siConfig.get().then(function($configs){const lList=$configs.lists.find(function($l){return $l.alias==$scope.options.alias});if(null!=lList)$siApi.call("listing/view/"+lList.source.id+"/fr/items/ref_number/"+$scope.options.ref_number+"/photos/").then(function($response){$scope.image_list=$response,$resolve($response)})})})},$scope.startRotator=function(){$scope.getPictures().then(function($pictures){if(1==$pictures.length)return;let lPictureIndex=0;$scope.rotator_active=true;const lPictureColl=$pictures.slice(1),lShowNext=function(){const lPreviousImage=$scope.$element.querySelector(".image .rotator-picture");$scope.showPicture(lPictureColl[lPictureIndex]).then(function(){if(lPictureIndex=(lPictureIndex+1)%lPictureColl.length,null!=lPreviousImage)$scope.removePicture(lPreviousImage).then(function(){if($scope.rotator_active)lShowNext()});else $timeout(function(){if($scope.rotator_active)lShowNext()},500)})};lShowNext()})},$scope.stopRotator=function(){if(null!=$scope.rotator_stop_timeout_hndl)window.clearTimeout($scope.rotator_stop_timeout_hndl);$scope.rotator_stop_timeout_hndl=window.setTimeout(function(){if($scope.removePictures(),$scope.rotator_active=false,null!=$scope.rotator_interval_hndl)window.clearInterval($scope.rotator_interval_hndl)},250)},$scope.showPicture=function($picture){const lImgElm=document.createElement("IMG");lImgElm.classList.add("rotator-picture"),lImgElm.setAttribute("src",$picture.url);const lImgContainerElm=$scope.$element.querySelector(".image");return lImgContainerElm.append(lImgElm),console.log("rotator:showPicture",lImgContainerElm,lImgElm,$picture),new Promise(function($resolve,$reject){lImgElm.addEventListener("transitionend",function(){console.log("display transition ended"),$resolve()},{once:true}),lImgElm.addEventListener("load",function(){lImgElm.classList.add("show"),console.log("rotator:showPicture:onLoad")})})},$scope.removePicture=function($pictureElm){return new Promise(function($resolve,$reject){if($pictureElm=void 0==$pictureElm?$scope.$element.querySelector(".image .rotator-picture"):$pictureElm,null!=$pictureElm)if($pictureElm.addEventListener("transitionend",function(){console.log("removePicture",$pictureElm),$pictureElm.remove(true),$resolve()},{once:true}),$pictureElm.classList.contains("show"))$pictureElm.classList.remove("show");else $pictureElm.remove(true),$resolve()})},$scope.removePictures=function(){const lPictureElmColl=Array.from($scope.$element.querySelectorAll(".image .rotator-picture"));lPictureElmColl.forEach(function($elm,$i){if($i==lPictureElmColl.length-1)$scope.removePicture($elm);else $elm.remove(true)})}}}}]),siApp.directive("siListingNavigation",["$q",function siListingNavigation(){return{restrict:"E",replace:true,transclude:true,scope:{current:"=siCurrent",display:"@siDisplay",panelTitle:"@?siTitle"},templateUrl:siCtx.base_path+"views/ang-templates/si-listing-navigation.html?v=2",link:function($scope,element,attr){$scope.init()},controller:function($scope,$rootScope){$scope.list=[],$scope.previous=null,$scope.next=null,$scope.init=function(){},$scope.$watch("current",function($new,$old){if(null!=$new)$scope.getNextAndPrevious()}),$scope.loadList=function(){let lList=sessionStorage.getItem("si.list.listings.{0}".format(siCtx.locale));if(void 0!=lList)lList=JSON.parse(lList);else lList=[];return console.log("listingNavigation",lList),lList},$scope.getNextAndPrevious=function(){const lList=$scope.loadList();if(null==lList||0==lList.length)return void($scope.list=null);let lCurrentIndex=lList.findIndex(function($e){return $e.id==$scope.current});const lResult=Array.from(Array(2));if(lCurrentIndex>0)lResult[0]=lList[lCurrentIndex-1];if(lCurrentIndex<lList.length-1)lResult[1]=lList[lCurrentIndex+1];$scope.list=lResult}}}}]),siApp.directive("siMap",function siMap($siTemplate,$siUtils,$siDictionary,$siHooks,$siConfig){const dir_controller=function($scope,$q,$siApi,$rootScope){function SiMarker(options){this.latlng_=options.position,this.markerClass=options.markerClass,this.onClick=options.onPinClick,this.obj=options.obj,this.div_=null,this.title=options.title,this.setMap(options.map)}if($scope.ready=false,$scope.is_visible=false,$scope.zoom=8,$scope.is_loading_data=false,$scope.late_init=true,$scope.markers=[],$scope.markerCluster=null,$scope.bounds=null,$scope.client={search_token:null},$scope.permalink="",$scope.$onInit=function(){if(null!=$scope.latlng)$scope.$on("si-display-map",$scope.display);else $scope.$on("si-{0}-display-switch-map".format($scope.alias),$scope.onSwitchToMap),$scope.$on("si-{0}-display-switch-list".format($scope.alias),$scope.onSwitchToList);$rootScope.$on($scope.alias+"FilterTokenChanged",$scope.onFilterTokenChanged)},$scope.display=function(){$scope.mapInit()},$scope.mapInit=function(){if("undefined"!=typeof google)return $q(function($resolve,$reject){$siConfig.get().then(function($config){if(false==$scope.ready){let options={center:new google.maps.LatLng(45.6025503,-73.8469538),zoom:Number($scope.zoom)};if($config.map_style)try{const lParsedMapStyle=JSON.parse($config.map_style);if(lParsedMapStyle)options.styles=lParsedMapStyle}catch(error){}$scope.map=new google.maps.Map($scope.viewport_element,options),$scope.ready=true,$resolve()}else $resolve()})});else console.error("google map object is undefined")},$scope.setZoom=function($zoom){if(!isNaN($zoom))$scope.map.setZoom($zoom)},$scope.getList=function(){if(false==$scope.is_loading_data)$scope.search($scope.getSearchToken())},$scope.getSearchToken=function(){if(null!=$scope.client.search_token)return $scope.client.search_token;else return $scope.configs.search_token},$scope.onFilterTokenChanged=function($event,$newToken){$scope.client.search_token=$newToken,$scope.isReady().then(function(){$scope.getList()})},$scope.onSwitchToMap=function(){$scope.mapInit().then(function(){if($scope.bounds)window.setTimeout(function(){$scope.map.fitBounds($scope.bounds)},250);if(0==$scope.markers.length)$scope.getList();$scope.is_visible=true})},$scope.onSwitchToList=function(){$scope.is_visible=false},$scope.search=function($token){lParams={st:$token},$scope.page_index=0,$scope.is_loading_data=true,$siApi.api($scope.getEndpoint()+"map_markers",lParams,{method:"GET"}).then(function($response){$scope.list=$response.markers,$scope.updateMarkerList(),$rootScope.$broadcast("si-listings-update",$scope.list,{item_count:$scope.list.length}),$scope.is_loading_data=false})},$scope.getEndpoint=function(){let lOrigin=$scope.getEndpointType();return lOrigin.concat("/view/",$scope.configs.source.id,"/")},$scope.getEndpointType=function(){let lResult=$scope.configs.type;switch(lResult){case"listings":lResult="listing";break;case"brokers":lResult="broker";break;case"cities":lResult="city";break}return lResult},$scope.clear=function(){if($scope.markers)$scope.markers.forEach(function($m){$m.setMap(null)});if(null!=$scope.markerCluster)$scope.markerCluster.clearMarkers();$scope.markers=[]},$scope.addSingleMarker=function($location){$scope.clear(),$scope.markers.push(new google.maps.Marker({map:$scope.map,position:$location,animation:google.maps.Animation.DROP})),$scope.map.setCenter($location)},$scope.updateMarkerList=function(){$scope.clear(),$scope.bounds=new google.maps.LatLngBounds;const lPoints=[];$siConfig.get().then(function($configs){const lListConfig=$configs.lists.find(function($e){return $e.alias==$scope.alias}),lDefaultZoom=lListConfig.default_zoom_level||"auto",lSmartFocusTolerance=lListConfig.smart_focus_tolerance||5;if($scope.list.forEach(function($marker){let lngLat=new google.maps.LatLng($marker.latitude,$marker.longitude);const lMarkerClass=["map-marker-icon",$marker.category_code.replace(" ","_")];if(void 0!=$marker.status_code)lMarkerClass.push($marker.status_code.toLowerCase());$marker.marker=new SiMarker({position:lngLat,map:$scope.map,obj:$marker,markerClass:lMarkerClass,onPinClick:$scope.pinClick}),$scope.markers.push($marker.marker);const lLngLat=$marker.marker.getPosition();lPoints.push({x:lLngLat.lat(),y:lLngLat.lng(),lngLat:lLngLat})}),"off"!=lSmartFocusTolerance){const lXMed=$scope.median(lPoints.map(function($p){return $p.x})),lYMed=$scope.median(lPoints.map(function($p){return $p.y}));let lXAvg=lPoints.reduce(function($sum,$p){return $sum+Math.abs(lXMed-$p.x)},0)/lPoints.length,lYAvg=lPoints.reduce(function($sum,$p){return $sum+Math.abs(lYMed-$p.y)},0)/lPoints.length;if(lSmartFocusTolerance>0){const lLatDegKm=110.574,lLngDegKm=111.32,deg2rad=function($deg){return $deg*Math.PI/180};lXAvg+=lSmartFocusTolerance/lLatDegKm,lYAvg+=lSmartFocusTolerance/lLngDegKm/Math.cos(deg2rad(lYAvg))}const lMedianRect={x:lXMed-lXAvg,x_prime:lXMed+lXAvg,y:lYMed-lYAvg,y_prime:lYMed+lYAvg,contains:function($x,$y){return $x>this.x&&$x<this.x_prime&&$y>this.y&&$y<this.y_prime}};lPoints.filter(function($p){return lMedianRect.contains($p.x,$p.y)}).forEach(function($p){$scope.bounds.extend($p.lngLat)})}else lPoints.forEach(function($p){$scope.bounds.extend($p.lngLat)});if($scope.list.length>1){let lImagePath="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m",lClustererOptions={gridSize:80,styles:[{url:lImagePath+"1.png",height:53,width:54,anchor:[0,0]},{url:lImagePath+"2.png",height:56,width:55,anchor:[0,0]},{url:lImagePath+"3.png",width:66,height:65,anchor:[0,0]}]};if(lClustererOptions=$siHooks.filter("marker_cluster_options",lClustererOptions),$scope.markerCluster=new MarkerClusterer($scope.map,$scope.markers,lClustererOptions),true==$scope.is_visible)window.setTimeout(function(){if($scope.map.fitBounds($scope.bounds),"auto"!=lDefaultZoom)$scope.map.setZoom(Number(lDefaultZoom))},250)}else if($scope.list.length>0)if($scope.map.setCenter($scope.list[0].marker.getPosition()),"auto"!=lDefaultZoom)$scope.map.setZoom(Number(lDefaultZoom));else $scope.map.setZoom(12)})},$scope.median=function(values){values.sort(function(a,b){return a-b});var half=Math.floor(values.length/2);if(values.length%2)return values[half];else return(values[half-1]+values[half])/2},$scope.extendBounds=function($bounds,$lngLat){$bounds.extend($lngLat)},$scope.pinClick=function($marker){$siApi.api($scope.getEndpoint().concat("/",siApiSettings.locale,"/items/",$marker.obj.id)).then(function($response){let lInfoWindowScope=$siUtils;$siDictionary.source=$response.dictionary,lInfoWindowScope.compileListingItem($response),lInfoWindowScope.item=$response,$siTemplate.load("views/ang-templates/si-map-info-window.html?v=2",lInfoWindowScope).then(function($content){let infowindow=new google.maps.InfoWindow({content:$content});infowindow.open($scope.map,$marker)})})},$scope.isReady=function(){let lPromise=$q(function($resolve,$reject){if(true==$scope.ready)$resolve();else $scope.$watch("ready",function(){if(true==$scope.ready)$resolve()})});return lPromise},$scope.$watch("latlng",function(){if(null!=$scope.latlng&&void 0!=$scope.latlng.lat)$scope.isReady().then(function(){$scope.addSingleMarker($scope.latlng)})}),$scope.$watch("zoom",function(){if(null!=$scope.zoom)$scope.isReady().then(function(){$scope.setZoom(Number($scope.zoom))})}),"undefined"!=typeof google)SiMarker.prototype=new google.maps.OverlayView,$proto=SiMarker.prototype,$proto.draw=function(){var me=this,div=this.div_,point=this.getProjection().fromLatLngToDivPixel(this.latlng_);if(point)div.style.left=point.x+"px",div.style.top=point.y+"px"},$proto.onAdd=function(){var me=this;div=this.div_=document.createElement("DIV"),div.style.border="none",div.style.position="absolute",div.style.paddingLeft="0px",div.style.cursor="pointer",this.markerClass.forEach(function($c){div.classList.add($c.toLowerCase())}),google.maps.event.addDomListener(div,"click",function(event){if("function"==typeof me.onClick)me.onClick(me)});var panes=this.getPanes();panes.overlayImage.appendChild(div)},$proto.onRemove=function(){if(null!=this.div_)this.div_.parentNode.removeChild(this.div_),this.div_=null},$proto.hide=function(){if(this.div_)this.div_.style.visibility="hidden"},$proto.show=function(){if(this.div_)this.div_.style.visibility="visible"},$proto.toggle=function(){if(this.div_)if("hidden"===this.div_.style.visibility)this.show();else this.hide()},$proto.getPosition=function(){return this.latlng_},$proto.toggleDOM=function(){if(this.getMap())this.setMap(null);else this.setMap(this.map_)};var $proto};return{restrict:"E",replace:true,scope:{alias:"@siAlias",class:"@class",configs:"=?siConfigs",latlng:"=?latlng",zoom:"@"},controllerAs:"ctrl",template:'<div><div id="map-{{alias}}" class="viewport"></div></div>',controller:dir_controller,link:function($scope,element){$scope.viewport_element=element.children()[0],$scope.$onInit()}}}),siApp.directive("siMediabox",[function siMediabox(){return{restrict:"E",scope:{model:"=siModel",defaultTab:"@siDefaultTab",tabs:"=siTabs",pictureListDisplay:"@siPictureListAs"},link:function($scope,$elm,$attrs){$scope.$element=$elm,$scope.init()},templateUrl:siCtx.base_path+"views/ang-templates/si-mediabox.html?v=2",replace:true,controller:function($scope,$siConfig){$scope.selected_media=$scope.defaultTab||"pictures",$scope.video_player=null,$scope._initialized=false,$scope.init=function(){const cFirstTab=$scope.tabs?$scope.tabs[0]:"pictures";$scope.selectMedia($scope.defaultTab||cFirstTab),$siConfig.get().then(function($configs){$scope._initialized=true,$scope.configs=$configs})},$scope.tabIsAvailable=function($name){if($scope.configs)if(["map","streetview"].includes($name))if(""==$scope.configs.map_api_key)return false;if(!$scope.tabs)return true;else return $scope.tabs.some(function($t){return $t==$name})},$scope.selectMedia=function($media){$scope.selected_media=$media;const lTrigger="si-display-"+$media;if($scope._initialized)$scope.$broadcast(lTrigger);else window.setTimeout(function(){$scope.$broadcast(lTrigger)},1e3);if($scope._initialized&&"video"!=$media)$scope.callPlayer("video-player","stopVideo")},$scope.callPlayer=function(frame_id,func,args){function messageEvent(add,listener){var w3=add?window.addEventListener:window.removeEventListener;w3?w3("message",listener,!1):(add?window.attachEvent:window.detachEvent)("onmessage",listener)}if(window.jQuery&&frame_id instanceof jQuery)frame_id=frame_id.get(0).id;var iframe=document.getElementById(frame_id);if(iframe&&"IFRAME"!=iframe.tagName.toUpperCase())iframe=iframe.getElementsByTagName("iframe")[0];if(!$scope.callPlayer.queue)$scope.callPlayer.queue={};var queue=$scope.callPlayer.queue[frame_id],domReady="complete"==document.readyState;if(domReady&&!iframe){if(window.console&&console.log("$scope.callPlayer: Frame not found; id="+frame_id),queue)clearInterval(queue.poller)}else if("listening"===func){if(iframe&&iframe.contentWindow)func='{"event":"listening","id":'+JSON.stringify(""+frame_id)+"}",iframe.contentWindow.postMessage(func,"*")}else if(!domReady||iframe&&(!iframe.contentWindow||queue&&!queue.ready)||(!queue||!queue.ready)&&"function"===typeof func){if(!queue)queue=$scope.callPlayer.queue[frame_id]=[];if(queue.push([func,args]),!("poller"in queue))queue.poller=setInterval(function(){$scope.callPlayer(frame_id,"listening")},250),messageEvent(1,function runOnceReady(e){if(!iframe){if(iframe=document.getElementById(frame_id),!iframe)return;if("IFRAME"!=iframe.tagName.toUpperCase())if(iframe=iframe.getElementsByTagName("iframe")[0],!iframe)return}if(e.source===iframe.contentWindow){clearInterval(queue.poller),queue.ready=true,messageEvent(0,runOnceReady);while(tmp=queue.shift())$scope.callPlayer(frame_id,tmp[0],tmp[1])}},false)}else if(iframe&&iframe.contentWindow){if(func.call)return func();iframe.contentWindow.postMessage(JSON.stringify({event:"command",func:func,args:args||[],id:frame_id}),"*")}}}}}]),siApp.directive("siStreetview",function siStreetView($siTemplate,$siUtils,$siDictionary){let dir_controller=function($scope,$q,$siApi,$rootScope){$scope.ready=false,$scope.is_visible=false,$scope.positioned=false,$scope.zoom=14,$scope.is_loading_data=false,$scope.late_init=true,$scope.markers=[],$scope.markerCluster=null,$scope.bounds=null,$scope.client={search_token:null},$scope.permalink="",$scope.$onInit=function(){$scope.$on("si-display-streetview",$scope.display)},$scope.mapInit=function(){return $q(function($resolve,$reject){if(false==$scope.ready){let options={center:new google.maps.LatLng(45.6025503,-73.8469538),zoom:$scope.zoom};$scope.map=new google.maps.Map($scope.map_element,options),$scope.ready=true,$resolve()}else $resolve()})},$scope.display=function(){if("undefined"!=typeof google)if(null!=$scope.latlng)$scope.mapInit().then(function(){$scope.setView($scope.latlng)});else $scope.registerWatch();else console.error("google map object is undefined")},$scope.setView=function($position){if(true==$scope.positioned)return;let lPosition=new google.maps.LatLng($position.lat,$position.lng);$scope.panorama=new google.maps.StreetViewPanorama($scope.viewport_element,{position:lPosition,pov:{heading:34,pitch:10}}),$scope.map.setStreetView($scope.panorama),$scope.positioned=true},$scope.isReady=function(){let lPromise=$q(function($resolve,$reject){if(true==$scope.ready)$resolve();else $scope.$watch("ready",function(){if(true==$scope.ready)$resolve()})});return lPromise},$scope.registerWatch=function(){$scope.$watch("latlng",function(){if(null!=$scope.latlng&&void 0!=$scope.latlng.lat)$scope.display()})}};return{restrict:"E",replace:true,scope:{alias:"@siAlias",class:"@class",configs:"=?siConfigs",latlng:"=?latlng",zoom:"@"},controllerAs:"ctrl",template:'<div><div id="map-{{alias}}" class="map-viewport"></div><div id="pano-{{alias}}" class="viewport"></div></div>',controller:dir_controller,link:function($scope,element){$scope.map_element=element.children()[0],$scope.viewport_element=element.children()[1],$scope.$onInit()}}}),siApp.directive("siThumbnailsSlider",["$timeout",function siThumbnailsSlider($timeout){return{restrict:"E",templateUrl:siCtx.base_path+"views/ang-templates/si-thumbnails-slider.html",replace:true,scope:{list:"=siList"},link:function($scope,$element,$attr){$scope.init($element)},controller:function($scope,$rootScope){$scope.selectedIndex=0,$scope.trolleyOffset=0,$scope._element=null,$scope.init=function($element){$scope._element=$element,$scope.$on("mediabox-picture-next",function(){$scope.next()}),$scope.$on("mediabox-picture-next",function(){$scope.previous()}),$scope.$on("mediabox-picture-select",function($event,$picture){$scope.select($picture),$scope.trolleyOffset=$scope.getTrolleyIndexFromSelection($scope.selectedIndex)})},$scope.next=function(){let lOffsetValue=$scope.trolleyOffset+1;const lCompsWidth=$scope.getComponentsWidth(),controlWidth=lCompsWidth.controlWidth,pictureWidth=lCompsWidth.pictureWidth;if(!$scope.hasViewablePicture(lOffsetValue,$scope.list.length,controlWidth,pictureWidth))lOffsetValue=$scope.trolleyOffset;$scope.trolleyOffset=lOffsetValue},$scope.previous=function(){let lOffsetValue=$scope.trolleyOffset>0?$scope.trolleyOffset-1:0;$scope.trolleyOffset=lOffsetValue},$scope.hasViewablePicture=function($trolleyOffset,$pictureCount,$controlWidth,$pictureWidth){if($controlWidth<$pictureWidth)return false;if(0==$pictureCount)return false;if(0==$trolleyOffset)return true;const lPicturePerPage=Math.floor($controlWidth/$pictureWidth),lCurrentPictureIndex=$trolleyOffset*lPicturePerPage;if(lCurrentPictureIndex>$pictureCount)return false;else return true},$scope.getTrolleyOffset=function(){if(0==$scope.trolleyOffset)return 0;let lResult=0;const lCompsWidth=$scope.getComponentsWidth(),controlWidth=lCompsWidth.controlWidth,pictureWidth=lCompsWidth.pictureWidth,lPicturePerPage=Math.floor(controlWidth/pictureWidth),indexOfFirstPicture=$scope.trolleyOffset*lPicturePerPage;return lResult=-1*indexOfFirstPicture*pictureWidth,lResult.toString()+"px"},$scope.getTrolleyIndexFromSelection=function($selectedIndex){if(0==$selectedIndex)return 0;const lCompsWidth=$scope.getComponentsWidth(),controlWidth=lCompsWidth.controlWidth,pictureWidth=lCompsWidth.pictureWidth,lPicturePerPage=Math.floor(controlWidth/pictureWidth);if($selectedIndex+1<=lPicturePerPage)return 0;else return Math.floor($selectedIndex/lPicturePerPage)},$scope.getComponentsWidth=function(){const ljqElement=jQuery($scope._element);return{controlWidth:ljqElement.width(),pictureWidth:ljqElement.find(".item").eq(0).outerWidth()}},$scope.select=function($picture,$triggerEvents){if($triggerEvents="undefined"==typeof $triggerEvents?true:$triggerEvents,$scope.selectedIndex=$scope.list.findIndex(function($e){return $e.url==$picture.url}),$triggerEvents)$rootScope.$broadcast("thumbnails-slider-select",$scope.list[$scope.selectedIndex])},$scope.getImageAlt=function($img){const lCaption=$siDictionary.getCaption({src:$img,key:"category_code"},"photo_category"),lResult=$siHooks.filter("listing-picture-alt",lCaption,$img);return lResult},$scope.getImageCaption=function($img){const lCaption=$siDictionary.getCaption({src:$img,key:"category_code"},"photo_category"),lResult=$siHooks.filter("listing-picture-caption",lCaption,$img);return lResult}}}}]),siApp.factory("$siSearchContext",[function $siSearchContext(){const $scope={};let lToday=(new Date).round(),lNow=new Date;return $scope.main_filters={listings:{RES:{field:"market_codes",operator:"array_contains",value:"RES",type:"market"},COM:{field:"market_codes",operator:"array_contains",value:"COM",type:"market"},"for-sale":{field:"for_sale_flag",operator:"equal",value:true,type:"flag"},"for-rent":{field:"for_rent_flag",operator:"equal",value:true,type:"flag"}}},$scope.listing_states=[{key:"sale",caption:"For sale".translate(),filter:{field:"for_sale_flag",operator:"equal",value:true}},{key:"rent",caption:"For rent".translate(),filter:{field:"for_rent_flag",operator:"equal",value:true}}],$scope.listing_flags={sold:{caption:"Sold",filter:{field:"status_code",operator:"not_equal_to",value:"AVAILABLE"}},available:{caption:"On the market",filter:{field:"status_code",operator:"equal",value:"AVAILABLE"}},open_house:{caption:"Open house",filter:{field:"open_houses[0].end_date",operator:"greater_or_equal_to",value:"udf.now()"}},forclosure:{caption:"Foreclosure",filter:{field:"price.foreclosure",operator:"equal",value:true}},virtual_tour:{caption:"With virtual tour",filter:{field:"virtual_tour_flag",operator:"equal",value:true}},video:{caption:"With video",filter:{field:"video_flag",operator:"equal",value:true}}},$scope.listing_ages=[{key:"24h",caption:"24 hours".translate(),filter:{field:"contract.start_date",operator:"greater_than",value:lNow.addDays(-1).toJSON()}},{key:"48h",caption:"48 hours".translate(),filter:{field:"contract.start_date",operator:"greater_than",value:lNow.addDays(-2).toJSON()}},{key:"7d",caption:"7 days".translate(),filter:{field:"contract.start_date",operator:"greater_than",value:lToday.addDays(-7).toJSON()}},{key:"2w",caption:"2 weeks".translate(),filter:{field:"contract.start_date",operator:"greater_than",value:lToday.addDays(-14).toJSON()}},{key:"1m",caption:"1 month".translate(),filter:{field:"contract.start_date",operator:"greater_than",value:lToday.addMonths(-1).toJSON()}},{key:"3m",caption:"3 months".translate(),filter:{field:"contract.start_date",operator:"greater_than",value:lToday.addMonths(-3).toJSON()}},{key:"6m",caption:"6 months".translate(),filter:{field:"contract.start_date",operator:"greater_than",value:lToday.addMonths(-6).toJSON()}},{key:"1y",caption:"1 year".translate(),filter:{field:"contract.start_date",operator:"greater_than",value:lToday.addYears(-1).toJSON()}},{key:"",caption:"More than a year".translate(),filter:{field:"contract.start_date",operator:"greater_than",value:""}}],$scope.land_areas=Array.from(Array(3)).map(function($e,$i){return{caption:"{0} sqft".translate().format(5e3*($i+1)),value:5e3*($i+1)}}),$scope.land_areas=$scope.land_areas.concat(Array.from(Array(10)).map(function($e,$i){return{caption:"{0} sqft".translate().format(2e4*($i+1)),value:2e4*($i+1)}})),$scope.available_areas=Array.from(Array(13)).map(function($e,$i){return{caption:"{0} sqft".translate().format(500*($i+1)),value:500*($i+1)}}),$scope.listing_attributes={pool:{caption:"Pool",field:"attributes.POOL"},fireplace:{caption:"Fireplace",field:"attributes.HEART_STOVE"},elevator:{caption:"Elevator",field:"attributes.ELEVATOR"},garage:{caption:"Garage",field:"attributes.GARAGE"},waterfront:{caption:"Water front",field:"attributes.WATER_FRONT"},panoramicview:{caption:"Panoramic view",field:"attributes.PANORAMIC_VIEW"}},$scope.extendTo=function($target){Object.keys($scope).forEach(function($att){$target[$att]=$scope[$att]})},$scope}]),siApp.directive("siSearch",["$siList",function siSearch($siList){return{restrict:"E",replace:true,scope:{alias:"@siAlias",class:"@class",configs:"=?siConfigs",dictionary:"=?siDictionary",result_url:"@siResultUrl",standalone:"@siStandalone"},controllerAs:"ctrl",template:"<div><div ng-include=\"'si-search-for-' + alias\"></div></div>",link:function($scope,$element,$attrs){console.log("siSearch standalone",$scope.standalone,typeof $scope.standalone),$scope.standalone="string"==typeof $scope.standalone?"true"==$scope.standalone:$scope.standalone,console.log("siSearch standalone",$scope.standalone,typeof $scope.standalone),console.log("Search box element",$element[0]),$scope.init($element)},controller:function($scope,$q,$siApi,$rootScope,$timeout,$siDictionary,$siUtils,$siFilters,$siHooks,$siFavorites,$siSearchContext){$scope.siDictionary=$siDictionary,$scope.PRICE_RANGE_MAX=1e6,$scope.PRICE_RANGE_PRECISION=1e3,$scope.PRICE_RANGE_FORMAT="{0}",$scope.tabCursor=null,$scope.is_ready=false,$scope.tab_category=null,$scope.tab_region="",$scope.regions=[],$scope.geolocation_available=void 0!=navigator.geolocation&&"https:"==window.location.protocol,$scope.sort_fields=[],$scope.selected_price_input="min",$scope.keyword="",$scope.priceSuggestions=[],$scope.bedroomSuggestions=[],$scope.bathroomSuggestions=[],$scope.parkingSuggestions=[],$scope.garageSuggestions=[],$scope.filterHints=[],$scope.suggestions=[],$scope.query_text=null,$scope.alphaList="abcdefghijklmnopqrstuvwxyz".split(""),$scope.officeList=[],$scope.priceBoundaries={min:0,max:1e6},$scope.filter=null,$scope.data={keyword:"",min_price:null,max_price:null,location:null,transaction_type:null},$scope.priceRange=[0,1,0],$scope.filter_group={operator:"and",filters:null,filter_groups:null},$siSearchContext.extendTo($scope),$scope.init=function($element){$scope._element=$element[0];const lFilterPanelContainer=angular.element('<div class="si si-filter-panel-container"></div>');if(angular.element(document.body).append(lFilterPanelContainer),$scope.filterPanelContainer=lFilterPanelContainer,lFilterPanelContainer.on("click",function($event){$event.stopPropagation()}),$element.on("click",function($event){$event.stopPropagation()}),$scope._element.addEventListener("mouseover",function($event){$scope.updateExpandPanelPosition(true),$scope.extractFilterPanels()},true),$rootScope.$on($scope.alias+"SortDataChanged",$scope.onSortDataChanged),$scope.standalone)$scope._element.classList.add("show-trigger");$scope.buildDropdownSuggestions(),$scope.isReady().then(function(){console.log("Ready, carry on");const lSearchEngineOptions=Object.assign({type:"full",orientation:"h",focus_category:null},$scope.configs.search_engine_options);if($scope._element.classList.add("layout-"+lSearchEngineOptions.type),$scope._element.classList.add("orientation-"+lSearchEngineOptions.orientation),void 0!=lSearchEngineOptions.tabs&&lSearchEngineOptions.tabs.length>0)$scope._element.classList.add("si-has-tabs");const lListElement=$scope._element.closest(".si-list-of-"+$scope.configs.type);if(null!=lListElement)lListElement.classList.add("search-orientation-"+lSearchEngineOptions.orientation);if($scope._element._rect=$scope._element.getBoundingClientRect(),$scope._element._computedStyle=window.getComputedStyle($scope._element),true===lSearchEngineOptions.sticky){const lAnchorElement=document.createElement("DIV");lAnchorElement.classList.add("sticky-anchor"),$scope._element.parentNode.prepend(lAnchorElement);var options={rootMargin:"0px",threshold:1};const observer=new IntersectionObserver(function(entries,observer){entries.forEach(entry=>{if(console.log(entry.isIntersecting),entry.isIntersecting)$scope._element.classList.remove("stick");else $scope._element.classList.add("stick")})},options);observer.observe(lAnchorElement)}let lfSyncFilter=function($filter){if($filter.hasFilters())$scope.syncFiltersToUI($filter)};$siFilters.with($scope.alias,$scope,function($filter){if($scope.filter=$filter,!$scope.standalone)$filter.result_url=$scope.result_url;$filter.loadState(),$scope.applyDefaultMainFilter(),$scope.$watch(function(){return $scope.filter.data},function($new,$old){if($new.min_price!=$old.min_price||$new.max_price!=$old.max_price)if(0==$new.min_price&&null==$new.max_price)$scope.resetPriceRange()},true),$filter.on("update").then(function(){console.log("filter",$scope.alias,"update trigger"),lfSyncFilter($filter),$timeout(function(){$scope.updateExpandPanelPosition(true)})}),$filter.on("filterTokenChanged").then(function($token){lfSyncFilter($filter),$rootScope.$broadcast($scope.alias+"FilterTokenChanged",$token),$timeout(function(){$scope.updateExpandPanelPosition(true)})})}),angular.element(document.body).on("click",function($event){$scope.closePanels()}),window._resizeTimeoutHndl=null,window.addEventListener("scroll",function(){const lContainer=$scope.filterPanelContainer[0];delete lContainer._relative_style}),window.addEventListener("resize",function(){if(null!=window._resizeTimeoutHndl)window.clearTimeout(window._resizeTimeoutHndl);window._resizeTimeoutHndl=window.setTimeout(function(){$scope._element._rect=$scope._element.getBoundingClientRect(),$scope.updateExpandPanelPosition(true)},500)}),$scope.$on("close-everything",function(){$scope.closePanels()}),$scope.$broadcast("search-is-ready");let lStoredSearchToken=$scope.filter.loadState("st");if(lStoredSearchToken&&$scope.configs.search_token!=lStoredSearchToken);}),$scope.$on("si-searchbox-focus",function(){$scope._element.classList.add("searchbox-has-focus")}),$scope.$on("si-searchbox-blur",function(){$scope._element.classList.remove("searchbox-has-focus")}),$scope.$on("si-searchbox-add-filter",function($event,$item){const lTypeMap={city:"cities",region:"regions"},lDataProp=lTypeMap[$item.type];$timeout(function(){if($scope.filter.data[lDataProp].push($item.ref_number),"region"==$item.type)$scope.filter.sublistClearFilters($item.ref_number,$scope.city_list,$scope.filter.data.cities);if($scope.filter.update(),console.log("si-searchbox-add-filter:triggered",lDataProp,$scope.filter.data),$scope.standalone)$scope.showResultPage()})})},$scope.isReady=function(){if(null!=$scope.dictionary&&null!=$scope.configs)return $scope.is_ready=true,$q.resolve();let lPromise=$q(function($resolve,$reject){if(false==$scope.is_ready){const lFilter=$siFilters.with($scope.alias,$scope);$scope.getConfigs().then(function($configs){$scope.configs=$configs,lFilter.configs=$configs,console.log("Loading view meta"),$siUtils.all({meta:function(){return $siApi.getViewMeta($configs.type,$configs.source.id)},offices:function(){if("brokers"!=$configs.type)return $q.resolve();else return $siApi.call("office/view/"+$configs.source.id+"/fr/items")}}).then(function($results){$scope.dictionary=$results.meta.dictionary,$scope.officeList=$results.offices?$results.offices.items:[],$scope.is_ready=true,console.log("View meta loaded"),$resolve()})})}else $resolve()});return lPromise},$scope.showResultPage=function(){window.location=$scope.result_url},$scope.selectMainFilter=function($tab){if(console.log("selectMainFilter",$scope.current_main_filter,$tab),void 0!=$tab){if($scope.current_main_filter!=$tab){
if(["for-sale","for-rent"].includes($tab)){if("for-sale"==$tab)$scope.PRICE_RANGE_MAX=1e6,$scope.PRICE_RANGE_PRECISION=1e3,$scope.PRICE_RANGE_FORMAT="{0}";if("for-rent"==$tab)$scope.PRICE_RANGE_MAX=1e4,$scope.PRICE_RANGE_PRECISION=100,$scope.PRICE_RANGE_FORMAT="{0}/month";$scope.updatePrice()}$scope.filter.setMainFilter($scope.configs.type,$tab),$scope.filter.update(),$scope.current_main_filter=$tab,$scope.buildDropdownSuggestions(),$timeout(function(){$scope.alignPanelTabCursor()}),sessionStorage.setItem("si.currentMainFilter",$scope.current_main_filter)}}else $scope.current_main_filter=null},$scope.isMainFiltered=function($values){const lMainFilter=void 0==$scope.current_main_filter?null:$scope.current_main_filter;if(Array.isArray($values))return $values.includes(lMainFilter);else return $values==lMainFilter},$scope.mainSubCategoryMatchFilter=function($item){const $category_code=$item.parent;if(void 0==$scope.current_main_filter)return true;if(void 0==$scope.configs)return false;const lFilter=$scope.main_filters[$scope.configs.type][$scope.current_main_filter];if("category"!=lFilter.type)return true;else return lFilter.value.includes($category_code)},$scope.isFieldFiltered=function($field){if(isNullOrEmpty($scope.configs))return false;if(isNullOrEmpty($scope.configs.search_engine_options.fields))return true;else return $scope.configs.search_engine_options.fields.includes($field)},$scope.closePanels=function(){if($timeout(function(){$scope._expandedPanel=null}),null!=$scope.filterPanelContainer)if($scope._element.classList.remove("expanded"),$scope.filterPanelContainer.removeClass("expanded"),null!=$scope.tabCursor)$scope.tabCursor.style.display="none"},$scope._expandedPanel=null,$scope.toggleExpand=function($event,$key){$scope.extractFilterPanels($key).then(function(){if($scope._expandedPanel=$scope._expandedPanel==$key?null:$key,$scope._expandedPanel)$scope._element.classList.add("expanded"),$scope.filterPanelContainer.addClass("expanded"),$scope.ensureClickTrap(),$scope.ensureTabCursor();else if($scope._element.classList.remove("expanded"),$scope.filterPanelContainer.removeClass("expanded"),null!=$scope.tabCursor)$scope.tabCursor.style.display="none"})},$scope.applyPanelFilters=function($event,$key){if($scope.standalone)$scope.showResultPage();else $scope.toggleExpand($event,$key)},$scope.extractFilterPanels=function($key){return $q(function($resolve,$reject){const lContainer=$scope.filterPanelContainer[0];if(0==lContainer.querySelectorAll(".filter-panel").length)$scope._element.querySelectorAll(".filter-panel").forEach(function($e,$i){lContainer.appendChild($e)});$resolve()})},$scope.updateExpandPanelPosition=function($force){if($force=void 0==$force?false:$force,null==$scope._element)return;const lContainer=$scope.filterPanelContainer[0];if($force||void 0==lContainer._relative_style){$scope._element._rect=$scope._element.getBoundingClientRect();const lElmRect=$scope._element._rect,lCompStyle=$scope._element._computedStyle,lBorderWidth=lCompStyle.borderWidth,lTop=$scope.getElementOffset($scope._element,"offsetTop"),lLeft=$scope.getElementOffset($scope._element,"offsetLeft");lContainer.style.setProperty("--relative-top",Math.round(lTop)+"px"),lContainer.style.setProperty("--relative-left",lLeft+"px"),lContainer.style.setProperty("--relative-width",lElmRect.width+"px"),lContainer.style.setProperty("--relative-height",lElmRect.height+"px"),lContainer.style.setProperty("--relative-border-size",lBorderWidth),lContainer._relative_style=true}},$scope.getElementOffset=function($elm,$metric){let offsetValue=0;do{if(!isNaN($elm[$metric]))offsetValue+=$elm[$metric]}while($elm=$elm.offsetParent);if("offsetTop"==$metric&&null!=document.querySelector("#wpadminbar")){const lBodyStyles=window.getComputedStyle(document.body);if(console.log("body position",lBodyStyles.position),!["absolute","relative"].includes(lBodyStyles.position)){const lAdminBarHeight=document.querySelector("#wpadminbar").offsetHeight;offsetValue+=lAdminBarHeight}}return offsetValue},$scope.ensureClickTrap=function(){const lClickTrap=document.body;return lClickTrap.addEventListener("click",function($event){$scope.closePanels()},{once:true}),lClickTrap},$scope.ensureTabCursor=function(){if(null==$scope.tabCursor){const lCursor=document.createElement("DIV");lCursor.classList.add("si-tab-cursor"),document.body.appendChild(lCursor),$scope.tabCursor=lCursor}$scope.alignPanelTabCursor()},$scope.isExpanded=function($key){if($scope._expandedPanel==$key)return"expanded";else return""},$scope.expandSublist=function($list,$item,$itemKey){const lItemKey=$itemKey||$item.__$obj_key;if(!Array.isArray($list))console.log(angular.copy($list)),$list=$siUtils.toArray($list),console.log($list);$list.forEach(function($e){if($e.__$obj_key!=lItemKey)delete $e.expanded}),$item.expanded=void 0!=$item.expanded?!$item.expanded:true},$scope.alignPanelTabCursor=function(){if(null==$scope.tabCursor)return;const lTab=$scope._element.querySelector(".main-filter-tabs .si-tab.active"),lCursor=$scope.tabCursor;if(null==lTab)return void(lCursor.style.display="none");console.log("alignPanelTabCursor");const lTabRect=lTab.getBoundingClientRect(),lRef={left:$scope.getElementOffset(lTab,"offsetLeft"),top:$scope.getElementOffset(lTab,"offsetTop"),width:lTabRect.width};lCursor.setAttribute("style",Object.keys(lRef).map(function($k){return"--ref-"+$k+":"+lRef[$k]+"px"}).join(";")),lCursor.style.display="block"},$scope.getCategoryIcon=function($key){return lIconset={RESIDENTIAL:"home",IND:"industry-alt",COM:"shopping-bag",FARM:"paw",LOT:"tree-alt","MULTI-FAMILY":"building","REVENUE PROP":"usd-square"},lIconset[$key]},$scope.changeCategoryTab=function($key){$scope.tab_category=$key},$scope.changeRegionTab=function($key){$scope.region_list.forEach(function($r){if($r.__$obj_key!=$key)delete $r.selected}),$scope.tab_region=$key},$scope.buildDropdownSuggestions=function(){const fnGetSuggestion=function($i,$labelFormat,$singleLabelFormat){return $singleLabelFormat=void 0==$singleLabelFormat?$labelFormat:$singleLabelFormat,{value:$i,label:(1==$i?$singleLabelFormat:$labelFormat).translate().format($i),caption:(1==$i?$singleLabelFormat:$labelFormat).translate().format($i)}};$scope.bedroomSuggestions=Array.from(new Array(5)).map(function($e,$i){return fnGetSuggestion($i+1,"{0}+ bedrooms")}),$scope.bathroomSuggestions=Array.from(new Array(5)).map(function($e,$i){return fnGetSuggestion($i+1,"{0}+ bathrooms")}),$scope.garageSuggestions=Array.from(new Array(5)).map(function($e,$i){return fnGetSuggestion($i+1,"{0}+ garages")});const lParkingMul="COM"==$scope.current_main_filter?5:1;$scope.parkingSuggestions=Array.from(new Array(5)).map(function($e,$i){return fnGetSuggestion(($i+1)*lParkingMul,"{0} spaces or +","1 space or +")})},$scope.buildSuggestions=function($event){let lResult=[];if($scope.trapKeyCode($event.keyCode))return false;if(""!=$scope.data.keyword)if(!isNaN($scope.data.keyword)){let lValue=Number($scope.data.keyword),lPriceMin=Math.max(0,lValue/2),lPriceMax=Math.min(1e6,2*lValue);if(lResult=[{selected:true,label:'Contains "{0}"'.translate().format(lValue),action:function(){$scope.query_text=lValue,$scope.buildFilters(),$scope.saveState()}}],"listings"==$scope.configs.type)lResult=lResult.concat([{label:"Price is less than {0}".translate().format(lValue.formatPrice()),action:function(){$scope.setMaxPrice(lValue)}},{label:"Price is more than {0}".translate().format(lValue.formatPrice()),action:function(){$scope.setMinPrice(lValue)}},{label:"Price is between {0} and {1}".translate().format(lPriceMin.formatPrice(),lPriceMax.formatPrice()),action:function(){$scope.setMinPrice(lPriceMin),$scope.setMaxPrice(lPriceMax)}},{label:'Has "{0}" as civic address'.translate().format(lValue),action:function(){$scope.filter.addFilter("location.address.street_number","equal",lValue,'Has "{0}" as civic address'.translate().format(lValue))}}])}else{let lValue=$filter.data.keyword.toLowerCase();if(lResult=[{selected:true,label:'Contains "{0}"'.translate().format(lValue),action:function(){$filter.query_text=lValue,$filter.buildFilters(),$filter.buildHints(),$filter.saveState()}}],"listings"==$scope.configs.type){for($key in $scope.dictionary.listing_category){let lElm=$scope.dictionary.listing_category[$key];if(lElm.caption.toLowerCase().indexOf(lValue)>=0)lResult.push({label:"{0} (category)".translate().format(lElm.caption),action:function(){lElm.selected=true,$scope.filter.addFilter("category","in",$scope.getSelection($scope.dictionary.listing_category))}})}for($key in $scope.dictionary.listing_subcategory){let lElm=$scope.dictionary.listing_subcategory[$key];if(lElm.caption.toLowerCase().indexOf(lValue)>=0)lResult.push({label:"{0} (subcategory)".translate().format(lElm.caption),action:function(){lElm.selected=true,$scope.filter.addFilter("subcategory","in",$scope.getSelection($scope.dictionary.listing_subcategory))}})}for($key in $scope.dictionary.region){let lElm=$scope.dictionary.region[$key];if(lElm.caption.toLowerCase().indexOf(lValue)>=0)lResult.push({label:"{0} (region)".translate().format(lElm.caption),action:function(){lElm.selected=true,$scope.filter.addFilter("location.region_code","in",$scope.getSelection($scope.dictionary.region))}})}for($key in $scope.dictionary.city){let lElm=$scope.dictionary.city[$key];if(lElm.caption.toLowerCase().indexOf(lValue)>=0)lResult.push({label:"{0} (city)".translate().format(lElm.caption),action:function(){lElm.selected=true,$scope.filter.addFilter("location.city_code","in",$scope.getSelection($scope.dictionary.city))}})}}else if("brokers"==$scope.configs.type)lResult.push({label:'Last name is "{0}"'.translate().format($scope.data.keyword),action:function(){$scope.filter.addFilter("last_name","equal_to",$scope.data.keyword,'Last name is "{0}"'.translate().format($scope.data.keyword)),$scope.buildFilters(),$scope.buildHints()}}),lResult.push({label:'Last name starts with "{0}"'.translate().format(lValue),action:function(){$scope.filter.addFilter("last_name","starts_with",lValue,'Last name starts with "{0}"'.translate().format(lValue)),$scope.buildFilters(),$scope.buildHints()}}),lResult.push({label:'Last name ends with "{0}"'.translate().format(lValue),action:function(){$scope.filter.addFilter("last_name","ends_with",lValue,'Last name ends with "{0}"'.translate().format(lValue)),$scope.buildFilters(),$scope.buildHints()}}),lResult.push({label:'First name is "{0}"'.translate().format($scope.data.keyword),action:function(){$scope.filter.addFilter("first_name","equal_to",$scope.data.keyword,'First name is "{0}"'.translate().format($scope.data.keyword)),$scope.buildFilters(),$scope.buildHints()}}),lResult.push({label:'First name starts with "{0}"'.translate().format(lValue),action:function(){$scope.filter.addFilter("first_name","starts_with",lValue,'First name starts with "{0}"'.translate().format(lValue)),$scope.buildFilters(),$scope.buildHints()}}),lResult.push({label:'First name ends with "{0}"'.translate().format(lValue),action:function(){$scope.filter.addFilter("first_name","ends_with",lValue,'First name ends with "{0}"'.translate().format(lValue)),$scope.buildFilters(),$scope.buildHints()}})}$scope.suggestions=lResult},$scope.trapKeyCode=function($keyCode){let lSelectedIndex=0,lResult=false;switch($keyCode){case 13:let lPassthrough=$scope.suggestions.every(function($e,$i){if(true===$e.selected)return $e.action(),lResult=true,false;else return true});if(lPassthrough)$scope.suggestions[0].action(),lResult=true;$scope.data.keyword="",$scope.suggestions=[];break;case 38:$scope.suggestions.every(function($e,$i){if(true===$e.selected)return lSelectedIndex=$i,delete $e.selected,false;else return true}),lSelectedIndex=Math.max(lSelectedIndex-1,0),$scope.suggestions[lSelectedIndex].selected=true,lResult=true;break;case 40:$scope.suggestions.every(function($e,$i){if(void 0!=$e.selected&&true===$e.selected)return lSelectedIndex=$i,delete $e.selected,false;else return true}),lSelectedIndex=Math.min(lSelectedIndex+1,$scope.suggestions.length-1),$scope.suggestions[lSelectedIndex].selected=true,lResult=true;break}return lResult},$scope.searchForKeyword=function(){if($scope.filter.query_text=$scope.filter.data.keyword,""!=$scope.filter.query_text)$scope.filter.saveState(),$scope.filter.buildFilters();else $scope.resetFilters()},$scope.lateCall=function($func){$siUtils.lateCall($func)},$scope._priceChangeDebounce=null,$scope.updatePrice=function(){if(null!=$scope._priceChangeDebounce)window.clearTimeout($scope._priceChangeDebounce);const lPriceMaxBoundary=$siHooks.filter("search-max-price-boundary",$scope.PRICE_RANGE_MAX),lRoundPrecision=$siHooks.filter("search-round-precision",$scope.PRICE_RANGE_PRECISION),fnRoundPrice=function($price){return Math.round($price/lRoundPrecision)*lRoundPrecision},lMinPrice=fnRoundPrice(lPriceMaxBoundary*$scope.priceRange[0]),lMaxPrice=fnRoundPrice(lPriceMaxBoundary*$scope.priceRange[1]);$scope._priceChangeDebounce=window.setTimeout(function(){$scope.filter.data.min_price=lMinPrice,$scope.filter.data.max_price=lMaxPrice<lPriceMaxBoundary?lMaxPrice:null,$scope.filter.update()},100)},$scope.resetPriceRange=function(){$scope.priceRange=[0,1,0],$scope.updatePrice()},$scope.selectPriceInput=function($value){$scope.selected_price_input=$value,$scope.updatePriceSuggestions()},$scope.updatePriceSuggestions=function(){$scope.priceSuggestions=$scope.getPriceSuggestions($scope.selected_price_input),$scope.minPriceSuggestions=$scope.getPriceSuggestions("min"),$scope.maxPriceSuggestions=$scope.getPriceSuggestions("max")},$scope.getPriceSuggestions=function($minOrMax){let lResult=[],lMinPrice=$scope.min_price||0,lMaxPrice=$scope.max_price||5e5,lStartAt=lMinPrice;const lList=[5e3,25e3,5e4,75e3,1e5,2e5,3e5,4e5];if("max"==$minOrMax)lStartAt=lMaxPrice;return lList.forEach(function($val){let lValue=$val+lStartAt;lResult.push({value:lValue,label:lValue.formatPrice()})}),lResult},$scope.applyDefaultMainFilter=function(){if($scope.current_main_filter,"focused"!=$scope.configs.search_engine_options.type)if(void 0!=$scope.configs.search_engine_options.tabs)if($scope.current_main_filter=sessionStorage.getItem("si.currentMainFilter"),null==$scope.current_main_filter){const lFilters=$scope.main_filters[$scope.configs.type];console.log("applyDefaultMainFilter",lFilters);const lFirstFilter=Object.keys(lFilters).find(function($k){return $scope.configs.search_engine_options.tabs.includes($k)});if(!isNullOrEmpty(lFirstFilter))$scope.selectMainFilter(lFirstFilter)}else{const lFilter=$scope.current_main_filter;if($scope.current_main_filter=void 0,!isNullOrEmpty(lFilter))$scope.selectMainFilter(lFilter)}},$scope.getInputCount=function(){if(null==$scope.configs)return 5;const lValueMap={listings:{default:5,potentialInputs:function(){return null}},brokers:{default:3,potentialInputs:function(){if(isNullOrEmpty($scope.configs))return null;if(isNullOrEmpty($scope.configs.search_engine_options.fields))return null;const lEffectiveInputs=$scope.configs.search_engine_options.fields.filter(function($fieldname){if("licenses"==$fieldname)return $scope.siDictionary.count("broker_license_type")>1;if("offices"==$fieldname)return $scope.officeList.length>1;else return true});return lEffectiveInputs.length}}};return lValueMap[$scope.configs.type].potentialInputs()||lValueMap[$scope.configs.type].default},$scope.setFilterFromList=function($list,$value){$list.forEach(function($item){$scope.filter.addFilter($item.filter.field,$item.filter.operator,null)});const lFilter=$list.find(function($item){return $item.key==$value});if(null!=lFilter)$scope.filter.addFilter(lFilter.filter.field,lFilter.filter.operator,lFilter.filter.value,lFilter.key)},$scope.setPrice=function($value,$eventOrInput){let lInput=$scope.selected_price_input;if("string"==typeof $eventOrInput)lInput=$eventOrInput;$siFilters.with($scope.alias,function($filter){let lOperators={min:"greater_or_equal_to",max:"less_or_equal_to"};if($scope.filter.addFilter(["price.sell.amount","price.lease.amount"],lOperators[lInput],$value),""==$value)$filter.data[lInput+"_price"]=void 0;else $filter.data[lInput+"_price"]=$value;if("min"==$scope.selected_price_input)if($eventOrInput&&"string"!=typeof $eventOrInput)$eventOrInput.stopPropagation(),$scope.selectPriceInput("max")})},$scope.setPriceFromRange=function($values){$siFilters.with($scope.alias,function($filter){let lOperators=["greater_or_equal_to","less_or_equal_to"];const lPriceMaxBoundary=$siHooks.filter("search-max-price-boundary",1e6);$filter.data.min_price=$values[0],$filter.data.max_price=$values[1]<lPriceMaxBoundary?$values[1]:0,$values.forEach(function($e,$i){if($e>0&&$e<lPriceMaxBoundary)$filter.addFilter(["price.sell.amount","price.lease.amount"],lOperators[$i],$e);else if($filter.hasFilter(["price.sell.amount","price.lease.amount"]))$filter.addFilter(["price.sell.amount","price.lease.amount"],lOperators[$i],"")})})},$scope.setMinPrice=function($value){$scope.setPrice($value,"min")},$scope.setMaxPrice=function($value){$scope.setPrice($value,"max")},$scope.getPriceFromScale=function($value,$multiplier,$starting,$default_value){if($starting="undefined"==typeof $starting?0:$starting,$default_value="undefined"==typeof $default_value?$value:$default_value,!isNaN($default_value))$default_value=$default_value.formatPrice();if(0==$value)return $default_value;$value*=100;let lResult=$starting+$value*$multiplier;return Math.round(lResult).formatPrice()},$scope.getMinPriceLabel=function($minLabel){const lPriceMaxBoundary=$siHooks.filter("search-max-price-boundary",$scope.PRICE_RANGE_MAX),lRoundPrecision=$siHooks.filter("search-round-precision",$scope.PRICE_RANGE_PRECISION),lResultFormat=$siHooks.filter("search-price-format",$scope.PRICE_RANGE_FORMAT),fnRoundPrice=function($price){return Math.round($price/lRoundPrecision)*lRoundPrecision};if($minLabel=void 0==$minLabel?(0).formatPrice():$minLabel,0==$scope.priceRange[0])return $minLabel;const lResult=fnRoundPrice(lPriceMaxBoundary*$scope.priceRange[0]);return lResultFormat.translate().format(lResult.formatPrice())},$scope.getMaxPriceLabel=function($maxLabel){const lPriceMaxBoundary=$siHooks.filter("search-max-price-boundary",$scope.PRICE_RANGE_MAX),lRoundPrecision=$siHooks.filter("search-round-precision",$scope.PRICE_RANGE_PRECISION),lResultFormat=$siHooks.filter("search-price-format",$scope.PRICE_RANGE_FORMAT),fnRoundPrice=function($price){return Math.round($price/lRoundPrecision)*lRoundPrecision};if($maxLabel=void 0==$maxLabel?lPriceMaxBoundary.formatPrice():$maxLabel,1==$scope.priceRange[1])return $maxLabel;const lResult=fnRoundPrice(lPriceMaxBoundary*$scope.priceRange[1]);return lResultFormat.translate().format(lResult.formatPrice())},$scope.setBedroomCount=function($item){$scope.bedroomSuggestions.forEach(function($e){$e.selected=false}),$item.selected=true,$scope.filter.addFilter("main_unit.bedroom_count","greater_or_equal_to",$item.value,"{0}+ bedrooms".translate().format($item.value),function(){$scope.setBedroomCount({value:""})})},$scope.setGarageCount=function($item){$scope.garageSuggestions.forEach(function($e){$e.selected=false}),$item.selected=true,$scope.filter.addFilter("attributes.PARKING_GARAGE","greater_or_equal_to",$item.value,$item.caption,function(){$scope.setGarageCount({value:""})})},$scope.setParkingCount=function($item){$scope.parkingSuggestions.forEach(function($e){$e.selected=false}),$item.selected=true,$scope.filter.addFilter("attributes.PARKING","greater_or_equal_to",$item.value,$item.caption,function(){$scope.setParkingCount({value:""})})},$scope.setBathroomCount=function($item){$scope.bathroomSuggestions.forEach(function($e){$e.selected=false}),$item.selected=true,$scope.filter.addFilter("main_unit.bathroom_count","greater_or_equal_to",$item.value,$item.caption,function(){$scope.setBathroomCount({value:""})})},$scope.syncFiltersToUI=function($filter){const lPriceMaxBoundary=$siHooks.filter("search-max-price-boundary",$scope.PRICE_RANGE_MAX);if(null!=$filter.data.min_price){const lPriceRangeMin=$filter.data.min_price/lPriceMaxBoundary;$scope.priceRange[0]=lPriceRangeMin}if(null!=$filter.data.max_price){const lPriceRangeMax=0==$filter.data.max_price?1:$filter.data.max_price/lPriceMaxBoundary;$scope.priceRange[1]=lPriceRangeMax}},$scope.syncToList=function($filter,$list){$siFilters.with($scope.alias,$scope).syncToList($filter,$list)},$scope.setState=function($item){let lValue=$item.filter.value;if(true!=$item.selected)lValue="";$scope.filter.addFilter($item.filter.field,$item.filter.operator,lValue,$item.caption.translate(),function(){$item.selected="",$scope.setState($item)})},$scope.hasChild=function($parent_key,$list){for($key in $list){let lData=$list[$key];if(lData.parent==$parent_key)return true}return false},$scope.getFavorites=function($key){return $siFavorites.favorites.map(function($e){return $e[$key]})},$scope.hasFavorites=function(){return!$siFavorites.isEmpty()},$scope.buildHints=function(){let lResult=[];$siFilters.with($scope.alias,$scope,function($filter){if(lResult=lResult.concat($scope.buildFilterHints($filter.filter_group)),$scope.buildPriceHint($filter,lResult),$scope.buildAreasHint($filter,"land",lResult),$scope.buildAreasHint($filter,"building",lResult),null!=$filter.query_text)lResult.push({item:"QUERY_TEXT",label:'Contains "{0}"'.translate().format($filter.query_text),reverse:function(){$filter.query_text=null,$filter.buildFilters(),$scope.buildHints(),$filter.saveState()}});if(null!=$filter.data.location)lResult.push({item:"NEAR_ME",label:"Near me".translate(),reverse:function(){$filter.data.location=null,$filter.buildFilters(),$scope.buildHints(),$filter.saveState()}});$scope.filterHints=lResult})},$scope.buildPriceHint=function($filter,$hints){const lResult=[];if((void 0!=$filter.data.min_price||void 0!=$filter.data.max_price)&&(0!=$filter.data.min_price||0!=$filter.data.max_price)){let lPriceHint=["Min","Max"];if(void 0!=$filter.data.min_price)lPriceHint[0]=$filter.data.min_price.formatPrice();if(void 0!=$filter.data.max_price&&0!=$filter.data.max_price)lPriceHint[1]=$filter.data.max_price.formatPrice();else lPriceHint[1]="Unlimited".translate();$hints.push({item:"PRICE",label:lPriceHint.join(" - "),reverse:function(){$scope.priceRange=[0,1,0],$scope.updatePrice()}})}},$scope.buildAreasHint=function($filter,$type,$hints){const lMinValue=$filter.data[$type+"_min"],lMaxValue=$filter.data[$type+"_max"],lTypeLabel="land"==$type?"Land area":"Available area";if(console.log("buildAreasHint",lMinValue,lMaxValue,$filter),(void 0!=lMinValue||void 0!=lMaxValue)&&(0!=lMinValue||0!=lMaxValue)){let lAreaLabels=["Min","Max"];if(void 0!=lMinValue)lAreaLabels[0]="{0} sqft".translate().format(lMinValue);if(void 0!=lMaxValue&&0!=lMaxValue)lAreaLabels[1]="{0} sqft".translate().format(lMaxValue);$hints.push({item:"AREA",label:lTypeLabel.translate()+" "+lAreaLabels.join(" - "),reverse:function(){$filter.data[$type+"_min"]=null,$filter.data[$type+"_max"]=null,$scope.setArea(null,$type,"min",""),$scope.setArea(null,$type,"max","")}})}},$scope.buildFilterHints=function($group){let lResult=[],lListSync={category_code:"listing_category",subcategory_code:"listing_subcategory","location.city_code":"city","location.region_code":"region","building.category_code":"building_category",office_ref_number:$scope.officeList};if(null!=$group.filters)$group.filters.forEach(function($e,$i){let lList=null;if(Array.isArray(lListSync[$e.field]))lList=lListSync[$e.field],lResult=lResult.concat($scope.buildFilterHintForList($e,lList));if(void 0!=lListSync[$e.field]){let lDictionaryKey=lListSync[$e.field];if($scope.dictionary[lDictionaryKey])lList=$scope.dictionary[lDictionaryKey],lResult=lResult.concat($scope.buildFilterHintForList($e,lList))}else if($e.label)lResult.push({item:$e,label:$e.label,reverse:function(){if("function"==typeof $e.reverse)$e.reverse();else $scope.filter.addFilter($e.field,$e.operator,"")}})});if(null!=$group.filter_groups)$group.filter_groups.forEach(function($g){let lSubGroups=$scope.buildFilterHints($g);lResult=lResult.concat(lSubGroups)});return lResult},$scope.buildFilterHintForList=function($filter,$list){let lResult=[];if(Array.isArray($list))return $list.forEach(function($e,$i){const lKey=Object.keys($e).find(function($k){return"id"==$k})||Object.keys($e)[0];if($e.selected)lResult.push({item:lKey,label:$e.name||$e.caption||$e.label,reverse:function(){delete $e.selected,$scope.filter.addFilter($filter.field,"in",$scope.getSelection($list))}})}),lResult;for(let $key in $list)if("in"==$filter.operator&&$filter.value.indexOf($key)>=0)lResult.push({item:$key,label:$list[$key].caption,reverse:function(){$list[$key].selected=false,$scope.filter.addFilter($filter.field,"in",$scope.getSelection($list))}});else if($list[$key].selected)lResult.push({item:$key,label:$list[$key].caption,reverse:function(){$list[$key].selected=false,$scope.filter.addFilter($filter.field,"equal","")}});return lResult},$scope.resetFilters=function(){$scope.priceRange=[0,1,0],$siHooks.do("filter-reset"),$scope.filter.resetFilters(),$scope.applyDefaultMainFilter(),$scope.getConfigs().then(function($configs){if(""!=$configs.search_token)if($rootScope.$broadcast($scope.alias+"FilterTokenChanged",$configs.search_token),void 0!=$scope.onTokenChange)$scope.onTokenChange()})},$scope.navigate=function(){if(""!=$scope.result_url&&null!=$scope.result_url)$scope.buildFilters().then(function($token){window.location=$scope.result_url})},$scope.toggleAllFor=function($key,$operator,$list,$item_parent){for(let lKey in $list){let lToggle=false;if(void 0==$item_parent)lToggle=true;else if($list[lKey].parent==$item_parent.__$obj_key)lToggle=true;if(true==lToggle)if(true!=$item_parent.selected)delete $list[lKey].selected;else $list[lKey].selected=true}$scope.filter.addFilter($key,$operator,$scope.getSelection($list))},$scope.getSelection=function($list,$key_prop){let lResult=[];if(Array.isArray($list))$list.forEach(function($e){const lKey=$key_prop||Object.keys($e).find(function($k){return"id"==$k})||Object.keys($e)[0];if($e.selected)lResult.push($e[lKey])});else for(let lKey in $list)if(true==$list[lKey].selected)lResult.push(lKey);return lResult},$scope.normalizeFilterGroup=function($filter_group){if($filter_group.filters)$filter_group.filters.forEach(function($filter){if(["in","not_in"].indexOf($filter.operator)>=0){if("function"==typeof $filter.value.split)$filter.value=$filter.value.split(",");$filter.value.forEach(function($val){if(typeof $val!==typeof true)if(!isNaN($val))$val=Number($val)})}else if(typeof $filter.value!==typeof true)if(!isNaN($filter.value))$filter.value=Number($filter.value)});if($filter_group.filter_groups)$filter_group.filter_groups.forEach(function($group){$scope.normalizeFilterGroup($group)});return $filter_group},$scope.getConfigs=function(){let lPromise=$q(function($resolve,$reject){if(null==$scope.configs)$siApi.getListConfigs($scope.alias).then(function($configs){$scope.configs=$configs,$resolve($scope.configs)});else $resolve($scope.configs)});return lPromise},$scope.onSortDataChanged=function($event,$newSortData){$scope.filter.sort_fields=[$newSortData],$scope.filter.buildFilters()},$scope.$watch("dictionary",function(newValue,oldValue){if(void 0!=$scope.dictionary&&void 0!=$scope.dictionary.region){let lRegionList=$siUtils.toSortedArray($scope.dictionary.region);console.log("region_list",lRegionList),$scope.region_list=lRegionList,$scope.tab_region=lRegionList[0].__$key}if(void 0!=$scope.dictionary&&void 0!=$scope.dictionary.city){let lCityList=$siUtils.toArray($scope.dictionary.city);$scope.city_list=lCityList}if(void 0!=$scope.dictionary&&void 0!=$scope.dictionary.listing_subcategory){let lSubcategoryList=$siUtils.toArray($scope.dictionary.listing_subcategory);$scope.subcategory_list=lSubcategoryList}if(void 0!=$scope.dictionary&&void 0!=$scope.dictionary.listing_category){let lCategoryList=$siUtils.toArray($scope.dictionary.listing_category);console.log("category list",lCategoryList),$scope.category_list=lCategoryList}}),$scope.getListType=function(){return $scope.configs.type}}}}]),siApp.directive("siSearchBox",["$sce","$compile","$siUtils","$siFilters","$siConfig",function siSearchBox($sce,$compile,$siUtils,$siFilters,$siConfig){return{restrict:"E",replace:true,required:"^siSearch",scope:{alias:"@",placeholder:"@",onTokenChange:"&onEnter",result_page:"@resultPage",persistantKeyword:"@persistantKeyword"},templateUrl:siCtx.base_path+"views/ang-templates/si-searchbox.html?v=6",link:function($scope,element,attrs){$scope.persistantKeyword="true"==$scope.persistantKeyword,$scope._el=element[0],$scope.init()},controller:function($scope,$q,$siApi,$rootScope,$siDictionary,$siUtils,$timeout){$scope.configs=null,$scope.suggestions=[],$scope.is_ready=false,$scope.keyword="",$scope.query_text=null,$scope.sort_fields=[],$scope.filter=null,$scope.stored_suggestions=null,$scope._suggestion_list_el=null,$scope.init=function(){$scope.isReady().then(function(){$siFilters.with($scope.alias,$scope,function($filter){if($scope.filter=$filter,$scope.filter.result_url=$scope.result_page,$filter.loadState(),$scope.persistantKeyword&&""!=$filter.query_text)$filter.data.keyword=$filter.query_text;else $filter.data.keyword=""});let lInput=angular.element($scope._el).find("input");lInput.bind("focus",function(){if(angular.element($scope._el).addClass("has-focus"),window.innerWidth<=800){const lInputRect=$scope._el.getBoundingClientRect();window.scroll({top:lInputRect.top+window.scrollY-30,behavior:"smooth"})}if(null!=$scope.filter.data.keyword&&""!=$scope.filter.data.keyword)$scope.buildSuggestions(),$scope.$apply()}),lInput.bind("blur",function(){$timeout(function(){$scope.closeSuggestionPanel().then(function(){angular.element($scope._el).removeClass("has-focus"),console.log("remove focus class and clear suggestions"),$scope.suggestions=[],$scope.stored_suggestions=null,$scope.$emit("si-searchbox-blur")})},200)}),$scope.$broadcast("search-is-ready")})},$scope.isReady=function(){if(null!=$scope.dictionary&&null!=$scope.configs)$scope.is_ready=true;let lPromise=$q(function($resolve,$reject){if(false==$scope.is_ready)$scope.getConfigs().then(function($configs){$scope.configs=$configs,$siFilters.with($scope.alias,$scope).configs=$configs,$siApi.getViewMeta($configs.type,$configs.source.id).then(function($response){$scope.dictionary=$response.dictionary,$scope.is_ready=true,$resolve()})});else $resolve()});return lPromise},$scope.getSuggestionPosition=function(){if(void 0==$scope._el)return"";let lRect=$siUtils.absolutePosition($scope._el);return lRect.width=Math.min($scope._el.offsetWidth,window.innerWidth),lRect.height=window.getComputedStyle($scope._el).getPropertyValue("height").replace("px",""),"top:{0}px;padding-top:{1}px;left:{2}px;width:{3}px;".format(lRect.top,lRect.height-1,lRect.left,lRect.width)},$scope._buildSuggestionsDebounceHndl=null,$scope.buildSuggestions=function($event){const lSUGGESTION_COUNT_LIMIT=10;if(null!=$scope._buildSuggestionsDebounceHndl)window.clearTimeout($scope._buildSuggestionsDebounceHndl);let lResult=[];if(void 0!=$event)if($scope.trapKeyCode($event.keyCode))return false;$siFilters.with($scope.alias,$scope,function($filter){if(""==$filter.data.keyword)$scope.suggestions=[],$scope.stored_suggestions=null;if(null==$scope.stored_suggestions||0==$scope.stored_suggestions.length||$scope.stored_suggestions.length>=lSUGGESTION_COUNT_LIMIT)$scope._buildSuggestionsDebounceHndl=window.setTimeout(function(){if(""==$filter.data.keyword)$scope.stored_suggestions=null,$scope.suggestions=lResult;else $scope.getConfigs().then(function($configs){let lType="";if("function"==typeof $scope.$parent.getListType)lType=$scope.$parent.getListType(),lType="listings"==lType?"listing-city-region":lType.replace("s","");$siApi.api($scope.getEndpoint(),{q:$filter.data.keyword,t:lType,c:lSUGGESTION_COUNT_LIMIT},{method:"GET"}).then(function($qsItems){if($qsItems.forEach(function($e){if("undefined"!=typeof $e.context)Object.keys($e.context).forEach(function($k){
if($e.context[$k].match($scope.getKeywordRegEx()))$e.caption=$e.caption+" "+$e.context[$k]})}),$qsItems.length>0)$scope.suggestions=$qsItems,$scope.stored_suggestions=$scope.suggestions,$scope.suggestions[0].selected=true,$scope.openSuggestionPanel();else $scope.closeSuggestionPanel().then(function(){$scope.suggestions=$qsItems,$scope.stored_suggestions=$scope.suggestions})})})},250);else if($scope.suggestions=$scope.stored_suggestions.filter(function($e){return $scope.elementMatchKeyword($e,false)}),$scope.suggestions.length>0)$scope.suggestions[0].selected=true})},$scope.openSuggestionPanel=function(){if($scope.$emit("si-searchbox-focus"),null==$scope._suggestion_list_el)$scope._suggestion_list_el=$scope._el.querySelector(".suggestion-list"),angular.element("body").append($scope._suggestion_list_el);const lMainElmRect=$scope._el.getBoundingClientRect(),lRect={width:lMainElmRect.width,height:lMainElmRect.height,top:lMainElmRect.top,left:lMainElmRect.left};Object.keys(lRect).forEach(function($k){$scope._suggestion_list_el.style.setProperty("--input-"+$k,lMainElmRect[$k]+"px")}),$scope._suggestion_list_el.style.setProperty("--input-offset",window.pageYOffset+"px"),$scope._suggestion_list_el.classList.add("expanded")},$scope.closeSuggestionPanel=function(){if(null==$scope._suggestion_list_el)return $q.resolve();else return $q(function($resolve,$reject){console.log("closing suggestion panel"),angular.element($scope._suggestion_list_el).on("transitionend",function(){angular.element($scope._suggestion_list_el).off("transitionend"),console.log("Suggestion panel close"),$resolve()}),$scope._suggestion_list_el.classList.remove("expanded")})},$scope.getKeywordRegEx=function($startsWith){if($startsWith="undefined"==typeof $startsWith?true:$startsWith,null==$scope.filter)return null;if(""==$scope.filter.data.keyword)return null;let lPattern=$scope.filter.data.keyword,lSpecials={a:"(a||||)",e:"(e||||)",i:"(i||||)",o:"(o||||)",u:"(u||||)",c:"(c|)"};if(Object.keys(lSpecials).forEach(function($k){lPattern=lPattern.replace(new RegExp($k,"gi"),lSpecials[$k])}),$startsWith)lPattern="^"+lPattern;let lResult=new RegExp(lPattern,"i");return lResult},$scope.getWrapRegex=function(){return $scope.getKeywordRegEx(false)},$scope.getSelection=function(){return $scope.suggestions.find(function($e){return $e.selected})},$scope.elementMatchKeyword=function($item,$startsWith){if(null==$scope.filter)return false;let lMatchRegEx=$scope.getKeywordRegEx($startsWith),lMathResult=$item.caption.match(lMatchRegEx);return null!=lMathResult&&lMathResult.length>0},$scope.selectionMatchKeyword=function(){if(null==$scope.filter)return false;if(null==$scope.suggestions||0==$scope.suggestions.length)return false;let lSelection=$scope.getSelection();if(void 0==lSelection)return false;else return $scope.elementMatchKeyword(lSelection)},$scope.getSelectionPlaceholder=function(){if(null==$scope.filter)return"";let lSelection=$scope.getSelection();if(void 0==lSelection)return"";let lCaption=lSelection.caption,lMatchRegEx=$scope.getKeywordRegEx();return lCaption=lSelection.caption.replace(lMatchRegEx,'<span class="matched">'+$scope.filter.data.keyword+"</span>"),lCaption},$scope.getReverseSuggestions=function(){return $siFilters.with($scope.alias,$scope,function($filter){let lValue=$filter.data.keyword.toLowerCase(),lValueList=lValue.split(" "),lLabelResults=[],lActionResults=[];for($key in $scope.dictionary.listing_subcategory){let lElm=$scope.dictionary.listing_subcategory[$key],lAdded=false;if(lValue.indexOf(lElm.caption.toLowerCase())>=0)lLabelResults.push(lElm.caption),lActionResults.push(function(){lElm.selected=true,$filter.addFilter("subcategory","in",$filter.getSelection($scope.dictionary.listing_subcategory))}),lAdded=true;else lValueList.some(function($e){if(lElm.caption.toLowerCase().indexOf($e)>=0)return lLabelResults.push(lElm.caption),lActionResults.push(function(){lElm.selected=true,$filter.addFilter("subcategory","in",$filter.getSelection($scope.dictionary.listing_subcategory))}),lAdded=true,true});if(lAdded)break}let lTransactions=["for sale","sale"];for($key in lTransactions.some(function($e){if(lValue.indexOf($e)>=0)return lLabelResults.push($e),lActionResults.push(function(){$filter.addFilter("price.sell.amount","greater_than",0)}),true}),lTransactions=["for rent","rent"],lTransactions.some(function($e){if(lValue.indexOf($e)>=0)return lLabelResults.push($e),lActionResults.push(function(){$filter.addFilter("price.lease.amount","greater_than",0)}),true}),$scope.dictionary.city){let lElm=$scope.dictionary.city[$key],lAdded=false;if(lValue.indexOf(lElm.caption.toLowerCase())>=0)lLabelResults.push("in {0}".translate().format(lElm.caption)),lActionResults.push(function(){lElm.selected=true,$filter.addFilter("location.city_code","in",$filter.getSelection($scope.dictionary.city))});else lValueList.some(function($e){if(lElm.caption.toLowerCase().indexOf($e)>=0)return lLabelResults.push("in {0}".translate().format(lElm.caption)),lActionResults.push(function(){lElm.selected=true,$filter.addFilter("location.city_code","in",$filter.getSelection($scope.dictionary.city))}),lAdded=true,true});if(lAdded)break}}),{label:lLabelResults.join(" "),action:function(){lActionResult.forEach(function($lf){$lf()}),$scope.filter.buildFilters()}}},$scope.doActionFor=function($item){$scope.suggestions=[],$item.action()},$scope.trapKeyCode=function($keyCode){let lSelectedIndex=0,lResult=false;switch($keyCode){case 27:$scope.suggestions=[],$scope.stored_suggestions=[],lResult=true;break;case 13:if(""==$scope.filter.data.keyword)$scope.resetFilters();else{let lSelection=$scope.getSelection();if(null!=lSelection)return $scope.openItem(lSelection),$scope.suggestions=[],$scope.filter.data.keyword="",true;else{if($scope.filter.query_text=$scope.filter.data.keyword,$scope.filter.buildFilters(),!$scope.persistantKeyword)$scope.filter.data.keyword="";$scope.filter.saveState()}}break;case 38:$scope.suggestions.every(function($e,$i){if(true===$e.selected)return lSelectedIndex=$i,delete $e.selected,false;else return true}),lSelectedIndex=Math.max(lSelectedIndex-1,0),$scope.suggestions[lSelectedIndex].selected=true,lResult=true;break;case 40:$scope.suggestions.every(function($e,$i){if(void 0!=$e.selected&&true===$e.selected)return lSelectedIndex=$i,delete $e.selected,false;else return true}),lSelectedIndex=Math.min(lSelectedIndex+1,$scope.suggestions.length-1),$scope.suggestions[lSelectedIndex].selected=true,lResult=true;break;case 8:$scope.stored_suggestions=null;break}return lResult},$scope.getConfigs=function(){let lPromise=$q(function($resolve,$reject){if(null==$scope.configs)$siApi.getListConfigs($scope.alias).then(function($configs){$scope.configs=$configs,$resolve($scope.configs)});else $resolve($scope.configs)});return lPromise},$scope.openItem=function($item){if(["listing","broker"].includes($item.type)){const lInput=angular.element($scope._el).find("input");return lInput.val(""),lInput.attr("placeholder","Opening...".translate()),void $siConfig.get().then(function($global_configs){let lShortcut=$scope.getItemLinkShortcut($item.type,$global_configs),lPath=lShortcut.replace("{{item.ref_number}}",$item.ref_number);console.log("Open item @",lPath),window.location="/"+lPath})}$scope.$emit("si-searchbox-add-filter",$item),$scope.suggestions=[],$scope.stored_suggestions=null},$scope.getItemLinkShortcut=function($type,$configs){let lRoute=$configs[$type+"_routes"].find(function($r){return $r.lang==siApiSettings.locale})||$configs[$type+"_routes"][0];return lRoute.shortcut},$scope.resetFilters=function(){$siFilters.with($scope.alias,$scope).resetFilters()},$scope.getEndpoint=function(){return"view/".concat($scope.configs.source.id,"/",siApiSettings.locale+"/quick_search")}}}}]),siApp.directive("siSearchFilterTags",[function siSearchFilterTags(){return{restrict:"E",scope:{alias:"@siAlias"},template:'<div class="si-search-filter-tags"><div class="si-tag-list"><div class="si-tag-item" ng-click="doItemAction(item)" ng-repeat="item in list"><span>{{item.text}}</span> <i class="fal fa-fw fa-times"></i></div></div></div>',replace:true,link:function($scope,$element,$attrs){$scope.$element=$element[0],console.log("siSearchFilterTags"),$scope.init()},controller:function($scope,$rootScope,$q,$siFilters,$siDictionary,$siSearchContext,$siList){$siSearchContext.extendTo($scope),$scope.list=[],$scope.init=function(){$scope.isReady().then(function(){$scope.$watch(function(){return $scope.filter.data},function($new,$old){$scope.updateList()},true),$scope.filter.on("update").then(function(){console.log("filter tags",$scope.alias,"update trigger"),$scope.updateList()}),$scope.updateList()})},$scope.isReady=function(){if(null!=$scope.dictionary&&null!=$scope.configs)return $q.resolve();else return $q(function($resolve,$reject){$scope.filter=$siFilters.with($scope.alias,$scope),$scope.filter.loadState(),$siDictionary.onLoad().then(function(){$siList.dictionary=$siDictionary.source,$resolve()})})},$scope.reverseFilterMap={bedrooms:function($value){return{text:($value>1?"{0} bedrooms":"{0} bedroom").translate().format($value),remove(){$scope.filter.data.bedrooms=null,$scope.filter.update()}}},bathrooms:function($value){return{text:($value>1?"{0} bathrooms":"{0} bathroom").translate().format($value),remove(){$scope.filter.data.bathrooms=null,$scope.filter.update()}}},parkings:function($value){return{text:($value>1?"{0} parkings":"{0} parking").translate().format($value),remove(){$scope.filter.data.parkings=null,$scope.filter.update()}}},attributes:function($values){return $values.map(function($val){return{text:$scope.getCaptionOfFilter($val,$scope.listing_attributes,"field").translate(),remove(){const lIndex=$scope.filter.data.attributes.indexOf($val);$scope.filter.data.attributes.splice(lIndex,1),$scope.filter.update()}}})},cities:function($values){return $values.map(function($val){return console.log("city",$val),{text:$scope.getCaptionOfFilter($val,$siList.getCityList(),"key"),remove(){const lIndex=$scope.filter.data.cities.indexOf($val);$scope.filter.data.cities.splice(lIndex,1),$scope.filter.update()}}})},regions:function($values){return $values.map(function($val){return console.log("region",$val),{text:$scope.getCaptionOfFilter($val,$siList.getRegionList(),"key"),remove(){const lIndex=$scope.filter.data.regions.indexOf($val);$scope.filter.data.regions.splice(lIndex,1),$scope.filter.update()}}})},subcategories:function($values){return $values.map(function($val){return console.log("subcategories",$val),{text:$scope.getCaptionOfFilter($val,$siList.getSubcategoryList(),"key"),remove(){const lIndex=$scope.filter.data.subcategories.indexOf($val);$scope.filter.data.subcategories.splice(lIndex,1),$scope.filter.update()}}})},building_categories:function($values){return $values.map(function($val){return console.log("building_categories",$val),{text:$scope.getCaptionOfFilter($val,$siList.getBuildingCategoryList(),"key"),remove(){const lIndex=$scope.filter.data.building_categories.indexOf($val);$scope.filter.data.building_categories.splice(lIndex,1),$scope.filter.update()}}})},transaction_type:function($value){return{text:"For {0}".format($value).translate(),remove(){$scope.filter.data.transaction_type=null,$scope.filter.update()}}},contract:function($value){return{text:"Online since".translate()+" "+$scope.getCaptionOfFilter($value,$siSearchContext.listing_ages,"key"),remove(){$scope.filter.data.contract=null,$scope.filter.update()}}},states:function($values){return $values.map(function($val){return{text:$scope.getCaptionOfFilter($val,$siSearchContext.listing_flags,"key").translate(),remove(){const lIndex=$scope.filter.data.states.indexOf($val);$scope.filter.data.states.splice(lIndex,1),$scope.filter.update()}}})}},$scope.getCaptionOfFilter=function($filter,$list,$valueAccessor){const lList=Object.keys($list).map(function($k){return Object.assign({key:$k},$list[$k])}),lItem=lList.find(function($item){switch(typeof $valueAccessor){case"string":return $filter==$item[$valueAccessor];break;case"function":return $filter==$valueAccessor($item);break;default:return $filter==$item.value}});if(null==lItem)return $filter;else return lItem.caption||lItem.label},$scope.updateList=function(){const lList=[],lFilters=$scope.filter.data;Object.keys(lFilters).forEach(function($k){if(!isNullOrEmpty(lFilters[$k]))if(!["min_price","max_price"].includes($k))if(!["land_min","land_max"].includes($k))if(!["available_min","available_max"].includes($k)){if(void 0!=$scope.reverseFilterMap[$k]){const lItems=$scope.reverseFilterMap[$k](lFilters[$k]);if(Array.isArray(lItems))lList.push(...lItems);else lList.push(lItems)}}else $scope.addRangeItem(["available_min","available_max"],lList,{srcList:$siSearchContext.available_areas,textFormat:"Available area of {0} - {1}"});else $scope.addRangeItem(["land_min","land_max"],lList,{srcList:$siSearchContext.land_areas,textFormat:"Land of {0} - {1}"});else{if(0==lFilters[$k])return;const lMinPrice=0==$scope.filter.data.min_price?"Min":$scope.filter.data.min_price.formatPrice(),lMaxPrice=null==$scope.filter.data.max_price?"Unlimited":$scope.filter.data.max_price.formatPrice(),lPriceItem=lList.find(function($e){return"price"==$e.key});if(lTextFormat="{0} - {1}".format(lMinPrice,lMaxPrice),null!=lPriceItem)lPriceItem.text=lTextFormat;else lList.push({key:"price",text:lTextFormat,remove(){$scope.filter.data.min_price=0,$scope.filter.data.max_price=null,$scope.filter.update()}})}}),$scope.list=lList},$scope.addRangeItem=function($keys,$targetList,$options){$options=Object.assign({srcList:[],listKey:"value",textFormat:"{0} - {1}",min:"Min",max:"Max"},$options);const lKeyMin=$keys[0],lKeyMax=$keys[1],lListKey=$keys.join("-"),lMin=isNullOrEmpty($scope.filter.data[lKeyMin])?$options.min:$scope.getCaptionOfFilter($scope.filter.data[lKeyMin],$options.srcList,$options.listKey),lMax=isNullOrEmpty($scope.filter.data[lKeyMax])?$options.max:$scope.getCaptionOfFilter($scope.filter.data[lKeyMax],$options.srcList,$options.listKey),lItem=$targetList.find(function($e){return $e.key==lListKey});if(lTextFormat=$options.textFormat.translate().format(lMin,lMax),null!=lItem)lItem.text=lTextFormat;else $targetList.push({key:lListKey,text:lTextFormat,remove(){$scope.filter.data[lKeyMin]=null,$scope.filter.data[lKeyMax]=null,$scope.filter.update()}})},$scope.doItemAction=function($item){if("function"==typeof $item.remove)$item.remove()}}}}]),siApp.factory("$siFilters",["$q","$siApi","$siUtils",function $siFilters($q,$siApi,$siUtils){function FilterManager($alias,$context){let $fm={result_url:null,alias:$alias,query_text:null,sort_fields:[],filter_group:{operator:"and",filters:null,filter_groups:null},main_filter:null,data:{keyword:"",min_price:null,max_price:null,location:null,transaction_type:null,attributes:[],states:[],building_categories:[],categories:[],subcategories:[],cities:[],regions:[],parkings:null,contract:null,bedrooms:null,bathrooms:null,land_min:null,land_max:null,available_min:null,available_max:null,favorites:null,letters:null,licenses:[],offices:[]},configs:null,state_loaded:false,mainFilterMap:{listings:{RES:{field:"market_codes",operator:"array_contains",value:"RES",type:"market"},COM:{field:"market_codes",operator:"array_contains",value:"COM",type:"market"},"for-sale":{field:"for_sale_flag",operator:"equal",value:true,shadows:"transaction_type"},"for-rent":{field:"for_rent_flag",operator:"equal",value:true,shadows:"transaction_type"}}}};return $fm.dataFilterMap={transaction_type:function($value){if("sale"==$value)return[{field:"for_sale_flag",operator:"equal",value:true},{field:"for_rent_flag",operator:"equal",value:""}];if("rent"==$value)return[{field:"for_rent_flag",operator:"equal",value:true},{field:"for_sale_flag",operator:"equal",value:""}];else return[{field:"for_rent_flag",operator:"equal",value:""},{field:"for_sale_flag",operator:"equal",value:""}]},parkings:{field:"attributes.PARKING",operator:"greater_than"},contract:function($value){if(null==$value)return{field:"contract.start_date",operator:"greater_than",value:""};else return $context.listing_ages.find(function($age){return $age.key==$value}).filter},land_min:{field:"land.dimension.area_sf",operator:"greater_or_equal_to"},land_max:{field:"land.dimension.area_sf",operator:"less_or_equal_to"},available_min:{field:"available_area_sf",operator:"greater_or_equal_to"},available_max:{field:"available_area_sf",operator:"less_or_equal_to"},min_price:function($value){return{field:["price.sell.amount","price.lease.amount"],operator:"greater_or_equal_to",value:$value}},max_price:function($value){return{field:["price.sell.amount","price.lease.amount"],operator:"less_or_equal_to",value:$value}},building_categories:function($values){return{field:"building.category_code",operator:"in",value:$values}},attributes:function($value){return Object.keys($context.listing_attributes).map(function($k){const lItem=$context.listing_attributes[$k],lValue=null==$value?"":$value.includes(lItem.field)?true:"";return{field:lItem.field,operator:"equal",value:lValue}})},states:function($value){return Object.keys($context.listing_flags).map(function($k){const lItem=$context.listing_flags[$k].filter,lValue=null==$value?"":$value.includes($k)?lItem.value:"";return{field:lItem.field,operator:lItem.operator,value:lValue}})},categories:{field:"category_code",operator:"in"},subcategories:{field:"subcategory_code",operator:"in"},bedrooms:{field:"main_unit.bedroom_count",operator:"greater_or_equal_to"},bathrooms:{field:"main_unit.bathroom_count",operator:"greater_or_equal_to"},cities:{field:"location.city_code",operator:"in"},regions:{field:"location.region_code",operator:"in"},favorites:{field:"ref_number",operator:"in"},letters:{field:"last_name",operator:"starts_with"},licenses:{field:"license_type_code",operator:"in"},offices:{field:"office_ref_number",operator:"in"}},$fm._buildFiltersDebounce=null,$fm._events_listener={},$fm.on=function($event_key){if("undefined"==typeof $fm._events_listener[$event_key])$fm._events_listener[$event_key]=[];let lResult={_callback:null,then:function($fn){this._callback=$fn},resolve:function(){this._callback.apply(void 0,arguments)}};return $fm._events_listener[$event_key].push(function(){lResult.resolve.apply(lResult,arguments)}),lResult},$fm.trigger=function($event_key){if("undefined"==typeof $fm._events_listener[$event_key])return;const $params=Array.prototype.slice.call(arguments,1);$fm._events_listener[$event_key].forEach(function($e){return $e.apply(void 0,$params)})},$fm.searchByKeyword=function($keyword){$fm.resetFilters(false),$fm.query_text=$keyword,$fm.data.keyword=$keyword,$fm.saveState(),$fm.buildFilters()},$fm.setLetter=function($letter){$fm.data.letters=$letter,$fm.update(),$fm.trigger("update")},$fm.count=function(){return Object.keys($fm.data).reduce(function($acc,$k){if(Array.isArray($fm.data[$k]))return $fm.data[$k].length>0?$acc+1:$acc;if("min_price"==$k)return null!=$fm.data[$k]&&$fm.data[$k]>0?$acc+1:$acc;else return null!=$fm.data[$k]&&""!=$fm.data[$k]?$acc+1:$acc},0)},$fm.hasFilters=function($customCheck){return Object.keys($fm.data).some(function($k){if(Array.isArray($fm.data[$k]))return $fm.data[$k].length>0;if("min_price"==$k)return null!=$fm.data[$k]&&$fm.data[$k]>0;else return null!=$fm.data[$k]&&""!=$fm.data[$k]})},$fm.hasFilter=function($fieldname){if($fm.hasFilters()){let lFields=$fieldname;if(!Array.isArray(lFields))lFields=[$fieldname];return lFields.some(function($f){if(void 0!=$fm.data[$f]){if(Array.isArray($fm.data[$f]))return $fm.data[$f].length>0;if(!isNaN($fm.data[$f]))return $fm.data[$f]>0;else return null!=$fm.data[$f]}return null!=$fm.getFilterByFieldName($f)})}else return false},$fm.sublistHasFilters=function($parent_code,$list,$selections){if(null==$selections)return false;if(!Array.isArray($selections))return false;if(0==$selections.length)return false;else return $list.filter(function($item){return $item.parent==$parent_code}).some(function($item){return $selections.includes($item.__$obj_key)})},$fm.sublistClearFilters=function($parent_code,$list,$selections){if(null!=$selections)if(Array.isArray($selections))if(0!=$selections.length)$list.filter(function($item){return $item.parent==$parent_code}).forEach(function($item){const lItemIndex=$selections.findIndex(function($i){return $i==$item.__$obj_key});if(lItemIndex>=0)$selections.splice(lItemIndex,1)})},$fm.getFilterValue=function($fieldname){let lFilter=$fm.getFilterByFieldName($fieldname);if(null!=lFilter)return lFilter.value;else return null},$fm.getFilterCaption=function($fieldname,$default){let lFilter=$fm.getFilterByFieldName($fieldname);if(null!=lFilter)return $default="undefined"==typeof $default?lFilter.value:$default,lFilter.label;else return $default="undefined"==typeof $default?"":$default,$default},$fm.getFilterCaptionFromList=function($fieldname,$list,$default){let lValue=null;if("object"==typeof $fieldname){const lKey=Object.keys($fieldname)[0];lValue=$fm[lKey][$fieldname[lKey]]}else lValue=$fm.getFilterValue($fieldname);if(null==lValue)return $default;let lItem=null;if($list.some(function($e){return void 0!=$e.filter}))lItem=$list.find(function($e){return $e.filter.value==lValue});else lItem=$list.find(function($e){return $e.value==lValue});if(null==lItem)return $default;if(void 0!=lItem.label)return lItem.label;if(void 0!=lItem.name)return lItem.name;else return lItem.caption},$fm.getFilterByFieldName=function($fieldname,$group){let lResult=null;if($group="undefined"==typeof $group?$fm.filter_group:$group,null!=$group.filters)$group.filters.some(function($e){if($fieldname.indexOf("*")>=0){if($e.field.indexOf($fieldname.replace("*",""))>=0)return lResult=$e,true}else if($e.field==$fieldname)return lResult=$e,true});if(null==lResult&&null!=$group.filter_groups)$group.filter_groups.some(function($group){let lGroupResult=$fm.getFilterByFieldName($fieldname,$group);if(null!=lGroupResult)return lResult=lGroupResult,true});return lResult},$fm.setMainFilter=function($type,$filterKey){$fm.main_filter={type:$type,key:$filterKey}},$fm.addFilter=function($field,$operator,$value,$label,$reverseFunc){if(null!=$fm._buildFiltersDebounce)window.clearTimeout($fm._buildFiltersDebounce);if($fm.resetKeywordSearch(),Array.isArray($field))$fm.addFilterGroup($field,$operator,$value,$label);else $fm.setFilter($field,$operator,$value,$fm.filter_group,$label,$reverseFunc);$fm.saveState(),$fm._buildFiltersDebounce=window.setTimeout(function(){$fm.buildFilters()},100)},$fm.toggleFilter=function($field,$operator,$value,$label,$reverseFunc){if($fm.hasFilter($field)&&$fm.getFilterValue($field)==$value)$fm.addFilter($field,$operator,null);else $fm.addFilter($field,$operator,$value,$label,$reverseFunc)},$fm.addGeoFilter=function(){$q(function($resolve,$reject){if(null!=$fm.data.location)$fm.data.location=null,$resolve();else navigator.geolocation.getCurrentPosition(function($position){$fm.data.location={latitude:$position.coords.latitude,longitude:$position.coords.longitude,distance:5e3},$resolve()})}).then(function(){$fm.saveState(),$fm.buildFilters(),$fm.trigger("update")})},$fm.addAttributeFilter=function($attr){let lValue=$attr.selected?true:"";$fm.addFilter($attr.field,"equal",lValue,$attr.caption.translate(),function(){$attr.selected=false,$fm.addFilter($attr.field,"equal","")})},$fm.addFilterGroup=function($fields,$operator,$value,$label){let lGroupName=$fields.join("-")+"-"+$operator,parentFilterGroup=$fm.getFieldGroup(lGroupName,$fm.filter_group);if(null==parentFilterGroup){if(parentFilterGroup={operator:"or",name:lGroupName,filters:null,filter_groups:null},null==$fm.filter_group.filter_groups)$fm.filter_group.filter_groups=[];$fm.filter_group.filter_groups.push(parentFilterGroup)}if($fields.forEach(function($f,$index){let lValue=$value;if(null!=$value){if("function"==typeof $value.push)if($value.length>$index)lValue=$value[$index];else lValue=null;$fm.setFilter($f,$operator,lValue,parentFilterGroup,$label)}}),null==parentFilterGroup.filters)$fm.filter_group.filter_groups.forEach(function($g,$i){if($g.name==parentFilterGroup.name)$fm.filter_group.filter_groups.splice($i,1)});if(0==$fm.filter_group.filter_groups.length)$fm.filter_group.filter_groups=null},$fm.setFilter=function($field,$operator,$value,$group,$label,$reverseFunc){if(null==$group.filters)$group.filters=[];let lFilterIndex=0,lNewFilter={field:$field,operator:$operator,value:$value,label:$label,reverse:$reverseFunc||function(){$fm.addFilter($field,$operator,"")}};if(lFilterIndex=$group.filters.findIndex(function($gf){if($gf.field==$field&&$gf.operator==$operator)return true}),lFilterIndex>=0)if(""===$value||null==$value)$fm.removeFilter(lFilterIndex,$group);else if(Array.isArray($value)&&0==$value.length)$fm.removeFilter(lFilterIndex,$group);else $fm.updateFilter(lNewFilter,lFilterIndex,$group);else if(""!==$value&&null!==$value)$group.filters.push(lNewFilter)},$fm.updateFilter=function($filter,$index,$group){$group.filters[$index]=$filter},$fm.removeFilter=function($index,$group){if($group.filters.splice($index,1),0==$group.filters.length)$group.filters=null},$fm.getFieldGroup=function($groupName,$parent){if($parent.name==$groupName)return $parent;else if(null!=$parent.filter_groups){let lResult=$parent.filter_groups.find(function($g){return $g.name==$groupName});if(null==lResult)$parent.filter_groups.some(function($g){return lResult=$fm.getFieldGroup($groupName,$g),null==lResult});return lResult}return null},$fm.update=function(){const lDataKeys=Object.keys($fm.data),lMainFilter=null!=$fm.main_filter?$fm.mainFilterMap[$fm.main_filter.type][$fm.main_filter.key]:null;if(null!=lMainFilter)Object.keys($fm.mainFilterMap[$fm.main_filter.type]).forEach(function($k){const lOtherFilter=$fm.mainFilterMap[$fm.main_filter.type][$k];if(lOtherFilter.field!=lMainFilter.field)$fm.addFilter(lOtherFilter.field,lOtherFilter.operator,"")}),$fm.addFilter(lMainFilter.field,lMainFilter.operator,lMainFilter.value);lDataKeys.forEach(function($key){const lFilterMap=$fm.dataFilterMap[$key],lDataValue=$fm.data[$key];if(void 0==lFilterMap)return;if(null!=lMainFilter&&lMainFilter.shadows===$key)return;const lFilter="function"==typeof lFilterMap?lFilterMap(lDataValue):lFilterMap;if(isNullOrEmpty(lDataValue))if(Array.isArray(lFilter))lFilter.forEach(function($f){$fm.addFilter($f.field,$f.operator,"")});else $fm.addFilter(lFilter.field,lFilter.operator,"");else if(Array.isArray(lFilter))lFilter.forEach(function($f){const lFilterValue=void 0==$f.value?lDataValue:$f.value;$fm.addFilter($f.field,$f.operator,lFilterValue)});else{const lFilterValue=void 0==lFilter.value?lDataValue:lFilter.value;$fm.addFilter(lFilter.field,lFilter.operator,lFilterValue)}})},$fm.resetFilters=function($triggerUpdate){console.log("resetFilters",$triggerUpdate);const lArrayAttr=["categories","attributes","states","cities","regions","building_categories","subcategories","licenses","offices"];if($triggerUpdate="undefined"==typeof $triggerUpdate?true:$triggerUpdate,$fm.main_filter=null,$fm.filter_group={operator:"and",filters:null,filter_groups:null},$fm.query_text=null,Object.keys($fm.data).forEach(function($k){$fm.data[$k]=null}),lArrayAttr.forEach(function($k){$fm.data[$k]=[]}),$fm.data.keyword="",$fm.trigger("reset"),$fm.clearState(),$triggerUpdate)$fm.getConfigs().then(function($configs){$fm.trigger("filterTokenChanged"),$fm.trigger("update")})},$fm.resetKeywordSearch=function(){let lKey="si."+$fm.alias+".{0}";$fm.query_text=null,$fm.data.keyword="",sessionStorage.removeItem(lKey.format("query"))},$fm.resetListSelections=function($list){for(let $subkey in $list)delete $list[$subkey].selected},$fm.buildFilters=function(){let lResult=null,lPromise=$q(function($resolve,$reject){$fm.getConfigs().then(function($configs){if(!$fm.hasFilters()&&null==$fm.query_text&&0==$fm.sort_fields.length&&null==$fm.data.location&&null==$fm.main_filter)return $fm.clearState(),void $fm.resetFilters();if($configs.limit>0)lResult={max_item_count:$configs.limit};if(null!=$configs.filter_group||$fm.hasFilters()||null!=$fm.main_filter){if($fm.clean(),null==lResult)lResult={};if(lResult.filter_group={filters:[]},null!=$configs.filter_group)lResult.filter_group=angular.copy($configs.filter_group);if($fm.hasFilters()||null!=$fm.main_filter){if(void 0==lResult.filter_group.filter_groups)lResult.filter_group.filter_groups=[];lResult.filter_group.filter_groups.push($fm.filter_group)}lResult.filter_group=$fm.normalizeFilterGroup(lResult.filter_group)}if($fm.sort_fields.length>0&&$fm.sort_fields.filter(function($f){return""!=$f.field}).length>0)lResult.sort_fields=$fm.sort_fields.filter(function($f){return""!=$f.field});else if("auto"!=$configs.sort&&""!=$configs.sort)lResult.sort_fields=[{field:$configs.sort,desc:$configs.sort_reverse}];else lResult.sort_fields=null;if(null!=$fm.query_text)lResult.query_text=$fm.query_text,lResult.filter_group=null;if(null!=$fm.data.location)lResult.proximity_filter=$fm.data.location;$fm.getSearchToken(lResult).then(function($token){if(""!=$token)if($fm.saveState("st",$token),$fm.trigger("filterTokenChanged",$token),null!=$fm.result_url)$fm.saveState(),window.location=$fm.result_url;else $resolve($token);else $reject()})})});return lPromise},$fm.syncToList=function($filter,$list){let lListArray=$siUtils.toArray($list);lListArray.forEach(function($e){if("in"==$filter.operator&&$filter.value.indexOf($e.__$obj_key)>=0){if(void 0==$list[$e.__$obj_key].selected||!$list[$e.__$obj_key].selected)$list[$e.__$obj_key].selected=true}else if($e.field==$filter.field){if(!$e.selected)$e.selected=true}else if(void 0!=$e.filter&&$e.filter.field==$filter.field)if(!$e.selected)$e.selected=true})},$fm.getSelection=function($list){let lResult=[];for(let lKey in $list)if(true==$list[lKey].selected)lResult.push(lKey);return lResult},$fm.normalizeFilterGroup=function($filter_group){if($filter_group.filters)$filter_group.filters.forEach(function($filter){if(["in","not_in"].indexOf($filter.operator)>=0){if("function"==typeof $filter.value.split)$filter.value=$filter.value.split(",");$filter.value.forEach(function($val){if(typeof $val!==typeof true)if(!isNaN($val))$val=Number($val)})}else if(typeof $filter.value!==typeof true)if(!isNaN($filter.value))$filter.value=Number($filter.value)});if($filter_group.filter_groups)$filter_group.filter_groups.forEach(function($group){$fm.normalizeFilterGroup($group)});return $filter_group},$fm.saveState=function($item_key,$data){let lKey="si."+$fm.alias+".{0}";if(void 0==$item_key){if($fm.state_loaded=false,sessionStorage.setItem(lKey.format("filter_group"),JSON.stringify($fm.filter_group)),null!=$fm.query_text)sessionStorage.setItem(lKey.format("query"),$fm.query_text);sessionStorage.setItem(lKey.format("mainFilter"),JSON.stringify($fm.main_filter)),sessionStorage.setItem(lKey.format("data"),JSON.stringify($fm.data))}else{let lValue=$data;if("object"==typeof lValue)lValue=JSON.stringify(lValue);sessionStorage.setItem(lKey.format($item_key),lValue)}},$fm.clearState=function($item_key){let lKey="si."+$fm.alias+".{0}";if(void 0==$item_key)$fm.state_loaded=false,sessionStorage.removeItem(lKey.format("filter_group")),sessionStorage.removeItem(lKey.format("data")),sessionStorage.removeItem(lKey.format("mainFilter")),sessionStorage.removeItem(lKey.format("query")),sessionStorage.removeItem(lKey.format("st"));else sessionStorage.removeItem(lKey.format($item_key))},$fm.loadState=function($item_key){if($key="si."+$fm.alias+".{0}",void 0==$item_key&&!$fm.state_loaded){const lSessionFilterGroup=sessionStorage.getItem($key.format("filter_group")),lSessionData=sessionStorage.getItem($key.format("data")),lMainFilterData=sessionStorage.getItem($key.format("mainFilter")),lQuery=sessionStorage.getItem($key.format("query"));if(null!=lSessionFilterGroup)$fm.filter_group=JSON.parse(lSessionFilterGroup);if(null!=lSessionData){let lData=JSON.parse(lSessionData);$fm.data=Object.assign($fm.data,lData)}if(null!=lMainFilterData){const lMainFilter=JSON.parse(lMainFilterData);$fm.main_filter=lMainFilter}
if(null!=lQuery)$fm.query_text=lQuery,$fm.data.keyword=lQuery;else $fm.data.keyword="";$fm.state_loaded=true}else{let lResult=sessionStorage.getItem($key.format($item_key));try{lResult=JSON.parse(lResult)}catch(error){}return lResult}},$fm.clean=function($group){if($group=void 0==$group?$fm.filter_group:$group,null!=$group.filters)if(0==$group.filters.length)$group.filters=null;if(null!=$group.filter_groups){if($group.filter_groups.length>0)if($group.filter_groups.forEach(function($g){$fm.clean($g)}),$group.filter_groups.every(function($g){return null==$g.filters}))$group.filter_groups=null;if(null!=$group.filter_groups&&0==$group.filter_groups.length)$group.filter_groups=null}},$fm.getCaption=function($attr,$format){if($format=void 0==$format?"{0}":$format,Array.isArray($attr))return $format.format(...$attr);else return $format.format($attr)},$fm.getPriceRangeCaption=function(){const lMin=null==$fm.data.min_price||0==$fm.data.min_price?"Min":$fm.data.min_price.formatPrice(),lMax=null==$fm.data.max_price?"Max":$fm.data.max_price.formatPrice();return $fm.getCaption([lMin,lMax],"{0} - {1}")},$fm.getSearchToken=function($filters){if(null==$filters)return $q.resolve();$fm.normalize($filters.filter_group);let lPromise=$q(function($resolve,$reject){if(null!=$filters)$siApi.api("utils/search_encode",$filters).then(function($response){$resolve($response)});else $resolve("")});return lPromise},$fm.normalize=function($filterGroup){const lNewGroup=[];if(null!=$filterGroup)if($filterGroup.filter_groups)$filterGroup.filter_groups.forEach(function($f,$i){if(null!=$f.filter_groups)$fm.normalize($f);if(null!=$f.filter_groups)lNewGroup.push($f);else if(null!=$f.filters)lNewGroup.push($f)}),$filterGroup.filter_groups=lNewGroup},$fm.getConfigs=function(){return $q(function($resolve,$reject){if(null!=$fm.configs)$resolve($fm.configs)})},$fm}return $scope={filters:{}},$scope.with=function($alias,$context,$resolve){if("undefined"==typeof $alias)return new FilterManager;if("undefined"==typeof $scope.filters[$alias])$scope.filters[$alias]=new FilterManager($alias,$context);if("function"==typeof $resolve)$resolve($scope.filters[$alias]);return $scope.filters[$alias]},$scope}]),siApp.factory("$siTemplate",["$http","$q","$interpolate","$sce",function $siTemplate($http,$q,$interpolate,$sce){let $scope={load:function($path,$template_scope){let templateUrl=$sce.getTrustedResourceUrl(siCtx.base_path+$path),lPromise=$q(function($resolve,$reject){$http.get(templateUrl).then(function($response){let lContent=$scope.interpolate($response.data,$template_scope);$resolve(lContent)})});return lPromise},interpolate:function($content,$template_scope){return $interpolate($content)($template_scope)}};return $scope}]),siApp.factory("$siApi",["$http","$q","$siConfig","$rootScope",function $siApi($http,$q,$siConfig,$rootScope){let $scope={viewMetas:{},api:function($path,$data,$options){let lPromise=$q(function($resolve,$reject){$scope.call($path,$data,$options).then(function($result){$resolve($result)})});return lPromise},rest:function($path,$data,$options){return $scope.rest_call($path,$data,$options)},tokenIsValid:function(){let lNow=new Date;if(null==$scope.auth_token){let lStoredToken=sessionStorage.getItem("si.auth_token");if(null!=lStoredToken&&""!=lStoredToken)$scope.auth_token=JSON.parse(lStoredToken);else return false}let lExpireDate=new Date(Date.parse($scope.auth_token.expire_date));if(lExpireDate<lNow)return false;else return true},renewToken:function(){let lPromise=$q(function($resolve,$reject){$resolve()});return lPromise},getDefaultDataView:function(){let lPromise=$q(function($resolve,$reject){$siConfig.get().then(function($config){if($config.default_view.indexOf("{")>=0)$resolve(JSON.parse($config.default_view).id);else $resolve($config.default_view)})});return lPromise},getViewDictionary:function($view_id,$lang){let lPromise=$q(function($resolve,$reject){$scope.call("view/"+$view_id+"/"+$lang).then(function($response){$resolve($response.dictionary)})});return lPromise},getListConfigs:function($alias){let lPromise=$q(function($resolve,$reject){$siConfig.get().then(function($configs){let lResult=null;$configs.lists.some(function($e){if($e.alias==$alias)return lResult=$e,true}),$resolve(lResult)})});return lPromise},getViewMeta:function($type,$view_id){let lOrigin=$type,lViewMetaKey=$type+"::"+$view_id;switch(lOrigin){case"listings":lOrigin="listing";break;case"brokers":lOrigin="broker";break;case"cities":lOrigin="city";break}let lEndPoint="".concat("view/",$view_id,"/",siApiSettings.locale),lPromise=$q(function($resolve,$reject){if(void 0!=$scope.viewMetas[lViewMetaKey]&&void 0==$scope.viewMetas[lViewMetaKey].loading)$resolve($scope.viewMetas[lViewMetaKey]);else if(void 0!=$scope.viewMetas[lViewMetaKey]&&true==$scope.viewMetas[lViewMetaKey].loading){let fnWait=function(){if(true==$scope.viewMetas[lViewMetaKey].loading)window.setTimeout(fnWait,15);else $resolve($scope.viewMetas[lViewMetaKey])};fnWait()}else $scope.viewMetas[lViewMetaKey]={loading:true},$scope.api(lEndPoint).then(function($response){$scope.viewMetas[lViewMetaKey]=$response,$resolve($response)})});return lPromise},call:function($path,$data,$options){const lApiRoot=siApiSettings.api_root.replace(/\/+$/,"");if($options=angular.merge({url:lApiRoot+"/api/"+$path,method:"undefined"==typeof $data||null==$data?"GET":"POST",data:$data},$options),"GET"==$options.method)if(null!=$options.data)$options.params=$options.data,$options.data=null;let lPromise=$q(function($resolve,$reject){$siConfig.get().then(function($configs){$options.headers={"x-si-account":$configs.account_id,"x-si-api":$configs.api_key,"x-si-appId":$configs.app_id,"x-si-appVersion":$configs.app_version},$http($options).then(function success($result){if("200"==$result.status)$resolve($result.data);else $reject(null)},function fail($error){})})});return lPromise},rest_call:function($path,$data,$options){if($options=angular.merge({url:siApiSettings.rest_root+"si-rest/"+$path,method:"undefined"==typeof $data||null==$data?"GET":"POST",data:$data,headers:{"X-WP-Nonce":siApiSettings.nonce}},$options),"GET"==$options.method)if(null!=$options.data)$options.params=$options.data,$options.data=null;let lPromise=$q(function($resolve,$reject){$http($options).then(function success($result){if("200"==$result.status)$resolve($result.data);else $reject(null)},function fail($error){})});return lPromise}};return $scope}]),siApp.factory("$siDictionary",["$q",function $siDictionary($q){let $scope={source:null,_loadCallbacks:[],init:function($source){if(null==$scope.source)$scope.source=$source;else Object.assign($scope.source,$source);$scope._loadCallbacks.forEach(function($fn){$fn()})},onLoad:function(){if(null!=$scope.source)return $q.resolve();const lDeferred=$q.defer();return $scope._loadCallbacks.push(function(){lDeferred.resolve()}),lDeferred.promise},sortData:function(){for(let lGroup in $scope.source)$scope.source[lGroup]=$scope.sortCollection($scope.source[lGroup])},sortCollection:function($coll){let lCollArray=$scope._toArray($coll);lCollArray.sort(function(a,b){if(a.__data.caption<=b.__data.caption)return-1;else return 1});let lResult=$scope._toObject(lCollArray);return lResult},_toArray:function($object){let lResult=[];for(let $key in $object)lResult.push({__key:$key.toString(),__data:$object[$key]});return lResult},_toObject:function($array){let lResult={};return $array.forEach(function($e){lResult[$e.__key]=$e.__data}),lResult},count:function($domain){let lResult=0;if($scope.source&&$scope.source[$domain]){const lDomainKeys=Object.keys($scope.source[$domain]);lResult=lDomainKeys.length}return lResult},getCaption:function($key,$domain,$asAbbr){if("object"==typeof $key)return $scope.getCaptionFrom($key.src,$key.key,$domain,$asAbbr);const lKeyValue=$key;let lResult=lKeyValue;if($asAbbr=void 0==$asAbbr?false:$asAbbr,$scope.source&&$scope.source[$domain])if(void 0!=$scope.source[$domain][lKeyValue])if($asAbbr)lResult=$scope.source[$domain][lKeyValue].abbr;else lResult=$scope.source[$domain][lKeyValue].caption;return lResult},getCaptionFrom:function($obj,$key,$domain,$asAbbr){let lDictionaryKey=$obj[$key];if("##OTHER##"==lDictionaryKey)lDictionaryKey="_other";if(void 0!=lDictionaryKey&&0==lDictionaryKey.indexOf("_")){const lSrcKey=$key.replace("_code",lDictionaryKey);if(!isNullOrEmpty($obj[lSrcKey]))return $obj[lSrcKey]}return $scope.getCaption(lDictionaryKey,$domain,$asAbbr)}};return $scope}]),siApp.factory("$siList",["$siApi",function $siList($siApi){let $scope={dictionary:null,init:function($view_id){$scope.fetchDictionary($view_id)},fetchDictionary:function($view_id){if(null!=$view_id)$siApi.rest("dictionary").then(function($response){$scope.dictionary=$response})},getCountryList:function(){if(null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.country)},getStateList:function(){if(null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.state)},getRegionList:function(){if(null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.region)},getCityList:function(){if(null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.city)},getCategoryList:function(){if(null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.listing_category)},getSubcategoryList:function(){if(null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.listing_subcategory)},getBuildingCategoryList:function(){if(null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.building_category)},getLicenseList:function(){if(null==$scope.dictionary)return[];else return $scope.toArray($scope.dictionary.broker_license_type)},getOfficeList:function($source_id){if(null==$scope.offices)return[];else return $scope.offices},toArray:function($source){let lResult=[];for($key in $source)lResult.push({key:$key,label:$source[$key].caption});return lResult}};return $scope}]),siApp.factory("$siUtils",["$siDictionary","$siTemplate","$interpolate","$sce","$siConfig","$siHooks","$siList","$q",function $siUtils($siDictionary,$siTemplate,$interpolate,$sce,$siConfig,$siHooks,$siList,$q){let $scope={page_list:[],configs:null,getSingularType:function($type,$toLower){$toLower=void 0==$toLower?true:$toLower;const lTypes={listings:"Listing",brokers:"Broker",offices:"Office",cities:"City"},lResult=lTypes[$type];if(void 0==lResult)return null;if($toLower)return lResult.toLowerCase();else return lResult},getCaption:function($key,$domain,$asAbbr){return $siDictionary.getCaption($key,$domain,$asAbbr)},formatPhone:function($phone){const cleaned=(""+$phone).replace(/\D/g,""),match=cleaned.match(/^(\d{3})(\d{3})(\d{4})$/);if(match)return match[1]+"."+match[2]+"."+match[3];else return null},formatPrice:function($item,$format){$format=void 0!=$format?$format:"short";let lResult=[];if("SOLD"==$item.status_code){if(void 0!=$item.price.sell)lResult.push("Sold".translate());else lResult.push("Rented".translate());return lResult.join("")}for(let $key in $item.price)if(["sell","lease"].indexOf($key)>=0){let lPart=[$item.price[$key].amount.formatPrice()];if($item.price[$key].taxable)lPart[0]+="+tx";if($item.price[$key].unit_code)lPart.push($scope.getCaption($item.price[$key].unit_code,"price_unit",true));if($item.price[$key].period_code)lPart.push($scope.getCaption($item.price[$key].period_code,"price_period"));if("long"==$format){let lStart="for {0} for ".format($key).translate();lResult.push(lStart+'<span class="nowrap">'+lPart.join("/")+"</span>")}else lResult.push(lPart.join("/"))}let lSeperator=" or ".translate();if("long"==$format)lSeperator="<br />"+lSeperator;return lResult.join(lSeperator)},formatDimension:function($dimension){let lResult="";if(void 0!=$dimension)if("undefined"!=typeof $dimension.width){let lUnit=$siDictionary.getCaption($dimension.unit_code,"dimension_unit",true);lResult="{0}{2} x {1}{2}".format($dimension.width,$dimension.length,lUnit)}else if(void 0!=typeof $dimension.area){let lUnit=$siDictionary.getCaption($dimension.area_unit_code,"dimension_unit",true);lResult="{0} {1}".format($dimension.area,lUnit)}return lResult},hasDimension:function($dimension){let lResult=false;if(void 0!=$dimension){if(void 0!=$dimension.width)if(void 0!=$dimension.length)return true;if(void 0!=$dimension.area)return true}return lResult},hasValue:function($values,$arrayOffset){if(void 0==$values)return false;$arrayOffset=void 0==$arrayOffset?0:$arrayOffset;const lValuesToCheck=Array.isArray($values)?$values:[$values];if(0==lValuesToCheck.length)return false;else return lValuesToCheck.some(function($value){if(null==$value)return false;if(Array.isArray($value))return $value.length>$arrayOffset;if("object"===typeof $value)return Object.keys($value).length>0;if("string"==typeof $value)return""!=$value;if(void 0!=$value)return true;else return})},getPermalink:function($item,$type,$configs){let lRoute="";if($type="undefined"==typeof $type?"listing":$type,void 0==siCtx[$type+"_routes"])return"";$scope.item=angular.copy($item),siCtx[$type+"_routes"].forEach(function($r){if($r.lang==siCtx.locale)lRoute=$r});let lMandatoryLocationData=["country","state","region","city"];if($scope.item.location)lMandatoryLocationData.forEach(function($d){if("undefined"==typeof $scope.item.location[$d])$scope.item.location[$d]=("other "+$d).translate()});let lResult=$scope.sanitize("/"+$siTemplate.interpolate(lRoute.route,$scope));if($siConfig._data.enable_custom_page)$scope.page_list.some(function($p){let lCustomPage="";switch($type){case"broker":lCustomPage=lResult.replace("/"+$item.ref_number,"-"+$item.ref_number);break;case"listing":let lRx=new RegExp("/[^/]+/"+$item.ref_number);lCustomPage=lResult.replace(lRx,"/"+$scope.sanitize($item.location.civic_address)+"-"+$item.ref_number);break;case"office":let oRx=new RegExp("/[^/]+/"+$item.ref_number);lCustomPage=lResult.replace(oRx,"/"+$scope.sanitize($item.location.civic_address)+"-"+$item.ref_number);break}if(""!=lCustomPage&&lCustomPage==$p.permalink)return lResult=lCustomPage,true});if(siCtx.use_lang_in_path)lResult="/"+siCtx.locale+lResult;return lResult=$siHooks.filter($type+"_permalink",lResult,$item),lResult},evaluate:function($text,$context){return $interpolate($text)($context)},getPhoneIcon:function($key){let lPhoneIcon={mobile:"mobile",office:"building"};if(void 0!=lPhoneIcon[$key])return lPhoneIcon[$key];else return"phone"},compileListingList:function($list){return $list.forEach(function($e){$scope.compileListingItem($e)}),$list},compileListingItem:function($item){if(void 0==$item.category){if($item.location.city=$scope.getCaption($item.location.city_code,"city"),$item.location.region=$scope.getCaption($item.location.region_code,"region"),$item.subcategory=$scope.getCaption($item.subcategory_code,"listing_subcategory"),$item.category=$scope.getCaption($item.category_code,"listing_category"),$item.transaction=$scope.getTransaction($item),$item.short_price=$scope.formatPrice($item),$item.location.civic_address="{0} {1}".format($item.location.address.street_number,$item.location.address.street_name).trim(),!$scope.isNullOrEmpty($item.location.address.door))$item.location.civic_address+=", "+"apt. {0}".translate().format($item.location.address.door);if(!$scope.isNullOrEmpty($item.available_area))$item.available_area_unit=$scope.getCaption($item.available_area_unit_code,"dimension_unit",true);$scope.compileListingRooms($item),$item.permalink=$scope.getPermalink($item)}},compileBrokerList:function($list){return $siConfig.get().then(function($configs){$siList.getOfficeList($configs.default_view)}),$list.forEach(function($e){$scope.compileBrokerItem($e)}),$list},compileBrokerItem:function($item){if(void 0==$item.permalink)if($item.license_type=$siDictionary.getCaption($item.license_type_code,"broker_license_type"),$item.permalink=$scope.getPermalink($item,"broker"),void 0!=$item.office_ref_number)$officeList=$siList.getOfficeList(),$item.office=$officeList.find(function($e){return $e.ref_number==$item.office_ref_number}),$scope.compileOfficeItem($item.office)},compileListingRooms:function($item){if("undefined"!=typeof $item.main_unit){const lIconRef={bathroom_count:"bath",bedroom_count:"bed",waterroom_count:"hand-holding-water"},lLabelRef={bathroom_count:"Bathroom",bedroom_count:"Bedroom",waterroom_count:"Powder room"},lPluralLabelRef={bathroom_count:"Bathrooms",bedroom_count:"Bedrooms",waterroom_count:"Powder rooms"};$item.rooms={},Object.keys($item.main_unit).forEach(function($k){if($item.main_unit[$k]>0){const lLabel=$item.main_unit[$k]>1?lPluralLabelRef[$k]:lLabelRef[$k];if("undefined"!=typeof lIconRef[$k])$item.rooms[lIconRef[$k]]={count:$item.main_unit[$k],label:lLabel}}})}},compileOfficeList:function($list){$list.forEach(function($e){$scope.compileOfficeItem($e)})},compileOfficeItem:function($item){if(void 0!=$item){if(null!=$item.phones)Object.keys($item.phones).forEach(function($key){$item.phones[$key]=$scope.formatPhone($item.phones[$key])});$item.location.region=$scope.getCaption($item.location.region_code,"region"),$item.location.country=$scope.getCaption($item.location.country_code,"country"),$item.location.state=$scope.getCaption($item.location.state_code,"state"),$item.location.city=$scope.getCaption($item.location.city_code,"city"),$item.location.street_address="{0} {1}".format($item.location.address.street_number,$item.location.address.street_name),$item.location.full_address="{0} {1}, {2}".format($item.location.address.street_number,$item.location.address.street_name,$item.location.city),$item.permalink=$scope.getPermalink($item,"office")}},compileCityList:function($list){$list.forEach(function($e){$scope.compileCityItem($e)})},compileCityItem:function($item){$item.region=$scope.getCaption($item.region_code,"region"),$item.country=$scope.getCaption($item.country_code,"country"),$item.state=$scope.getCaption($item.state_code,"state"),$item.city=$scope.getCaption($item.city_code,"city"),$item.permalink=$scope.getPermalink($item,"city")},getClassList:function($item){let lResult=[];if(null!=$item){if($item.ref_number)lResult.push("ref-"+$item.ref_number);if($item.license)lResult.push("license-"+$item.license.toLowerCase());if($item.license_type_code)lResult.push("license-type-"+$scope.sanitize($item.license_type_code));if("SOLD"==$item.status_code)lResult.push("sold");let lHasFlags=false;if($item.video_flag)lHasFlags=true,lResult.push("has-video");if($item.virtual_tour_flag)lHasFlags=true,lResult.push("has-virtual-tour");if(lHasFlags)lResult.push("has-flags");if(void 0!=$item.open_houses&&$item.open_houses.length>0)lResult.push("has-open-house")}return lResult.join(" ")},getCity:function($item,$sanitize){$sanitize=void 0==$sanitize?true:$sanitize;let lResult=$scope.getCaption($item.location.city_code,"city");if($sanitize)lResult=$scope.sanitize(lResult);return lResult},getRegion:function($item,$sanitize){$sanitize=void 0==$sanitize?true:$sanitize;let lResult=$scope.getCaption($item.location.region_code,"region");if($sanitize)lResult=$scope.sanitize(lResult);return lResult},getTransaction:function($item,$sanitize){$sanitize=void 0==$sanitize?false:$sanitize;let lResult=[];const lLabel={rent:"For rent",lease:"For rent",sell:"For sale"};if(lResult=$scope.getTransactionFromArray($item,["rent","sell"],lLabel,$sanitize),0==lResult.length)lResult=$scope.getTransactionFromArray($item,["lease","sell"],lLabel,$sanitize);return lResult.join(" "+"or".translate()+" ")},getTransactionFromArray:function($item,$keys,$labels,$sanitize){let lResult=[];return $keys.forEach(function($key){if("undefined"!=typeof $item.price[$key]){let lTrans=$labels[$key].translate();if($sanitize)lTrans=$scope.sanitize(lTrans);lResult.push(lTrans)}}),lResult},sanitize:function($value,$useCamelCase){if("undefined"==typeof $value)return"-";$useCamelCase="undefined"==typeof $useCamelCase?false:$useCamelCase;let lResult=$value.toLowerCase();if(lResult=lResult.replace(/(\s|\+)/gm,"-"),lResult=lResult.replace(/('|"|\(|\))/gm,""),lResult=lResult.replace(/(|||)/gm,"e"),lResult=lResult.replace(/(||)/gm,"a"),lResult=lResult.replace(/(||)/gm,"i"),lResult=lResult.replace(/(||)/gm,"u"),lResult=lResult.replace(/(||)/gm,"o"),lResult=lResult.replace(/\./gm,""),$useCamelCase)lResult=lResult.split("-").map(function($e,$i){if(0==$i)return $e;else return $e[0].toUpperCase()+$e.substr(1)}).join("");return lResult},filesize:function($value){const lSizeGroup=["bytes","Kb","Mb","Gb","Tb"];let lSizeDivider=0;while($value>1e3)$value/=1e3,lSizeDivider++;return Math.round(100*$value)/100+lSizeGroup[lSizeDivider].translate()},toArray:function($object){if(!angular.isObject($object))return $object;let lResult=[];for(let objectKey in $object)$object[objectKey].__$key=objectKey,$object[objectKey].__$obj_key=objectKey,lResult.push($object[objectKey]);return lResult},toSortedArray:function($object,$attr){$attr=void 0==$attr?"caption":$attr;let lResult=$scope.toArray($object);return lResult.sort(function(a,b){if(!isNaN(a[$attr]))return a=parseInt(a[$attr]),b=parseInt(b[$attr]),a-b;else if(a[$attr]<=b[$attr])return-1;else return 1}),lResult},search:function(){let lResult={},lSearch=location.search.replace("?","");if(""!=lSearch){let lQueryArr=lSearch.split("&");lQueryArr.forEach(function($item){lKeyValue=$item.split("="),lResult[lKeyValue[0]]=lKeyValue[1]})}return lResult},absolutePosition:function(element){var top=0,left=0;if(void 0!=element){do{top+=element.offsetTop||0,left+=element.offsetLeft||0,element=element.offsetParent}while(element);let lHtmlElm=angular.element("html")[0],lGlobalTop={margin:Number(window.getComputedStyle(lHtmlElm,null).getPropertyValue("margin-top").replace("px","")),padding:Number(window.getComputedStyle(lHtmlElm,null).getPropertyValue("padding-top").replace("px",""))},lGlobalLeft={margin:Number(window.getComputedStyle(lHtmlElm,null).getPropertyValue("margin-left").replace("px","")),padding:Number(window.getComputedStyle(lHtmlElm,null).getPropertyValue("padding-left").replace("px",""))};lGlobalOffsetTop=lGlobalTop.margin+lGlobalTop.padding,lGlobalOffsetLeft=lGlobalLeft.margin+lGlobalLeft.padding,top+=lGlobalOffsetTop,left+=lGlobalOffsetLeft}return{top:top,left:left}},lateCallHndl:null,lateCall:function($func){if(null!=$scope.lateCallHndl)window.clearTimeout($scope.lateCallHndl);$scope.lateCallHndl=window.setTimeout(function(){$func()},500)},appendToUrlQuery:function($url,$key,$value){let lDataPrefix="?";if($url.indexOf("?")>=0)lDataPrefix="&";return $url+lDataPrefix+$key+"="+$value},isNullOrEmpty:function($value){return isNullOrEmpty($value)},isLegacyBrowser:function(){const lUA=window.navigator.userAgent;if(!["Chrome","Safari","Firefox"].some(function($e){return lUA.indexOf($e)>=0}))return true;else return false},all:function($promises){return $q(function($resolve,$reject){const lConvertedPromises=Array.isArray($promises)?$promises:Object.keys($promises).map(function($k){return $promises[$k]()});$q.all(lConvertedPromises).then(function($results){const lConvertedResults=Array.isArray($promises)?$results:Object.keys($promises).reduce(function($result,$k,$index){return $result[$k]=$results[$index],$result},{});$resolve(lConvertedResults)})})},stylesToNum:function($styleList,$source){return $styleList.reduce(function($r,$s){if(void 0==$source[$s])$r[$s]=0;else $r[$s]=Number($source[$s].replace(/\D/gi,""));return $r},{})},elmOffsetZIndex:function($elm){let lElmZindex=window.getComputedStyle($elm).zIndex;if("BODY"==$elm.tagName)return 1;if("auto"==lElmZindex)lElmZindex=1;const lParentZIndex=$scope.elmOffsetZIndex($elm.parentNode);if(!isNaN(lParentZIndex))lElmZindex+=lParentZIndex;return Number(lElmZindex)}};return $scope}]),siApp.factory("$siConfig",["$http","$q",function $siConfig($http,$q){let $scope={_data:null,_loading:false,init:function(){$scope.get()},get:function(){let lPromise=$q(function($resolve,$reject){if(true==$scope._loading){let fnWait=function(){if(true==$scope._loading)window.setTimeout(fnWait,50);else $resolve($scope._data)};fnWait()}else if(null!=$scope._data)$resolve($scope._data);else $scope._loading=true,$http.get(siCtx.config_path).then(function($response){if(200==$response.status)$scope._data=$response.data,$scope._loading=false,$resolve($scope._data);else $reject()})});return lPromise}};return $scope.init(),$scope}]),siApp.factory("$siHooks",["$q",function $siHooks($q){let $scope={_actions:[],_filters:[],addAction:function($key,$func,$priority){let lNewAction={key:$key,fn:$func};if(void 0==$priority||$priority>$scope._actions.length-1)$scope._actions.push(lNewAction);else $scope._actions.splice($priority,0,lNewAction)},addFilter:function($key,$func,$priority){let lNewFilter={key:$key,fn:$func};if(void 0==$priority||$priority>$scope._filters.length-1)$scope._filters.push(lNewFilter);else $scope._filters.splice($priority,0,lNewFilter)},do:function($key,$params){const lActions=[];$scope._actions.forEach(function($a){if($key==$a.key)lActions.push($a)}),lActions.forEach(function($a){$a.fn($params)})},filter:function($key,$default_value,$otherParams){const lFilters=[];return $scope._filters.forEach(function($f){if($key==$f.key)lFilters.push($f)}),$siGlobalHooks._filters.forEach(function($f){if($key==$f.key)lFilters.push($f)}),lFilters.forEach(function($f){$default_value=$f.fn($default_value,$otherParams)}),$default_value}};return $scope}]),siApp.factory("$siFavorites",["$q",function $siFavorites($q){let $scope={favorites:[],init:function(){if($scope.favorites=JSON.parse(localStorage.getItem("favorites")),null==$scope.favorites)$scope.favorites=[]},save:function(){localStorage.setItem("favorites",JSON.stringify($scope.favorites))},hasFavorites:function(){return $scope.favorites.length>0},toggle:function($item){if(false===$scope.isFavorite($item.ref_number))$item.added_to_fav=new Date,$scope.favorites.push($item),$scope.save();else $scope.favorites=$scope.favorites.filter(function($e){return $e.ref_number!=$item.ref_number}),$scope.save()},isFavorite:function($ref_number){return $scope.favorites.some(function($e){return $e.ref_number==$ref_number})},isEmpty:function(){return 0==$scope.favorites.length},getValues:function(){if(0==$scope.favorites.length)return[];else return $scope.favorites.map(function($e){return $e.ref_number})}};return $scope.init(),$scope}]),siApp.factory("$siShare",["$q","$siHooks","$siUtils",function siShare($q,$siHooks,$siUtils){let $scope={data:{url:null,url_timed:null,text:null,media:null,title:null},init:function(){$scope.data.url=window.location.href,$scope.data.title=document.title,$scope.data.description=document.description},execute:function($dest){let lShareUrl=$scope.get_destination_format($dest);if(null==$scope.data.url)return false;if($scope.data=$siHooks.filter("si.share.data",$scope.data),null!=$scope.data.url&&null==$scope.data.url_timed)$scope.data.url_timed=$siUtils.appendToUrlQuery($scope.data.url,"t",moment().valueOf());for($key in $scope.data)lShareUrl=lShareUrl.replace("["+$key+"]",escape($scope.data[$key]));window.open(lShareUrl)},get_destination_format:function($dest){let lFormats={facebook:"https://www.facebook.com/sharer/sharer.php?u=[url_timed]",twitter:"https://twitter.com/intent/tweet?url=[url]",pinterest:"http://pinterest.com/pin/create/button/?url=[url]&media=[media]&description=[title]",googleplus:"https://plus.google.com/share?url=[url]",linkedin:"https://www.linkedin.com/sharing/share-offsite/?url=[url]",email:"mailto:?subject=[title]&body=[url]&v=3"};return lFormats[$dest]}};return $scope.init(),$scope}]),siApp.filter("range",function rangeFilter(){return function($items,$lowerBound,$upperBound){if(null==$items)return null;$items.forEach(function($e,$i){$e.index=$i});let lRange=$upperBound-$lowerBound;if(lRange>$items.length)lRange=$items.length,$lowerBound=0,$upperBound=$items.length-1;else if($lowerBound<0)$lowerBound=0,$upperBound=$lowerBound+lRange;else if($upperBound>$items.length-1)$upperBound=$items.length-1,$lowerBound=$upperBound-lRange;let lResult=$items.filter(function($e,$i){return $lowerBound<=$i&&$i<$upperBound});return lResult}}),siApp.filter("asArray",function asArrayFilter(){return function($object){const lResult=[];if($object)Object.keys($object).forEach(function($k){$object[$k].__$key=$k,lResult.push($object[$k])});return lResult}}),siApp.filter("orderObjectBy",function orderObjectByFilter(){return function(input,attribute){if(!angular.isObject(input))return input;const lResult=[];return Object.keys(input).forEach(function($k){input[$k].__$key=$k,lResult.push(input[$k])}),lResult.sort(function(a,b){if(!isNaN(a[attribute]))return a=parseInt(a[attribute]),b=parseInt(b[attribute]),a-b;else if(a[attribute]<=b[attribute])return-1;else return 1}),lResult}}),siApp.filter("textToHtml",[function textToHtml(){return function($value){if(null==$value||void 0==$value)return"";const tagRegex=/<[^>]+>/gm;if($matches=tagRegex.exec($value),null!=$matches&&$matches.length>0)return $value;let lReplacements=[{match:/(\n{2,})/gm,by:"</p><p>",wrap_by:"p"},{match:/(\n)/g,by:"<br />"}];return lReplacements.forEach(function($e){if($value=$value.replace($e.match,$e.by),void 0!=$e.wrap_by)$value="<"+$e.wrap_by+">"+$value+"</"+$e.wrap_by+">"}),$value}}]),siApp.filter("siHasValue",["$siUtils",function siHasValueFilter($siUtils){return function($values,$arrayOffset){return $siUtils.hasValue($values,$arrayOffset)}}]),siApp.filter("formatDimension",["$siUtils",function dimensionFilter($siUtils){return function($value){return $siUtils.formatDimension($value)}}]),siApp.filter("filesize",["$siUtils",function filesize($siUtils){return function($value){return $siUtils.filesize($value)}}]),siApp.filter("sanitize",["$siUtils",function sanitize($siUtils){return function($value){return $siUtils.sanitize($value)}}]),siApp.filter("iconFromType",["$siUtils",function iconFromType($siUtils){return function($value){let lTypeIcons={listing:"home",broker:"user",city:"map-marker-alt",region:"directions"};return lTypeIcons[$value]}}]),siApp.filter("wrapWith",["$siUtils",function wrapWith(){return function($text,$tag,$search,$startingAt){if($startingAt="undefined"==typeof $startingAg?0:$startingAt,"undefined"==typeof $search)return $text;if($text.search($search)<$startingAt)return $text;let lResult=$text,lMatchText=$text.match($search)[0],lTagWrap="<"+$tag+">"+lMatchText+"</"+$tag+">";return lResult=$text.replace($search,lTagWrap),lResult}}]);const findProperty=function($source,$path){let lPathParts=$path.split("."),lCursor=$source,lResult=null;return lPathParts.forEach(function($e){if("undefined"!=typeof lCursor[$e])lCursor=lCursor[$e],lResult=lCursor;else lResult=null}),lResult};