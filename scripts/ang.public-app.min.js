var ImmoDbApp=angular.module("ImmoDb",["ngSanitize"]);ImmoDbApp.controller("publicCtrl",function publicCtrl($scope,$rootScope,$immodbDictionary,$immodbUtils){$scope.model=null,$scope.broker_count=0,$scope.listing_count=0,$scope.init=function(){},$scope.$on("immodb-listings-update",function($event,$list,$meta){$scope.listing_count=$meta.item_count}),$scope.$on("immodb-brokers-update",function(ev,$list,$meta){$scope.broker_count=$meta.item_count}),$scope.getCaption=function($key,$domain,$asAbbr){return $immodbDictionary.getCaption($key,$domain,$asAbbr)},$rootScope.formatPrice=function($item){return $immodbUtils.formatPrice($item)},$scope.scrollTo=function($target){let opt={duration:250,easing:"swing"},position=angular.element($target).offset().top;angular.element("html, body").animate({scrollTop:position},opt)}}),ImmoDbApp.controller("singleListingCtrl",function singleListingCtrl($scope,$q,$immodbApi,$immodbDictionary,$immodbUtils,$immodbConfig){$scope.model=null,$scope.permalinks=null,$scope.sections={addendum:{opened:!0},building:{opened:!1},lot:{opened:!1},other:{opened:!1},in_exclusions:{opened:!1}},$scope.selected_media="pictures",$scope.calculator_result={},$scope.message_model={},$scope.init=function($ref_number){void 0!=$ref_number&&(console.log($ref_number),$scope.fetchPrerequisites().then(function(){$scope.loadSingleData($ref_number)}))},$scope.fetchPrerequisites=function(){let lPromise;return $q(function($resolve,$reject){$immodbConfig.get().then(function($configs){$resolve({brokers:$configs.broker_routes,listings:$configs.listing_routes})})})},$scope.loadSingleData=function($ref_number){let lPromise;$q(function($resolve,$reject){"undefined"!=typeof immodbListingData?$resolve(immodbListingData):$immodbApi.getDefaultDataView().then(function($view){console.log($view),$immodbApi.api("listing/view/{0}/{1}/items/ref_number/{2}".format($view.id,immodbApiSettings.locale,$ref_number)).then(function($data){$resolve($data)})})}).then(function($data){$scope.model=$data,$immodbDictionary.source=$data.dictionary,$scope.preprocess(),$scope.message_model.subject="Request information for : {0} ({1})".translate().format($scope.model.location.full_address,$scope.model.ref_number),console.log($scope.model)})},$scope.preprocess=function(){$scope.model.location.city=$scope.getCaption($scope.model.location.city_code,"city"),$scope.model.location.region=$scope.getCaption($scope.model.location.region_code,"region"),$scope.model.location.country=$scope.getCaption($scope.model.location.country_code,"country"),$scope.model.location.state=$scope.getCaption($scope.model.location.state_code,"state"),$scope.model.category=$scope.getCaption($scope.model.category_code,"listing_category"),$scope.model.subcategory=$scope.getCaption($scope.model.subcategory_code,"listing_subcategory"),$scope.model.addendum=$scope.model.addendum?$scope.model.addendum.trim():null,$scope.model.location.full_address="{0} {1}, {2}".format($scope.model.location.address.street_number,$scope.model.location.address.street_name,$scope.model.location.city),$scope.model.building.attributes=[],$scope.model.lot={attributes:[]},$scope.model.other={attributes:[]},$scope.model.important_flags=[],$scope.model.long_price=$immodbUtils.formatPrice($scope.model,"long");let lMainUnit=$scope.model.units.find(function($u){return"MAIN"==$u.category});null!=lMainUnit&&(lMainUnit.bedroom_count&&$scope.model.important_flags.push({icon:"bed",value:lMainUnit.bedroom_count,caption:"Bedroom".translate()}),lMainUnit.bathroom_count&&$scope.model.important_flags.push({icon:"bath",value:lMainUnit.bathroom_count,caption:"Bathroom".translate()}),lMainUnit.waterroom_count&&$scope.model.important_flags.push({icon:"hand-holding-water",value:lMainUnit.waterroom_count,caption:"Water room".translate()})),$scope.model.attributes.forEach(function($e){if($e.caption=$scope.getCaption($e.code,"attribute"),$e.values.forEach(function($v){$v.caption=$scope.getCaption($v.code,"attribute_value"),$v.count&&($v.caption=$v.caption.concat(" ({0})".format($v.count))),$v.details&&($v.caption=$v.details)}),["CUPBOARD","WINDOWS","WINDOW TYPE","ROOFING","FOUNDATION","GARAGE","SIDING","BATHR./WASHR","BASEMENT"].includes($e.code)?$scope.model.building.attributes.push($e):["LANDSCAPING","DRIVEWAY","PARKING","POOL","TOPOGRAPHY","VIEW","ZONING","PROXIMITY"].includes($e.code)?$scope.model.lot.attributes.push($e):["HEATING SYSTEM","HEATING ENERGY","HEART STOVE","WATER SUPPLY","SEWAGE SYST.","EQUIP. AVAIL"].includes($e.code)&&$scope.model.other.attributes.push($e),"PARKING"==$e.code){let lParkingCount=0;$e.values.forEach(function($v){lParkingCount+=$v.count}),lParkingCount>0&&$scope.model.important_flags.push({icon:"car",value:lParkingCount,caption:$e.caption})}"POOL"==$e.code&&$scope.model.important_flags.push({icon:"swimmer",value:0,caption:$e.caption}),"HEART STOVE"==$e.code&&$scope.model.important_flags.push({icon:"fire",value:0,caption:$e.caption})});let lRoute=$scope.permalinks.brokers.find(function($r){return $r.lang==immodbCtx.locale});$scope.model.brokers.forEach(function($e){$e.detail_link=$immodbUtils.evaluate(lRoute.route,{item:$e}),$e.license_type=$scope.getCaption($e.license_type_code,"broker_license_type")})},$scope.sectionOpened=function($section){return $scope.sections[$section].opened},$scope.toggleSection=function($section){$scope.sections[$section].opened=!$scope.sections[$section].opened},$scope.onMortgageChange=function($calculatorResult){$scope.calculator_result=$calculatorResult},$scope.sendMessage=function(){console.log("message data:",$scope.message_model)}}),ImmoDbApp.controller("singleBrokerCtrl",function singleBrokerCtrl($scope,$q,$immodbApi,$immodbDictionary,$immodbUtils){$scope.filter_keywords="",$scope.model=null,$scope.permalinks=null,$scope.sections={addendum:{opened:!0},building:{opened:!1},lot:{opened:!1},other:{opened:!1},in_exclusions:{opened:!1}},$scope.selected_media="pictures",$scope.calculator_result={},$scope.message_model={},$scope.init=function($ref_number){void 0!=$ref_number&&(console.log($ref_number),$scope.fetchPrerequisites().then(function(){$scope.loadSingleData($ref_number)}))},$scope.fetchPrerequisites=function(){let lPromise;return $q(function($resolve,$reject){null!=$scope.permalinks?$resolve():$immodbApi.rest("permalinks").then(function($response){$scope.permalinks=$response,$resolve()})})},$scope.loadSingleData=function($ref_number){$immodbApi.getDefaultDataView().then(function($view){console.log($view),$immodbApi.api("broker/view/{0}/{1}/items/ref_number/{2}".format($view.id,immodbApiSettings.locale,$ref_number)).then(function($data){$scope.model=$data,$immodbDictionary.source=$data.dictionary,$scope.preprocess(),console.log($scope.model)})})},$scope.preprocess=function(){$scope.model.license_type=$scope.getCaption($scope.model.license_type_code,"broker_license_type"),$scope.model.languages="N/A".translate();let lExpertises=[];$scope.model.listings.forEach(function($e,$i,$arr){let lNewItem=$scope.getCaption($e.category,"listing_category");lExpertises.indexOf(lNewItem)<0&&lExpertises.push(lNewItem)}),$scope.model.expertises=lExpertises.join(", "),$scope.list=$scope.model.listings,$scope.model.office.location.country=$scope.getCaption($scope.model.office.location.country_code,"country"),$scope.model.office.location.state=$scope.getCaption($scope.model.office.location.state_code,"state"),$scope.model.office.location.full_address="{0} {1}, {2}".format($scope.model.office.location.address.street_number,$scope.model.office.location.address.street_name,$scope.model.office.location.city),$scope.model.location=$scope.model.office.location,$immodbUtils.compileListingList($scope.model.listings)},$scope.getPhoneIcon=function($key){let lPhoneIcon={mobile:"mobile",office:"building"};return void 0!=lPhoneIcon[$key]?lPhoneIcon[$key]:"phone"},$scope.filterListings=function($listing){return void 0==$scope.filter_keywords||""==$scope.filter_keywords||($listing.description&&$listing.description.toLowerCase().indexOf($scope.filter_keywords.toLowerCase())>=0?(console.log("found kw in description"),!0):$listing.price.sell&&$listing.price.sell.amount.toString().indexOf($scope.filter_keywords)>=0?(console.log("found kw in price sell"),!0):$listing.price.rent&&$listing.price.rent.amount.toString().indexOf($scope.filter_keywords)>=0?(console.log("found kw in price rent"),!0):$listing.location.city.toLowerCase().indexOf($scope.filter_keywords.toLowerCase())>=0&&(console.log("found kw in city"),!0))},$scope.sectionOpened=function($section){return $scope.sections[$section].opened},$scope.toggleSection=function($section){$scope.sections[$section].opened=!$scope.sections[$section].opened},$scope.onMortgageChange=function($calculatorResult){$scope.calculator_result=$calculatorResult},$scope.sendMessage=function(){console.log("message data:",$scope.message_model)}}),ImmoDbApp.directive("immodbList",function immodbList(){return{restrict:"E",scope:{alias:"@immodbAlias",class:"@immodbClass"},controllerAs:"ctrl",template:'<div ng-include="\'immodb-template-for-\' + alias" class="{{class}}"></div>',link:function($scope){$scope.init()},controller:function($scope,$q,$immodbApi,$rootScope,$immodbDictionary,$immodbUtils){$scope.configs=null,$scope.list=[],$scope.page=1,$scope.meta=null,$scope.dictionary={},$scope.auth_token=null,$scope.is_ready=!1,$scope.display_mode="list",$scope.page_index=0,$scope.is_loading_data=!1,$scope.client={search_token:null},$scope.init=function(){console.log("initializing list for "+$scope.alias),$immodbApi.getListConfigs($scope.alias).then(function($configs){$scope.configs=$configs,$immodbApi.renewToken().then(function(){$scope.start()})}),$rootScope.$on($scope.alias+"FilterTokenChanged",$scope.onFilterTokenChanged)},$scope.start=function(){$immodbApi.getViewMeta($scope.configs.type,$scope.configs.source.id).then(function($response){$immodbDictionary.init($response.dictionary),$scope.dictionary=$response.dictionary,$scope.is_ready=!0,$scope.getList()})},$scope.getList=function(){$scope.search($scope.getSearchToken())},$scope.getSearchToken=function(){return null!=$scope.client.search_token?$scope.client.search_token:$scope.configs.search_token},$scope.onFilterTokenChanged=function($event,$newToken){console.log("Filter token changed"),$scope.client.search_token=$newToken,$scope.isReady().then(function(){$scope.getList()})},$scope.isReady=function(){return $q(function($resolve,$reject){if($scope.is_ready)$resolve();else{let lIntervalHnd=null;lIntervalHnd=window.setInterval(function(){$scope.is_ready&&(window.clearInterval(lIntervalHnd),$resolve())},500)}})},$scope.search=function($token){lParams={st:$token},$scope.page_index=0,console.log("search called loading:",$scope.is_loading_data),0==$scope.is_loading_data&&($scope.is_loading_data=!0,console.log("search called api"),$immodbApi.api($scope.getEndpoint()+"/items",lParams,{method:"GET"}).then(function($response){"listings"==$scope.configs.type?$scope.list=$immodbUtils.compileListingList($response.items):$scope.list=$response.items,$scope.listMeta=$response.metadata,$scope.is_loading_data=!1,console.log("Broadcasting list on","immodb-"+$scope.configs.type+"-update","..."),$rootScope.$broadcast("immodb-"+$scope.configs.type+"-update",$scope.list,$scope.listMeta),$scope.$emit("immodb-"+$scope.configs.type+"-update",$scope.list,$scope.listMeta),console.log("The list",$scope.list)}))},$scope.checkNextPage=function(){null!=$scope.listMeta&&$scope.page_index<2&&$scope.listMeta.next_token&&$scope.showNextPage()},$scope.showNextPage=function(){lParams={st:$scope.listMeta.search_token,nt:$scope.listMeta.next_token},console.log($scope.is_loading_data,"loading page",$scope.page_index+1),$scope.is_loading_data||(console.log,$scope.is_loading_data=!0,$immodbApi.api($scope.getEndpoint()+"/items",lParams,{method:"GET"}).then(function($response){let lNewItems=$response.items;"listings"==$scope.configs.type&&(lNewItems=$immodbUtils.compileListingList(lNewItems)),$scope.list=$scope.list.concat(lNewItems),$scope.listMeta=$response.metadata,$scope.page_index++,$scope.$emit("immodb-"+$scope.configs.type+"-update",$scope.list,$scope.listMeta),window.setTimeout(function(){$scope.is_loading_data=!1},500)}))},$scope.getEndpoint=function(){let lOrigin=$scope.configs.type;switch(lOrigin){case"listings":lOrigin="listing";break;case"brokers":lOrigin="broker";break;case"cities":lOrigin="city"}return lOrigin.concat("/view/",$scope.configs.source.id,"/",immodbApiSettings.locale)},$scope.todo=function(){alert("TODO")},$scope.sortByPrice=function($more_to_least){let lNewSortFields={field:"price.sell.amount",desc:$more_to_least};$rootScope.$broadcast($scope.alias+"SortDataChanged",lNewSortFields)},$scope.sortByDate=function($more_to_least){let lNewSortFields={field:"contract.start_date",desc:$more_to_least};$rootScope.$broadcast($scope.alias+"SortDataChanged",lNewSortFields)},$scope.sortByName=function($more_to_least){let lNewSortFields={field:"last_name",desc:$more_to_least};$rootScope.$broadcast($scope.alias+"SortDataChanged",lNewSortFields)},$scope.sortByListingCount=function($more_to_least){let lNewSortFields={field:"listings_count",desc:$more_to_least};$rootScope.$broadcast($scope.alias+"SortDataChanged",lNewSortFields)},$scope.getCaption=function($key,$domain,$asAbbr){return $immodbDictionary.getCaption($key,$domain,$asAbbr)},$scope.formatPrice=function($item){return $immodbUtils.formatPrice($item)},$scope.getClassList=function($item){return $immodbUtils.getClassList($item)},$scope.switchDisplayTo=function($mode){$scope.display_mode!=$mode&&($scope.display_mode=$mode,$rootScope.$broadcast("immodb-{0}-display-switch-{1}".format($scope.alias,$mode)))},$scope.getCity=function($item,$sanitize){return $immodbUtils.getCity($item,$sanitize)},$scope.getRegion=function($item,$sanitize){return $immodbUtils.getRegion($item,$sanitize)},$scope.getTransaction=function($item,$sanitize){return $immodbUtils.getTransaction($item,$sanitize)}}}}),ImmoDbApp.directive("immodbSearch",function immodbSearch(){return{restrict:"E",replace:!0,scope:{alias:"@immodbAlias",class:"@class",configs:"=?immodbConfigs",dictionary:"=?immodbDictionary",result_url:"@immodbResultUrl"},controllerAs:"ctrl",template:"<div ng-include=\"'immodb-search-for-' + alias\"></div>",link:function($scope){$scope.init()},controller:function($scope,$q,$immodbApi,$rootScope,$immodbDictionary,$immodbUtils){let lToday=(new Date).round();$scope.is_ready=!1,$scope.tab_category="RESIDENTIAL",$scope.tab_region="",$scope.regions=[],$scope.geolocation_available=void 0!=navigator.geolocation,$scope.sort_fields=[],$scope.selected_price_input="min",$scope.keyword="",$scope.priceSuggestions=[],$scope.bedroomSuggestions=[],$scope.bathroomSuggestions=[],$scope.parkingSuggestions=[],$scope.filterHints=[],$scope.suggestions=[],$scope.query_text=null,$scope.data={keyword:"",min_price:null,max_price:null,location:null},$scope.filter_group={operator:"and",filters:null,filter_groups:null},$scope.listing_states={sold:{caption:"Sold",filter:{field:"status_code",operator:"not_equal_to",value:"AVAILABLE"}},sell:{caption:"To sell",filter:{field:"price.sell.amount",operator:"greater_than",value:0}},lease:{caption:"To lease",filter:{field:"price.lease.amount",operator:"greater_than",value:0}},open_house:{caption:"Open house",filter:{field:"price.sell.amount",operator:"greater_than",value:0}},forclosure:{caption:"Foreclosure",filter:{field:"price.foreclosure",operator:"equal",value:!0}}},$scope.listing_ages=[{selected:!0,caption:"No limit".translate(),filter:{field:"contract.start_date",operator:"greater_than",value:""}},{caption:"7 days".translate(),filter:{field:"contract.start_date",operator:"greater_than",value:lToday.addDays(-7).toJSON()}},{caption:"1 month".translate(),filter:{field:"contract.start_date",operator:"greater_than",value:lToday.addMonths(-1).toJSON()}},{caption:"6 months".translate(),filter:{field:"contract.start_date",operator:"greater_than",value:lToday.addMonths(-6).toJSON()}},{caption:"1 year".translate(),filter:{field:"contract.start_date",operator:"greater_than",value:lToday.addYears(-1).toJSON()}}],$scope.listing_attributes={pool:{caption:"Pool",field:"attributes.POOL"},fireplace:{caption:"Fireplace",field:"attributes.HEART_STOVE"},garage:{caption:"Garage",field:"attributes.GARAGE"},waterfront:{caption:"Water front",field:"attributes.WATER_FRONT"},panoramicview:{caption:"Panoramic view",field:"attributes.PANORAMIC_VIEW"}},$scope.init=function(){$rootScope.$on($scope.alias+"SortDataChanged",$scope.onSortDataChanged),$scope.buildDropdownSuggestions(),$scope.loadState();let lStoredSearchToken=$scope.loadState("st");lStoredSearchToken&&$rootScope.$broadcast($scope.alias+"FilterTokenChanged",lStoredSearchToken),$scope.isReady().then(function(){$scope.syncFiltersToUI(),$scope.hasFilters()&&$scope.buildHints()})},$scope.isReady=function(){let lPromise;return null!=$scope.dictionary&&null!=$scope.configs&&($scope.is_ready=!0),$q(function($resolve,$reject){0==$scope.is_ready?$scope.getConfigs().then(function($configs){$scope.configs=$configs,$immodbApi.getViewMeta($configs.type,$configs.source.id).then(function($response){$scope.dictionary=$response.dictionary,$scope.is_ready=!0,$resolve()})}):$resolve()})},$scope.getCategoryIcon=function($key){return lIconset={RESIDENTIAL:"home",COM:"shopping-bag",FARM:"paw",LOT:"tree-alt","MULTI-FAMILY":"building","REVENUE PROP":"usd-square"},lIconset[$key]},$scope.changeCategoryTab=function($key){$scope.tab_category=$key},$scope.changeRegionTab=function($key){$scope.tab_region=$key},$scope.buildDropdownSuggestions=function(){$scope.updatePriceSuggestions();for(let i=1;i<6;i++)$scope.bedroomSuggestions.push({value:i,label:"{0}+ bedrooms".translate().format(i)}),$scope.bathroomSuggestions.push({value:i,label:"{0}+".format(i),caption:"{0}+ bathrooms".translate().format(i)}),$scope.parkingSuggestions.push({value:i,label:"{0}+".format(i),caption:"{0}+ parking spaces".translate().format(i)})},$scope.buildSuggestions=function($event){let lResult=[];if($scope.trapKeyCode($event.keyCode))return!1;if(""!=$scope.data.keyword)if(isNaN($scope.data.keyword)){let lValue=$scope.data.keyword.toLowerCase();if(lResult=[{selected:!0,label:'Contains "{0}"'.translate().format(lValue),action:function(){$scope.query_text=lValue,$scope.buildFilters(),$scope.buildHints()}}],"listings"==$scope.configs.type){for($key in $scope.dictionary.listing_category){let lElm=$scope.dictionary.listing_category[$key];lElm.caption.toLowerCase().indexOf(lValue)>=0&&lResult.push({label:"{0} (category)".translate().format(lElm.caption),action:function(){lElm.selected=!0,$scope.addFilter("category","in",$scope.getSelection($scope.dictionary.listing_category))}})}for($key in $scope.dictionary.listing_subcategory){let lElm=$scope.dictionary.listing_subcategory[$key];lElm.caption.toLowerCase().indexOf(lValue)>=0&&lResult.push({label:"{0} (subcategory)".translate().format(lElm.caption),action:function(){lElm.selected=!0,$scope.addFilter("subcategory","in",$scope.getSelection($scope.dictionary.listing_subcategory))}})}for($key in $scope.dictionary.region){let lElm=$scope.dictionary.region[$key];lElm.caption.toLowerCase().indexOf(lValue)>=0&&lResult.push({label:"{0} (region)".translate().format(lElm.caption),action:function(){lElm.selected=!0,$scope.addFilter("location.region_code","in",$scope.getSelection($scope.dictionary.region))}})}for($key in $scope.dictionary.city){let lElm=$scope.dictionary.city[$key];lElm.caption.toLowerCase().indexOf(lValue)>=0&&lResult.push({label:"{0} (city)".translate().format(lElm.caption),action:function(){lElm.selected=!0,$scope.addFilter("location.city_code","in",$scope.getSelection($scope.dictionary.city))}})}}else"brokers"==$scope.configs.type&&(lResult.push({label:'Last name is "{0}"'.translate().format($scope.data.keyword),action:function(){$scope.addFilter("last_name","equal_to",$scope.data.keyword,'Last name is "{0}"'.translate().format($scope.data.keyword)),$scope.buildFilters(),$scope.buildHints()}}),lResult.push({label:'Last name starts with "{0}"'.translate().format(lValue),action:function(){$scope.addFilter("last_name","starts_with",lValue,'Last name starts with "{0}"'.translate().format(lValue)),$scope.buildFilters(),$scope.buildHints()}}),lResult.push({label:'Last name ends with "{0}"'.translate().format(lValue),action:function(){$scope.addFilter("last_name","ends_with",lValue,'Last name ends with "{0}"'.translate().format(lValue)),$scope.buildFilters(),$scope.buildHints()}}),lResult.push({label:'First name is "{0}"'.translate().format($scope.data.keyword),action:function(){$scope.addFilter("first_name","equal_to",$scope.data.keyword,'First name is "{0}"'.translate().format($scope.data.keyword)),$scope.buildFilters(),$scope.buildHints()}}),lResult.push({label:'First name starts with "{0}"'.translate().format(lValue),action:function(){$scope.addFilter("first_name","starts_with",lValue,'First name starts with "{0}"'.translate().format(lValue)),$scope.buildFilters(),$scope.buildHints()}}),lResult.push({label:'First name ends with "{0}"'.translate().format(lValue),action:function(){$scope.addFilter("first_name","ends_with",lValue,'First name ends with "{0}"'.translate().format(lValue)),$scope.buildFilters(),$scope.buildHints()}}))}else{let lValue=Number($scope.data.keyword),lPriceMin=Math.max(0,lValue/2),lPriceMax=Math.min(1e6,2*lValue);lResult=[{selected:!0,label:'ID is "{0}"'.translate().format(lValue),action:function(){$scope.addFilter("ref_number","equal_to",lValue,'ID is "{0}"'.translate().format(lValue))}}],"listings"==$scope.configs.type&&(lResult=lResult.concat([{label:"Price is less than {0}".translate().format(lValue.formatPrice()),action:function(){$scope.setMaxPrice(lValue)}},{label:"Price is more than {0}".translate().format(lValue.formatPrice()),action:function(){$scope.setMinPrice(lValue)}},{label:"Price is between {0} and {1}".translate().format(lPriceMin.formatPrice(),lPriceMax.formatPrice()),action:function(){$scope.setMinPrice(lPriceMin),$scope.setMaxPrice(lPriceMax)}},{label:'Has "{0}" as civic address'.translate().format(lValue),action:function(){$scope.addFilter("location.address.street_number","equal_to",lValue,'Has "{0}" as civic address'.translate().format(lValue))}}]))}$scope.suggestions=lResult},$scope.trapKeyCode=function($keyCode){let lSelectedIndex=0,lResult=!1;switch($keyCode){case 13:let lPassthrough;$scope.suggestions.every(function($e,$i){return console.log($i,$e.selected),!0!==$e.selected||($e.action(),lResult=!0,!1)})&&($scope.suggestions[0].action(),lResult=!0),$scope.data.keyword="",$scope.suggestions=[];break;case 38:$scope.suggestions.every(function($e,$i){return!0!==$e.selected||(lSelectedIndex=$i,delete $e.selected,!1)}),lSelectedIndex=Math.max(lSelectedIndex-1,0),$scope.suggestions[lSelectedIndex].selected=!0,lResult=!0;break;case 40:$scope.suggestions.every(function($e,$i){return void 0==$e.selected||!0!==$e.selected||(lSelectedIndex=$i,delete $e.selected,!1)}),lSelectedIndex=Math.min(lSelectedIndex+1,$scope.suggestions.length-1),$scope.suggestions[lSelectedIndex].selected=!0,lResult=!0}return lResult},$scope.selectPriceInput=function($value){$scope.selected_price_input=$value,$scope.updatePriceSuggestions()},$scope.updatePriceSuggestions=function(){$scope.priceSuggestions=$scope.getPriceSuggestions($scope.selected_price_input)},$scope.getPriceSuggestions=function($minOrMax){let lResult=[],lMinPrice=$scope.min_price||1e4,lMaxPrice=$scope.max_price||5e5,lStartAt=1e4,lEndsAt=1e5,lStep=1e4;"max"==$minOrMax&&(lStep=((lEndsAt=(lStartAt=Math.max(lMinPrice+5e4,lMaxPrice-2e5))+5e5)-lStartAt)/10),"min"==$minOrMax&&lResult.push({value:"",label:"Min"});for(let $i=lStartAt;$i<=lEndsAt;$i+=lStep)lResult.push({value:$i,label:$i.formatPrice()});return"max"==$minOrMax&&lResult.push({value:"",label:"Max"}),lResult},$scope.setPrice=function($value,$eventOrInput){let lInput=$scope.selected_price_input;"string"==typeof $eventOrInput&&(lInput=$eventOrInput),$scope.data[lInput+"_price"]=""==$value?void 0:$value,"min"==$scope.selected_price_input&&$eventOrInput&&"string"!=typeof $eventOrInput&&($eventOrInput.stopPropagation(),$scope.selectPriceInput("max"))},$scope.setBedroomCount=function($item){$scope.bedroomSuggestions.forEach(function($e){$e.selected=!1}),$item.selected=!0,$scope.addFilter("main_unit.bedroom_count","greater_or_equal_to",$item.value,"{0}+ bedrooms".translate().format($item.value),function(){$scope.setBedroomCount({value:""})})},$scope.syncFiltersToUI=function(){let lListSync={category_code:"listing_category",subcategory_code:"listing_subcategory","location.city_code":"city","location.region_code":"region","building.category_code":"building_category"};null!=$scope.filter_group&&null!=$scope.filter_group.filters&&$scope.filter_group.filters.forEach(function($e,$i){if(void 0!=lListSync[$e.field]){let lDictionaryKey=lListSync[$e.field];$scope.dictionary[lDictionaryKey]&&$scope.syncToList($e,$scope.dictionary[lDictionaryKey])}else $e.label&&($scope.syncToList($e,$scope.listing_attributes),$scope.syncToList($e,$scope.listing_states))})},$scope.syncToList=function($filter,$list){let lListArray;$immodbUtils.toArray($list).forEach(function($e){"in"==$filter.operator&&$filter.value.indexOf($e.__$key)>=0?$list[$e.__$key].selected||($list[$e.__$key].selected=!0):$e.field==$filter.field?$e.selected||($e.selected=!0):void 0!=$e.filter&&$e.filter.field==$filter.field&&($e.selected||($e.selected=!0))})},$scope.setState=function($item){let lValue=$item.filter.value;1!=$item.selected&&(lValue=""),$scope.addFilter($item.filter.field,$item.filter.operator,lValue,$item.caption.translate(),function(){$item.selected="",$scope.setState($item)})},$scope.buildHints=function(){let lResult=[];if(lResult=$scope.buildFilterHints($scope.filter_group),void 0!=$scope.data.min_price||void 0!=$scope.data.max_price){let lPriceHint=["Min","Max"];void 0!=$scope.data.min_price&&(lPriceHint[0]=$scope.data.min_price.formatPrice()),void 0!=$scope.data.max_price&&(lPriceHint[1]=$scope.data.max_price.formatPrice()),lResult.push({item:"PRICE",label:lPriceHint.join(" - "),reverse:function(){$scope.setPrice("","min"),$scope.setPrice("","max")}})}null!=$scope.query_text&&lResult.push({item:"QUERY_TEXT",label:'Contains "{0}"'.translate().format($scope.query_text),reverse:function(){$scope.query_text=null,$scope.buildFilters(),$scope.buildHints()}}),console.log("hint for data",$scope.data),null!=$scope.data.location&&lResult.push({item:"NEAR_ME",label:"Near me".translate(),reverse:function(){$scope.data.location=null,$scope.buildFilters(),$scope.buildHints()}}),console.log("hints",lResult),$scope.filterHints=lResult},$scope.buildFilterHints=function($group){let lResult=[],lListSync={category_code:"listing_category",subcategory_code:"listing_subcategory","location.city_code":"city","location.region_code":"region","building.category_code":"building_category"};return null!=$group.filters&&$group.filters.forEach(function($e,$i){let lList=null;if(void 0!=lListSync[$e.field]){let lDictionaryKey=lListSync[$e.field];$scope.dictionary[lDictionaryKey]&&(lList=$scope.dictionary[lDictionaryKey],lResult=lResult.concat($scope.buildFilterHintForList($e,lList)))}else $e.label&&lResult.push({item:$e,label:$e.label,reverse:function(){"function"==typeof $e.reverse?$e.reverse():$scope.addFilter($e.field,$e.operator,"")}})}),null!=$group.filter_groups&&$group.filter_groups.forEach(function($g){let lSubGroups=$scope.buildFilterHints($g);lResult=lResult.concat(lSubGroups)}),lResult},$scope.buildFilterHintForList=function($filter,$list){let lResult=[];for(let $key in $list)"in"==$filter.operator&&$filter.value.indexOf($key)>=0?lResult.push({item:$key,label:$list[$key].caption,reverse:function(){$list[$key].selected=!1,$scope.addFilter($filter.field,"in",$scope.getSelection($list))}}):$list[$key].selected&&lResult.push({item:$key,label:$list[$key].caption,reverse:function(){$list[$key].selected=!1,$scope.addFilter($filter.field,"equal","")}});return lResult},$scope.hasFilters=function(){return null!=$scope.filter_group.filter_groups||null!=$scope.filter_group.filters||null!=$scope.query_text||null!=$scope.data.location},$scope.hasFilter=function($fieldname){if($scope.hasFilters()){let lFilter;return null!=$scope.getFilterByFieldName($fieldname)}return!1},$scope.getFilterValue=function($fieldname){let lFilter=$scope.getFilterByFieldName($fieldname);return null!=lFilter?lFilter.value:null},$scope.getFilterByFieldName=function($fieldname){let lResult=null;return null!=$scope.filter_group.filters&&$scope.filter_group.filters.every(function($e){return $e.field!=$fieldname||(lResult=$e,!1)}),lResult},$scope.resetFilters=function(){$scope.filter_group={operator:"and",filters:null,filter_groups:null},$scope.query_text=null,$scope.data.min_price=null,$scope.data.max_price=null,$scope.data.location=null;for(let $key in $scope.dictionary)$scope.resetListSelections($scope.dictionary[$key]);$scope.resetListSelections($s),$scope.clearState(),$scope.buildHints(),$scope.buildFilters()},$scope.resetListSelections=function($list){for(let $subkey in $list)delete $list[$subkey].selected},$scope.addFilter=function($field,$operator,$value,$label,$reverseFunc){"function"==typeof $field.push?$scope.addFilterGroup($field,$operator,$value,$label):$scope.setFilter($field,$operator,$value,$scope.filter_group,$label,$reverseFunc),$scope.saveState(),$scope.buildHints(),$scope.buildFilters()},$scope.addAttributeFilter=function($attr){let lValue=!!$attr.selected||"";$scope.addFilter($attr.field,"equal",lValue,$attr.caption.translate(),function(){console.log("reversin attr",$attr),$attr.selected=!1,$scope.addFilter($attr.field,"equal","")})},$scope.addGeoFilter=function(){let lSaveAndBuild=function(){$scope.saveState(),$scope.buildHints(),$scope.buildFilters()};null!=$scope.data.location?($scope.data.location=null,lSaveAndBuild()):navigator.geolocation.getCurrentPosition(function($position){console.log($position),$scope.data.location={latitude:$position.coords.latitude,longitude:$position.coords.longitude,distance:5e3},lSaveAndBuild()})},$scope.addFilterGroup=function($field,$operator,$value,$label){let lGroupName=$field.join("-")+"-"+$operator,parentFilterGroup=$scope.getFieldGroup(lGroupName,$scope.filter_group);null==parentFilterGroup&&(parentFilterGroup={operator:"or",name:lGroupName,filters:null,filter_groups:null},null==$scope.filter_group.filter_groups&&($scope.filter_group.filter_groups=[]),$scope.filter_group.filter_groups.push(parentFilterGroup)),$field.forEach(function($f){$scope.setFilter($f,$operator,$value,parentFilterGroup,$label)}),null==parentFilterGroup.filters&&$scope.filter_group.filter_groups.every(function($g,$i){if($g.name==parentFilterGroup.name)return $scope.filter_group.filter_groups.splice($i,1),!1}),0==$scope.filter_group.filter_groups.length&&($scope.filter_group.filter_groups=null)},$scope.setFilter=function($field,$operator,$value,$group,$label,$reverseFunc){null==$group.filters&&($group.filters=[]);let lFilterIndex=0,lNewFilter={field:$field,operator:$operator,value:$value,label:$label,reverse:$reverseFunc||function(){$scope.addFilter($field,$operator,"")}};for(lFilterIndex=0;lFilterIndex<$group.filters.length&&$group.filters[lFilterIndex].field!=$field;lFilterIndex++);""===$value||null==$value?$scope.removeFilter(lFilterIndex,$group):"function"==typeof $value.push&&0==$value.length?$scope.removeFilter(lFilterIndex,$group):$scope.updateFilter(lNewFilter,lFilterIndex,$group)},$scope.updateFilter=function($filter,$index,$group){console.log("update filter",$filter),$group.filters[$index]=$filter},$scope.removeFilter=function($index,$group){console.log("remove filter",$index),$group.filters.splice($index,1),0==$group.filters.length&&($group.filters=null)},$scope.saveState=function($item_key,$data){let lKey="immodb."+$scope.alias+".{0}";if(void 0==$item_key)sessionStorage.setItem(lKey.format("filter_group"),JSON.stringify($scope.filter_group)),sessionStorage.setItem(lKey.format("data"),JSON.stringify($scope.data));else{let lValue=$data;"object"==typeof lValue&&(lValue=JSON.stringify(lValue)),sessionStorage.setItem(lKey.format($item_key),JSON.stringify(lValue))}},$scope.clearState=function($item_key){let lKey="immodb."+$scope.alias+".{0}";if(void 0==$item_key)sessionStorage.removeItem(lKey.format("filter_group")),sessionStorage.removeItem(lKey.format("data")),sessionStorage.removeItem(lKey.format("st"));else{let lValue=$data;"object"==typeof lValue&&(lValue=JSON.stringify(lValue)),sessionStorage.removeItem(lKey.format($item_key))}},$scope.loadState=function($item_key){if($key="immodb."+$scope.alias+".{0}",void 0!=$item_key)return JSON.parse(sessionStorage.getItem($key.format($item_key)));{let lSessionFilterGroup=sessionStorage.getItem($key.format("filter_group")),lSessionData=sessionStorage.getItem($key.format("data"));null!=lSessionFilterGroup&&($scope.filter_group=JSON.parse(lSessionFilterGroup)),null!=lSessionData&&($scope.data=JSON.parse(lSessionData),$scope.data.keyword="")}},$scope.getFieldGroup=function($groupName,$parent){if($parent.name==$groupName)return $parent;if(null!=$parent.filter_groups){let lResult=null;return $parent.filter_groups.every(function($g){return null==(lResult=$scope.getFieldGroup($groupName,$g))}),lResult}return null},$scope.buildFilters=function(){let lResult=null,lPromise;return $q(function($resolve,$reject){$scope.getConfigs().then(function($configs){$configs.limit>0&&(lResult={max_item_count:$configs.limit}),(null!=$configs.filter_group||$scope.hasFilters())&&(null==lResult&&(lResult={}),lResult.filter_group={filters:[]},null!=$configs.filter_group&&(lResult.filter_group=angular.copy($configs.filter_group)),$scope.hasFilters()&&lResult.filter_group.filter_groups.push($scope.filter_group),lResult.filter_group=$scope.normalizeFilterGroup(lResult.filter_group)),$scope.sort_fields.length>0?lResult.sort_fields=$scope.sort_fields:lResult.sort_fields=[{field:$configs.sort,desc:$configs.sort_reverse}],null!=$scope.query_text&&(lResult.query_text=$scope.query_text),null!=$scope.data.location&&(lResult.proximity_filter=$scope.data.location),$scope.getSearchToken(lResult).then(function($token){""!=$token?($scope.saveState("st",$token),$rootScope.$broadcast($scope.alias+"FilterTokenChanged",$token),$resolve($token)):$reject()})})})},$scope.navigate=function(){""!=$scope.result_url&&null!=$scope.result_url&&$scope.buildFilters().then(function($token){window.location=$scope.result_url})},$scope.getSelection=function($list){let lResult=[];for(let lKey in $list)1==$list[lKey].selected&&lResult.push(lKey);return lResult},$scope.normalizeFilterGroup=function($filter_group){return $filter_group.filters&&$filter_group.filters.forEach(function($filter){["in","not_in"].indexOf($filter.operator)>=0?("function"==typeof $filter.value.split&&($filter.value=$filter.value.split(",")),$filter.value.forEach(function($val){typeof $val!=typeof!0&&(isNaN($val)||($val=Number($val)))})):typeof $filter.value!=typeof!0&&(isNaN($filter.value)||($filter.value=Number($filter.value)))}),$filter_group.filter_groups&&$filter_group.filter_groups.forEach(function($group){$scope.normalizeFilterGroup($group)}),$filter_group},$scope.getSearchToken=function($filters){let lPromise;return $q(function($resolve,$reject){null!=$filters?$immodbApi.api("utils/search_encode",$filters).then(function($response){$resolve($response)}):$resolve("")})},$scope.getConfigs=function(){let lPromise;return $q(function($resolve,$reject){null==$scope.configs?(console.log($scope.alias),$immodbApi.getListConfigs($scope.alias).then(function($configs){$scope.configs=$configs,$resolve($scope.configs)})):$resolve($scope.configs)})},$scope.onSortDataChanged=function($event,$newSortData){$scope.sort_fields=[$newSortData],console.log("sort field changed",$newSortData),$scope.buildFilters()},$scope.$watch("data.min_price",function(newValue,oldValue){newValue!=oldValue&&(console.log("min-price changed",newValue,oldValue),$scope.addFilter(["price.sell.amount","price.lease.amount"],"greater_or_equal_to",$scope.data.min_price),$scope.updatePriceSuggestions())}),$scope.$watch("data.max_price",function(newValue,oldValue){newValue!=oldValue&&(console.log("max-price changed",newValue,oldValue),$scope.addFilter(["price.sell.amount","price.lease.amount"],"less_or_equal_to",$scope.data.max_price),$scope.updatePriceSuggestions())}),$scope.$watch("dictionary",function(newValue,oldValue){if(void 0!=$scope.dictionary&&void 0!=$scope.dictionary.region){let lRegionList=$immodbUtils.toSortedArray($scope.dictionary.region);console.log("lRegionList",lRegionList),$scope.tab_region=lRegionList[0].__$key}})}}}),ImmoDbApp.directive("immodbMap",function immodbMap($immodbTemplate,$immodbUtils,$immodbDictionary){let dir_controller;return{restrict:"E",replace:!0,scope:{alias:"@immodbAlias",class:"@class",configs:"=?immodbConfigs",latlng:"=?latlng",zoom:"@"},controllerAs:"ctrl",template:'<div><div id="map-{{alias}}" class="viewport"></div></div>',controller:function($scope,$q,$immodbApi,$rootScope){function ImmoDbMarker(options){this.latlng_=options.position,this.markerClass=options.markerClass,this.onClick=options.onPinClick,this.obj=options.obj,this.div_=null,this.title=options.title,this.setMap(options.map)}var $proto;$scope.ready=!1,$scope.is_visible=!1,$scope.zoom=8,$scope.is_loading_data=!1,$scope.late_init=!0,$scope.markers=[],$scope.markerCluster=null,$scope.bounds=null,$scope.client={search_token:null},$scope.permalink="",$scope.$onInit=function(){console.log("init",$scope),null!=$scope.latlng?$scope.mapInit():($scope.$on("immodb-{0}-display-switch-map".format($scope.alias),$scope.onSwitchToMap),$scope.$on("immodb-{0}-display-switch-list".format($scope.alias),$scope.onSwitchToList)),$rootScope.$on($scope.alias+"FilterTokenChanged",$scope.onFilterTokenChanged)},$scope.mapInit=function(){if(0==$scope.ready){let options={center:new google.maps.LatLng(45.6025503,-73.8469538),zoom:$scope.zoom};$scope.map=new google.maps.Map($scope.viewport_element,options),$scope.ready=!0}},$scope.setZoom=function($zoom){$scope.map.setZoom($zoom)},$scope.getList=function(){0==$scope.is_loading_data&&$scope.search($scope.getSearchToken())},$scope.getSearchToken=function(){return null!=$scope.client.search_token?$scope.client.search_token:$scope.configs.search_token},$scope.onFilterTokenChanged=function($event,$newToken){$scope.client.search_token=$newToken,$scope.isReady().then(function(){console.log("update list"),$scope.getList()})},$scope.onSwitchToMap=function(){$scope.mapInit(),console.log("map initialized"),$scope.bounds&&(console.log("fit to bounds",$scope.bounds),window.setTimeout(function(){$scope.map.fitBounds($scope.bounds)},250)),0==$scope.markers.length&&$scope.getList(),$scope.is_visible=!0},$scope.onSwitchToList=function(){$scope.is_visible=!1},$scope.search=function($token){lParams={st:$token},$scope.page_index=0,$scope.is_loading_data=!0,$immodbApi.api($scope.getEndpoint()+"map_markers",lParams,{method:"GET"}).then(function($response){$scope.list=$response.markers,$scope.updateMarkerList(),console.log("marker list:",$scope.list),$scope.is_loading_data=!1})},$scope.getEndpoint=function(){let lOrigin;return $scope.getEndpointType().concat("/view/",$scope.configs.source.id,"/")},$scope.getEndpointType=function(){let lResult=$scope.configs.type;switch(lResult){case"listings":lResult="listing";break;case"brokers":lResult="broker";break;case"cities":lResult="city"}return lResult},$scope.clear=function(){$scope.markers&&$scope.markers.forEach(function($m){$m.setMap(null)}),null!=$scope.markerCluster&&$scope.markerCluster.clearMarkers(),$scope.markers=[]},$scope.addSingleMarker=function($location){console.log("adding single marker at",$location),$scope.clear(),$scope.markers.push(new google.maps.Marker({map:$scope.map,position:$location,animation:google.maps.Animation.DROP})),$scope.map.setCenter($location)},$scope.updateMarkerList=function(){$scope.clear(),$scope.bounds=new google.maps.LatLngBounds,console.log($scope.list[0]),$scope.list.forEach(function($marker){let lngLat=new google.maps.LatLng($marker.latitude,$marker.longitude);$marker.marker=new ImmoDbMarker({position:lngLat,map:$scope.map,obj:$marker,markerClass:["map-marker-icon",$marker.category_code.replace(" ","_")],onPinClick:$scope.pinClick}),$scope.markers.push($marker.marker),$scope.bounds.extend($marker.marker.getPosition())}),$scope.list.length>1?($scope.markerCluster=new MarkerClusterer($scope.map,$scope.markers,{imagePath:"https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m"}),1==$scope.is_visible&&window.setTimeout(function(){$scope.map.fitBounds($scope.bounds)},250)):($scope.map.setCenter($scope.list[0].marker.getPosition()),$scope.map.setZoom(12)),console.log("Map markers updated")},$scope.pinClick=function($marker){console.log("Marker clicked",$marker),$immodbApi.api($scope.getEndpointType().concat("/",$marker.obj.id,"/",immodbApiSettings.locale)).then(function($response){let lInfoWindowScope=$immodbUtils;$immodbDictionary.source=$response.dictionary,lInfoWindowScope.item=$response,console.log(lInfoWindowScope),$immodbTemplate.load("views/ang-templates/immodb-map-info-window.html",lInfoWindowScope).then(function($content){let infowindow;new google.maps.InfoWindow({content:$content}).open($scope.map,$marker)})})},$scope.isReady=function(){let lPromise;return $q(function($resolve,$reject){1==$scope.ready?$resolve():$scope.$watch("ready",function(){1==$scope.ready&&$resolve()})})},$scope.$watch("latlng",function(){null!=$scope.latlng&&void 0!=$scope.latlng.lat&&(console.log("latlng",$scope.latlng),$scope.isReady().then(function(){$scope.addSingleMarker($scope.latlng)}))}),$scope.$watch("zoom",function(){null!=$scope.zoom&&$scope.isReady().then(function(){$scope.setZoom(Number($scope.zoom))})}),ImmoDbMarker.prototype=new google.maps.OverlayView,($proto=ImmoDbMarker.prototype).draw=function(){var me=this,div=this.div_,point=this.getProjection().fromLatLngToDivPixel(this.latlng_);point&&(div.style.left=point.x+"px",div.style.top=point.y+"px")},$proto.onAdd=function(){var me=this,panes;div=this.div_=document.createElement("DIV"),div.style.border="none",div.style.position="absolute",div.style.paddingLeft="0px",div.style.cursor="pointer",this.markerClass.forEach(function($c){div.classList.add($c.toLowerCase())}),google.maps.event.addDomListener(div,"click",function(event){"function"==typeof me.onClick&&me.onClick(me)}),this.getPanes().overlayImage.appendChild(div)},$proto.onRemove=function(){null!=this.div_&&(this.div_.parentNode.removeChild(this.div_),this.div_=null)},$proto.hide=function(){this.div_&&(this.div_.style.visibility="hidden")},$proto.show=function(){this.div_&&(this.div_.style.visibility="visible")},$proto.toggle=function(){this.div_&&("hidden"===this.div_.style.visibility?this.show():this.hide())},$proto.getPosition=function(){return this.latlng_},$proto.toggleDOM=function(){this.getMap()?this.setMap(null):this.setMap(this.map_)}},link:function($scope,element){$scope.viewport_element=element.children()[0],$scope.$onInit()}}}),ImmoDbApp.directive("onBottomReached",function onBottomReached($document){return{restrict:"A",link:function(scope,element,attrs){var raw=element[0];let doc=$document[0];console.log("loading directive on "),$document.bind("scroll",function(){let lTop,lBottomLimit;(window.pageYOffset||doc.scrollTop)-(doc.clientTop||0)>=raw.offsetHeight+raw.offsetTop-window.innerHeight/3*2&&scope.$apply(attrs.onBottomReached)})}}}),ImmoDbApp.directive("immodbImageSlider",function immodbImageSlider(){let dir_controller=function immodbImageSliderCtrl($scope,$q,$immodbApi,$rootScope){$scope.expand_mode=!1,$scope.position={current_picture_index:0},$scope.init=function(){$scope.index=0},$scope.next=function(){let lNewIndex=$scope.index+1;lNewIndex==$scope.pictures.length-1&&(lNewIndex=0),$scope.set(lNewIndex)},$scope.previous=function(){let lNewIndex=$scope.index-1;-1==lNewIndex&&(lNewIndex=$scope.pictures.length-2),$scope.set(lNewIndex)},$scope.set=function($index){$scope.index=$index;try{$scope.$digest()}catch($e){}},$scope.toggleExpand=function(){$scope.expand_mode=!$scope.expand_mode},$scope.getPosition=function(){return"-"+100*$scope.position.current_picture_index+"%"},$scope.$watch("pictures",function(){null!=$scope.pictures&&$scope.init()})};return{restrict:"E",scope:{pictures:"=immodbPictures",dictionary:"=?immodbDictionary",gap:"@immodbGap",index:"=?immodbIndex"},controllerAs:"ctrl",replace:!0,templateUrl:immodbCtx.base_path+"views/ang-templates/immodb-image-slider.html",controller:dir_controller,link:function(scope,element,attrs){scope.$element=element[0];var mc=new Hammer(element[0]);let lPanHndl=null;mc.get("pan").set({direction:Hammer.DIRECTION_HORIZONTAL}),mc.on("swipeleft swiperight",function(ev){switch(console.log(ev.type+" gesture detected."),ev.type){case"swipeleft":scope.next();break;case"swiperight":scope.previous()}})}}}),ImmoDbApp.directive("immodbCalculator",function immodbCalculator(){return{restrict:"E",scope:{amount:"=immodbAmount",dictionary:"=?immodbDictionary",downpayment_selection:"@?immodbDownpaymentSelection",region:"@?immodbRegion",on_change:"&onChange"},controllerAs:"ctrl",replace:!0,templateUrl:immodbCtx.base_path+"views/ang-templates/immodb-calculator.html",controller:function($scope,$q,$rootScope){$scope.downpayment_selection="manual",$scope.data={amount:0,amortization:25,downpayment:20,interest:3,frequency:26,downpayment_method:"percent"},$scope.frequencies={12:"Monthly",26:"Every two weeks",52:"Weekly"},$scope.init=function(){$scope.preload(),$scope.data.amount=$scope.amount,$scope.process()},$scope.changeDownpaymentMethod=function($value){$value!=$scope.data.downpayment_method&&($scope["convertDownpaymentTo_"+$value](),$scope.data.downpayment_method=$value,$scope.process())},$scope.convertDownpaymentTo_cash=function(){let lResult=0;lResult=Math.round($scope.data.amount*($scope.data.downpayment/100)),$scope.data.downpayment=lResult},$scope.convertDownpaymentTo_percent=function(){let lResult=0;lResult=Math.round(100/($scope.data.amount/$scope.data.downpayment)),$scope.data.downpayment=lResult},$scope.setFrequency=function($value){$scope.data.frequency=$value,$scope.process()},$scope.process=function(){"manual"==$scope.downpayment_selection?$scope.process_single():$scope.process_multi(),$scope.save()},$scope.process_single=function(){let lBranch={downpayment:0,insurance:0,mortgage:0,amortization:$scope.data.amortization,rate:$scope.data.interest,frequency:$scope.data.frequency,frequency_caption:$scope.frequencies[$scope.data.frequency],payment:0},lRatio="percent"==$scope.data.downpayment_method?$scope.data.downpayment/100:$scope.data.downpayment/$scope.data.amount;console.log("ratio",lRatio),$scope.process_branch(lBranch,lRatio);let lResult={mortgage:lBranch,transfer_tax:getTransferTax($scope.data.amount,"06 "==$scope.region)};$rootScope.$broadcast("immodb-mortgage-calculator-result-changed",lResult),"function"==typeof $scope.on_change&&$scope.on_change({$result:lResult}),console.log("processing triggered",lResult)},$scope.process_branch=function(branch,downpayment_ratio){branch.downpayment=getDownPayment($scope.data.amount,downpayment_ratio),branch.insurance=getMortgageInsurance($scope.data.amount,downpayment_ratio),branch.mortgage=$scope.data.amount-branch.downpayment+branch.insurance;var PrValue=branch.mortgage,IntRate=branch.rate/100,Period=branch.amortization,PPay=branch.frequency,intcandebase=Math.pow(1+IntRate/2,2/PPay)-1,paymperiobase=PrValue*intcandebase/(1-1/Math.pow(1+intcandebase,Period*PPay));branch.payment=paymperiobase},getDownPayment=function(price,downpayment_ratio){return price*downpayment_ratio},getMortgageInsurance=function(price,downpayment_ratio){var lResult=price-price*downpayment_ratio;switch(downpayment_ratio){case.05:lResult*=.036;break;case.1:lResult*=.024;break;case.15:lResult*=.018;break;case.2:lResult*=0}return lResult},getTransferTax=function(amount,in_montreal){in_montreal=void 0!==in_montreal&&in_montreal,parts=[],console.log("in montreal",in_montreal),parts.push(.005*(amount>5e4?5e4:amount)),amount>5e4&&(parts.push(.01*(amount>25e4?2e5:amount-5e4)),in_montreal?(amount>25e4&&parts.push(.015*(amount>5e5?25e4:amount-25e4)),amount>5e5&&parts.push(.02*(amount-5e5))):amount>25e4&&parts.push(.015*(amount-25e4)));for(var lResult=0,i=0;i<parts.length;i++)lResult+=parts[i];return lResult},$scope.preload=function(){let lData=sessionStorage.getItem("immodb.mortgage-calculator");null!=lData&&($scope.data=JSON.parse(lData))},$scope.save=function(){sessionStorage.setItem("immodb.mortgage-calculator",JSON.stringify($scope.data))},$scope.$watch("amount",function(){null!=$scope.amount&&$scope.init()})}}}),ImmoDbApp.directive("immodbModal",function immodbModal(){let dir_controller=function immodbModalCtrl($scope,$q,$immodbApi,$rootScope){$scope.options={close_label:"Close",ok_label:"OK"},$scope.init=function(){null==$scope.model&&($scope.model={})},$scope.closeWithValue=function(){console.log("close with value",typeof $scope.onOK),"function"==typeof $scope.onOK&&$scope.onOK()},$scope.$watch("modal_title",function(){null!=$scope.amount&&$scope.init()}),$scope.$watch("ok_label",function(){null!=$scope.ok_label&&($scope.options.ok_label=$scope.ok_label)}),$scope.$watch("close_label",function(){null!=$scope.close_label&&($scope.options.close_label=$scope.close_label)})};return{restrict:"E",scope:{modal_id:"@modalId",modal_title:"@modalTitle",onOK:"&?onOk",model:"=ngModel",ok_label:"@?okLabel",cancel_label:"@?cancelLabel"},controllerAs:"ctrl",replace:!0,transclude:!0,templateUrl:immodbCtx.base_path+"views/ang-templates/immodb-modal.html",controller:dir_controller}}),ImmoDbApp.directive("immodbContainer",function immodbContainer(){return{restrict:"E",replace:!0,transclude:!0,scope:!0,template:"",controller:function($element,$transclude){$element.append($transclude())}}}),ImmoDbApp.factory("$immodbTemplate",["$http","$q","$interpolate","$sce",function $immodbTemplate($http,$q,$interpolate,$sce){let $scope={load:function($path,$template_scope){let templateUrl=$sce.getTrustedResourceUrl(immodbCtx.base_path+$path),lPromise;return $q(function($resolve,$reject){$http.get(templateUrl).then(function($response){let lContent=$scope.interpolate($response.data,$template_scope);$resolve(lContent)})})},interpolate:function($content,$template_scope){return $interpolate($content)($template_scope)}};return $scope}]),ImmoDbApp.factory("$immodbApi",["$http","$q","$immodbConfig",function $immodbApi($http,$q,$immodbConfig){let $scope={viewMetas:{},api:function($path,$data,$options){let lPromise;return $q(function($resolve,$reject){$scope.renewToken().then(function(){$scope.call($path,$data,$options).then(function($result){$resolve($result)})})})},rest:function($path,$data,$options){return $scope.rest_call($path,$data,$options)},tokenIsValid:function(){let lNow=new Date;if(null==$scope.auth_token){let lStoredToken=localStorage.getItem("immodb.auth_token");if(null==lStoredToken)return!1;$scope.auth_token=JSON.parse(lStoredToken)}return!(Date.parse($scope.auth_token.expire_date)<lNow)},renewToken:function(){let lPromise;return $q(function($resolve,$reject){$scope.tokenIsValid()?$resolve():$scope.rest_call("access_token").then(function($reponse){$scope.auth_token=$reponse,localStorage.setItem("immodb.auth_token",JSON.stringify($scope.auth_token)),$resolve()})})},getDefaultDataView:function(){let lPromise;return $q(function($resolve,$reject){$scope.call(null,null,{url:immodbApiSettings.rest_root+"immodb/data_view",headers:{"X-WP-Nonce":immodbApiSettings.nonce}}).then(function($response){$resolve(JSON.parse($response))})})},getListConfigs:function($alias){let lPromise;return $q(function($resolve,$reject){$immodbConfig.get().then(function($configs){let lResult=null;console.log($configs),$configs.lists.some(function($e){if($e.alias==$alias)return lResult=$e,!0}),$resolve(lResult)})})},getViewMeta:function($type,$view_id){let lOrigin=$type,lViewMetaKey=$type+"::"+$view_id;switch(lOrigin){case"listings":lOrigin="listing";break;case"brokers":lOrigin="broker";break;case"cities":lOrigin="city"}let lEndPoint="".concat("view/",$view_id,"/",immodbApiSettings.locale),lPromise;return $q(function($resolve,$reject){if(void 0!=$scope.viewMetas[lViewMetaKey]&&void 0==$scope.viewMetas[lViewMetaKey].loading)$resolve($scope.viewMetas[lViewMetaKey]);else if(void 0!=$scope.viewMetas[lViewMetaKey]&&1==$scope.viewMetas[lViewMetaKey].loading){let fnWait=function(){1==$scope.viewMetas[lViewMetaKey].loading?window.setTimeout(fnWait,15):$resolve($scope.viewMetas[lViewMetaKey])};fnWait()}else $scope.viewMetas[lViewMetaKey]={loading:!0},$scope.api(lEndPoint).then(function($response){$scope.viewMetas[lViewMetaKey]=$response,$resolve($response)})})},call:function($path,$data,$options){let lPromise;return"GET"==($options=angular.merge({url:immodbApiSettings.api_root+"/api/"+$path,method:void 0===$data||null==$data?"GET":"POST",data:$data},$options)).method&&null!=$options.data&&($options.params=$options.data,$options.data=null),void 0===$options.params&&($options.params={}),$options.params.at=$scope.auth_token.key,$q(function($resolve,$reject){$http($options).then(function success($result){"200"==$result.status?$resolve($result.data):$reject(null)},function fail($error){console.log($error)})})},rest_call:function($path,$data,$options){let lPromise;return"GET"==($options=angular.merge({url:immodbApiSettings.rest_root+"immodb/"+$path,method:void 0===$data||null==$data?"GET":"POST",data:$data,headers:{"X-WP-Nonce":immodbApiSettings.nonce}},$options)).method&&null!=$options.data&&($options.params=$options.data,$options.data=null),$q(function($resolve,$reject){$http($options).then(function success($result){"200"==$result.status?$resolve($result.data):$reject(null)},function fail($error){console.log($error)})})}};return $scope}]),ImmoDbApp.factory("$immodbDictionary",function $immodbDictionary(){let $scope={source:null,init:function($source){$scope.source=$source},sortData:function(){for(let lGroup in $scope.source)$scope.source[lGroup]=$scope.sortCollection($scope.source[lGroup])},sortCollection:function($coll){let lCollArray=$scope._toArray($coll);lCollArray.sort(function(a,b){return a.__data.caption<=b.__data.caption?-1:1}),console.log("immodbDictionary array sorted",lCollArray);let lResult=$scope._toObject(lCollArray);return console.log("immodbDictionary sorted collection",lResult),lResult},_toArray:function($object){let lResult=[];for(let $key in $object)lResult.push({__key:$key.toString(),__data:$object[$key]});return lResult},_toObject:function($array){let lResult={};return $array.forEach(function($e){lResult[$e.__key]=$e.__data}),lResult},getCaption:function($key,$domain,$asAbbr){let lResult=$key;return $asAbbr=void 0!=$asAbbr&&$asAbbr,$scope.source&&$scope.source[$domain]&&void 0!=$scope.source[$domain][$key]&&(lResult=$asAbbr?$scope.source[$domain][$key].abbr:$scope.source[$domain][$key].caption),lResult}};return $scope}),ImmoDbApp.factory("$immodbUtils",["$immodbDictionary","$immodbTemplate","$interpolate",function $immodbUtils($immodbDictionary,$immodbTemplate,$interpolate){let $scope={configs:null,getCaption:function($key,$domain,$asAbbr){return $immodbDictionary.getCaption($key,$domain,$asAbbr)},formatPrice:function($item,$format){$format=void 0!=$format?$format:"short";let lResult=[];if("SOLD"==$item.status_code)return void 0!=$item.price.sell?lResult.push("Sold".translate()):lResult.push("Leased".translate()),lResult.join("");for(let $key in $item.price)if(["sell","lease"].indexOf($key)>=0){let lPart=[$item.price[$key].amount.formatPrice()];if($item.price[$key].taxable&&(lPart[0]+="+tx"),$item.price[$key].unit&&lPart.push($scope.getCaption($item.price[$key].unit_code,"price_unit",!0)),"long"==$format){let lStart="for {0} for ".format($key).translate();lResult.push(lStart+lPart.join("/"))}else lResult.push(lPart.join("/"))}let lSeperator=" or ".translate();return lResult.join(lSeperator)},getPermalink:function($item){let lRoute="";return $scope.item=$item,immodbCtx.listing_routes.forEach(function($r){$r.lang==immodbCtx.locale&&(lRoute=$r)}),$immodbTemplate.interpolate(lRoute.route,$scope)},evaluate:function($text,$context){return $interpolate($text)($context)},compileListingList:function($list){return $list.forEach(function($e){$e.location.city=$scope.sanitize($scope.getCaption($e.location.city_code,"city")),$e.location.region=$scope.sanitize($scope.getCaption($e.location.region_code,"region")),$e.transaction=$scope.getTransaction($e,!0),$e.location.civic_address="{0} {1}".format($e.location.address.street_number,$e.location.address.street_name)}),$list},getClassList:function($item){let lResult=[];return null!=$item&&"SOLD"==$item.status_code&&lResult.push("sold"),lResult.join(" ")},getCity:function($item,$sanitize){$sanitize=void 0==$sanitize||$sanitize;let lResult=$scope.getCaption($item.location.city_code,"city");return $sanitize&&(lResult=$scope.sanitize(lResult)),lResult},getRegion:function($item,$sanitize){$sanitize=void 0==$sanitize||$sanitize;let lResult=$scope.getCaption($item.location.region_code,"region");return $sanitize&&(lResult=$scope.sanitize(lResult)),lResult},getTransaction:function($item,$sanitize){$sanitize=void 0!=$sanitize&&$sanitize;let lResult=[];for(var $key in $item.price)if("foreclosure"!=$key){let lTrans=("To "+$key).translate();$sanitize&&(lTrans=$scope.sanitize(lTrans)),lResult.push(lTrans)}return lResult.join(" "+"or".translate()+" ")},sanitize:function($value){if(!$value)return"-";let lResult=$value.toLowerCase();return lResult=(lResult=(lResult=(lResult=(lResult=(lResult=lResult.replace(/(\s|\+)/gm,"-")).replace(/('|"|\(|\))/gm,"")).replace(/(é|è|ë|ê)/gm,"e")).replace(/(à|â|ä)/gm,"a")).replace(/(ì|î|ï)/gm,"i")).replace(/(ù|û|ü)/gm,"u")},toArray:function($object){if(!angular.isObject($object))return $object;let lResult=[];for(let objectKey in $object)$object[objectKey].__$key=objectKey,lResult.push($object[objectKey]);return lResult},toSortedArray:function($object,$attr){$attr=void 0==$attr?"caption":$attr;let lResult=$scope.toArray($object);return lResult.sort(function(a,b){return isNaN(a[$attr])?a[$attr]<=b[$attr]?-1:1:(a=parseInt(a[$attr]))-(b=parseInt(b[$attr]))}),lResult}};return $scope}]),ImmoDbApp.factory("$immodbConfig",["$http","$q",function $immodbConfig($http,$q){let $scope={_data:null,_loading:!1,init:function(){$scope.get()},get:function(){let lPromise;return $q(function($resolve,$reject){if(console.log("on get $scope._data:",$scope._data,"loading:",$scope._loading),1==$scope._loading){let fnWait=function(){1==$scope._loading?window.setTimeout(fnWait,50):$resolve($scope._data)};fnWait()}else null!=$scope._data?$resolve($scope._data):($scope._loading=!0,$http.get(immodbCtx.config_path).then(function($response){200==$response.status?($scope._data=$response.data,$scope._loading=!1,$resolve($scope._data)):$reject()}))})}};return $scope.init(),$scope}]),ImmoDbApp.filter("range",function rangeFilter(){return function($items,$lowerBound,$upperBound){if(null==$items)return null;$items.forEach(function($e,$i){$e.index=$i});let lRange=$upperBound-$lowerBound,lResult;return lRange>$items.length?(lRange=$items.length,$lowerBound=0,$upperBound=$items.length-1):$lowerBound<0?$upperBound=($lowerBound=0)+lRange:$upperBound>$items.length-1&&($upperBound=$items.length-1,$lowerBound=$upperBound-lRange),$items.filter(function($e,$i){return $lowerBound<=$i&&$i<$upperBound})}}),ImmoDbApp.filter("asArray",function asArrayFilter(){return function($object){let lResult=[];if($object)for(key in $object)"function"!=typeof $object[key]&&($object[key].__$key=key,lResult.push($object[key]));return lResult}}),ImmoDbApp.filter("orderObjectBy",function orderObjectByFilter(){return function(input,attribute){if(!angular.isObject(input))return input;var array=[];for(var objectKey in input)input[objectKey].__$key=objectKey,array.push(input[objectKey]);return array.sort(function(a,b){return isNaN(a[attribute])?a[attribute]<=b[attribute]?-1:1:(a=parseInt(a[attribute]))-(b=parseInt(b[attribute]))}),array}});