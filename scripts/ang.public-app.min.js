var ImmoDbApp=angular.module("ImmoDb",["ngSanitize","angularMoment"]);ImmoDbApp.run(function(amMoment){amMoment.changeLocale(immodbCtx.locale)}),ImmoDbApp.controller("publicCtrl",function publicCtrl($scope,$rootScope,$immodbDictionary,$immodbUtils,$immodbHooks){$scope.model=null,$scope.broker_count=0,$scope.listing_count=0,$scope.init=function(){},$scope.$on("immodb-listings-update",function($event,$list,$meta){$scope.listing_count=$immodbHooks.filter("listing_count",$meta.item_count)}),$scope.$on("immodb-brokers-update",function(ev,$list,$meta){$scope.broker_count=$immodbHooks.filter("broker_count",$meta.item_count)}),$scope.getCaption=function($key,$domain,$asAbbr){return $immodbDictionary.getCaption($key,$domain,$asAbbr)},$rootScope.formatPrice=function($item){return $immodbUtils.formatPrice($item)},$scope.scrollTo=function($target){let opt={duration:250,easing:"swing"},position=angular.element($target).offset().top;angular.element("html, body").animate({scrollTop:position},opt)},$scope.cancelEvent=function($event){console.log("event trapped bouhou!"),$event.stopPropagation()},$scope.$on("modal-opened",function(){angular.element(document.body).addClass("immodb-modal-open")}),$scope.$on("modal-closed",function(){angular.element(document.body).removeClass("immodb-modal-open")})}),ImmoDbApp.controller("singleListingCtrl",function singleListingCtrl($scope,$q,$immodbApi,$immodbDictionary,$immodbUtils,$immodbConfig,$sce,$immodbHooks,$immodbFavorites,$immodbShare){$scope.model=null,$scope.permalinks=null,$scope.sections={addendum:{opened:!1},building:{opened:!1},lot:{opened:!1},other:{opened:!1},in_exclusions:{opened:!1},rooms:{opened:!1},expenses:{opened:!1}},$scope.selected_media="pictures",$scope.calculator_result={},$scope.message_model={},$scope.favorites=$immodbFavorites,$scope.init=function($ref_number){null!=$ref_number&&(console.log($ref_number),$scope.fetchPrerequisites().then(function($prerequisits){$scope.permalinks=$prerequisits,$scope.loadSingleData($ref_number)}))},$scope.fetchPrerequisites=function(){let lPromise;return $q(function($resolve,$reject){$immodbConfig.get().then(function($configs){$resolve({brokers:$configs.broker_routes,listings:$configs.listing_routes})})})},$scope.loadSingleData=function($ref_number){let lPromise;$q(function($resolve,$reject){"undefined"!=typeof immodbListingData?$resolve(immodbListingData):$immodbApi.getDefaultDataView().then(function($view){$immodbApi.api("listing/view/{0}/{1}/items/ref_number/{2}".format($view.id,immodbApiSettings.locale,$ref_number)).then(function($data){$resolve($data)})})}).then(function($data){$scope.model=$data,$immodbDictionary.source=$data.dictionary,$scope.preprocess(),$scope.message_model.subject="Request information for : {0} ({1})".translate().format($scope.model.location.full_address,$scope.model.ref_number);let lUserInfo=sessionStorage.getItem("user_infos");void 0!==lUserInfo&&null!=(lUserInfo=JSON.parse(lUserInfo))&&($scope.message_model.firstname=lUserInfo.firstname,$scope.message_model.lastname=lUserInfo.lastname,$scope.message_model.phone=lUserInfo.phone,$scope.message_model.email=lUserInfo.email),$immodbHooks.do("listing-message-model-post-process",$scope.message_model),$immodbHooks.do("listing-ready",$scope.model),$immodbHooks.addFilter("immodb.share.data",$scope.setShareData),console.log($scope.model)})},$scope.preprocess=function(){$scope.model.location.city=$scope.getCaption($scope.model.location.city_code,"city"),$scope.model.location.region=$scope.getCaption($scope.model.location.region_code,"region"),$scope.model.location.country=$scope.getCaption($scope.model.location.country_code,"country"),$scope.model.location.state=$scope.getCaption($scope.model.location.state_code,"state"),$scope.model.category=$scope.getCaption($scope.model.category_code,"listing_category"),$scope.model.subcategory=$scope.getCaption($scope.model.subcategory_code,"listing_subcategory"),$scope.model.addendum=$scope.model.addendum?$scope.model.addendum.trim():null,""!=$scope.model.location.address.street_number&&""!=$scope.model.location.address.street_name?$scope.model.location.civic_address="{0} {1}".format($scope.model.location.address.street_number,$scope.model.location.address.street_name):""!=$scope.model.location.address.street_name?$scope.model.location.civic_address=$scope.model.location.address.street_name:$scope.model.location.civic_address="",""!=$scope.model.location.civic_address?$scope.model.location.full_address="{0} {1}, {2}".format($scope.model.location.address.street_number,$scope.model.location.address.street_name,$scope.model.location.city):$scope.model.location.full_address=$scope.model.location.city,$scope.model.building.attributes=[],$scope.model.land.attributes=[],$scope.model.other={attributes:[]},$scope.model.important_flags=[],$scope.model.long_price=$immodbUtils.formatPrice($scope.model,"long"),$scope.model.short_price=$immodbUtils.formatPrice($scope.model);let lMainUnit=$scope.model.units.find(function($u){return"MAIN"==$u.category_code});if(null!=lMainUnit&&(lMainUnit.bedroom_count&&$scope.model.important_flags.push({icon:"bed",value:lMainUnit.bedroom_count,caption:"Bedroom".translate()}),lMainUnit.bathroom_count&&$scope.model.important_flags.push({icon:"bath",value:lMainUnit.bathroom_count,caption:"Bathroom".translate()}),lMainUnit.waterroom_count&&$scope.model.important_flags.push({icon:"hand-holding-water",value:lMainUnit.waterroom_count,caption:"Water room".translate()})),$scope.model.attributes.forEach(function($e){if($e.caption=$scope.getCaption($e.code,"attribute"),$e.values.forEach(function($v){$v.caption=$scope.getCaption($v.code,"attribute_value"),$v.count&&($v.caption=$v.caption.concat(" ({0})".format($v.count))),$v.details&&($v.caption=$v.details)}),["CUPBOARD","WINDOWS","WINDOW TYPE","ROOFING","FOUNDATION","GARAGE","SIDING","BATHR./WASHR","BASEMENT"].includes($e.code)?$scope.model.building.attributes.push($e):["LANDSCAPING","DRIVEWAY","PARKING","POOL","TOPOGRAPHY","VIEW","ZONING","PROXIMITY"].includes($e.code)?$scope.model.land.attributes.push($e):["HEATING SYSTEM","HEATING ENERGY","HEART STOVE","WATER SUPPLY","SEWAGE SYST.","EQUIP. AVAIL"].includes($e.code)&&$scope.model.other.attributes.push($e),"PARKING"==$e.code){let lParkingCount=0;$e.values.forEach(function($v){lParkingCount+=$v.count}),lParkingCount>0&&$scope.model.important_flags.push({icon:"car",value:lParkingCount,caption:$e.caption})}"POOL"==$e.code&&$scope.model.important_flags.push({icon:"swimmer",value:0,caption:$e.caption}),"HEART STOVE"==$e.code&&$scope.model.important_flags.push({icon:"fire",value:0,caption:$e.caption})}),$scope.model.units.forEach(function($u){$u.category=$immodbDictionary.getCaption($u.category_code,"unit_category"),$u.flags=[],$u.room_count&&$u.flags.push({icon:"door-open",value:$u.room_count,caption:"Rooms".translate()}),$u.bedroom_count&&$u.flags.push({icon:"bed",value:$u.bedroom_count,caption:"Bedrooms".translate()}),$u.bathroom_count&&$u.flags.push({icon:"bath",value:$u.bathroom_count,caption:"Bathrooms".translate()})}),$scope.model.rooms.forEach(function($r){$r.category=$immodbDictionary.getCaption($r.category_code,"room_category"),$r.level_category=$immodbDictionary.getCaption($r.level_category_code,"level_category"),$r.short_dimension=$immodbUtils.formatDimension($r.dimension);let lRoomInfos=[];"OTHER"!=$r.flooring_code&&($r.flooring=$immodbDictionary.getCaption($r.flooring_code,"flooring"))}),null!=$scope.model.virtual_tour&&($scope.model.virtual_tour.trusted_url=$sce.trustAsResourceUrl($scope.model.virtual_tour.url)),null!=$scope.model.video){let lEmbedVideo=$scope.model.video.url;"youtube"==$scope.model.video.type&&(lEmbedVideo="//www.youtube.com/embed/{0}?rel=0&showinfo=0&enablejsapi=1&origin=*".format($scope.model.video.id)),$scope.model.video.trusted_url=$sce.trustAsResourceUrl(lEmbedVideo)}$immodbHooks.do("single-listing-preprocess",$scope.model)},$scope.setShareData=function($data){return $data.description=$scope.model.description,$data.media=$scope.model.photos[0].source_url,console.log("set share data",$data),$data},$scope.sectionOpened=function($section){return $scope.sections[$section].opened},$scope.toggleSection=function($section){$scope.sections[$section].opened=!$scope.sections[$section].opened},$scope.onMortgageChange=function($calculatorResult){$scope.calculator_result=$calculatorResult},$scope.sendMessage=function(){console.log("message data:",$scope.message_model),sessionStorage.setItem("user_infos",JSON.stringify({firstname:$scope.message_model.firstname,lastname:$scope.message_model.lastname,phone:$scope.message_model.phone,email:$scope.message_model.email}));let lSent=$immodbHooks.do("single-listing-send-message",$scope.message_model);if(console.log(lSent),!0!==lSent){let lDestEmails=$scope.model.brokers.map($e=>$e.email);lDestEmails=$immodbHooks.filter("single-listing-message-emails",lDestEmails,$scope.model.brokers),lMessage={type:"information_request",metadata:{id:$scope.model.id,ref_number:$scope.model.ref_number,address:$scope.model.location.civic_address},destination:lDestEmails,data:$scope.message_model},$immodbApi.rest("message",{params:lMessage}).then(function($response){$scope.request_sent=!0})}},$scope.print=function(){let lPrintLink=$scope.model.permalink.split("/");lPrintLink.splice(2,3,"print").join("/"),window.open(lPrintLink.join("/"))},$scope.hasDimension=function($dimension){return $immodbUtils.hasDimension($dimension)},$scope.shareTo=function($social_media){$immodbShare.execute($social_media)}}),ImmoDbApp.controller("immodbMediaBoxCtrl",function immodbMediaBoxCtrl($scope){$scope.selected_media="pictures",$scope.video_player=null,$scope.init=function(){},$scope.selectMedia=function($media){$scope.selected_media=$media,"video"!=$media&&$scope.callPlayer("video-player","stopVideo")},$scope.callPlayer=function(frame_id,func,args){window.jQuery&&frame_id instanceof jQuery&&(frame_id=frame_id.get(0).id);var iframe=document.getElementById(frame_id);iframe&&"IFRAME"!=iframe.tagName.toUpperCase()&&(iframe=iframe.getElementsByTagName("iframe")[0]),$scope.callPlayer.queue||($scope.callPlayer.queue={});var queue=$scope.callPlayer.queue[frame_id],domReady="complete"==document.readyState;if(domReady&&!iframe)window.console&&console.log("$scope.callPlayer: Frame not found; id="+frame_id),queue&&clearInterval(queue.poller);else if("listening"===func)iframe&&iframe.contentWindow&&(func='{"event":"listening","id":'+JSON.stringify(""+frame_id)+"}",iframe.contentWindow.postMessage(func,"*"));else if(domReady&&(!iframe||iframe.contentWindow&&(!queue||queue.ready))&&(queue&&queue.ready||"function"!=typeof func)){if(iframe&&iframe.contentWindow){if(func.call)return func();iframe.contentWindow.postMessage(JSON.stringify({event:"command",func:func,args:args||[],id:frame_id}),"*")}}else queue||(queue=$scope.callPlayer.queue[frame_id]=[]),queue.push([func,args]),"poller"in queue||(queue.poller=setInterval(function(){$scope.callPlayer(frame_id,"listening")},250),messageEvent(1,function runOnceReady(e){if(!iframe){if(!(iframe=document.getElementById(frame_id)))return;if("IFRAME"!=iframe.tagName.toUpperCase()&&!(iframe=iframe.getElementsByTagName("iframe")[0]))return}if(e.source===iframe.contentWindow)for(clearInterval(queue.poller),queue.ready=!0,messageEvent(0,runOnceReady);tmp=queue.shift();)$scope.callPlayer(frame_id,tmp[0],tmp[1])},!1));function messageEvent(add,listener){var w3=add?window.addEventListener:window.removeEventListener;w3?w3("message",listener,!1):(add?window.attachEvent:window.detachEvent)("onmessage",listener)}}}),ImmoDbApp.controller("singleBrokerCtrl",function singleBrokerCtrl($scope,$q,$immodbApi,$immodbDictionary,$immodbUtils,$immodbConfig,$immodbHooks){$scope.filter_keywords="",$scope.message_model={},$scope.model=null,$scope.permalinks=null,$scope.sections={addendum:{opened:!0},building:{opened:!1},lot:{opened:!1},other:{opened:!1},in_exclusions:{opened:!1}},$scope.selected_media="pictures",$scope.calculator_result={},$scope.message_model={},$scope.init=function($ref_number){null!=$ref_number&&(console.log($ref_number),$scope.fetchPrerequisites().then(function(){$scope.loadSingleData($ref_number)}))},$scope.fetchPrerequisites=function(){let lPromise;return $q(function($resolve,$reject){$immodbConfig.get().then(function($configs){$resolve({brokers:$configs.broker_routes,listings:$configs.listing_routes})})})},$scope.loadSingleData=function($ref_number){let lPromise;$q(function($resolve,$reject){"undefined"!=typeof immodbBrokerData?$resolve(immodbBrokerData):$immodbApi.getDefaultDataView().then(function($view){console.log($view),$immodbApi.api("broker/view/{0}/{1}/items/ref_number/{2}".format($view.id,immodbApiSettings.locale,$ref_number)).then(function($data){$resolve($data)})})}).then(function($data){$scope.model=$data,$immodbDictionary.source=$data.dictionary,$scope.preprocess(),console.log($scope.model)})},$scope.preprocess=function(){$scope.model.license_type=$scope.getCaption($scope.model.license_type_code,"broker_license_type"),$scope.model.languages="N/A".translate();let lExpertises=[];$scope.model.listings.forEach(function($e,$i,$arr){let lNewItem=$scope.getCaption($e.category_code,"listing_category");lExpertises.indexOf(lNewItem)<0&&lExpertises.push(lNewItem)}),$scope.model.expertises=lExpertises.join(", "),$scope.list=$scope.model.listings,$scope.model.office.location.country=$scope.getCaption($scope.model.office.location.country_code,"country"),$scope.model.office.location.state=$scope.getCaption($scope.model.office.location.state_code,"state"),$scope.model.office.location.full_address="{0} {1}, {2}".format($scope.model.office.location.address.street_number,$scope.model.office.location.address.street_name,$scope.model.office.location.city),$scope.model.location=$scope.model.office.location,$immodbUtils.compileListingList($scope.model.listings)},$scope.getPhoneIcon=function($key){let lPhoneIcon={mobile:"mobile",office:"building"};return null!=lPhoneIcon[$key]?lPhoneIcon[$key]:"phone"},$scope.filterListings=function($listing){return null==$scope.filter_keywords||""==$scope.filter_keywords||($listing.description&&$listing.description.toLowerCase().indexOf($scope.filter_keywords.toLowerCase())>=0?(console.log("found kw in description"),!0):$listing.price.sell&&$listing.price.sell.amount.toString().indexOf($scope.filter_keywords)>=0?(console.log("found kw in price sell"),!0):$listing.price.rent&&$listing.price.rent.amount.toString().indexOf($scope.filter_keywords)>=0?(console.log("found kw in price rent"),!0):$listing.location.city.toLowerCase().indexOf($scope.filter_keywords.toLowerCase())>=0&&(console.log("found kw in city"),!0))},$scope.sectionOpened=function($section){return $scope.sections[$section].opened},$scope.toggleSection=function($section){$scope.sections[$section].opened=!$scope.sections[$section].opened},$scope.onMortgageChange=function($calculatorResult){$scope.calculator_result=$calculatorResult},$scope.getClassList=function($item){let lResult;return $immodbUtils.getClassList($item)},$scope.sendMessage=function(){let lSent;if(console.log("message data:",$scope.message_model),sessionStorage.setItem("user_infos",JSON.stringify({firstname:$scope.message_model.firstname,lastname:$scope.message_model.lastname,phone:$scope.message_model.phone,email:$scope.message_model.email})),!0!==$immodbHooks.do("single-broker-send-message",$scope.message_model)){let lDestEmails=$scope.model.email;lDestEmails=$immodbHooks.filter("single-broker-message-emails",lDestEmails,$scope.model),lMessage={type:"broker_message",destination:lDestEmails,data:$scope.message_model},$immodbApi.rest("message",{params:lMessage}).then(function($response){$scope.request_sent=!0})}},$scope.validateMessage=function(){}}),ImmoDbApp.directive("immodbList",["$immodbFavorites",function immodbList(){return{restrict:"E",scope:{alias:"@immodbAlias",class:"@immodbClass"},controllerAs:"ctrl",template:'<div ng-include="\'immodb-template-for-\' + alias" class="{{class}}"></div>',link:function($scope){$scope.init()},controller:function($scope,$q,$immodbApi,$rootScope,$immodbDictionary,$immodbUtils,$immodbFavorites){$scope.configs=null,$scope.list=[],$scope.page=1,$scope.meta=null,$scope.dictionary={},$scope.auth_token=null,$scope.is_ready=!1,$scope.display_mode="list",$scope.page_index=0,$scope.is_loading_data=!1,$scope.client={search_token:null},$scope.city_list=[],$scope.subcategory_list=[],$scope.client_sort=null,$scope.favorites=$immodbFavorites,$scope.init=function(){$scope.ghost_list=[];for(let $i=0;$i<12;$i++)$scope.ghost_list.push({location:{city:"City",civic_address:"00 address"},price:{sell:{amount:0}},category:"Category",subcategory:"Subcategory",ref_number:"XXXXXX",first_name:"First name",last_name:"Last name",license_type:"License type",listing_count:0,phones:{cell:"555-555-5555"},description:"Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident."});$rootScope.$on($scope.alias+"FilterTokenChanged",$scope.onFilterTokenChanged),$scope.$on("immodb-{0}-display-switch-map".format($scope.alias),function(){$scope.display_mode="map"}),$scope.$on("immodb-{0}-display-switch-list".format($scope.alias),function(){$scope.display_mode="list"}),$scope.$on("auth_token_refresh",function(){sessionStorage.removeItem("immodb.list.{0}.{1}".format($scope.configs.type,immodbCtx.locale)),sessionStorage.removeItem("immodb.listMeta.{0}.{1}".format($scope.configs.type,immodbCtx.locale)),sessionStorage.removeItem("immodb.pageIndex.{0}.{1}".format($scope.configs.type,immodbCtx.locale))}),$immodbApi.getListConfigs($scope.alias).then(function($configs){$scope.configs=$configs;let lClientSearchToken=sessionStorage.getItem("immodb.{0}.st".format($scope.configs.alias));null!=lClientSearchToken&&($scope.client.search_token=lClientSearchToken),$immodbApi.renewToken().then(function(){$scope.start()})})},$scope.start=function(){$immodbApi.getViewMeta($scope.configs.type,$scope.configs.source.id).then(function($response){$immodbDictionary.init($response.dictionary),$scope.configs.enable_custom_page?$immodbApi.rest_call("pages",{locale:immodbCtx.locale},{method:"GET"}).then(function($site_page_list){$immodbUtils.page_list=$site_page_list,$scope.dictionary=$response.dictionary,$scope.is_ready=!0,$scope.getList()}):($immodbUtils.page_list=[],$scope.dictionary=$response.dictionary,$scope.is_ready=!0,$scope.getList())})},$scope.getList=function(){$scope.search($scope.getSearchToken())},$scope.getSearchToken=function(){return null!=$scope.client.search_token?(console.log("return client st",$scope.client.search_token),$scope.client.search_token):(console.log("return config st",$scope.configs.search_token),$scope.configs.search_token)},$scope.onFilterTokenChanged=function($event,$newToken){$newToken==$scope.configs.search_token?$scope.client.search_token=null:$scope.client.search_token=$newToken,$scope.isReady().then(function(){$scope.getLatestSearchToken()!=$newToken&&(console.log("clear latest st for ",$newToken),sessionStorage.removeItem("immodb.{0}.latestSearchToken.{1}".format($scope.configs.alias,immodbCtx.locale)),sessionStorage.removeItem("immodb.list.{0}.{1}".format($scope.configs.type,immodbCtx.locale))),$scope.getList()})},$scope.isReady=function(){return $q(function($resolve,$reject){if($scope.is_ready)$resolve();else{let lIntervalHnd=null;lIntervalHnd=window.setInterval(function(){$scope.is_ready&&(window.clearInterval(lIntervalHnd),$resolve())},500)}})},$scope.setLoadingState=function($is_loading){$scope.is_loading_data=$is_loading;try{$scope.$digest()}catch(error){}},$scope.search=function($token){lParams={st:$token},$scope.page_index=0,"list"==$scope.display_mode&&($scope.loadListFromStorage($scope.configs.type)?($rootScope.$broadcast("immodb-"+$scope.configs.type+"-update",$scope.list,$scope.listMeta),$scope.$emit("immodb-"+$scope.configs.type+"-update",$scope.list,$scope.listMeta)):0==$scope.is_loading_data&&($scope.setLoadingState(!0),$immodbApi.api($scope.getEndpoint()+"/items",lParams,{method:"GET"}).then(function($response){"listings"==$scope.configs.type?$scope.list=$immodbUtils.compileListingList($response.items):$scope.list=$immodbUtils.compileBrokerList($response.items),$scope.ghost_list=[],$scope.listMeta=$response.metadata,$scope.setLoadingState(!1),$rootScope.$broadcast("immodb-"+$scope.configs.type+"-update",$scope.list,$scope.listMeta),$scope.$emit("immodb-"+$scope.configs.type+"-update",$scope.list,$scope.listMeta),$scope.saveListToStorage($scope.configs.type),$scope.saveLatestSearchToken($token)})))},$scope.checkNextPage=function(){"list"==$scope.display_mode&&null!=$scope.listMeta&&$scope.page_index<2&&$scope.listMeta.next_token&&$scope.showNextPage()},$scope.showNextPage=function($reset){$reset=void 0!==$reset&&$reset,lParams={st:$scope.listMeta.search_token,nt:$scope.listMeta.next_token},$scope.is_loading_data||(console.log,$scope.setLoadingState(!0),$immodbApi.api($scope.getEndpoint()+"/items",lParams,{method:"GET"}).then(function($response){let lNewItems=$response.items;lNewItems="listings"==$scope.configs.type?$immodbUtils.compileListingList(lNewItems):$immodbUtils.compileBrokerList(lNewItems),$scope.list=$scope.list.concat(lNewItems),$scope.listMeta=$response.metadata,$scope.page_index++,$scope.$emit("immodb-"+$scope.configs.type+"-update",$scope.list,$scope.listMeta),window.setTimeout(function(){$scope.setLoadingState(!1)},500),$reset&&($scope.page_index=0),$scope.saveListToStorage($scope.configs.type)}))},$scope.loadListFromStorage=function($type){let lListDate=sessionStorage.getItem("immodb.list.date.{0}.{1}".format($type,immodbCtx.locale));if(null==lListDate)return!1;{let lNow;if(lListDate=new Date(Date.parse(lListDate)),moment().diff(lListDate,"minutes")>10)return!1}let lList=sessionStorage.getItem("immodb.list.{0}.{1}".format($type,immodbCtx.locale)),lListMeta=sessionStorage.getItem("immodb.listMeta.{0}.{1}".format($type,immodbCtx.locale)),lPageIndex=sessionStorage.getItem("immodb.pageIndex.{0}.{1}".format($type,immodbCtx.locale));return null!=lList&&($scope.list=JSON.parse(lList),$scope.listMeta=JSON.parse(lListMeta),$scope.page_index=lPageIndex,!0)},$scope.saveListToStorage=function($type){sessionStorage.setItem("immodb.list.{0}.{1}".format($type,immodbCtx.locale),JSON.stringify($scope.list)),sessionStorage.setItem("immodb.listMeta.{0}.{1}".format($type,immodbCtx.locale),JSON.stringify($scope.listMeta)),sessionStorage.setItem("immodb.pageIndex.{0}.{1}".format($type,immodbCtx.locale),$scope.page_index)},$scope.getLatestSearchToken=function(){return sessionStorage.getItem("immodb.{0}.latestSearchToken.{1}".format($scope.configs.alias,immodbCtx.locale))},$scope.saveLatestSearchToken=function($token){sessionStorage.setItem("immodb.{0}.latestSearchToken.{1}".format($scope.configs.alias,immodbCtx.locale),$token)},$scope.getEndpoint=function(){let lOrigin=$scope.configs.type;switch(lOrigin){case"listings":lOrigin="listing";break;case"brokers":lOrigin="broker";break;case"cities":lOrigin="city"}return lOrigin.concat("/view/",$scope.configs.source.id,"/",immodbApiSettings.locale)},$scope.todo=function(){alert("TODO")},$scope.sortByPrice=function($more_to_least){$scope.client_sort="price_"+($more_to_least?"desc":"asc");let lNewSortFields={field:"price.sell.amount",desc:$more_to_least};$rootScope.$broadcast($scope.alias+"SortDataChanged",lNewSortFields)},$scope.sortByDate=function($more_to_least){$scope.client_sort="date_"+($more_to_least?"desc":"asc");let lNewSortFields={field:"contract.start_date",desc:$more_to_least};$rootScope.$broadcast($scope.alias+"SortDataChanged",lNewSortFields)},$scope.sortByName=function($more_to_least){$scope.client_sort="name_"+($more_to_least?"desc":"asc");let lNewSortFields={field:"last_name",desc:$more_to_least};$rootScope.$broadcast($scope.alias+"SortDataChanged",lNewSortFields)},$scope.sortByListingCount=function($more_to_least){$scope.client_sort="listings_"+($more_to_least?"desc":"asc");let lNewSortFields={field:"listings_count",desc:$more_to_least};$rootScope.$broadcast($scope.alias+"SortDataChanged",lNewSortFields)},$scope.getCaption=function($key,$domain,$asAbbr){return $immodbDictionary.getCaption($key,$domain,$asAbbr)},$scope.formatPrice=function($item){return $immodbUtils.formatPrice($item)},$scope.getClassList=function($item){return $immodbUtils.getClassList($item)},$scope.switchDisplayTo=function($mode){$scope.display_mode!=$mode&&($scope.display_mode=$mode,$rootScope.$broadcast("immodb-{0}-display-switch-{1}".format($scope.alias,$mode)))},$scope.getCity=function($item,$sanitize){return $immodbUtils.getCity($item,$sanitize)},$scope.getRegion=function($item,$sanitize){return $immodbUtils.getRegion($item,$sanitize)},$scope.getTransaction=function($item,$sanitize){return $immodbUtils.getTransaction($item,$sanitize)}}}}]),ImmoDbApp.directive("immodbSearch",function immodbSearch(){return{restrict:"E",replace:!0,scope:{alias:"@immodbAlias",class:"@class",configs:"=?immodbConfigs",dictionary:"=?immodbDictionary",result_url:"@immodbResultUrl"},controllerAs:"ctrl",template:"<div ng-include=\"'immodb-search-for-' + alias\"></div>",link:function($scope){$scope.init()},controller:function($scope,$q,$immodbApi,$rootScope,$immodbDictionary,$immodbUtils){let lToday=(new Date).round(),lNow=new Date;$scope.is_ready=!1,$scope.tab_category="RESIDENTIAL",$scope.tab_region="",$scope.regions=[],$scope.geolocation_available=null!=navigator.geolocation&&"https:"==window.location.protocol,$scope.sort_fields=[],$scope.selected_price_input="min",$scope.keyword="",$scope.priceSuggestions=[],$scope.bedroomSuggestions=[],$scope.bathroomSuggestions=[],$scope.parkingSuggestions=[],$scope.garageSuggestions=[],$scope.filterHints=[],$scope.suggestions=[],$scope.query_text=null,$scope.alphaList="abcdefghijklmnopqrstuvwxyz".split(""),$scope.data={keyword:"",min_price:null,max_price:null,location:null},$scope.filter_group={operator:"and",filters:null,filter_groups:null},$scope.listing_states={sold:{caption:"Sold",filter:{field:"status_code",operator:"not_equal_to",value:"AVAILABLE"}},sell:{caption:"To sell",filter:{field:"price.sell.amount",operator:"greater_than",value:0}},lease:{caption:"To lease",filter:{field:"price.lease.amount",operator:"greater_than",value:0}},open_house:{caption:"Open house",filter:{field:"open_houses[*].end_date",operator:"greater_or_equal_to",value:"udf.now()"}},forclosure:{caption:"Foreclosure",filter:{field:"price.foreclosure",operator:"equal",value:!0}},virtual_tour:{caption:"With virtual tour",filter:{field:"virtual_tour_flag",operator:"equal",value:!0}},video:{caption:"With video",filter:{field:"video_flag",operator:"equal",value:!0}}},$scope.listing_ages=[{caption:"No limit".translate(),filter:{field:"contract.start_date",operator:"greater_than",value:""}},{caption:"24 hours".translate(),filter:{field:"contract.start_date",operator:"greater_than",value:lNow.addDays(-1).toJSON()}},{caption:"48 hours".translate(),filter:{field:"contract.start_date",operator:"greater_than",value:lNow.addDays(-2).toJSON()}},{caption:"7 days".translate(),filter:{field:"contract.start_date",operator:"greater_than",value:lToday.addDays(-7).toJSON()}},{caption:"2 weeks".translate(),filter:{field:"contract.start_date",operator:"greater_than",value:lToday.addDays(-14).toJSON()}},{caption:"1 month".translate(),filter:{field:"contract.start_date",operator:"greater_than",value:lToday.addMonths(-1).toJSON()}},{caption:"3 months".translate(),filter:{field:"contract.start_date",operator:"greater_than",value:lToday.addMonths(-3).toJSON()}},{caption:"6 months".translate(),filter:{field:"contract.start_date",operator:"greater_than",value:lToday.addMonths(-6).toJSON()}},{caption:"1 year".translate(),filter:{field:"contract.start_date",operator:"greater_than",value:lToday.addYears(-1).toJSON()}}],$scope.listing_attributes={pool:{caption:"Pool",field:"attributes.POOL"},fireplace:{caption:"Fireplace",field:"attributes.HEART_STOVE"},garage:{caption:"Garage",field:"attributes.GARAGE"},waterfront:{caption:"Water front",field:"attributes.WATER_FRONT"},panoramicview:{caption:"Panoramic view",field:"attributes.PANORAMIC_VIEW"}},$scope.init=function(){$rootScope.$on($scope.alias+"SortDataChanged",$scope.onSortDataChanged),$scope.$on($scope.alias+"filterUpdate",function(){console.log("filter updated"),$scope.loadState(),$scope.syncFiltersToUI(),$scope.hasFilters()?$scope.buildHints():console.log("No filter found")}),$scope.buildDropdownSuggestions(),$scope.loadState(),$scope.isReady().then(function(){$scope.syncFiltersToUI(),$scope.hasFilters()&&$scope.buildHints(),$scope.$broadcast("search-is-ready");let lStoredSearchToken=$scope.loadState("st");lStoredSearchToken&&$scope.configs.search_token})},$scope.isReady=function(){let lPromise;return null!=$scope.dictionary&&null!=$scope.configs&&($scope.is_ready=!0),$q(function($resolve,$reject){0==$scope.is_ready?$scope.getConfigs().then(function($configs){$scope.configs=$configs,$immodbApi.getViewMeta($configs.type,$configs.source.id).then(function($response){$scope.dictionary=$response.dictionary,$scope.is_ready=!0,$resolve()})}):$resolve()})},$scope._expandedPanel=null,$scope.toggleExpand=function($key){$scope._expandedPanel=$scope._expandedPanel==$key?null:$key},$scope.isExpanded=function($key){return $scope._expandedPanel==$key?"expanded":""},$scope.getCategoryIcon=function($key){return lIconset={RESIDENTIAL:"home",COM:"shopping-bag",FARM:"paw",LOT:"tree-alt","MULTI-FAMILY":"building","REVENUE PROP":"usd-square"},lIconset[$key]},$scope.changeCategoryTab=function($key){$scope.tab_category=$key},$scope.changeRegionTab=function($key){$scope.tab_region=$key},$scope.buildDropdownSuggestions=function(){$scope.updatePriceSuggestions();for(let i=1;i<6;i++)$scope.bedroomSuggestions.push({value:i,label:"{0}+ bedrooms".translate().format(i),caption:"{0}+ bedrooms".translate().format(i)}),$scope.bathroomSuggestions.push({value:i,label:"{0}+ bathrooms".translate().format(i),caption:"{0}+ bathrooms".translate().format(i)}),$scope.parkingSuggestions.push({value:i,label:(1==i?"1 space or +":"{0} spaces or +").translate().format(i),caption:"{0}+ parking spaces".translate().format(i)}),$scope.garageSuggestions.push({value:i,label:"{0}+ garages".translate().format(i),caption:"{0}+ garages".translate().format(i)})},$scope.buildSuggestions=function($event){let lResult=[];if($scope.trapKeyCode($event.keyCode))return!1;if(""!=$scope.data.keyword)if(isNaN($scope.data.keyword)){let lValue=$scope.data.keyword.toLowerCase();if(lResult=[{selected:!0,label:'Contains "{0}"'.translate().format(lValue),action:function(){$scope.query_text=lValue,$scope.buildFilters(),$scope.buildHints(),$scope.saveState()}}],"listings"==$scope.configs.type){for($key in $scope.dictionary.listing_category){let lElm=$scope.dictionary.listing_category[$key];lElm.caption.toLowerCase().indexOf(lValue)>=0&&lResult.push({label:"{0} (category)".translate().format(lElm.caption),action:function(){lElm.selected=!0,$scope.addFilter("category","in",$scope.getSelection($scope.dictionary.listing_category))}})}for($key in $scope.dictionary.listing_subcategory){let lElm=$scope.dictionary.listing_subcategory[$key];lElm.caption.toLowerCase().indexOf(lValue)>=0&&lResult.push({label:"{0} (subcategory)".translate().format(lElm.caption),action:function(){lElm.selected=!0,$scope.addFilter("subcategory","in",$scope.getSelection($scope.dictionary.listing_subcategory))}})}for($key in $scope.dictionary.region){let lElm=$scope.dictionary.region[$key];lElm.caption.toLowerCase().indexOf(lValue)>=0&&lResult.push({label:"{0} (region)".translate().format(lElm.caption),action:function(){lElm.selected=!0,$scope.addFilter("location.region_code","in",$scope.getSelection($scope.dictionary.region))}})}for($key in $scope.dictionary.city){let lElm=$scope.dictionary.city[$key];lElm.caption.toLowerCase().indexOf(lValue)>=0&&lResult.push({label:"{0} (city)".translate().format(lElm.caption),action:function(){lElm.selected=!0,$scope.addFilter("location.city_code","in",$scope.getSelection($scope.dictionary.city))}})}}else"brokers"==$scope.configs.type&&(lResult.push({label:'Last name is "{0}"'.translate().format($scope.data.keyword),action:function(){$scope.addFilter("last_name","equal_to",$scope.data.keyword,'Last name is "{0}"'.translate().format($scope.data.keyword)),$scope.buildFilters(),$scope.buildHints()}}),lResult.push({label:'Last name starts with "{0}"'.translate().format(lValue),action:function(){$scope.addFilter("last_name","starts_with",lValue,'Last name starts with "{0}"'.translate().format(lValue)),$scope.buildFilters(),$scope.buildHints()}}),lResult.push({label:'Last name ends with "{0}"'.translate().format(lValue),action:function(){$scope.addFilter("last_name","ends_with",lValue,'Last name ends with "{0}"'.translate().format(lValue)),$scope.buildFilters(),$scope.buildHints()}}),lResult.push({label:'First name is "{0}"'.translate().format($scope.data.keyword),action:function(){$scope.addFilter("first_name","equal_to",$scope.data.keyword,'First name is "{0}"'.translate().format($scope.data.keyword)),$scope.buildFilters(),$scope.buildHints()}}),lResult.push({label:'First name starts with "{0}"'.translate().format(lValue),action:function(){$scope.addFilter("first_name","starts_with",lValue,'First name starts with "{0}"'.translate().format(lValue)),$scope.buildFilters(),$scope.buildHints()}}),lResult.push({label:'First name ends with "{0}"'.translate().format(lValue),action:function(){$scope.addFilter("first_name","ends_with",lValue,'First name ends with "{0}"'.translate().format(lValue)),$scope.buildFilters(),$scope.buildHints()}}))}else{let lValue=Number($scope.data.keyword),lPriceMin=Math.max(0,lValue/2),lPriceMax=Math.min(1e6,2*lValue);lResult=[{selected:!0,label:'Contains "{0}"'.translate().format(lValue),action:function(){$scope.query_text=lValue,$scope.buildFilters(),$scope.saveState()}}],"listings"==$scope.configs.type&&(lResult=lResult.concat([{label:"Price is less than {0}".translate().format(lValue.formatPrice()),action:function(){$scope.setMaxPrice(lValue)}},{label:"Price is more than {0}".translate().format(lValue.formatPrice()),action:function(){$scope.setMinPrice(lValue)}},{label:"Price is between {0} and {1}".translate().format(lPriceMin.formatPrice(),lPriceMax.formatPrice()),action:function(){$scope.setMinPrice(lPriceMin),$scope.setMaxPrice(lPriceMax)}},{label:'Has "{0}" as civic address'.translate().format(lValue),action:function(){$scope.addFilter("location.address.street_number","equal",lValue,'Has "{0}" as civic address'.translate().format(lValue))}}]))}$scope.suggestions=lResult},$scope.trapKeyCode=function($keyCode){let lSelectedIndex=0,lResult=!1;switch($keyCode){case 13:let lPassthrough;$scope.suggestions.every(function($e,$i){return console.log($i,$e.selected),!0!==$e.selected||($e.action(),lResult=!0,!1)})&&($scope.suggestions[0].action(),lResult=!0),$scope.data.keyword="",$scope.suggestions=[];break;case 38:$scope.suggestions.every(function($e,$i){return!0!==$e.selected||(lSelectedIndex=$i,delete $e.selected,!1)}),lSelectedIndex=Math.max(lSelectedIndex-1,0),$scope.suggestions[lSelectedIndex].selected=!0,lResult=!0;break;case 40:$scope.suggestions.every(function($e,$i){return null==$e.selected||!0!==$e.selected||(lSelectedIndex=$i,delete $e.selected,!1)}),lSelectedIndex=Math.min(lSelectedIndex+1,$scope.suggestions.length-1),$scope.suggestions[lSelectedIndex].selected=!0,lResult=!0}return lResult},$scope.searchForKeyword=function(){$scope.query_text=$scope.data.keyword,$scope.saveState(),$scope.buildFilters()},$scope.lateCall=function($func){$immodbUtils.lateCall($func)},$scope.selectPriceInput=function($value){$scope.selected_price_input=$value,$scope.updatePriceSuggestions()},$scope.updatePriceSuggestions=function(){$scope.priceSuggestions=$scope.getPriceSuggestions($scope.selected_price_input),$scope.minPriceSuggestions=$scope.getPriceSuggestions("min"),$scope.maxPriceSuggestions=$scope.getPriceSuggestions("max")},$scope.getPriceSuggestions=function($minOrMax){let lResult=[],lMinPrice=$scope.min_price||0,lMaxPrice=$scope.max_price||5e5,lStartAt=lMinPrice;const lList=[5e3,25e3,5e4,75e3,1e5,2e5,3e5,4e5];return"max"==$minOrMax&&(lStartAt=lMaxPrice),lList.forEach(function($val){let lValue=$val+lStartAt;lResult.push({value:lValue,label:lValue.formatPrice()})}),lResult},$scope.setPrice=function($value,$eventOrInput){let lInput=$scope.selected_price_input;"string"==typeof $eventOrInput&&(lInput=$eventOrInput),$scope.data[lInput+"_price"]=""==$value?void 0:$value,console.log(lInput,"price changed to",$value),"min"==$scope.selected_price_input&&$eventOrInput&&"string"!=typeof $eventOrInput&&($eventOrInput.stopPropagation(),$scope.selectPriceInput("max"))},$scope.setMinPrice=function($value){$scope.setPrice($value,"min")},$scope.setMaxPrice=function($value){$scope.setPrice($value,"max")},$scope.setBedroomCount=function($item){$scope.bedroomSuggestions.forEach(function($e){$e.selected=!1}),$item.selected=!0,$scope.addFilter("main_unit.bedroom_count","greater_or_equal_to",$item.value,"{0}+ bedrooms".translate().format($item.value),function(){$scope.setBedroomCount({value:""})})},$scope.setGarageCount=function($item){$scope.garageSuggestions.forEach(function($e){$e.selected=!1}),$item.selected=!0,$scope.addFilter("attributes.PARKING_GARAGE","greater_or_equal_to",$item.value,$item.caption,function(){$scope.setGarageCount({value:""})})},$scope.setParkingCount=function($item){$scope.parkingSuggestions.forEach(function($e){$e.selected=!1}),$item.selected=!0,$scope.addFilter("attributes.PARKING","greater_or_equal_to",$item.value,$item.caption,function(){$scope.setParkingCount({value:""})})},$scope.setBathroomCount=function($item){$scope.bathroomSuggestions.forEach(function($e){$e.selected=!1}),$item.selected=!0,$scope.addFilter("main_unit.bathroom_count","greater_or_equal_to",$item.value,$item.caption,function(){$scope.setBathroomCount({value:""})})},$scope.syncFiltersToUI=function(){let lListSync={category_code:"listing_category",subcategory_code:"listing_subcategory","location.city_code":"city","location.region_code":"region","building.category_code":"building_category"};null!=$scope.filter_group&&null!=$scope.filter_group.filters&&$scope.filter_group.filters.forEach(function($e,$i){if(null!=lListSync[$e.field]){let lDictionaryKey=lListSync[$e.field];$scope.dictionary[lDictionaryKey]&&$scope.syncToList($e,$scope.dictionary[lDictionaryKey])}else $e.label&&($scope.syncToList($e,$scope.listing_attributes),$scope.syncToList($e,$scope.listing_states))}),lListSync={"main_unit.bedroom_count":$scope.bedroomSuggestions,"main_unit.bathroom_count":$scope.bathroomSuggestions,"attributes.PARKING":$scope.parkingSuggestions,"attributes.PARKING_GARAGE":$scope.garageSuggestions};for(const key in lListSync){let lValue=$scope.getFilterValue(key);lListSync[key].some(function($e){if($e.value==lValue)return $e.selected=!0,!0})}},$scope.syncToList=function($filter,$list){let lListArray;$immodbUtils.toArray($list).forEach(function($e){"in"==$filter.operator&&$filter.value.indexOf($e.__$key)>=0?$list[$e.__$key].selected||($list[$e.__$key].selected=!0):$e.field==$filter.field?$e.selected||($e.selected=!0):null!=$e.filter&&$e.filter.field==$filter.field&&($e.selected||($e.selected=!0))})},$scope.setState=function($item){let lValue=$item.filter.value;1!=$item.selected&&(lValue=""),$scope.addFilter($item.filter.field,$item.filter.operator,lValue,$item.caption.translate(),function(){$item.selected="",$scope.setState($item)})},$scope.hasChild=function($parent_key,$list){for($key in $list){let lData;if($list[$key].parent==$parent_key)return!0}return!1},$scope.buildHints=function(){let lResult=[];if(lResult=$scope.buildFilterHints($scope.filter_group),null!=$scope.data.min_price||null!=$scope.data.max_price){let lPriceHint=["Min","Max"];null!=$scope.data.min_price&&(lPriceHint[0]=$scope.data.min_price.formatPrice()),null!=$scope.data.max_price&&(lPriceHint[1]=$scope.data.max_price.formatPrice()),lResult.push({item:"PRICE",label:lPriceHint.join(" - "),reverse:function(){$scope.setPrice("","min"),$scope.setPrice("","max")}})}null!=$scope.query_text&&lResult.push({item:"QUERY_TEXT",label:'Contains "{0}"'.translate().format($scope.query_text),reverse:function(){$scope.query_text=null,$scope.buildFilters(),$scope.buildHints(),$scope.saveState()}}),console.log("hint for data",$scope.data),null!=$scope.data.location&&lResult.push({item:"NEAR_ME",label:"Near me".translate(),reverse:function(){$scope.data.location=null,$scope.buildFilters(),$scope.buildHints(),$scope.saveState()}}),console.log("hints",lResult),$scope.filterHints=lResult},$scope.buildFilterHints=function($group){let lResult=[],lListSync={category_code:"listing_category",subcategory_code:"listing_subcategory","location.city_code":"city","location.region_code":"region","building.category_code":"building_category"};return null!=$group.filters&&$group.filters.forEach(function($e,$i){let lList=null;if(null!=lListSync[$e.field]){let lDictionaryKey=lListSync[$e.field];$scope.dictionary[lDictionaryKey]&&(lList=$scope.dictionary[lDictionaryKey],lResult=lResult.concat($scope.buildFilterHintForList($e,lList)))}else $e.label&&lResult.push({item:$e,label:$e.label,reverse:function(){"function"==typeof $e.reverse?$e.reverse():$scope.addFilter($e.field,$e.operator,"")}})}),null!=$group.filter_groups&&$group.filter_groups.forEach(function($g){let lSubGroups=$scope.buildFilterHints($g);lResult=lResult.concat(lSubGroups)}),lResult},$scope.buildFilterHintForList=function($filter,$list){let lResult=[];for(let $key in $list)"in"==$filter.operator&&$filter.value.indexOf($key)>=0?lResult.push({item:$key,label:$list[$key].caption,reverse:function(){$list[$key].selected=!1,$scope.addFilter($filter.field,"in",$scope.getSelection($list))}}):$list[$key].selected&&lResult.push({item:$key,label:$list[$key].caption,reverse:function(){$list[$key].selected=!1,$scope.addFilter($filter.field,"equal","")}});return lResult},$scope.hasFilters=function(){return null!=$scope.filter_group.filter_groups||null!=$scope.filter_group.filters||null!=$scope.query_text||null!=$scope.data.location},$scope.hasFilter=function($fieldname){if($scope.hasFilters()){let lFilter;return null!=$scope.getFilterByFieldName($fieldname)}return!1},$scope.sublistHasFilters=function($parent_code,$list){for(let lKey in $list){let lItem=$list[lKey];if(lItem.parent==$parent_code&&lItem.selected)return!0}},$scope.filterPanelHasFilters=function($section){let lResult=!1,lPanelFilters;return{location:["location.city_code"],price:["price.sell.amount"],category:["category_code","subcategory_code"],room:["main_unit.bedroom_count","main_unit.bathroom_count"],other:["attributes.POOL","attributes.HEART_STOVE","attributes.GARAGE","attributes.WATER_FRONT","attributes.PANORAMIC_VIEW","attributes.PARKING_GARAGE","attributes.PARKING","building.category_code","contract.start_date","open_houses[*].end_date","virtual_tour_flag","video_flag","status_code"]}[$section].some(function($e){if($scope.hasFilter($e))return lResult=!0,!0}),lResult},$scope.getFilterValue=function($fieldname){let lFilter=$scope.getFilterByFieldName($fieldname);return null!=lFilter?lFilter.value:null},$scope.getFilterCaption=function($fieldname,$default){let lFilter=$scope.getFilterByFieldName($fieldname);return null!=lFilter?(console.log("filter found for caption",lFilter),$default=void 0===$default?lFilter.value:$default,lFilter.label):$default=void 0===$default?"":$default},$scope.getFilterCaptionFromList=function($fieldname,$list,$default){let lValue=$scope.getFilterValue($fieldname);if(null==lValue)return $default;let lItem=null;return null==(lItem=$list.some($e=>null!=$e.filter)?$list.find($e=>$e.filter.value==lValue):$list.find($e=>$e.value==lValue))?$default:null!=lItem.label?lItem.label:lItem.caption},$scope.getFilterByFieldName=function($fieldname,$group){let lResult=null;return null!=($group=void 0===$group?$scope.filter_group:$group).filters&&$group.filters.some(function($e){if($e.field==$fieldname)return lResult=$e,!0}),null==lResult&&null!=$group.filter_groups&&$group.filter_groups.some(function($group){let lGroupResult=$scope.getFilterByFieldName($fieldname,$group);if(null!=lGroupResult)return lResult=lGroupResult,!0}),lResult},$scope.resetFilters=function(){$scope.filter_group={operator:"and",filters:null,filter_groups:null},$scope.query_text=null,$scope.data.keyword="",$scope.data.min_price=null,$scope.data.max_price=null,$scope.data.location=null;for(let $key in $scope.dictionary)$scope.resetListSelections($scope.dictionary[$key]);$scope.resetListSelections($scope.listing_attributes),$scope.bedroomSuggestions.forEach(function($e){delete $e.selected}),$scope.bathroomSuggestions.forEach(function($e){delete $e.selected}),$scope.parkingSuggestions.forEach(function($e){delete $e.selected}),$scope.garageSuggestions.forEach(function($e){delete $e.selected}),$scope.clearState(),$scope.buildHints(),$scope.getConfigs().then(function($configs){console.log("Reset filter to",$configs.search_token),""!=$configs.search_token&&($rootScope.$broadcast($scope.alias+"FilterTokenChanged",$configs.search_token),null!=$scope.onTokenChange&&$scope.onTokenChange())})},$scope.resetListSelections=function($list){for(let $subkey in $list)delete $list[$subkey].selected},$scope.addFilter=function($field,$operator,$value,$label,$reverseFunc){"function"==typeof $field.push?$scope.addFilterGroup($field,$operator,$value,$label):(console.log("set filter",$field,$operator,$value),$scope.setFilter($field,$operator,$value,$scope.filter_group,$label,$reverseFunc)),$scope.saveState(),$scope.buildHints(),$scope.buildFilters()},$scope.addAttributeFilter=function($attr){let lValue=!!$attr.selected||"";$scope.addFilter($attr.field,"equal",lValue,$attr.caption.translate(),function(){console.log("reversin attr",$attr),$attr.selected=!1,$scope.addFilter($attr.field,"equal","")})},$scope.addGeoFilter=function(){let lSaveAndBuild=function(){$scope.saveState(),$scope.buildHints(),$scope.buildFilters()};null!=$scope.data.location?($scope.data.location=null,lSaveAndBuild()):navigator.geolocation.getCurrentPosition(function($position){$scope.data.location={latitude:$position.coords.latitude,longitude:$position.coords.longitude,distance:5e3},lSaveAndBuild()})},$scope.sendMessage=function(){console.log("message data:",$scope.message_model),sessionStorage.setItem("user_infos",JSON.stringify({firstname:$scope.message_model.firstname,lastname:$scope.message_model.lastname,phone:$scope.message_model.phone,email:$scope.message_model.email}));let lSent=$immodbHooks.do("single-listing-send-message",$scope.message_model);if(console.log(lSent),!0!==lSent){let lDestEmails=$scope.model.brokers.map($e=>$e.email);lDestEmails=$immodbHooks.filter("single-listing-message-emails",lDestEmails,$scope.model.brokers),lMessage={type:"information_request",metadata:{id:$scope.model.id,ref_number:$scope.model.ref_number,address:$scope.model.location.civic_address},destination:lDestEmails,data:$scope.message_model},$immodbApi.rest("message",{params:lMessage}).then(function($response){$scope.request_sent=!0})}},$scope.addFilterGroup=function($field,$operator,$value,$label){let lGroupName=$field.join("-")+"-"+$operator,parentFilterGroup=$scope.getFieldGroup(lGroupName,$scope.filter_group);null==parentFilterGroup&&(parentFilterGroup={operator:"or",name:lGroupName,filters:null,filter_groups:null},null==$scope.filter_group.filter_groups&&($scope.filter_group.filter_groups=[]),$scope.filter_group.filter_groups.push(parentFilterGroup)),$field.forEach(function($f,$index){let lValue=$value;null!=$value&&"function"==typeof $value.push&&(lValue=$value.length>$index?$value[$index]:null),$scope.setFilter($f,$operator,lValue,parentFilterGroup,$label)}),null==parentFilterGroup.filters&&$scope.filter_group.filter_groups.every(function($g,$i){if($g.name==parentFilterGroup.name)return $scope.filter_group.filter_groups.splice($i,1),!1}),0==$scope.filter_group.filter_groups.length&&($scope.filter_group.filter_groups=null)},$scope.setFilter=function($field,$operator,$value,$group,$label,$reverseFunc){null==$group.filters&&($group.filters=[]);let lFilterIndex=0,lNewFilter={field:$field,operator:$operator,value:$value,label:$label,reverse:$reverseFunc||function(){$scope.addFilter($field,$operator,"")}};for(lFilterIndex=0;lFilterIndex<$group.filters.length&&$group.filters[lFilterIndex].field!=$field;lFilterIndex++);""===$value||null==$value?$scope.removeFilter(lFilterIndex,$group):"function"==typeof $value.push&&0==$value.length?$scope.removeFilter(lFilterIndex,$group):$scope.updateFilter(lNewFilter,lFilterIndex,$group)},$scope.updateFilter=function($filter,$index,$group){$group.filters[$index]=$filter},$scope.removeFilter=function($index,$group){$group.filters.splice($index,1),0==$group.filters.length&&($group.filters=null)},$scope.saveState=function($item_key,$data){let lKey="immodb."+$scope.alias+".{0}";if(void 0===$item_key)console.log("Save search field group"),sessionStorage.setItem(lKey.format("query_text"),JSON.stringify($scope.query_text)),sessionStorage.setItem(lKey.format("filter_group"),JSON.stringify($scope.filter_group)),sessionStorage.setItem(lKey.format("data"),JSON.stringify($scope.data));else{let lValue=$data;"object"==typeof lValue&&(lValue=JSON.stringify(lValue)),sessionStorage.setItem(lKey.format($item_key),lValue)}},$scope.clearState=function($item_key){let lKey="immodb."+$scope.alias+".{0}";if(console.log("clearState",lKey.format("filter_group")),null==$item_key)sessionStorage.removeItem(lKey.format("query_text")),sessionStorage.removeItem(lKey.format("filter_group")),sessionStorage.removeItem(lKey.format("data")),sessionStorage.removeItem(lKey.format("st"));else{let lValue=$data;"object"==typeof lValue&&(lValue=JSON.stringify(lValue)),sessionStorage.removeItem(lKey.format($item_key))}},$scope.loadState=function($item_key){if($key="immodb."+$scope.alias+".{0}",null!=$item_key){let lResult=sessionStorage.getItem($key.format($item_key));try{lResult=JSON.parse(lResult)}catch(error){}return lResult}{let lSessionQueryText=sessionStorage.getItem($key.format("query_text")),lSessionFilterGroup=sessionStorage.getItem($key.format("filter_group")),lSessionData=sessionStorage.getItem($key.format("data"));null!=lSessionQueryText&&($scope.query_text=JSON.parse(lSessionQueryText)),null!=lSessionFilterGroup&&($scope.filter_group=JSON.parse(lSessionFilterGroup)),null!=lSessionData&&($scope.data=JSON.parse(lSessionData),$scope.data.keyword="")}},$scope.getFieldGroup=function($groupName,$parent){if($parent.name==$groupName)return $parent;if(null!=$parent.filter_groups){let lResult=null;return $parent.filter_groups.every(function($g){return null==(lResult=$scope.getFieldGroup($groupName,$g))}),lResult}return null},$scope.buildFilters=function(){console.log("build filters");let lResult=null,lPromise;return $q(function($resolve,$reject){$scope.getConfigs().then(function($configs){if(!$scope.hasFilters()&&null==$scope.query_text&&0==$scope.sort_fields.length&&null==$scope.data.location)return console.log("Everything is back to default"),$scope.clearState(),void $scope.resetFilters();$configs.limit>0&&(lResult={max_item_count:$configs.limit}),(null!=$configs.filter_group||$scope.hasFilters())&&(null==lResult&&(lResult={}),lResult.filter_group={filters:[]},null!=$configs.filter_group&&(lResult.filter_group=angular.copy($configs.filter_group)),$scope.hasFilters()&&lResult.filter_group.filter_groups.push($scope.filter_group),lResult.filter_group=$scope.normalizeFilterGroup(lResult.filter_group)),$scope.sort_fields.length>0?lResult.sort_fields=$scope.sort_fields:lResult.sort_fields=[{field:$configs.sort,desc:$configs.sort_reverse}],null!=$scope.query_text&&(lResult.query_text=$scope.query_text),null!=$scope.data.location&&(lResult.proximity_filter=$scope.data.location),$scope.getSearchToken(lResult).then(function($token){""!=$token?($scope.saveState("st",$token),$rootScope.$broadcast($scope.alias+"FilterTokenChanged",$token),$resolve($token)):$reject()})})})},$scope.navigate=function(){""!=$scope.result_url&&null!=$scope.result_url&&$scope.buildFilters().then(function($token){window.location=$scope.result_url})},$scope.toggleAllFor=function($key,$operator,$list,$item_parent){for(let lKey in $list){let lToggle=!1;null==$item_parent?lToggle=!0:$list[lKey].parent==$item_parent.__$obj_key&&(lToggle=!0),1==lToggle&&(1!=$item_parent.selected?delete $list[lKey].selected:$list[lKey].selected=!0)}$scope.addFilter($key,$operator,$scope.getSelection($list))},$scope.getSelection=function($list){let lResult=[];console.log($list);for(let lKey in $list)1==$list[lKey].selected&&lResult.push(lKey);return lResult},$scope.normalizeFilterGroup=function($filter_group){return $filter_group.filters&&$filter_group.filters.forEach(function($filter){["in","not_in"].indexOf($filter.operator)>=0?("function"==typeof $filter.value.split&&($filter.value=$filter.value.split(",")),$filter.value.forEach(function($val){typeof $val!=typeof!0&&(isNaN($val)||($val=Number($val)))})):typeof $filter.value!=typeof!0&&(isNaN($filter.value)||($filter.value=Number($filter.value)))}),$filter_group.filter_groups&&$filter_group.filter_groups.forEach(function($group){$scope.normalizeFilterGroup($group)}),$filter_group},$scope.getSearchToken=function($filters){let lPromise;return $q(function($resolve,$reject){null!=$filters?$immodbApi.api("utils/search_encode",$filters).then(function($response){$resolve($response)}):$resolve("")})},$scope.getConfigs=function(){let lPromise;return $q(function($resolve,$reject){null==$scope.configs?$immodbApi.getListConfigs($scope.alias).then(function($configs){$scope.configs=$configs,$resolve($scope.configs)}):$resolve($scope.configs)})},$scope.onSortDataChanged=function($event,$newSortData){$scope.sort_fields=[$newSortData],$scope.buildFilters()},$scope.$watch("data.min_price",function(newValue,oldValue){newValue!=oldValue&&($scope.addFilter(["price.sell.amount","price.lease.amount"],"greater_or_equal_to",$scope.data.min_price),$scope.updatePriceSuggestions())}),$scope.$watch("data.max_price",function(newValue,oldValue){newValue!=oldValue&&($scope.addFilter(["price.sell.amount","price.lease.amount"],"less_or_equal_to",$scope.data.max_price),$scope.updatePriceSuggestions())}),$scope.$watch("dictionary",function(newValue,oldValue){if(null!=$scope.dictionary&&null!=$scope.dictionary.region){let lRegionList=$immodbUtils.toSortedArray($scope.dictionary.region);$scope.tab_region=lRegionList[0].__$key}if(null!=$scope.dictionary&&null!=$scope.dictionary.city){let lCityList=$immodbUtils.toArray($scope.dictionary.city);$scope.city_list=lCityList}if(null!=$scope.dictionary&&null!=$scope.dictionary.listing_subcategory){let lSubcategoryList=$immodbUtils.toArray($scope.dictionary.listing_subcategory);$scope.subcategory_list=lSubcategoryList}})}}}),ImmoDbApp.directive("immodbSearchBox",["$immodbUtils",function immodbSearchBox($compile,$immodbUtils){return{restrict:"E",replace:!0,required:"^immodbSearch",scope:{alias:"@",placeholder:"@",onTokenChange:"&onEnter",result_page:"@resultPage"},templateUrl:immodbCtx.base_path+"views/ang-templates/immodb-searchbox.html",link:function($scope,element,attrs){$scope._suggestion_list_el=element.find(".suggestion-list"),$scope._el=element[0],angular.element("body").append($scope._suggestion_list_el),$scope.init()},controller:function($scope,$q,$immodbApi,$rootScope,$immodbDictionary,$immodbUtils){$scope.configs=null,$scope.suggestions=[],$scope.is_ready=!1,$scope.keyword="",$scope.query_text=null,$scope.sort_fields=[],$scope.data={keyword:"",min_price:null,max_price:null,location:null},$scope.filter_group={operator:"and",filters:null,filter_groups:null},$scope.init=function(){$scope.isReady().then(function(){$scope.loadState();let lInput=angular.element($scope._el).find("input");lInput.bind("focus",function(){null!=$scope.data.keyword&&""!=$scope.data.keyword&&($scope.buildSuggestions(),$scope.$apply())}),lInput.bind("blur",function(){window.setTimeout(function(){$scope.suggestions=[],$scope.$apply()},500)}),$scope.$broadcast("search-is-ready"),$scope.$on("immodb-reset-filter",function(){$scope.data={keyword:"",min_price:null,max_price:null,location:null},$scope.saveState("search-keyword",$scope.data.keyword)})})},$scope.isReady=function(){let lPromise;return null!=$scope.dictionary&&null!=$scope.configs&&($scope.is_ready=!0),$q(function($resolve,$reject){0==$scope.is_ready?$scope.getConfigs().then(function($configs){$scope.configs=$configs,console.log($scope.configs),$immodbApi.getViewMeta($configs.type,$configs.source.id).then(function($response){$scope.dictionary=$response.dictionary,$scope.is_ready=!0,$resolve()})}):$resolve()})},$scope.getSuggestionPosition=function(){if(null==$scope._el)return"";let lRect=$immodbUtils.absolutePosition($scope._el);return lRect.width=Math.min($scope._el.offsetWidth,window.innerWidth),lRect.height=$scope._el.offsetHeight,"top:{0}px;left:{1}px;width:{2}px;".format(lRect.top+(lRect.height-2),lRect.left,lRect.width)},$scope.buildSuggestions=function($event){let lResult=[];if(null!=$event&&$scope.trapKeyCode($event.keyCode))return!1;if(""!=$scope.data.keyword)if(isNaN($scope.data.keyword)){let lValue=$immodbUtils.sanitize($scope.data.keyword.toLowerCase());if(lValue.split(" ").length>1)lResult=[$scope.getReverseSuggestions()];else if(lResult=[{selected:!0,label:'Contains "{0}"'.translate().format(lValue),action:function(){$scope.query_text=lValue,$scope.saveState(),$scope.buildFilters()}}],"listings"==$scope.configs.type){for($key in lResult.push({label:'On "{0}" street'.translate().format(lValue),action:function(){$scope.addFilter("location.address.street_name","contains",lValue,'On "{0}" street'.translate().format(lValue)),$scope.buildFilters()}}),$scope.dictionary.listing_category){let lElm=$scope.dictionary.listing_category[$key],lCaption;$immodbUtils.sanitize(lElm.caption.toLowerCase()).indexOf(lValue)>=0&&lResult.push({label:"{0} (category)".translate().format(lElm.caption),action:function(){lElm.selected=!0,$scope.addFilter("category","in",$scope.getSelection($scope.dictionary.listing_category))}})}for($key in $scope.dictionary.listing_subcategory){let lElm=$scope.dictionary.listing_subcategory[$key],lCaption;$immodbUtils.sanitize(lElm.caption.toLowerCase()).indexOf(lValue)>=0&&lResult.push({label:"{0} (subcategory)".translate().format(lElm.caption),action:function(){lElm.selected=!0,$scope.addFilter("subcategory","in",$scope.getSelection($scope.dictionary.listing_subcategory))}})}for($key in $scope.dictionary.region){let lElm=$scope.dictionary.region[$key],lCaption;$immodbUtils.sanitize(lElm.caption.toLowerCase()).indexOf(lValue)>=0&&lResult.push({label:"{0} (region)".translate().format(lElm.caption),action:function(){lElm.selected=!0,$scope.addFilter("location.region_code","in",$scope.getSelection($scope.dictionary.region))}})}for($key in $scope.dictionary.city){let lElm=$scope.dictionary.city[$key],lCaption;$immodbUtils.sanitize(lElm.caption.toLowerCase()).indexOf(lValue)>=0&&lResult.push({label:"{0} (city)".translate().format(lElm.caption),action:function(){lElm.selected=!0,$scope.addFilter("location.city_code","in",$scope.getSelection($scope.dictionary.city))}})}}else"brokers"==$scope.configs.type&&(lResult.push({label:'Last name is "{0}"'.translate().format($scope.data.keyword),action:function(){$scope.addFilter("last_name","equal_to",$scope.data.keyword,'Last name is "{0}"'.translate().format($scope.data.keyword)),$scope.buildFilters()}}),lResult.push({label:'Last name starts with "{0}"'.translate().format(lValue),action:function(){$scope.addFilter("last_name","starts_with",lValue,'Last name starts with "{0}"'.translate().format(lValue)),$scope.buildFilters()}}),lResult.push({label:'Last name ends with "{0}"'.translate().format(lValue),action:function(){$scope.addFilter("last_name","ends_with",lValue,'Last name ends with "{0}"'.translate().format(lValue)),$scope.buildFilters()}}),lResult.push({label:'First name is "{0}"'.translate().format($scope.data.keyword),action:function(){$scope.addFilter("first_name","equal_to",$scope.data.keyword,'First name is "{0}"'.translate().format($scope.data.keyword)),$scope.buildFilters()}}),lResult.push({label:'First name starts with "{0}"'.translate().format(lValue),action:function(){$scope.addFilter("first_name","starts_with",lValue,'First name starts with "{0}"'.translate().format(lValue)),$scope.buildFilters()}}),lResult.push({label:'First name ends with "{0}"'.translate().format(lValue),action:function(){$scope.addFilter("first_name","ends_with",lValue,'First name ends with "{0}"'.translate().format(lValue)),$scope.buildFilters()}}))}else{let lValue=Number($scope.data.keyword),lPriceMin=Math.max(0,lValue/2),lPriceMax=Math.min(1e6,2*lValue);lResult=[{selected:!0,label:'Contains "{0}"'.translate().format(lValue),action:function(){$scope.query_text=lValue,$scope.buildFilters()}}],"listings"==$scope.configs.type&&(lResult=lResult.concat([{label:"Price is less than {0}".translate().format(lValue.formatPrice()),action:function(){$scope.setMaxPrice(lValue),$scope.buildFilters()}},{label:"Price is more than {0}".translate().format(lValue.formatPrice()),action:function(){$scope.setMinPrice(lValue),$scope.buildFilters()}},{label:"Price is between {0} and {1}".translate().format(lPriceMin.formatPrice(),lPriceMax.formatPrice()),action:function(){$scope.setMinPrice(lPriceMin),$scope.setMaxPrice(lPriceMax),$scope.buildFilters()}},{label:'Has "{0}" as civic address'.translate().format(lValue),action:function(){$scope.addFilter("location.address.street_number","equal",lValue,'Has "{0}" as civic address'.translate().format(lValue))}}]))}$scope.suggestions=lResult},$scope.getReverseSuggestions=function(){let lValue=$scope.data.keyword.toLowerCase(),lValueList=lValue.split(" "),lLabelResults=[],lActionResults=[];for($key in $scope.dictionary.listing_subcategory){let lElm=$scope.dictionary.listing_subcategory[$key],lAdded=!1;if(lValue.indexOf(lElm.caption.toLowerCase())>=0?(lLabelResults.push(lElm.caption),lActionResults.push(function(){lElm.selected=!0,$scope.addFilter("subcategory","in",$scope.getSelection($scope.dictionary.listing_subcategory))}),lAdded=!0):lValueList.some(function($e){if(lElm.caption.toLowerCase().indexOf($e)>=0)return lLabelResults.push(lElm.caption),lActionResults.push(function(){lElm.selected=!0,$scope.addFilter("subcategory","in",$scope.getSelection($scope.dictionary.listing_subcategory))}),lAdded=!0,!0}),lAdded)break}let lTransactions=["for sale","sale"];for($key in lTransactions.some(function($e){if(lValue.indexOf($e)>=0)return lLabelResults.push($e),lActionResults.push(function(){$scope.addFilter("price.sell.amount","greater_than",0)}),!0}),(lTransactions=["for lease","lease"]).some(function($e){if(lValue.indexOf($e)>=0)return lLabelResults.push($e),lActionResults.push(function(){$scope.addFilter("price.lease.amount","greater_than",0)}),!0}),$scope.dictionary.city){let lElm=$scope.dictionary.city[$key],lAdded=!1;if(lValue.indexOf(lElm.caption.toLowerCase())>=0?(lLabelResults.push("in {0}".translate().format(lElm.caption)),lActionResults.push(function(){lElm.selected=!0,$scope.addFilter("location.city_code","in",$scope.getSelection($scope.dictionary.city))})):lValueList.some(function($e){if(lElm.caption.toLowerCase().indexOf($e)>=0)return lLabelResults.push("in {0}".translate().format(lElm.caption)),lActionResults.push(function(){lElm.selected=!0,$scope.addFilter("location.city_code","in",$scope.getSelection($scope.dictionary.city))}),lAdded=!0,!0}),lAdded)break}return{label:lLabelResults.join(" "),action:function(){lActionResult.forEach(function($lf){$lf()}),$scope.buildFilters()}}},$scope.doActionFor=function($item){$scope.suggestions=[],console.log("item clicked"),$item.action()},$scope.trapKeyCode=function($keyCode){let lSelectedIndex=0,lResult=!1;switch($keyCode){case 27:$scope.suggestions=[],lResult=!0;break;case 13:if(""==$scope.data.keyword)$scope.resetFilters();else{let lPassthrough;$scope.suggestions.some(function($e,$i){if(!0===$e.selected)return $e.action(),lResult=!0,!0})&&($scope.suggestions[0].action(),lResult=!0),$scope.saveState("search-keyword",$scope.data.keyword),$scope.suggestions=[]}break;case 38:$scope.suggestions.every(function($e,$i){return!0!==$e.selected||(lSelectedIndex=$i,delete $e.selected,!1)}),lSelectedIndex=Math.max(lSelectedIndex-1,0),$scope.suggestions[lSelectedIndex].selected=!0,lResult=!0;break;case 40:$scope.suggestions.every(function($e,$i){return null==$e.selected||!0!==$e.selected||(lSelectedIndex=$i,delete $e.selected,!1)}),lSelectedIndex=Math.min(lSelectedIndex+1,$scope.suggestions.length-1),$scope.suggestions[lSelectedIndex].selected=!0,lResult=!0}return lResult},$scope.getConfigs=function(){let lPromise;return $q(function($resolve,$reject){null==$scope.configs?(console.log("get config for",$scope.alias),$immodbApi.getListConfigs($scope.alias).then(function($configs){$scope.configs=$configs,$resolve($scope.configs)})):$resolve($scope.configs)})},$scope.hasFilters=function(){return null!=$scope.filter_group.filter_groups||null!=$scope.filter_group.filters||null!=$scope.query_text||null!=$scope.data.location},$scope.hasFilter=function($fieldname){if($scope.hasFilters()){let lFilter;return null!=$scope.getFilterByFieldName($fieldname)}return!1},$scope.getFilterValue=function($fieldname){let lFilter=$scope.getFilterByFieldName($fieldname);return null!=lFilter?lFilter.value:null},$scope.getFilterByFieldName=function($fieldname){let lResult=null;return null!=$scope.filter_group.filters&&$scope.filter_group.filters.every(function($e){return $e.field!=$fieldname||(lResult=$e,!1)}),lResult},$scope.addFilter=function($field,$operator,$value,$label,$reverseFunc){"function"!=typeof $scope.$parent.addFilter?("function"==typeof $field.push?$scope.addFilterGroup($field,$operator,$value,$label):$scope.setFilter($field,$operator,$value,$scope.filter_group,$label,$reverseFunc),$scope.saveState(),$scope.buildFilters()):$scope.$parent.addFilter($field,$operator,$value,$label,$reverseFunc)},$scope.addAttributeFilter=function($attr){let lValue=!!$attr.selected||"";$scope.addFilter($attr.field,"equal",lValue,$attr.caption.translate(),function(){$attr.selected=!1,$scope.addFilter($attr.field,"equal","")})},$scope.addFilterGroup=function($field,$operator,$value,$label){let lGroupName=$field.join("-")+"-"+$operator,parentFilterGroup=$scope.getFieldGroup(lGroupName,$scope.filter_group);null==parentFilterGroup&&(parentFilterGroup={operator:"or",name:lGroupName,filters:null,filter_groups:null},null==$scope.filter_group.filter_groups&&($scope.filter_group.filter_groups=[]),$scope.filter_group.filter_groups.push(parentFilterGroup)),$field.forEach(function($f,$index){let lValue=$value;null!=$value&&"function"==typeof $value.push&&(lValue=$value.length>$index?$value[$index]:null),$scope.setFilter($f,$operator,lValue,parentFilterGroup,$label)}),null==parentFilterGroup.filters&&$scope.filter_group.filter_groups.every(function($g,$i){if($g.name==parentFilterGroup.name)return $scope.filter_group.filter_groups.splice($i,1),!1}),0==$scope.filter_group.filter_groups.length&&($scope.filter_group.filter_groups=null)},$scope.setFilter=function($field,$operator,$value,$group,$label,$reverseFunc){null==$group.filters&&($group.filters=[]);let lFilterIndex=0,lNewFilter={field:$field,operator:$operator,value:$value,label:$label,reverse:$reverseFunc||function(){$scope.addFilter($field,$operator,"")}};for(lFilterIndex=0;lFilterIndex<$group.filters.length&&$group.filters[lFilterIndex].field!=$field;lFilterIndex++);""===$value||null==$value?$scope.removeFilter(lFilterIndex,$group):"function"==typeof $value.push&&0==$value.length?$scope.removeFilter(lFilterIndex,$group):$scope.updateFilter(lNewFilter,lFilterIndex,$group)},$scope.updateFilter=function($filter,$index,$group){$group.filters[$index]=$filter},$scope.removeFilter=function($index,$group){$group.filters.splice($index,1),0==$group.filters.length&&($group.filters=null)},$scope.getFieldGroup=function($groupName,$parent){if($parent.name==$groupName)return $parent;if(null!=$parent.filter_groups){let lResult=null;return $parent.filter_groups.every(function($g){return null==(lResult=$scope.getFieldGroup($groupName,$g))}),lResult}return null},$scope.resetFilters=function(){$scope.data.keyword="",$scope.filter_group={operator:"and",filters:null,filter_groups:null},$scope.query_text=null,$scope.data.min_price=null,$scope.data.max_price=null,$scope.data.location=null;for(let $key in $scope.dictionary)$scope.resetListSelections($scope.dictionary[$key]);$scope.resetListSelections($scope.listing_attributes),null!=$scope.bedroomSuggestions&&$scope.bedroomSuggestions.forEach(function($e){delete $e.selected}),null!=$scope.bathroomSuggestions&&$scope.bathroomSuggestions.forEach(function($e){delete $e.selected}),null!=$scope.parkingSuggestions&&$scope.parkingSuggestions.forEach(function($e){delete $e.selected}),null!=$scope.garageSuggestions&&$scope.garageSuggestions.forEach(function($e){delete $e.selected}),$scope.clearState(),$scope.clearState("search-keyword"),$scope.buildFilters()},$scope.resetListSelections=function($list){for(let $subkey in $list)delete $list[$subkey].selected},$scope.buildFilters=function(){let lResult=null,lPromise;return $q(function($resolve,$reject){$scope.getConfigs().then(function($configs){$configs.limit>0&&(lResult={max_item_count:$configs.limit}),(null!=$configs.filter_group||$scope.hasFilters())&&(null==lResult&&(lResult={}),lResult.filter_group={filters:[]},null!=$configs.filter_group&&(lResult.filter_group=angular.copy($configs.filter_group)),$scope.hasFilters()&&lResult.filter_group.filter_groups.push($scope.filter_group),lResult.filter_group=$scope.normalizeFilterGroup(lResult.filter_group)),$scope.sort_fields.length>0?lResult.sort_fields=$scope.sort_fields:lResult.sort_fields=[{field:$configs.sort,desc:$configs.sort_reverse}],null!=$scope.query_text&&(lResult.query_text=$scope.query_text),null!=$scope.data.location&&(lResult.proximity_filter=$scope.data.location),$scope.getSearchToken(lResult).then(function($token){""!=$token?($scope.saveState("st",$token),$rootScope.$broadcast($scope.alias+"FilterTokenChanged",$token),""!=$scope.result_page&&null!=$scope.result_page&&(window.location=$scope.result_page),null!=$scope.onTokenChange?(console.log("calling onTokenChange function",$scope.onTokenChange),$scope.onTokenChange()):$rootScope.$broadcast($scope.alias+"filterUpdate"),$resolve($token)):$reject()})})})},$scope.navigate=function(){""!=$scope.result_page&&null!=$scope.result_page&&$scope.buildFilters().then(function($token){window.location=$scope.result_page})},$scope.getSelection=function($list){let lResult=[];for(let lKey in $list)1==$list[lKey].selected&&lResult.push(lKey);return lResult},$scope.normalizeFilterGroup=function($filter_group){return $filter_group.filters&&$filter_group.filters.forEach(function($filter){["in","not_in"].indexOf($filter.operator)>=0?("function"==typeof $filter.value.split&&($filter.value=$filter.value.split(",")),$filter.value.forEach(function($val){typeof $val!=typeof!0&&(isNaN($val)||($val=Number($val)))})):typeof $filter.value!=typeof!0&&(isNaN($filter.value)||($filter.value=Number($filter.value)))}),$filter_group.filter_groups&&$filter_group.filter_groups.forEach(function($group){$scope.normalizeFilterGroup($group)}),$filter_group},$scope.setPrice=function($value,$eventOrInput){let lInput=$scope.selected_price_input;"string"==typeof $eventOrInput&&(lInput=$eventOrInput),$scope.data[lInput+"_price"]=""==$value?void 0:$value},$scope.setMinPrice=function($value){$scope.setPrice($value,"min")},$scope.setMaxPrice=function($value){$scope.setPrice($value,"max")},$scope.$watch("data.min_price",function(newValue,oldValue){newValue!=oldValue&&$scope.addFilter(["price.sell.amount","price.lease.amount"],"greater_or_equal_to",$scope.data.min_price)}),$scope.$watch("data.max_price",function(newValue,oldValue){newValue!=oldValue&&$scope.addFilter(["price.sell.amount","price.lease.amount"],"less_or_equal_to",$scope.data.max_price)}),$scope.saveState=function($item_key,$data){let lKey="immodb."+$scope.alias+".{0}";if(null==$item_key)sessionStorage.setItem(lKey.format("filter_group"),JSON.stringify($scope.filter_group)),sessionStorage.setItem(lKey.format("data"),JSON.stringify($scope.data));else{let lValue=$data;"object"==typeof lValue&&(lValue=JSON.stringify(lValue)),sessionStorage.setItem(lKey.format($item_key),lValue)}},$scope.clearState=function($item_key){let lKey="immodb."+$scope.alias+".{0}";null==$item_key?(sessionStorage.removeItem(lKey.format("filter_group")),sessionStorage.removeItem(lKey.format("data")),sessionStorage.removeItem(lKey.format("st"))):sessionStorage.removeItem(lKey.format($item_key))},$scope.loadState=function($item_key){if($key="immodb."+$scope.alias+".{0}",null!=$item_key){let lResult=sessionStorage.getItem($key.format($item_key));try{lResult=JSON.parse(lResult)}catch(error){}return lResult}{let lSessionFilterGroup=sessionStorage.getItem($key.format("filter_group")),lSessionData=sessionStorage.getItem($key.format("data"));if(null!=lSessionFilterGroup&&($scope.filter_group=JSON.parse(lSessionFilterGroup)),null!=lSessionData){let lData=JSON.parse(lSessionData);$scope.data.keyword=lData.keyword}}},$scope.getSearchToken=function($filters){let lPromise;return $q(function($resolve,$reject){null!=$filters?$immodbApi.api("utils/search_encode",$filters).then(function($response){$resolve($response)}):$resolve("")})}}}}]),ImmoDbApp.directive("immodbStreetview",function immodbStreetView($immodbTemplate,$immodbUtils,$immodbDictionary){let dir_controller;return{restrict:"E",replace:!0,scope:{alias:"@immodbAlias",class:"@class",configs:"=?immodbConfigs",latlng:"=?latlng",zoom:"@"},controllerAs:"ctrl",template:'<div><div id="map-{{alias}}" class="map-viewport"></div><div id="pano-{{alias}}" class="viewport"></div></div>',controller:function($scope,$q,$immodbApi,$rootScope){$scope.ready=!1,$scope.is_visible=!1,$scope.zoom=14,$scope.is_loading_data=!1,$scope.late_init=!0,$scope.markers=[],$scope.markerCluster=null,$scope.bounds=null,$scope.client={search_token:null},$scope.permalink="",$scope.$onInit=function(){if("undefined"!=typeof google&&0==$scope.ready){let options={center:new google.maps.LatLng(45.6025503,-73.8469538),zoom:$scope.zoom};$scope.map=new google.maps.Map($scope.map_element,options),$scope.ready=!0}},$scope.setView=function($position){let lPosition=new google.maps.LatLng($position.lat,$position.lng);$scope.panorama=new google.maps.StreetViewPanorama($scope.viewport_element,{position:lPosition,pov:{heading:34,pitch:10}}),$scope.map.setStreetView($scope.panorama)},$scope.isReady=function(){let lPromise;return $q(function($resolve,$reject){1==$scope.ready?$resolve():$scope.$watch("ready",function(){1==$scope.ready&&$resolve()})})},$scope.$watch("latlng",function(){null!=$scope.latlng&&null!=$scope.latlng.lat&&$scope.isReady().then(function(){$scope.setView($scope.latlng)})})},link:function($scope,element){$scope.map_element=element.children()[0],$scope.viewport_element=element.children()[1],$scope.$onInit()}}}),ImmoDbApp.directive("immodbMap",function immodbMap($immodbTemplate,$immodbUtils,$immodbDictionary,$immodbHooks){let dir_controller;return{restrict:"E",replace:!0,scope:{alias:"@immodbAlias",class:"@class",configs:"=?immodbConfigs",latlng:"=?latlng",zoom:"@"},controllerAs:"ctrl",template:'<div><div id="map-{{alias}}" class="viewport"></div></div>',controller:function($scope,$q,$immodbApi,$rootScope){function ImmoDbMarker(options){this.latlng_=options.position,this.markerClass=options.markerClass,this.onClick=options.onPinClick,this.obj=options.obj,this.div_=null,this.title=options.title,this.setMap(options.map)}var $proto;$scope.ready=!1,$scope.is_visible=!1,$scope.zoom=8,$scope.is_loading_data=!1,$scope.late_init=!0,$scope.markers=[],$scope.markerCluster=null,$scope.bounds=null,$scope.client={search_token:null},$scope.permalink="",$scope.$onInit=function(){null!=$scope.latlng?$scope.mapInit():($scope.$on("immodb-{0}-display-switch-map".format($scope.alias),$scope.onSwitchToMap),$scope.$on("immodb-{0}-display-switch-list".format($scope.alias),$scope.onSwitchToList)),$rootScope.$on($scope.alias+"FilterTokenChanged",$scope.onFilterTokenChanged)},$scope.mapInit=function(){if(0==$scope.ready){let options={center:new google.maps.LatLng(45.6025503,-73.8469538),zoom:$scope.zoom};$scope.map=new google.maps.Map($scope.viewport_element,options),$scope.ready=!0}},$scope.setZoom=function($zoom){$scope.map.setZoom($zoom)},$scope.getList=function(){0==$scope.is_loading_data&&$scope.search($scope.getSearchToken())},$scope.getSearchToken=function(){return null!=$scope.client.search_token?$scope.client.search_token:$scope.configs.search_token},$scope.onFilterTokenChanged=function($event,$newToken){$scope.client.search_token=$newToken,$scope.isReady().then(function(){$scope.getList()})},$scope.onSwitchToMap=function(){$scope.mapInit(),$scope.bounds&&window.setTimeout(function(){$scope.map.fitBounds($scope.bounds)},250),0==$scope.markers.length&&$scope.getList(),$scope.is_visible=!0},$scope.onSwitchToList=function(){$scope.is_visible=!1},$scope.search=function($token){lParams={st:$token},$scope.page_index=0,$scope.is_loading_data=!0,$immodbApi.api($scope.getEndpoint()+"map_markers",lParams,{method:"GET"}).then(function($response){$scope.list=$response.markers,$scope.updateMarkerList(),console.log("marker list:",$scope.list),$scope.is_loading_data=!1})},$scope.getEndpoint=function(){let lOrigin;return $scope.getEndpointType().concat("/view/",$scope.configs.source.id,"/")},$scope.getEndpointType=function(){let lResult=$scope.configs.type;switch(lResult){case"listings":lResult="listing";break;case"brokers":lResult="broker";break;case"cities":lResult="city"}return lResult},$scope.clear=function(){$scope.markers&&$scope.markers.forEach(function($m){$m.setMap(null)}),null!=$scope.markerCluster&&$scope.markerCluster.clearMarkers(),$scope.markers=[]},$scope.addSingleMarker=function($location){console.log("adding single marker at",$location),$scope.clear(),$scope.markers.push(new google.maps.Marker({map:$scope.map,position:$location,animation:google.maps.Animation.DROP})),$scope.map.setCenter($location)},$scope.updateMarkerList=function(){if($scope.clear(),$scope.bounds=new google.maps.LatLngBounds,console.log($scope.list[0]),$scope.list.forEach(function($marker){let lngLat=new google.maps.LatLng($marker.latitude,$marker.longitude);$marker.marker=new ImmoDbMarker({position:lngLat,map:$scope.map,obj:$marker,markerClass:["map-marker-icon",$marker.category_code.replace(" ","_")],onPinClick:$scope.pinClick}),$scope.markers.push($marker.marker),$scope.bounds.extend($marker.marker.getPosition())}),$scope.list.length>1){let lImagePath="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m",lClustererOptions={gridSize:80,styles:[{url:lImagePath+"1.png",height:53,width:54,anchor:[0,0]},{url:lImagePath+"2.png",height:56,width:55,anchor:[0,0]},{url:lImagePath+"3.png",width:66,height:65,anchor:[0,0]}]};lClustererOptions=$immodbHooks.filter("marker_cluster_options",lClustererOptions),$scope.markerCluster=new MarkerClusterer($scope.map,$scope.markers,lClustererOptions),1==$scope.is_visible&&window.setTimeout(function(){$scope.map.fitBounds($scope.bounds)},250)}else $scope.list.length>0&&($scope.map.setCenter($scope.list[0].marker.getPosition()),$scope.map.setZoom(12));console.log("Map markers updated")},$scope.pinClick=function($marker){console.log("Marker clicked",$marker),$immodbApi.api($scope.getEndpointType().concat("/",$marker.obj.id,"/",immodbApiSettings.locale)).then(function($response){let lInfoWindowScope=$immodbUtils;$immodbDictionary.source=$response.dictionary,lInfoWindowScope.compileListingItem($response),lInfoWindowScope.item=$response,console.log("lInfoWindowScope",lInfoWindowScope),$immodbTemplate.load("views/ang-templates/immodb-map-info-window.html",lInfoWindowScope).then(function($content){let infowindow;new google.maps.InfoWindow({content:$content}).open($scope.map,$marker)})})},$scope.isReady=function(){let lPromise;return $q(function($resolve,$reject){1==$scope.ready?$resolve():$scope.$watch("ready",function(){1==$scope.ready&&$resolve()})})},$scope.$watch("latlng",function(){null!=$scope.latlng&&null!=$scope.latlng.lat&&(console.log("latlng",$scope.latlng),$scope.isReady().then(function(){$scope.addSingleMarker($scope.latlng)}))}),$scope.$watch("zoom",function(){null!=$scope.zoom&&$scope.isReady().then(function(){$scope.setZoom(Number($scope.zoom))})}),"undefined"!=typeof google&&(ImmoDbMarker.prototype=new google.maps.OverlayView,($proto=ImmoDbMarker.prototype).draw=function(){var me=this,div=this.div_,point=this.getProjection().fromLatLngToDivPixel(this.latlng_);point&&(div.style.left=point.x+"px",div.style.top=point.y+"px")},$proto.onAdd=function(){var me=this,panes;div=this.div_=document.createElement("DIV"),div.style.border="none",div.style.position="absolute",div.style.paddingLeft="0px",div.style.cursor="pointer",this.markerClass.forEach(function($c){div.classList.add($c.toLowerCase())}),google.maps.event.addDomListener(div,"click",function(event){"function"==typeof me.onClick&&me.onClick(me)}),this.getPanes().overlayImage.appendChild(div)},$proto.onRemove=function(){null!=this.div_&&(this.div_.parentNode.removeChild(this.div_),this.div_=null)},$proto.hide=function(){this.div_&&(this.div_.style.visibility="hidden")},$proto.show=function(){this.div_&&(this.div_.style.visibility="visible")},$proto.toggle=function(){this.div_&&("hidden"===this.div_.style.visibility?this.show():this.hide())},$proto.getPosition=function(){return this.latlng_},$proto.toggleDOM=function(){this.getMap()?this.setMap(null):this.setMap(this.map_)})},link:function($scope,element){$scope.viewport_element=element.children()[0],$scope.$onInit()}}}),ImmoDbApp.directive("onBottomReached",function onBottomReached($document){return{restrict:"A",link:function(scope,element,attrs){var raw=element[0];let doc=$document[0];console.log("loading directive on "),$document.bind("scroll",function(){let lTop,lBottomLimit;(window.pageYOffset||doc.scrollTop)-(doc.clientTop||0)>=raw.offsetHeight+raw.offsetTop-window.innerHeight/3*2&&scope.$apply(attrs.onBottomReached)})}}}),ImmoDbApp.directive("immodbImageSlider",function immodbImageSlider(){let dir_controller=function immodbImageSliderCtrl($scope,$q,$immodbApi,$rootScope,$immodbDictionary,$immodbHooks){$scope.expand_mode=!1,$scope.picture_grid_mode=!1,$scope.position={current_picture_index:0},$scope.init=function(){$scope.index=0},$scope.next=function(){console.log($scope.index,"/",$scope.pictures.length-1);let lNewIndex=$scope.index+1;lNewIndex>=$scope.pictures.length&&(lNewIndex=0),$scope.set(lNewIndex)},$scope.previous=function(){let lNewIndex=$scope.index-1;-1==lNewIndex&&(lNewIndex=$scope.pictures.length-1),$scope.set(lNewIndex)},$scope.set=function($index){$scope.index=$index,$scope.picture_grid_mode=!1;try{$scope.$digest()}catch($e){}},$scope.toggleExpand=function(){$scope.expand_mode=!$scope.expand_mode},$scope.getPosition=function(){return"-"+100*$scope.position.current_picture_index+"%"},$scope.$watch("pictures",function(){null!=$scope.pictures&&$scope.init()}),$scope.toggleFullscreen=function(){document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement?(document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen(),$scope.expand_mode=!1):($scope.$element.requestFullscreen?$scope.$element.requestFullscreen():$scope.$element.mozRequestFullScreen?$scope.$element.mozRequestFullScreen():$scope.$element.webkitRequestFullscreen?$scope.$element.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT):$scope.$element.msRequestFullscreen&&$scope.$element.msRequestFullscreen(),$scope.expand_mode=!0)},$scope.togglePictureGrid=function(){$scope.picture_grid_mode=!$scope.picture_grid_mode},$scope.getImageAlt=function($img){let lResult=$immodbDictionary.getCaption($img.category_code,"photo_category");return lResult=$immodbHooks.filter("listing-picture-alt",lResult,$img)},$scope.getImageCaption=function($img){let lResult=$immodbDictionary.getCaption($img.category_code,"photo_category");return lResult=$immodbHooks.filter("listing-picture-caption",lResult,$img)}};return{restrict:"E",scope:{pictures:"=immodbPictures",dictionary:"=?immodbDictionary",gap:"@immodbGap",index:"=?immodbIndex"},controllerAs:"ctrl",replace:!0,templateUrl:immodbCtx.base_path+"views/ang-templates/immodb-image-slider.html",controller:dir_controller,link:function(scope,element,attrs){scope.$element=element[0];var mc=new Hammer(element[0]);let lPanHndl=null;mc.get("pan").set({direction:Hammer.DIRECTION_HORIZONTAL}),mc.on("swipeleft swiperight",function(ev){switch(console.log(ev.type+" gesture detected."),ev.type){case"swipeleft":scope.next();break;case"swiperight":scope.previous()}})}}}),ImmoDbApp.directive("immodbCalculator",function immodbCalculator(){return{restrict:"E",scope:{amount:"=immodbAmount",dictionary:"=?immodbDictionary",downpayment_selection:"@?immodbDownpaymentSelection",region:"@?immodbRegion",on_change:"&onChange"},controllerAs:"ctrl",replace:!0,templateUrl:immodbCtx.base_path+"views/ang-templates/immodb-calculator.html",controller:function($scope,$q,$rootScope){$scope.downpayment_selection="manual",$scope.data={amount:0,amortization:25,downpayment:20,interest:3,frequency:26,downpayment_method:"percent"},$scope.frequencies={12:"Monthly",26:"Every two weeks",52:"Weekly"},$scope.init=function(){$scope.preload(),$scope.data.amount=$scope.amount,$scope.process()},$scope.changeDownpaymentMethod=function($value){$value!=$scope.data.downpayment_method&&($scope["convertDownpaymentTo_"+$value](),$scope.data.downpayment_method=$value,$scope.process())},$scope.convertDownpaymentTo_cash=function(){let lResult=0;lResult=Math.round($scope.data.amount*($scope.data.downpayment/100)),$scope.data.downpayment=lResult},$scope.convertDownpaymentTo_percent=function(){let lResult=0;lResult=Math.round(100/($scope.data.amount/$scope.data.downpayment)),$scope.data.downpayment=lResult},$scope.setFrequency=function($value){$scope.data.frequency=$value,$scope.process()},$scope.process=function(){"manual"==$scope.downpayment_selection?$scope.process_single():$scope.process_multi(),$scope.save()},$scope.process_single=function(){let lBranch={downpayment:0,insurance:0,mortgage:0,amortization:$scope.data.amortization,rate:$scope.data.interest,frequency:$scope.data.frequency,frequency_caption:$scope.frequencies[$scope.data.frequency],payment:0},lRatio="percent"==$scope.data.downpayment_method?$scope.data.downpayment/100:$scope.data.downpayment/$scope.data.amount;console.log("ratio",lRatio),$scope.process_branch(lBranch,lRatio);let lResult={mortgage:lBranch,transfer_tax:getTransferTax($scope.data.amount,"06 "==$scope.region)};$rootScope.$broadcast("immodb-mortgage-calculator-result-changed",lResult),"function"==typeof $scope.on_change&&$scope.on_change({$result:lResult}),console.log("processing triggered",lResult)},$scope.process_branch=function(branch,downpayment_ratio){branch.downpayment=getDownPayment($scope.data.amount,downpayment_ratio),branch.insurance=getMortgageInsurance($scope.data.amount,downpayment_ratio),branch.mortgage=$scope.data.amount-branch.downpayment+branch.insurance;var PrValue=branch.mortgage,IntRate=branch.rate/100,Period=branch.amortization,PPay=branch.frequency,intcandebase=Math.pow(1+IntRate/2,2/PPay)-1,paymperiobase=PrValue*intcandebase/(1-1/Math.pow(1+intcandebase,Period*PPay));branch.payment=paymperiobase},getDownPayment=function(price,downpayment_ratio){return price*downpayment_ratio},getMortgageInsurance=function(price,downpayment_ratio){var lResult=price-price*downpayment_ratio;switch(downpayment_ratio){case.05:lResult*=.036;break;case.1:lResult*=.024;break;case.15:lResult*=.018;break;case.2:lResult*=0}return lResult},getTransferTax=function(amount,in_montreal){in_montreal=void 0!==in_montreal&&in_montreal,parts=[],console.log("in montreal",in_montreal),parts.push(.005*(amount>5e4?5e4:amount)),amount>5e4&&(parts.push(.01*(amount>25e4?2e5:amount-5e4)),in_montreal?(amount>25e4&&parts.push(.015*(amount>5e5?25e4:amount-25e4)),amount>5e5&&parts.push(.02*(amount-5e5))):amount>25e4&&parts.push(.015*(amount-25e4)));for(var lResult=0,i=0;i<parts.length;i++)lResult+=parts[i];return lResult},$scope.preload=function(){let lData=sessionStorage.getItem("immodb.mortgage-calculator");null!=lData&&($scope.data=JSON.parse(lData))},$scope.save=function(){sessionStorage.setItem("immodb.mortgage-calculator",JSON.stringify($scope.data))},$scope.$watch("amount",function(){null!=$scope.amount&&$scope.init()})}}}),ImmoDbApp.directive("immodbModalTrigger",function immodbModalTrigger(){return{restrict:"C",scope:{target:"@"},link:function($scope,element,attr){angular.element(element).bind("click",function(){$scope.openModal()})},controller:function($scope,$rootScope){$scope.openModal=function(){console.log("broadcasting show-",$scope.target),$rootScope.$broadcast("show-"+$scope.target)}}}}),ImmoDbApp.directive("immodbModal",function immodbModal(){let dir_controller=function immodbModalCtrl($scope,$q,$immodbApi,$rootScope){$scope.options={close_label:null,ok_label:"OK"},console.log('listening to "show-'+$scope.modal_id+'" trigger'),$scope.$on("show-"+$scope.modal_id,function(){console.log("show modal trigger received"),$scope.open()}),$scope.init=function(){null==$scope.model&&($scope.model={})},$scope.cancelEvent=function($event){console.log("event trapped bouhou!"),$event.stopPropagation()},$scope.open=function(){$scope.modal_element.addClass("opened"),$scope.$emit("modal-opened")},$scope.close=function(){$scope.modal_element.removeClass("opened"),$scope.$emit("modal-closed")},$scope.closeWithValue=function(){console.log("close with value",typeof $scope.onOK),$scope.modalForm.$valid&&("function"==typeof $scope.onOK&&$scope.onOK(),$scope.close())},$scope.$watch("modal_title",function(){null!=$scope.amount&&$scope.init()}),$scope.$watch("ok_label",function(){null!=$scope.ok_label&&($scope.options.ok_label=$scope.ok_label)}),$scope.$watch("close_label",function(){null!=$scope.close_label&&($scope.options.close_label=$scope.close_label)})};return{restrict:"E",scope:{modal_id:"@modalId",modal_title:"@modalTitle",onOK:"&?onOk",model:"=ngModel",ok_label:"@?okLabel",cancel_label:"@?cancelLabel",onValidate:"&?onValidate"},controllerAs:"ctrl",replace:!0,transclude:!0,templateUrl:immodbCtx.base_path+"views/ang-templates/immodb-modal.html",link:function(scope,element,attr){scope.modal_element=element,angular.element(document.body).append(scope.modal_element)},controller:dir_controller}}),ImmoDbApp.directive("immodbContainer",function immodbContainer(){return{restrict:"E",replace:!0,transclude:!0,scope:!0,template:"",controller:function($element,$transclude){$element.append($transclude())}}}),ImmoDbApp.directive("immodbListingNavigation",["$q",function immodbListingNavigation(){return{restrict:"E",replace:!0,transclude:!0,scope:{current:"=immodbCurrent",display:"@immodbDisplay",panelTitle:"@?immodbTitle"},templateUrl:immodbCtx.base_path+"views/ang-templates/immodb-listing-navigation.html",link:function($scope,element,attr){$scope.init()},controller:function($scope,$rootScope){$scope.list=[],$scope.previous=null,$scope.next=null,$scope.init=function(){},$scope.$watch("current",function($new,$old){null!=$new&&$scope.getNextAndPrevious()}),$scope.loadList=function(){let lList=sessionStorage.getItem("immodb.list.listings.{0}".format(immodbCtx.locale));$scope.list=null!=lList?JSON.parse(lList):[]},$scope.getNextAndPrevious=function(){$scope.loadList();let lCurrentIndex=0;$scope.list.some(function($e,$index){if($e.id==$scope.current)return lCurrentIndex=$index,!0}),console.log("getNextAndPrevious",$scope.current,lCurrentIndex),lCurrentIndex>0&&($scope.previous=$scope.list[lCurrentIndex-1],console.log("previous",$scope.previous)),lCurrentIndex<$scope.list.length-1&&($scope.next=$scope.list[lCurrentIndex+1],console.log("next",$scope.next))}}}}]),ImmoDbApp.directive("immodbLoading",[function immodbLoading(){return{restrict:"E",replace:!0,scope:{label:"@immodbLabel"},template:'<div class="immodb-loading"><i class="fal fa-spinner fa-spin"></i> {{label.translate()}}</div>',controller:function($scope){}}}]),ImmoDbApp.directive("immodbDropdown",[function immodbDropdown(){return{restrict:"C",scope:{showButtonIcon:"=?",hasValue:"@?"},link:function(scope,element,attr){let lElm=angular.element(element);scope._elm=lElm,scope.showButtonIcon=void 0===scope.showButtonIcon||scope.showButtonIcon,scope.hasValue=void 0!==scope.hasValue&&null!=scope.hasValue,scope.hasValue&&lElm.addClass("has-value"),scope.showButtonIcon&&lElm.addClass("has-button-icon"),angular.element(document).bind("click",function(){lElm.removeClass("expanded")}),lElm.find(".button").bind("click",function($event){lElm.addClass("expanded"),$event.stopPropagation()})},controller:function($scope){$scope.$watch("hasValue",function($new,$old){1==$new?$scope._elm.addClass("has-value"):$scope._elm.removeClass("has-value")})}}}]),ImmoDbApp.directive("immodbCheckbox",[function immodbCheckbox(){return{retrict:"E",transclude:!0,scope:{label:"@",model:"=?ngModel"},template:'<div class="pretty p-icon p-pulse"><input type="checkbox" ng-model="model"><div class="state"><i class="icon fas fa-check"></i><label>{{label}}</label></div></div>'}}]),ImmoDbApp.directive("immodbRadio",[function immodbRadio(){return{retrict:"E",transclude:!0,scope:{label:"@",checked:"=?ngChecked",name:"@"},link:function(scope){},template:'<div class="any-selector pretty p-icon p-pulse p-round"><input type="radio" name="{{name}}" ng-checked="checked"><div class="state"><i class="icon fas fa-circle fa-xs"></i><label>{{label}}</label></div></div>'}}]),ImmoDbApp.directive("inputContainer",function(){return{restrict:"C",scope:{},link:function(scope,element,attr){let lElm=angular.element(element);lElm.find("[required]").length>0&&lElm.addClass("is-required"),scope.$watch(function(){return lElm.find("input,textarea").attr("class")},function(newValue){if(null==newValue||void 0===newValue)return null;["ng-invalid","ng-dirty","ng-pristine","ng-touched"].forEach(function($c){newValue.indexOf($c)>=0?lElm.addClass($c):lElm.removeClass($c)})})}}}),ImmoDbApp.factory("$immodbTemplate",["$http","$q","$interpolate","$sce",function $immodbTemplate($http,$q,$interpolate,$sce){let $scope={load:function($path,$template_scope){let templateUrl=$sce.getTrustedResourceUrl(immodbCtx.base_path+$path),lPromise;return $q(function($resolve,$reject){$http.get(templateUrl).then(function($response){let lContent=$scope.interpolate($response.data,$template_scope);$resolve(lContent)})})},interpolate:function($content,$template_scope){return $interpolate($content)($template_scope)}};return $scope}]),ImmoDbApp.factory("$immodbApi",["$http","$q","$immodbConfig","$rootScope",function $immodbApi($http,$q,$immodbConfig,$rootScope){let $scope={viewMetas:{},api:function($path,$data,$options){let lPromise;return $q(function($resolve,$reject){$scope.renewToken().then(function(){$scope.call($path,$data,$options).then(function($result){$resolve($result)})})})},rest:function($path,$data,$options){return $scope.rest_call($path,$data,$options)},tokenIsValid:function(){let lNow=new Date,lExpireDate;if(null==$scope.auth_token){let lStoredToken=sessionStorage.getItem("immodb.auth_token");if(null==lStoredToken||""==lStoredToken)return!1;$scope.auth_token=JSON.parse(lStoredToken)}return!(new Date(Date.parse($scope.auth_token.expire_date))<lNow)},renewToken:function(){let lPromise;return $q(function($resolve,$reject){$scope.tokenIsValid()?$resolve():$scope.rest_call("access_token").then(function($response){""!=$response?($scope.auth_token=$response,$rootScope.$broadcast("auth_token_refresh"),sessionStorage.setItem("immodb.auth_token",JSON.stringify($scope.auth_token)),$resolve()):$reject()})})},getDefaultDataView:function(){let lPromise;return $q(function($resolve,$reject){$immodbConfig.get().then(function($config){$resolve(JSON.parse($config.default_view))})})},getListConfigs:function($alias){let lPromise;return $q(function($resolve,$reject){$immodbConfig.get().then(function($configs){let lResult=null;console.log($configs),$configs.lists.some(function($e){if($e.alias==$alias)return lResult=$e,!0}),$resolve(lResult)})})},getViewMeta:function($type,$view_id){let lOrigin=$type,lViewMetaKey=$type+"::"+$view_id;switch(lOrigin){case"listings":lOrigin="listing";break;case"brokers":lOrigin="broker";break;case"cities":lOrigin="city"}let lEndPoint="".concat("view/",$view_id,"/",immodbApiSettings.locale),lPromise;return $q(function($resolve,$reject){if(null!=$scope.viewMetas[lViewMetaKey]&&null==$scope.viewMetas[lViewMetaKey].loading)$resolve($scope.viewMetas[lViewMetaKey]);else if(null!=$scope.viewMetas[lViewMetaKey]&&1==$scope.viewMetas[lViewMetaKey].loading){let fnWait=function(){1==$scope.viewMetas[lViewMetaKey].loading?window.setTimeout(fnWait,15):$resolve($scope.viewMetas[lViewMetaKey])};fnWait()}else $scope.viewMetas[lViewMetaKey]={loading:!0},$scope.api(lEndPoint).then(function($response){$scope.viewMetas[lViewMetaKey]=$response,$resolve($response)})})},call:function($path,$data,$options){let lPromise;return"GET"==($options=angular.merge({url:immodbApiSettings.api_root+"/api/"+$path,method:void 0===$data||null==$data?"GET":"POST",data:$data},$options)).method&&null!=$options.data&&($options.params=$options.data,$options.data=null),void 0===$options.params&&($options.params={}),$options.params.at=$scope.auth_token.key,$q(function($resolve,$reject){$http($options).then(function success($result){"200"==$result.status?$resolve($result.data):$reject(null)},function fail($error){console.log($error)})})},rest_call:function($path,$data,$options){let lPromise;return"GET"==($options=angular.merge({url:immodbApiSettings.rest_root+"immodb/"+$path,method:void 0===$data||null==$data?"GET":"POST",data:$data,headers:{"X-WP-Nonce":immodbApiSettings.nonce}},$options)).method&&null!=$options.data&&($options.params=$options.data,$options.data=null),$q(function($resolve,$reject){$http($options).then(function success($result){"200"==$result.status?$resolve($result.data):$reject(null)},function fail($error){console.log($error)})})}};return $scope}]),ImmoDbApp.factory("$immodbDictionary",function $immodbDictionary(){let $scope={source:null,init:function($source){$scope.source=$source},sortData:function(){for(let lGroup in $scope.source)$scope.source[lGroup]=$scope.sortCollection($scope.source[lGroup])},sortCollection:function($coll){let lCollArray=$scope._toArray($coll);lCollArray.sort(function(a,b){return a.__data.caption<=b.__data.caption?-1:1}),console.log("immodbDictionary array sorted",lCollArray);let lResult=$scope._toObject(lCollArray);return console.log("immodbDictionary sorted collection",lResult),lResult},_toArray:function($object){let lResult=[];for(let $key in $object)lResult.push({__key:$key.toString(),__data:$object[$key]});return lResult},_toObject:function($array){let lResult={};return $array.forEach(function($e){lResult[$e.__key]=$e.__data}),lResult},getCaption:function($key,$domain,$asAbbr){let lResult=$key;return $asAbbr=null!=$asAbbr&&$asAbbr,$scope.source&&$scope.source[$domain]&&null!=$scope.source[$domain][$key]&&(lResult=$asAbbr?$scope.source[$domain][$key].abbr:$scope.source[$domain][$key].caption),lResult}};return $scope}),ImmoDbApp.factory("$immodbUtils",["$immodbDictionary","$immodbTemplate","$interpolate","$sce","$immodbConfig",function $immodbUtils($immodbDictionary,$immodbTemplate,$interpolate,$sce,$immodbConfig){let $scope={page_list:[],configs:null,getCaption:function($key,$domain,$asAbbr){return $immodbDictionary.getCaption($key,$domain,$asAbbr)},formatPrice:function($item,$format){$format=null!=$format?$format:"short";let lResult=[];if("SOLD"==$item.status_code)return null!=$item.price.sell?lResult.push("Sold".translate()):lResult.push("Leased".translate()),lResult.join("");for(let $key in $item.price)if(["sell","lease"].indexOf($key)>=0){let lPart=[$item.price[$key].amount.formatPrice()];if($item.price[$key].taxable&&(lPart[0]+="+tx"),$item.price[$key].unit&&lPart.push($scope.getCaption($item.price[$key].unit_code,"price_unit",!0)),"long"==$format){let lStart="for {0} for ".format($key).translate();lResult.push(lStart+lPart.join("/"))}else lResult.push(lPart.join("/"))}let lSeperator=" or ".translate();return lResult.join(lSeperator)},formatDimension:function($dimension){let lResult="";if(null!=$dimension)if(void 0!==$dimension.width){let lUnit=$immodbDictionary.getCaption($dimension.unit_code,"dimension_unit",!0);lResult="{0}{2} x {1}{2}".format($dimension.width,$dimension.length,lUnit)}else if(null!=typeof $dimension.area){let lUnit=$immodbDictionary.getCaption($dimension.area_unit_code,"dimension_unit",!0);lResult="{0} {1}".format($dimension.area,lUnit)}return lResult},hasDimension:function($dimension){let lResult=!1;if(null!=$dimension){if(null!=$dimension.width&&null!=$dimension.length)return!0;if(null!=$dimension.area)return!0}return!1},getPermalink:function($item,$type,$configs){let lRoute="";$type=void 0===$type?"listing":$type,$scope.item=$item,immodbCtx[$type+"_routes"].forEach(function($r){$r.lang==immodbCtx.locale&&(lRoute=$r)});let lResult=$scope.sanitize("/"+$immodbTemplate.interpolate(lRoute.route,$scope));return $immodbConfig._data.enable_custom_page&&$scope.page_list.some(function($p){let lCustomPage="";switch($type){case"broker":lCustomPage=lResult.replace("/"+$item.ref_number,"-"+$item.ref_number);break;case"listing":let lRx=new RegExp("/[^/]+/"+$item.ref_number);lCustomPage=lResult.replace(lRx,"/"+$scope.sanitize($item.location.civic_address)+"-"+$item.ref_number)}if(""!=lCustomPage&&lCustomPage==$p.permalink)return lResult=lCustomPage,!0}),lResult},evaluate:function($text,$context){return $interpolate($text)($context)},compileListingList:function($list){return $list.forEach(function($e){$scope.compileListingItem($e)}),$list},compileListingItem:function($item){null==$item.category&&($item.location.city=$scope.getCaption($item.location.city_code,"city"),$item.location.region=$scope.getCaption($item.location.region_code,"region"),$item.subcategory=$scope.getCaption($item.subcategory_code,"listing_subcategory"),$item.category=$scope.getCaption($item.category_code,"listing_category"),$item.transaction=$scope.getTransaction($item),$item.short_price=$scope.formatPrice($item),$item.location.civic_address="{0} {1}".format($item.location.address.street_number,$item.location.address.street_name),$item.permalink=$scope.getPermalink($item))},compileBrokerList:function($list){return $list.forEach(function($e){$scope.compileBrokerItem($e)}),$list},compileBrokerItem:function($item){null==$item.permalink&&($item.license_type=$immodbDictionary.getCaption($item.license_type_code,"broker_license_type"),$item.permalink=$scope.getPermalink($item,"broker"))},getClassList:function($item){let lResult=[];if(null!=$item){"SOLD"==$item.status_code&&lResult.push("sold");let lHasFlags=!1;$item.video_flag&&(lHasFlags=!0,lResult.push("has-video")),$item.virtual_tour_flag&&(lHasFlags=!0,lResult.push("has-virtual-tour")),lHasFlags&&lResult.push("has-flags"),null!=$item.open_houses&&$item.open_houses.length>0&&lResult.push("has-open-house")}return lResult.join(" ")},getCity:function($item,$sanitize){$sanitize=null==$sanitize||$sanitize;let lResult=$scope.getCaption($item.location.city_code,"city");return $sanitize&&(lResult=$scope.sanitize(lResult)),lResult},getRegion:function($item,$sanitize){$sanitize=null==$sanitize||$sanitize;let lResult=$scope.getCaption($item.location.region_code,"region");return $sanitize&&(lResult=$scope.sanitize(lResult)),lResult},getTransaction:function($item,$sanitize){$sanitize=null!=$sanitize&&$sanitize;let lResult=[];for(var $key in $item.price)if("foreclosure"!=$key){let lTrans=("To "+$key).translate();$sanitize&&(lTrans=$scope.sanitize(lTrans)),lResult.push(lTrans)}return lResult.join(" "+"or".translate()+" ")},sanitize:function($value){if(void 0===$value)return"-";let lResult=$value.toLowerCase();return lResult=(lResult=(lResult=(lResult=(lResult=(lResult=(lResult=lResult.replace(/(\s|\+)/gm,"-")).replace(/('|"|\(|\))/gm,"")).replace(/(|||)/gm,"e")).replace(/(||)/gm,"a")).replace(/(||)/gm,"i")).replace(/(||)/gm,"u")).replace(/(||)/gm,"o")},toArray:function($object){if(!angular.isObject($object))return $object;let lResult=[];for(let objectKey in $object)$object[objectKey].__$key=objectKey,$object[objectKey].__$obj_key=objectKey,lResult.push($object[objectKey]);return lResult},toSortedArray:function($object,$attr){$attr=null==$attr?"caption":$attr;let lResult=$scope.toArray($object);return lResult.sort(function(a,b){return isNaN(a[$attr])?a[$attr]<=b[$attr]?-1:1:(a=parseInt(a[$attr]))-(b=parseInt(b[$attr]))}),lResult},search:function(){let lResult={},lSearch=location.search.replace("?","");if(""!=lSearch){let lQueryArr;lSearch.split("&").forEach(function($item){lKeyValue=$item.split("="),lResult[lKeyValue[0]]=lKeyValue[1]})}return lResult},absolutePosition:function(element){var top=0,left=0;if(null!=element){do{top+=element.offsetTop||0,left+=element.offsetLeft||0,element=element.offsetParent}while(element);let lHtmlElm=angular.element("html")[0],lGlobalTop={margin:Number(window.getComputedStyle(lHtmlElm,null).getPropertyValue("margin-top").replace("px","")),padding:Number(window.getComputedStyle(lHtmlElm,null).getPropertyValue("padding-top").replace("px",""))},lGlobalLeft={margin:Number(window.getComputedStyle(lHtmlElm,null).getPropertyValue("margin-left").replace("px","")),padding:Number(window.getComputedStyle(lHtmlElm,null).getPropertyValue("padding-left").replace("px",""))};lGlobalOffsetTop=lGlobalTop.margin+lGlobalTop.padding,lGlobalOffsetLeft=lGlobalLeft.margin+lGlobalLeft.padding,top+=lGlobalOffsetTop,left+=lGlobalOffsetLeft}return{top:top,left:left}},lateCallHndl:null,lateCall:function($func){null!=$scope.lateCallHndl&&window.clearTimeout($scope.lateCallHndl),$scope.lateCallHndl=window.setTimeout(function(){$func()},500)},appendToUrlQuery:function($url,$key,$value){let lDataPrefix="?";return $url.indexOf("?")>=0&&(lDataPrefix="&"),$url+lDataPrefix+$key+"="+$value}};return $scope}]),ImmoDbApp.factory("$immodbConfig",["$http","$q",function $immodbConfig($http,$q){let $scope={_data:null,_loading:!1,init:function(){$scope.get()},get:function(){let lPromise;return $q(function($resolve,$reject){if(console.log("on get $scope._data:",$scope._data,"loading:",$scope._loading),1==$scope._loading){let fnWait=function(){1==$scope._loading?window.setTimeout(fnWait,50):$resolve($scope._data)};fnWait()}else null!=$scope._data?$resolve($scope._data):($scope._loading=!0,$http.get(immodbCtx.config_path).then(function($response){200==$response.status?($scope._data=$response.data,$scope._loading=!1,$resolve($scope._data)):$reject()}))})}};return $scope.init(),$scope}]),ImmoDbApp.factory("$immodbHooks",["$q",function $immodbHooks($q){let $scope={_actions:[],_filters:[],addAction:function($key,$func,$priority){let lNewAction={key:$key,fn:$func};null==$priority||$priority>$scope._actions.length-1?$scope._actions.push(lNewAction):$scope._actions.splice($priority,0,lNewAction)},addFilter:function($key,$func,$priority){let lNewFilter={key:$key,fn:$func};null==$priority||$priority>$scope._filters.length-1?$scope._filters.push(lNewFilter):$scope._filters.splice($priority,0,lNewFilter)},do:function($key,$params){let lActions=[];$scope._actions.forEach(function($a){$key==$a.key&&lActions.push($a)}),lActions.forEach(function($a){$a.fn($params)})},filter:function($key,$default_value,$otherParams){let lFilters=[];return $scope._filters.forEach(function($f){$key==$f.key&&lFilters.push($f)}),lFilters.forEach(function($f){$default_value=$f.fn($default_value,$otherParams)}),$default_value}};return $scope}]),ImmoDbApp.factory("$immodbFavorites",["$q",function($q){let $scope={favorites:[],init:function(){$scope.favorites=JSON.parse(localStorage.getItem("favorites")),null==$scope.favorites&&($scope.favorites=[])},save:function(){localStorage.setItem("favorites",JSON.stringify($scope.favorites))},toggle:function($key){!1===$scope.isFavorite($key)?($scope.favorites.push($key),$scope.save()):($scope.favorites.splice($scope.favorites.indexOf($key),1),$scope.save())},isFavorite:function($key){return $scope.favorites.some($e=>$e==$key)}};return $scope.init(),$scope}]),ImmoDbApp.factory("$immodbShare",["$q","$immodbHooks","$immodbUtils",function immodbShare($q,$immodbHooks,$immodbUtils){let $scope={data:{url:null,url_timed:null,text:null,media:null,title:null},init:function(){$scope.data.url=window.location.href,$scope.data.title=document.title,$scope.data.description=document.description},execute:function($dest){let lShareUrl=$scope.get_destination_format($dest);if(null==$scope.data.url)return!1;for($key in $scope.data=$immodbHooks.filter("immodb.share.data",$scope.data),null!=$scope.data.url&&null==$scope.data.url_timed&&($scope.data.url_timed=$immodbUtils.appendToUrlQuery($scope.data.url,"t",moment().valueOf())),$scope.data)lShareUrl=lShareUrl.replace("["+$key+"]",escape($scope.data[$key]));window.open(lShareUrl)},get_destination_format:function($dest){let lFormats;return{facebook:"https://www.facebook.com/sharer/sharer.php?u=[url_timed]",twitter:"https://twitter.com/intent/tweet?url=[url]",pinterest:"http://pinterest.com/pin/create/button/?url=[url]&media=[media]&description=[title]",googleplus:"https://plus.google.com/share?url=[url]",linkedin:"https://www.linkedin.com/sharing/share-offsite/?url=[url]",email:"mailto:?subject=[title]&body=[url]&v=3"}[$dest]}};return $scope.init(),$scope}]),ImmoDbApp.filter("range",function rangeFilter(){return function($items,$lowerBound,$upperBound){if(null==$items)return null;$items.forEach(function($e,$i){$e.index=$i});let lRange=$upperBound-$lowerBound,lResult;return lRange>$items.length?(lRange=$items.length,$lowerBound=0,$upperBound=$items.length-1):$lowerBound<0?$upperBound=($lowerBound=0)+lRange:$upperBound>$items.length-1&&($upperBound=$items.length-1,$lowerBound=$upperBound-lRange),$items.filter(function($e,$i){return $lowerBound<=$i&&$i<$upperBound})}}),ImmoDbApp.filter("asArray",function asArrayFilter(){return function($object){let lResult=[];if($object)for(key in $object)"function"!=typeof $object[key]&&($object[key].__$key=key,lResult.push($object[key]));return lResult}}),ImmoDbApp.filter("orderObjectBy",function orderObjectByFilter(){return function(input,attribute){if(!angular.isObject(input))return input;var array=[];for(var objectKey in input)input[objectKey].__$key=objectKey,array.push(input[objectKey]);return array.sort(function(a,b){return isNaN(a[attribute])?a[attribute]<=b[attribute]?-1:1:(a=parseInt(a[attribute]))-(b=parseInt(b[attribute]))}),array}}),ImmoDbApp.filter("textToHtml",[function(){return function($value){if(null==$value||null==$value)return"";const tagRegex=/<[^>]+>/gm;if($matches=tagRegex.exec($value),null!=$matches&&$matches.length>0)return $value;let lReplacements;return[{match:/(\n+)/gm,by:"</p><p>",wrap_by:"p"},{match:/(\n)/g,by:"<br />"}].forEach(function($e){$value=$value.replace($e.match,$e.by),null!=$e.wrap_by&&($value="<"+$e.wrap_by+">"+$value+"</"+$e.wrap_by+">")}),$value}}]),ImmoDbApp.filter("formatDimension",["$immodbUtils",function dimensionFilter($immodbUtils){return function($value){return $immodbUtils.formatDimension($value)}}]);